(self.__chunk_yandex_ymaps3=self.__chunk_yandex_ymaps3||[]).push([[154],{26259:e=>{var t,i,r=Object.create,s=Object.defineProperty,o=Object.defineProperties,n=Object.getOwnPropertyDescriptor,a=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertyNames,d=Object.getOwnPropertySymbols,h=Object.getPrototypeOf,c=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,_=Reflect.get,p=Math.pow,m=(e,t,i)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,f=(e,t)=>{for(var i in t||(t={}))c.call(t,i)&&m(e,i,t[i]);if(d)for(var i of d(t))u.call(t,i)&&m(e,i,t[i]);return e},g=(e,t)=>o(e,a(t)),v=(e,t)=>{for(var i in t)s(e,i,{get:t[i],enumerable:!0})},y=(e,t,i,r)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let o of l(t))!c.call(e,o)&&o!==i&&s(e,o,{get:()=>t[o],enumerable:!(r=n(t,o))||r.enumerable});return e},x=(e,t,i)=>new Promise(((r,s)=>{var o=e=>{try{a(i.next(e))}catch(e){s(e)}},n=e=>{try{a(i.throw(e))}catch(e){s(e)}},a=e=>e.done?r(e.value):Promise.resolve(e.value).then(o,n);a((i=i.apply(e,t)).next())})),b=(t=(e,t)=>{var i=function(e){null==e&&(e=(new Date).getTime()),this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.mt=new Array(this.N),this.mti=this.N+1,e.constructor==Array?this.init_by_array(e,e.length):this.init_seed(e)};i.prototype.init_seed=function(e){for(this.mt[0]=e>>>0,this.mti=1;this.mti<this.N;this.mti++)e=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30,this.mt[this.mti]=(1812433253*((4294901760&e)>>>16)<<16)+1812433253*(65535&e)+this.mti,this.mt[this.mti]>>>=0},i.prototype.init_by_array=function(e,t){var i,r,s;for(this.init_seed(19650218),i=1,r=0,s=this.N>t?this.N:t;s;s--){var o=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1664525*((4294901760&o)>>>16)<<16)+1664525*(65535&o))+e[r]+r,this.mt[i]>>>=0,r++,++i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1),r>=t&&(r=0)}for(s=this.N-1;s;s--)o=this.mt[i-1]^this.mt[i-1]>>>30,this.mt[i]=(this.mt[i]^(1566083941*((4294901760&o)>>>16)<<16)+1566083941*(65535&o))-i,this.mt[i]>>>=0,++i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1);this.mt[0]=2147483648},i.prototype.random_int=function(){var e,t=new Array(0,this.MATRIX_A);if(this.mti>=this.N){var i;for(this.mti==this.N+1&&this.init_seed(5489),i=0;i<this.N-this.M;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+this.M]^e>>>1^t[1&e];for(;i<this.N-1;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+(this.M-this.N)]^e>>>1^t[1&e];e=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^e>>>1^t[1&e],this.mti=0}return e=this.mt[this.mti++],e^=e>>>11,e^=e<<7&2636928640,e^=e<<15&4022730752,(e^=e>>>18)>>>0},i.prototype.random_int31=function(){return this.random_int()>>>1},i.prototype.random_incl=function(){return this.random_int()*(1/4294967295)},i.prototype.random=function(){return this.random_int()*(1/4294967296)},i.prototype.random_excl=function(){return(this.random_int()+.5)*(1/4294967296)},i.prototype.random_long=function(){return(67108864*(this.random_int()>>>5)+(this.random_int()>>>6))*(1/9007199254740992)},t.exports=i},()=>(i||t((i={exports:{}}).exports,i),i.exports)),T={};v(T,{default:()=>Fh}),e.exports=(e=>y(s({},"__esModule",{value:!0}),e))(T);var P={};v(P,{BackgroundColor:()=>Il,BackgroundRenderUnit:()=>El,BuildingsRenderUnit:()=>Nl,Camera:()=>$e,CenterWrapMode:()=>Ye,Cesium3DTile:()=>Ba,Cesium3DTileSet:()=>Va,CollidingFriendIdRenderer:()=>zh,CollidingPrimitiveColorIdRenderer:()=>ls,CollidingPrimitivesResetRemovedRenderer:()=>_s,CollisionPriorityRank:()=>Pl,ColorIdCurvedLabelRenderer:()=>Ih,ColorIdGltfRenderer:()=>Ah,ColorIdIconRenderer:()=>Eh,ColorIdPointLabelRenderer:()=>Mh,ContentPortionPrimitiveProvider:()=>md,ContentProviderPriority:()=>wa,ContentProviderType:()=>bl,Context:()=>Cs,CoveredByIndoorFilter:()=>Ko,CurvedLabelRenderUnit:()=>vh,DEFAULT_SCENARIO:()=>cl,DebugFakePrimitiveRenderUnit:()=>xh,DepthClearStrategy:()=>Ll,Engine:()=>ys,EventTrigger:()=>qe,ExternalRendererRenderUnit:()=>yd,FxaaRenderUnit:()=>Dl,GlTFPrimitiveRenderUnit:()=>Kl,GltfResetRemovedRenderer:()=>Dh,GraphicsContentProvider:()=>cn,GraphicsPolylineRenderUnit:()=>Ld,GraphicsRenderUnit:()=>pd,GraphicsScenePrimitiveProvider:()=>gd,GroundCompositeRenderUnit:()=>bh,HybridMapContentProvider:()=>tl,IconRenderUnit:()=>$d,IndoorContentProvider:()=>Qo,IndoorPlan:()=>Zo,LabelCollidingFriendIdRenderer:()=>Bh,LabelResetRemovedRenderer:()=>Ch,LayerRenderUnit:()=>Ul,METADATA_KEYS:()=>So,MainContentProvider:()=>Tl,MapMode:()=>Fo,MapType:()=>hl,ModelRenderUnit:()=>ph,ModelsAnimationManager:()=>ud,PointLabelRenderUnit:()=>Hd,PolygonRenderUnit:()=>sh,PolylineRenderUnit:()=>Ad,RenderablePrimitive:()=>Tr,SceneObjectType:()=>ko,TILE3D_MODEL_COLOR_DAY:()=>qa,TILE3D_MODEL_COLOR_NIGHT:()=>Ya,TexPolygonRenderUnit:()=>lh,Tile3DContentProvider:()=>Wa,TileSize:()=>Is,TransparentPolygonRenderUnit:()=>nh,VECTOR_METADATA_PREFIX:()=>Ro,VectorMapContentProvider:()=>Yo,VectorPrimitiveTypes:()=>Us,VerboseCesium3DTileSet:()=>wl,VisibilityManager:()=>or,Vmap3ContentProvider:()=>_l,createColorTransform:()=>cd,getPhonyFov:()=>ot,isTile3DRenderable:()=>Mn,mapTypeToString:()=>Rl});var w=R(0,0,0,1),M=R(1,1,1,1);R(0,0,0,0);function R(e,t,i,r=1){return{r:e,g:t,b:i,a:r}}function S(e,t=R(0,0,0,0)){return t.r=e.r,t.g=e.g,t.b=e.b,t.a=e.a,t}var C=/^(0x|#)?(([a-fA-F0-9]{3}){1,2}|([a-fA-F0-9]{4}){1,2})$/;function I(e,t,i){let r=e.substring(i*t,(i+1)*t),s=(1<<4*t)-1;return parseInt(r,16)/s}function E(e){let t=C.exec(e);if(!t)return null;let i=t[2],r=i.length>4?2:1;return R(I(i,r,0),I(i,r,1),I(i,r,2),i.length%4?1:I(i,r,3))}var A={blend:!0,blendFuncSrcRgb:770,blendFuncDstRgb:771,blendFuncSrcAlpha:1,blendFuncDstAlpha:771},L={blend:!0,blendFuncSrcRgb:1,blendFuncDstRgb:771,blendFuncSrcAlpha:1,blendFuncDstAlpha:771},U={depthTest:!0,depthFunc:518,blend:!0,blendFuncSrcRgb:771,blendFuncDstRgb:770,blendFuncSrcAlpha:771,blendFuncDstAlpha:770},O=class{constructor(...e){this.clearColor=R(0,0,0,0),this.clearDepth=1,this.clearStencil=0,this.colorMaskR=!0,this.colorMaskG=!0,this.colorMaskB=!0,this.colorMaskAlpha=!0,this.blend=!1,this.blendEquationRgb=32774,this.blendEquationAlpha=32774,this.blendFuncSrcRgb=1,this.blendFuncDstRgb=0,this.blendFuncSrcAlpha=1,this.blendFuncDstAlpha=0,this.cullFace=!1,this.cullFaceMode=1029,this.frontFaceMode=2305,this.depthTest=!1,this.depthFunc=513,this.depthRangeNear=0,this.depthRangeFar=1,this.depthMask=!0,this.dither=!0,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.sampleAlphaToCoverage=!1,this.sampleCoverage=!1,this.sampleCoverageValue=1,this.sampleCoverageInvert=!1,this.scissorTest=!1,this.scissorX=0,this.scissorY=0,this.scissorWidth=-1,this.scissorHeight=-1,this.stencilTest=!1,this.stencilReference=0,this.stencilMask=255,this.stencilWriteMask=255,this.stencilFrontFunc=519,this.stencilFrontFailOp=7680,this.stencilFrontDepthFailOp=7680,this.stencilFrontDepthPassOp=7680,this.stencilBackFunc=519,this.stencilBackFailOp=7680,this.stencilBackDepthFailOp=7680,this.stencilBackDepthPassOp=7680,this.viewportX=0,this.viewportY=0,this.viewportWidth=-1,this.viewportHeight=-1,Object.assign(this,...e)}};function D(e,t,i=1e-6){let r=e-t;return-i<r&&r<i}function z(e,t){return{x:e,y:t}}var B=z(0,0);z(1,0),z(-1,0),z(0,1),z(0,-1);function F(e,t=z(0,0)){return t.x=e.x,t.y=e.y,t}function V(e,t,i=z(0,0)){return i.x=e.x+t.x,i.y=e.y+t.y,i}function N(e,t,i=z(0,0)){return i.x=e.x*t,i.y=e.y*t,i}function k(e,t,i=z(0,0)){return i.x=t(e.x),i.y=t(e.y),i}var H={minX:0,maxX:0,minY:0,maxY:0};function j(e,t){let i,r,s,o;return e.minX<t.minX?(i=e,r=t):(i=t,r=e),e.maxY>t.maxY?(s=e,o=t):(s=t,o=e),r.minX<i.maxX&&o.maxY>s.minY}function G(e,t={minX:0,maxX:0,minY:0,maxY:0}){if(0===e.length)return t;t.minX=t.maxX=e[0].x,t.minY=t.maxY=e[0].y;for(let i=1;i<e.length;++i){let{x:r,y:s}=e[i];r<t.minX&&(t.minX=r),r>t.maxX&&(t.maxX=r),s<t.minY&&(t.minY=s),s>t.maxY&&(t.maxY=s)}return t}new Array(9);function W(e,t,i){return{x:e,y:t,z:i}}function q(e,t,i,r){return r.x=e,r.y=t,r.z=i,r}var Y=W(0,0,0),X=(W(1,0,0),W(-1,0,0),W(0,1,0)),Z=(W(0,-1,0),W(0,0,1));W(0,0,-1);function $(e,t=W(0,0,0)){return t.x=e.x,t.y=e.y,t.z=e.z,t}function Q(e,t,i=W(0,0,0)){return i.x=e.x+t.x,i.y=e.y+t.y,i.z=e.z+t.z,i}function K(e,t,i=W(0,0,0)){return i.x=e.x*t.x,i.y=e.y*t.y,i.z=e.z*t.z,i}function J(e,t,i=W(0,0,0)){return i.x=e.x*t,i.y=e.y*t,i.z=e.z*t,i}function ee(e,t=W(0,0,0)){return function(e,t,i=W(0,0,0)){return i.x=e.x/t,i.y=e.y/t,i.z=e.z/t,i}(e,function(e){return Math.hypot(e.x,e.y,e.z)}(e),t)}function te(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}function ie(e,t,i=W(0,0,0)){let r=e.y*t.z-e.z*t.y,s=e.z*t.x-e.x*t.z,o=e.x*t.y-e.y*t.x;return i.x=r,i.y=s,i.z=o,i}function re(e,t,i=W(0,0,0)){let r=Math.cos(t),s=Math.sin(t),o=e.y;return i.x=e.x,i.y=o*r-e.z*s,i.z=o*s+e.z*r,i}function se(e,t,i=W(0,0,0)){let r=Math.cos(t),s=Math.sin(t);return e=e===i?$(e):e,i.x=e.x*r-e.y*s,i.y=e.x*s+e.y*r,i.z=e.z,i}function oe(e,t,i,r=W(0,0,0)){let s=(e-t.z)/(i.z-t.z);return 0<=s&&s<=1?function(e,t,i,r=W(0,0,0)){return r.x=(1-i)*e.x+i*t.x,r.y=(1-i)*e.y+i*t.y,r.z=(1-i)*e.z+i*t.z,r}(t,i,s,r):null}function ne(e,t,i=W(0,0,0)){let r=te(t.direction,e.normal);if(0===r)return null;let s=(e.distance-te(e.normal,t.origin))/r;return s<0?null:($(t.direction,i),J(i,s,i),Q(i,t.origin,i),i)}function ae(e,t=[W(0,0,0),W(0,0,0),W(0,0,0),W(0,0,0),W(0,0,0),W(0,0,0),W(0,0,0),W(0,0,0)]){return q(e.minX,e.minY,e.minZ,t[0]),q(e.minX,e.minY,e.maxZ,t[1]),q(e.minX,e.maxY,e.minZ,t[2]),q(e.minX,e.maxY,e.maxZ,t[3]),q(e.maxX,e.minY,e.minZ,t[4]),q(e.maxX,e.minY,e.maxZ,t[5]),q(e.maxX,e.maxY,e.minZ,t[6]),q(e.maxX,e.maxY,e.maxZ,t[7]),t}var le=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],de=16;function he(){return new Array(de)}function ce(e,t=he()){for(let i=0;i<de;++i)t[i]=e[i];return t}function ue(e,t,i=he()){for(let r=0;r<de;r+=4){let s=i[r+3]=e[r+3];i[r]=e[r]+s*t.x,i[r+1]=e[r+1]+s*t.y,i[r+2]=e[r+2]+s*t.z}return i}var _e=ce(le);function pe(e,t,i,r,s=he()){let o=function(e,t,i=W(0,0,0)){return i.x=e.x-t.x,i.y=e.y-t.y,i.z=e.z-t.z,i}(t,i);ee(o,o);let n=ie(r,o);ee(n,n);let a=ie(o,n);return _e[0]=n.x,_e[1]=a.x,_e[2]=o.x,_e[4]=n.y,_e[5]=a.y,_e[6]=o.y,_e[8]=n.z,_e[9]=a.z,_e[10]=o.z,_e[12]=-te(n,t),_e[13]=-te(a,t),_e[14]=-te(o,t),me(e,_e,s)}function me(e,t,i=he()){for(let r=0;r<de;r+=4){let s=e[r],o=e[r+1],n=e[r+2],a=e[r+3];for(let e=0;e<4;++e)i[r+e]=s*t[e]+o*t[4+e]+n*t[8+e]+a*t[12+e]}return i}function fe(e,t,i=W(0,0,0)){let r=e[3]*t.x+e[7]*t.y+e[11]*t.z+e[15],s=(e[0]*t.x+e[4]*t.y+e[8]*t.z+e[12])/r,o=(e[1]*t.x+e[5]*t.y+e[9]*t.z+e[13])/r,n=(e[2]*t.x+e[6]*t.y+e[10]*t.z+e[14])/r;return i.x=s,i.y=o,i.z=n,i}function ge(e,t=he()){for(let i=0;i<4;i++)for(let r=i;r<4;r++){let s=e[4*i+r];t[4*i+r]=e[4*r+i],t[4*r+i]=s}return t}he();function*ve(e,t){for(let i of e)yield t(i)}function*ye(e,t){for(let i of e)t(i)&&(yield i)}function xe(e,t){for(let i of e)if(!t(i))return!1;return!0}function be(e,t){let i=0;for(let r of e)(!t||t(r))&&i++;return i}function Te(e,t=4){let i=0;return{attributes:[...ve(e,(([e,{type:r,size:s,normalized:o,divisor:n}])=>{let a=[e,{type:r,size:s,normalized:o,offset:i,divisor:n}],l=s*function(e){switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4}}(r);return i=function(e,t){return(e-1&t)-t}(i+l,-t),a}))],vertexByteSize:i}}function Pe(e){return 65535*e|0}function we(e){return 4294967295*e|0}function Me(e,t){return e>t?1:e<t?-1:0}function Re(e,t,i){let r=e[t];e[t]=e[i],e[i]=r}function Se(e,t,i=0,r=e.length,s=0){for(let o=i,n=s;o<r;++o,++n)t[n]=e[o]}function Ce(e,t=Me,i=0,r=e.length){for(let s=i;s<r;++s)for(let r=s;r>i&&t(e[r-1],e[r])>0;--r)Re(e,r-1,r)}function Ie(e,t,i,r,s,o,n){let a=n,l=r,d=s;for(;l<s&&d<o;)t[a++]=i(e[l],e[d])>0?e[d++]:e[l++];Se(e,t,l,s,a),Se(e,t,d,o,a)}var Ee=Symbol("filter_out_is_removed");function Ae(e,t){for(let i=0;i<t.length;i++)for(let r=0;r<e.length;r++)if(e[r]===t[i]){t[i][Ee]=!0;break}let i=0;for(let t=0;t<e.length;t++)e[t][Ee]?e[t][Ee]=!1:(e[i]=e[t],i++);e.length=i}function*Le(e){for(let t=2;t<e;++t)yield 0,yield t-1,yield t}function*Ue(e){yield 0,yield 1,yield 2;let t=1,i=2;for(let r=3;r<e;++r){yield r-t,yield r-i,yield r;let e=t;t=i,i=e}}var Oe=class{constructor(e){this._nextWordOffset=0,this._initBuffers(e)}get isFull(){return this._nextWordOffset>=this._uint32View.length}get occupiedSize(){return this._nextWordOffset}get byteSize(){return this._uint32View.byteLength}extend(e){let t=this._uint32View;this._initBuffers(e),this._uint32View.set(t)}pushUint32(e){this._uint32View[this._nextWordOffset++]=e}pushFloat32(e){this._float32View[this._nextWordOffset++]=e}asUint32Array(){return this._uint32View.subarray(0,this.occupiedSize)}_initBuffers(e){let t=new ArrayBuffer(e);this._uint32View=new Uint32Array(t),this._float32View=new Float32Array(t)}static transferDataTail(e,t,i,r=0){let s=e.occupiedSize-i,o=e._uint32View.subarray(i,e.occupiedSize);t._uint32View.set(o,r),t._nextWordOffset=s,e._nextWordOffset=i}},De=class{constructor(e){this._nextIndexOffset=0,this._uint16View=new Uint16Array(e)}get occupiedSize(){return this._nextIndexOffset}get size(){return this._uint16View.length}extend(e){let t=this._uint16View;this._uint16View=new Uint16Array(e),this._uint16View.set(t)}push(e){this._uint16View[this._nextIndexOffset++]=e}asUint16Array(){return new Uint16Array(this._uint16View.buffer,0,this.occupiedSize)}static transferDataTail(e,t,i,r,s=0){for(let o=r,n=s;o<e.occupiedSize;o++,n++)t._uint16View[n]=e._uint16View[o]-i;t._nextIndexOffset=e.occupiedSize-r,e._nextIndexOffset=r}},ze=class{constructor(e,t=1024,i=65536,r=3072){this._vertexByteSize=e,this._initVertexBufferByteSize=e*t,this._maxVertexBufferByteSize=e*i,this._initIndexBufferUint16Size=r,this._vertexBuffer=new Oe(this._initVertexBufferByteSize),this._vertexBuffers=[this._vertexBuffer],this._indexBuffer=new De(this._initIndexBufferUint16Size),this._indexBuffers=[this._indexBuffer],this._currentMeshVertexOffset=0,this._currentMeshIndexOffset=0,this._currentMeshBaseIndex=0}writeIndices(e){this._ensureEnoughIndexBufferSpace(e.length);let t=this._indexBuffer,i=this._currentMeshBaseIndex;for(let r=0;r<e.length;++r)t.push(i+e[r])}writeIndicesForStrip(e){this._ensureEnoughIndexBufferSpace(3*(e.length-2));let t=this._indexBuffer,i=this._currentMeshBaseIndex;for(let r of Ue(e.length))t.push(i+e[r])}writeIndicesForContinuousStrip(e,t=0){this._ensureEnoughIndexBufferSpace(3*(e-2));let i=this._indexBuffer,r=this._currentMeshBaseIndex+t;for(let t of Ue(e))i.push(r+t)}writeIndicesForFan(e){this._ensureEnoughIndexBufferSpace(3*(e.length-2));let t=this._indexBuffer,i=this._currentMeshBaseIndex;for(let r of Le(e.length))t.push(i+e[r])}writeIndicesForContinuousFan(e,t=0){this._ensureEnoughIndexBufferSpace(3*(e-2));let i=this._indexBuffer,r=t+this._currentMeshBaseIndex;for(let t of Le(e))i.push(r+t)}endMesh(){let e=this._currentMeshVertexOffset,t=this._vertexBuffer.occupiedSize;this._currentMeshVertexOffset=t,this._currentMeshBaseIndex=(t<<2)/this._vertexByteSize;let i=this._currentMeshIndexOffset,r=this._indexBuffer.occupiedSize;return this._currentMeshIndexOffset=r,{vertexByteOffset:e<<2,vertexByteLength:t-e<<2,indexByteOffset:i<<1,indexByteLength:r-i<<1,indexType:5123,bufferIndex:this._vertexBuffers.length-1}}getBuffers(){return function(e,t,i=((e,t)=>[e,t])){let r=Math.min(e.length,t.length),s=new Array(r);for(let o=0;o<r;++o)s[o]=i(e[o],t[o]);return s}(this._vertexBuffers,this._indexBuffers,((e,t)=>({vertexBuffer:e.asUint32Array(),indexBuffer:t.asUint16Array()})))}getCurrentVertexBufferByteOffset(){return this._vertexBuffer.occupiedSize<<2}getCurrentVertexIdx(){return((this._vertexBuffer.occupiedSize<<2)/this._vertexByteSize|0)-this._currentMeshBaseIndex}_writeFloat32(e){this._ensureEnoughVertexBufferSpace(),this._vertexBuffer.pushFloat32(e)}_writeWord(e){this._ensureEnoughVertexBufferSpace(),this._vertexBuffer.pushUint32(e)}_writeHalfWords(e,t){this._writeWord(t<<16|65535&e)}_writeBytes(e,t,i,r){this._writeWord(r<<24|(255&i)<<16|(255&t)<<8|255&e)}_writeWorldCoordinate(e){let t=we(.5*(e.x+1)),i=we(.5*(e.y+1));this._writeHalfWords(t>>>16,i>>>16),this._writeHalfWords(t,i)}_getNextVertexBufferByteSize(e){return e<<1}_getNextIndexBufferUint16Size(e){return e<<1}_ensureEnoughVertexBufferSpace(){let e=this._vertexBuffer;if(!e.isFull)return;if(e.byteSize<this._maxVertexBufferByteSize)return void this._vertexBuffer.extend(this._getNextVertexBufferByteSize(e.byteSize));let t=this._currentMeshVertexOffset,i=4*(e.occupiedSize-t);if(i===this._maxVertexBufferByteSize)throw new Error("Mesh is too big to fit in.");let r=this._initVertexBufferByteSize;for(;r<=i;)r=this._getNextVertexBufferByteSize(r);let s=new Oe(r);Oe.transferDataTail(e,s,t),this._vertexBuffer=s,this._vertexBuffers.push(s),this._currentMeshVertexOffset=0;let o=this._indexBuffer,n=this._currentMeshIndexOffset,a=o.occupiedSize-n,l=this._initIndexBufferUint16Size;for(;l<=a;)l=this._getNextIndexBufferUint16Size(l);let d=new De(l);De.transferDataTail(o,d,this._currentMeshBaseIndex,n),this._currentMeshBaseIndex=0,this._currentMeshIndexOffset=0,this._indexBuffer=d,this._indexBuffers.push(d)}_ensureEnoughIndexBufferSpace(e){let t=this._indexBuffer,i=t.occupiedSize+e;if(i<=t.size)return;let r=t.size;for(;i>r;)r=this._getNextIndexBufferUint16Size(r);this._indexBuffer.extend(r)}},Be=Te([[0,{size:2,type:5123,normalized:!0}]]),Fe=class extends ze{constructor(e,t){let i=e*t;super(Be.vertexByteSize,i,void 0,0);let r=Pe(1/e),s=Pe(1/t),o=s/2;for(let i=0,n=r/2;i<e;i++,n+=r)for(let e=0,i=o;e<t;e++,i+=s)this._writeHalfWords(n,i);this.data=this.getBuffers()[0].vertexBuffer,this.numberOfSamplers=i}},Ve=class{constructor(e,t,i,r,s){this._context=e,this._renderState=t,this._program=i,this._hitTestRenderState=r,this._hitTestProgram=s}render(e,...t){this._program&&this._prepareProgram(this._program,...t),this._prepareRenderTarget(e,...t),this._render(...t)}renderHitTestBuffer(e,...t){this._hitTestProgram&&(this._prepareHitTestProgram(this._hitTestProgram,...t),this._prepareHitTestTarget(e,...t),this._renderHitTestBuffer(...t))}destroy(){this._program&&this._program.destroy(),this._hitTestProgram&&this._hitTestProgram.destroy()}_prepareProgram(e,...t){this._context.bindProgram(e)}_prepareHitTestProgram(e,...t){this._context.bindProgram(e)}_prepareRenderTarget(e,...t){this._context.bindRenderState(this._renderState),this._context.bindRenderTarget(e)}_prepareHitTestTarget(e,...t){let i=this._context;this._hitTestRenderState&&i.bindRenderState(this._hitTestRenderState),i.bindRenderTarget(e)}_renderHitTestBuffer(...e){}},Ne=class extends Ve{constructor(e,t){super(e,t)}get target(){return this._target}get content(){return this._context.bindRenderTarget(this._target),this._target.readPixels()}get size(){return this._target.size}updateGrid(...e){return this.render(this._target,...e),this._texture}_render(e,t,i,r,s,o,n,a,l,d){for(let h of i)h.render(this._target,e,t,this._renderState,r,s,o,n,a,l,d)}setResolution(e,t){this._destroyResources(),this._depthBuffer=this._context.createRenderbuffer(e,t,34041),this._texture=this._context.createEmpty2DTexture(e,t,6408,5121),this._target=this._context.createFramebuffer({color:this._texture,depthStencil:this._depthBuffer})}destroy(){this._destroyResources()}_prepareRenderTarget(e,t,i,r,s,o,n,a,l,d,h,c){super._prepareRenderTarget(e,t,i,r,s,o,n,a,l,d,h,c),c&&this._context.clearCurrentTarget(16640)}_destroyResources(){this._target&&(this._target.destroy(),this._texture.destroy(),this._depthBuffer.destroy())}};function ke(e,t,i){return t<e?e<i?e:i:t}function He(e,t,i){let r=(e-t)/(i-t);return t+(i-t)*(r-Math.floor(r))}var je=Math.PI/180;function Ge(e){return e*je}var We,qe=class{constructor(){this._listeners=new Map,this._listenersBuffer=[]}addListener(e,t){this._listeners.has(e)&&console.warn("Event listener already exists"),this._listeners.set(e,t),this._syncListenersBuffer()}removeListener(e){this._listeners.delete(e),this._syncListenersBuffer()}fire(...e){for(let[t,i]of this._listenersBuffer)t.call(i,...e)}_syncListenersBuffer(){this._listenersBuffer=Array.from(this._listeners)}},Ye=((We=Ye||{})[We.NONE=0]="NONE",We[We.CLAMP_TO_EDGE=1]="CLAMP_TO_EDGE",We[We.REPEAT=2]="REPEAT",We),Xe={wrapModeX:1,wrapModeY:1,minZoom:0,maxZoom:24,fov:Ge(30),maxTilt:Ge(40),minTilt:Ge(0),noTiltMaxZoom:1},Ze=class e{constructor(t){this.options=f(f({},Xe),t),this.center=new e._Center(this),this.onUpdate=this._onUpdate=new qe;let i=new e._ScreenSize(this);this.screenSize=i,this._zoom=this.options.minZoom,this._fov=this.options.fov,this._tilt=this._azimuth=0,this._pixelSize=z(0,0),this._updateVersion=0,this._updateVersionLastFlushed=0}get aspectRatio(){let{width:e,height:t}=this.screenSize;return e/t}get zoom(){return this._zoom}set zoom(e){(e=ke(e,this.options.minZoom,this.options.maxZoom))!==this._zoom&&(this._zoom=e,this.tilt=this._tilt,this._updateVersion++)}get fov(){return this._fov}get tilt(){return this._tilt}set tilt(e){let{minTilt:t,maxTilt:i,noTiltMaxZoom:r}=this.options,s=function(e,t,i){let r=ke((i-e)/(t-e),0,1);return r*r*(3-2*r)}(r,r+Ke,this._zoom);e=ke(e,t*s,i*s),this._tilt!==e&&(this._tilt=e,this._updateVersion++)}get azimuth(){return this._azimuth}set azimuth(e){e=He(e,0,2*Math.PI),this._azimuth!==e&&(this._azimuth=e,this._updateVersion++)}get pixelSize(){return this._pixelSize}get updateVersion(){return this._updateVersion}flushUpdates(){this._updateVersionLastFlushed<this._updateVersion&&(this._onUpdate.fire(),this._updateVersionLastFlushed=this._updateVersion)}};Ze._Center=class{constructor(e){this._camera=e,this._x=this._y=0}get x(){return this._x}set x(e){e=Qe(this._camera.options.wrapModeX,e),this._x!==e&&(this._x=e,this._camera._updateVersion++)}get y(){return this._y}set y(e){e=Qe(this._camera.options.wrapModeY,e),this._y!==e&&(this._y=e,this._camera._updateVersion++)}},Ze._ScreenSize=class{constructor(e){this._camera=e,this._width=this._height=1}get width(){return this._width}set width(e){this._width!==e&&e>0&&(this._width=e,this._camera._pixelSize.x=2/this._width,this._camera._updateVersion++)}get height(){return this._height}set height(e){this._height!==e&&e>0&&(this._height=e,this._camera._pixelSize.y=2/this._height,this._camera._updateVersion++)}};var $e=Ze;function Qe(e,t){switch(e){case 0:return t;case 1:return ke(t,-1,1);case 2:return He(t,-1,1)}}var Ke=1,Je=class{constructor(e){this._mins=new Array(e),this._maxs=new Array(e),this._mins.fill(Number.POSITIVE_INFINITY),this._maxs.fill(Number.NEGATIVE_INFINITY)}updateValue(e,t){this._mins[e]=Math.min(this._mins[e],t),this._maxs[e]=Math.max(this._maxs[e],t)}*values(){let e={min:0,max:0,index:-1};for(let t=0;t<this._mins.length;t++)e.min=this._mins[t],e.max=this._maxs[t],e.index=t,yield e}};function et(e,t){return Number.isInteger(e)&&t===e?e-1:Math.floor(e)}function tt(e){let t,i;return function(r){return(t!==r||void 0===t)&&(t=r,i=e(r)),i}}function it(e){let t,i;return function(...r){let s=void 0===t;if(s||(s=t.length!==r.length),!s)for(let e=0;e<r.length;++e)if(t[e]!==r[e]){s=!0;break}return s&&(t=r,i=e(...r)),i}}var rt=19;function st(e){return Math.min(e.zoom,rt)}function ot(e){return e.zoom<=rt?e.fov:nt(at(e.zoom)*lt(e.fov))}var nt=tt((e=>2*Math.atan(e))),at=tt((e=>Math.pow(2,-(e-rt)))),lt=tt((e=>Math.tan(.5*e)));function dt(e,t,i){return e*ct(i)*ut(t)*ht}var ht=1/256,ct=tt((e=>Math.pow(2,-e))),ut=tt((e=>1/Math.tan(.5*e)));function _t(e,t,i,r){return $(pt(e,t,i),r),r}var pt=it(((e,t,i)=>{let r=J(Z,e,mt);return re(r,i,r),se(r,t,r),r})),mt=W(0,0,0);function ft(e,t,i){let r=t/2;return!i||e<=r?e:Math.max(e-gt,r)}var gt=Ge(20);function vt(e,t="key_"+Math.random().toFixed(10)){let i=Symbol(t);return function(t){let r=t[i];return r||(r={cameraUpdateVersion:t.updateVersion,data:e(t)},t[i]=r),r.cameraUpdateVersion<t.updateVersion&&(r.data=e(t,r.data),r.cameraUpdateVersion=t.updateVersion),r.data}}var yt=function(e){return null!=e};function xt(e){let t;this.name="DeveloperError",this.message=e;try{throw new Error}catch(e){t=e.stack}this.stack=t}yt(Object.create)&&(xt.prototype=Object.create(Error.prototype),xt.prototype.constructor=xt),xt.prototype.toString=function(){let e=`${this.name}: ${this.message}`;return yt(this.stack)&&(e+=`\n${this.stack.toString()}`),e},xt.throwInstantiationError=function(){throw new xt("This function defines an interface and should not be called directly.")};var bt=xt,Tt={};function Pt(e,t,i){return`Expected ${i} to be typeof ${t}, actual typeof was ${e}`}Tt.typeOf={},Tt.defined=function(e,t){if(!yt(t))throw new bt(function(e){return`${e} is required, actual value was undefined`}(e))},Tt.typeOf.func=function(e,t){if("function"!=typeof t)throw new bt(Pt(typeof t,"function",e))},Tt.typeOf.string=function(e,t){if("string"!=typeof t)throw new bt(Pt(typeof t,"string",e))},Tt.typeOf.number=function(e,t){if("number"!=typeof t)throw new bt(Pt(typeof t,"number",e))},Tt.typeOf.number.lessThan=function(e,t,i){if(Tt.typeOf.number(e,t),t>=i)throw new bt(`Expected ${e} to be less than ${i}, actual value was ${t}`)},Tt.typeOf.number.lessThanOrEquals=function(e,t,i){if(Tt.typeOf.number(e,t),t>i)throw new bt(`Expected ${e} to be less than or equal to ${i}, actual value was ${t}`)},Tt.typeOf.number.greaterThan=function(e,t,i){if(Tt.typeOf.number(e,t),t<=i)throw new bt(`Expected ${e} to be greater than ${i}, actual value was ${t}`)},Tt.typeOf.number.greaterThanOrEquals=function(e,t,i){if(Tt.typeOf.number(e,t),t<i)throw new bt(`Expected ${e} to be greater than or equal to ${i}, actual value was ${t}`)},Tt.typeOf.object=function(e,t){if("object"!=typeof t)throw new bt(Pt(typeof t,"object",e))},Tt.typeOf.bool=function(e,t){if("boolean"!=typeof t)throw new bt(Pt(typeof t,"boolean",e))},Tt.typeOf.bigint=function(e,t){if("bigint"!=typeof t)throw new bt(Pt(typeof t,"bigint",e))},Tt.typeOf.number.equals=function(e,t,i,r){if(Tt.typeOf.number(e,i),Tt.typeOf.number(t,r),i!==r)throw new bt(`${e} must be equal to ${t}, the actual values are ${i} and ${r}`)};var wt=Tt;function Mt(e,t){return null!=e?e:t}Mt.EMPTY_OBJECT=Object.freeze({});var Rt=Mt,St=((e,t,i)=>(i=null!=e?r(h(e)):{},y(!t&&e&&e.__esModule?i:s(i,"default",{value:e,enumerable:!0}),e)))(b(),1),Ct={EPSILON1:.1,EPSILON2:.01,EPSILON3:.001,EPSILON4:1e-4,EPSILON5:1e-5,EPSILON6:1e-6,EPSILON7:1e-7,EPSILON8:1e-8,EPSILON9:1e-9,EPSILON10:1e-10,EPSILON11:1e-11,EPSILON12:1e-12,EPSILON13:1e-13,EPSILON14:1e-14,EPSILON15:1e-15,EPSILON16:1e-16,EPSILON17:1e-17,EPSILON18:1e-18,EPSILON19:1e-19,EPSILON20:1e-20,EPSILON21:1e-21,GRAVITATIONALPARAMETER:3986004418e5,SOLAR_RADIUS:6955e5,LUNAR_RADIUS:1737400,SIXTY_FOUR_KILOBYTES:65536,FOUR_GIGABYTES:4294967296};Ct.sign=Rt(Math.sign,(function(e){return 0===(e=+e)||e!=e?e:e>0?1:-1})),Ct.signNotZero=function(e){return e<0?-1:1},Ct.toSNorm=function(e,t){return t=Rt(t,255),Math.round((.5*Ct.clamp(e,-1,1)+.5)*t)},Ct.fromSNorm=function(e,t){return t=Rt(t,255),Ct.clamp(e,0,t)/t*2-1},Ct.normalize=function(e,t,i){return 0===(i=Math.max(i-t,0))?0:Ct.clamp((e-t)/i,0,1)},Ct.sinh=Rt(Math.sinh,(function(e){return(Math.exp(e)-Math.exp(-e))/2})),Ct.cosh=Rt(Math.cosh,(function(e){return(Math.exp(e)+Math.exp(-e))/2})),Ct.lerp=function(e,t,i){return(1-i)*e+i*t},Ct.PI=Math.PI,Ct.ONE_OVER_PI=1/Math.PI,Ct.PI_OVER_TWO=Math.PI/2,Ct.PI_OVER_THREE=Math.PI/3,Ct.PI_OVER_FOUR=Math.PI/4,Ct.PI_OVER_SIX=Math.PI/6,Ct.THREE_PI_OVER_TWO=3*Math.PI/2,Ct.TWO_PI=2*Math.PI,Ct.ONE_OVER_TWO_PI=1/(2*Math.PI),Ct.RADIANS_PER_DEGREE=Math.PI/180,Ct.DEGREES_PER_RADIAN=180/Math.PI,Ct.RADIANS_PER_ARCSECOND=Ct.RADIANS_PER_DEGREE/3600,Ct.toRadians=function(e){if(!yt(e))throw new bt("degrees is required.");return e*Ct.RADIANS_PER_DEGREE},Ct.toDegrees=function(e){if(!yt(e))throw new bt("radians is required.");return e*Ct.DEGREES_PER_RADIAN},Ct.convertLongitudeRange=function(e){if(!yt(e))throw new bt("angle is required.");let t=Ct.TWO_PI,i=e-Math.floor(e/t)*t;return i<-Math.PI?i+t:i>=Math.PI?i-t:i},Ct.clampToLatitudeRange=function(e){if(!yt(e))throw new bt("angle is required.");return Ct.clamp(e,-1*Ct.PI_OVER_TWO,Ct.PI_OVER_TWO)},Ct.negativePiToPi=function(e){if(!yt(e))throw new bt("angle is required.");return e>=-Ct.PI&&e<=Ct.PI?e:Ct.zeroToTwoPi(e+Ct.PI)-Ct.PI},Ct.zeroToTwoPi=function(e){if(!yt(e))throw new bt("angle is required.");if(e>=0&&e<=Ct.TWO_PI)return e;let t=Ct.mod(e,Ct.TWO_PI);return Math.abs(t)<Ct.EPSILON14&&Math.abs(e)>Ct.EPSILON14?Ct.TWO_PI:t},Ct.mod=function(e,t){if(!yt(e))throw new bt("m is required.");if(!yt(t))throw new bt("n is required.");if(0===t)throw new bt("divisor cannot be 0.");return Ct.sign(e)===Ct.sign(t)&&Math.abs(e)<Math.abs(t)?e:(e%t+t)%t},Ct.equalsEpsilon=function(e,t,i,r){if(!yt(e))throw new bt("left is required.");if(!yt(t))throw new bt("right is required.");i=Rt(i,0),r=Rt(r,i);let s=Math.abs(e-t);return s<=r||s<=i*Math.max(Math.abs(e),Math.abs(t))},Ct.lessThan=function(e,t,i){if(!yt(e))throw new bt("first is required.");if(!yt(t))throw new bt("second is required.");if(!yt(i))throw new bt("absoluteEpsilon is required.");return e-t<-i},Ct.lessThanOrEquals=function(e,t,i){if(!yt(e))throw new bt("first is required.");if(!yt(t))throw new bt("second is required.");if(!yt(i))throw new bt("absoluteEpsilon is required.");return e-t<i},Ct.greaterThan=function(e,t,i){if(!yt(e))throw new bt("first is required.");if(!yt(t))throw new bt("second is required.");if(!yt(i))throw new bt("absoluteEpsilon is required.");return e-t>i},Ct.greaterThanOrEquals=function(e,t,i){if(!yt(e))throw new bt("first is required.");if(!yt(t))throw new bt("second is required.");if(!yt(i))throw new bt("absoluteEpsilon is required.");return e-t>-i};var It=[1];Ct.factorial=function(e){if("number"!=typeof e||e<0)throw new bt("A number greater than or equal to 0 is required.");let t=It.length;if(e>=t){let i=It[t-1];for(let r=t;r<=e;r++){let e=i*r;It.push(e),i=e}}return It[e]},Ct.incrementWrap=function(e,t,i){if(i=Rt(i,0),!yt(e))throw new bt("n is required.");if(t<=i)throw new bt("maximumValue must be greater than minimumValue.");return++e>t&&(e=i),e},Ct.isPowerOfTwo=function(e){if("number"!=typeof e||e<0||e>4294967295)throw new bt("A number between 0 and (2^32)-1 is required.");return 0!==e&&0==(e&e-1)},Ct.nextPowerOfTwo=function(e){if("number"!=typeof e||e<0||e>2147483648)throw new bt("A number between 0 and 2^31 is required.");return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},Ct.previousPowerOfTwo=function(e){if("number"!=typeof e||e<0||e>4294967295)throw new bt("A number between 0 and (2^32)-1 is required.");return e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e=((e|=e>>32)>>>0)-(e>>>1)},Ct.clamp=function(e,t,i){return wt.typeOf.number("value",e),wt.typeOf.number("min",t),wt.typeOf.number("max",i),e<t?t:e>i?i:e};var Et=new St.default;Ct.setRandomNumberSeed=function(e){if(!yt(e))throw new bt("seed is required.");Et=new St.default(e)},Ct.nextRandomNumber=function(){return Et.random()},Ct.randomBetween=function(e,t){return Ct.nextRandomNumber()*(t-e)+e},Ct.acosClamped=function(e){if(!yt(e))throw new bt("value is required.");return Math.acos(Ct.clamp(e,-1,1))},Ct.asinClamped=function(e){if(!yt(e))throw new bt("value is required.");return Math.asin(Ct.clamp(e,-1,1))},Ct.chordLength=function(e,t){if(!yt(e))throw new bt("angle is required.");if(!yt(t))throw new bt("radius is required.");return 2*t*Math.sin(.5*e)},Ct.logBase=function(e,t){if(!yt(e))throw new bt("number is required.");if(!yt(t))throw new bt("base is required.");return Math.log(e)/Math.log(t)},Ct.cbrt=Rt(Math.cbrt,(function(e){let t=Math.pow(Math.abs(e),.3333333333333333);return e<0?-t:t})),Ct.log2=Rt(Math.log2,(function(e){return Math.log(e)*Math.LOG2E})),Ct.fog=function(e,t){let i=e*t;return 1-Math.exp(-i*i)},Ct.fastApproximateAtan=function(e){return wt.typeOf.number("x",e),e*(-.1784*Math.abs(e)-.0663*e*e+1.0301)},Ct.fastApproximateAtan2=function(e,t){wt.typeOf.number("x",e),wt.typeOf.number("y",t);let i,r=Math.abs(e);i=Math.abs(t);let s=Math.max(r,i);i=Math.min(r,i);let o=i/s;if(isNaN(o))throw new bt("either x or y must be nonzero");return r=Ct.fastApproximateAtan(o),r=Math.abs(t)>Math.abs(e)?Ct.PI_OVER_TWO-r:r,r=e<0?Ct.PI-r:r,r=t<0?-r:r,r};var At=Ct;function Lt(e,t,i){this.x=Rt(e,0),this.y=Rt(t,0),this.z=Rt(i,0)}Lt.fromSpherical=function(e,t){wt.typeOf.object("spherical",e),yt(t)||(t=new Lt);let i=e.clock,r=e.cone,s=Rt(e.magnitude,1),o=s*Math.sin(r);return t.x=o*Math.cos(i),t.y=o*Math.sin(i),t.z=s*Math.cos(r),t},Lt.fromElements=function(e,t,i,r){return yt(r)?(r.x=e,r.y=t,r.z=i,r):new Lt(e,t,i)},Lt.clone=function(e,t){if(yt(e))return yt(t)?(t.x=e.x,t.y=e.y,t.z=e.z,t):new Lt(e.x,e.y,e.z)},Lt.fromCartesian4=Lt.clone,Lt.packedLength=3,Lt.pack=function(e,t,i){return wt.typeOf.object("value",e),wt.defined("array",t),i=Rt(i,0),t[i++]=e.x,t[i++]=e.y,t[i]=e.z,t},Lt.unpack=function(e,t,i){return wt.defined("array",e),t=Rt(t,0),yt(i)||(i=new Lt),i.x=e[t++],i.y=e[t++],i.z=e[t],i},Lt.packArray=function(e,t){wt.defined("array",e);let i=e.length,r=3*i;if(yt(t)){if(!Array.isArray(t)&&t.length!==r)throw new bt("If result is a typed array, it must have exactly array.length * 3 elements");t.length!==r&&(t.length=r)}else t=new Array(r);for(let r=0;r<i;++r)Lt.pack(e[r],t,3*r);return t},Lt.unpackArray=function(e,t){if(wt.defined("array",e),wt.typeOf.number.greaterThanOrEquals("array.length",e.length,3),e.length%3!=0)throw new bt("array length must be a multiple of 3.");let i=e.length;yt(t)?t.length=i/3:t=new Array(i/3);for(let r=0;r<i;r+=3){let i=r/3;t[i]=Lt.unpack(e,r,t[i])}return t},Lt.fromArray=Lt.unpack,Lt.maximumComponent=function(e){return wt.typeOf.object("cartesian",e),Math.max(e.x,e.y,e.z)},Lt.minimumComponent=function(e){return wt.typeOf.object("cartesian",e),Math.min(e.x,e.y,e.z)},Lt.minimumByComponent=function(e,t,i){return wt.typeOf.object("first",e),wt.typeOf.object("second",t),wt.typeOf.object("result",i),i.x=Math.min(e.x,t.x),i.y=Math.min(e.y,t.y),i.z=Math.min(e.z,t.z),i},Lt.maximumByComponent=function(e,t,i){return wt.typeOf.object("first",e),wt.typeOf.object("second",t),wt.typeOf.object("result",i),i.x=Math.max(e.x,t.x),i.y=Math.max(e.y,t.y),i.z=Math.max(e.z,t.z),i},Lt.clamp=function(e,t,i,r){wt.typeOf.object("value",e),wt.typeOf.object("min",t),wt.typeOf.object("max",i),wt.typeOf.object("result",r);let s=At.clamp(e.x,t.x,i.x),o=At.clamp(e.y,t.y,i.y),n=At.clamp(e.z,t.z,i.z);return r.x=s,r.y=o,r.z=n,r},Lt.magnitudeSquared=function(e){return wt.typeOf.object("cartesian",e),e.x*e.x+e.y*e.y+e.z*e.z},Lt.magnitude=function(e){return Math.sqrt(Lt.magnitudeSquared(e))};var Ut=new Lt;Lt.distance=function(e,t){return wt.typeOf.object("left",e),wt.typeOf.object("right",t),Lt.subtract(e,t,Ut),Lt.magnitude(Ut)},Lt.distanceSquared=function(e,t){return wt.typeOf.object("left",e),wt.typeOf.object("right",t),Lt.subtract(e,t,Ut),Lt.magnitudeSquared(Ut)},Lt.normalize=function(e,t){wt.typeOf.object("cartesian",e),wt.typeOf.object("result",t);let i=Lt.magnitude(e);if(t.x=e.x/i,t.y=e.y/i,t.z=e.z/i,isNaN(t.x)||isNaN(t.y)||isNaN(t.z))throw new bt("normalized result is not a number");return t},Lt.dot=function(e,t){return wt.typeOf.object("left",e),wt.typeOf.object("right",t),e.x*t.x+e.y*t.y+e.z*t.z},Lt.multiplyComponents=function(e,t,i){return wt.typeOf.object("left",e),wt.typeOf.object("right",t),wt.typeOf.object("result",i),i.x=e.x*t.x,i.y=e.y*t.y,i.z=e.z*t.z,i},Lt.divideComponents=function(e,t,i){return wt.typeOf.object("left",e),wt.typeOf.object("right",t),wt.typeOf.object("result",i),i.x=e.x/t.x,i.y=e.y/t.y,i.z=e.z/t.z,i},Lt.add=function(e,t,i){return wt.typeOf.object("left",e),wt.typeOf.object("right",t),wt.typeOf.object("result",i),i.x=e.x+t.x,i.y=e.y+t.y,i.z=e.z+t.z,i},Lt.subtract=function(e,t,i){return wt.typeOf.object("left",e),wt.typeOf.object("right",t),wt.typeOf.object("result",i),i.x=e.x-t.x,i.y=e.y-t.y,i.z=e.z-t.z,i},Lt.multiplyByScalar=function(e,t,i){return wt.typeOf.object("cartesian",e),wt.typeOf.number("scalar",t),wt.typeOf.object("result",i),i.x=e.x*t,i.y=e.y*t,i.z=e.z*t,i},Lt.divideByScalar=function(e,t,i){return wt.typeOf.object("cartesian",e),wt.typeOf.number("scalar",t),wt.typeOf.object("result",i),i.x=e.x/t,i.y=e.y/t,i.z=e.z/t,i},Lt.negate=function(e,t){return wt.typeOf.object("cartesian",e),wt.typeOf.object("result",t),t.x=-e.x,t.y=-e.y,t.z=-e.z,t},Lt.abs=function(e,t){return wt.typeOf.object("cartesian",e),wt.typeOf.object("result",t),t.x=Math.abs(e.x),t.y=Math.abs(e.y),t.z=Math.abs(e.z),t};var Ot=new Lt;Lt.lerp=function(e,t,i,r){return wt.typeOf.object("start",e),wt.typeOf.object("end",t),wt.typeOf.number("t",i),wt.typeOf.object("result",r),Lt.multiplyByScalar(t,i,Ot),r=Lt.multiplyByScalar(e,1-i,r),Lt.add(Ot,r,r)};var Dt=new Lt,zt=new Lt;Lt.angleBetween=function(e,t){wt.typeOf.object("left",e),wt.typeOf.object("right",t),Lt.normalize(e,Dt),Lt.normalize(t,zt);let i=Lt.dot(Dt,zt),r=Lt.magnitude(Lt.cross(Dt,zt,Dt));return Math.atan2(r,i)};var Bt=new Lt;Lt.mostOrthogonalAxis=function(e,t){wt.typeOf.object("cartesian",e),wt.typeOf.object("result",t);let i=Lt.normalize(e,Bt);return Lt.abs(i,i),t=i.x<=i.y?i.x<=i.z?Lt.clone(Lt.UNIT_X,t):Lt.clone(Lt.UNIT_Z,t):i.y<=i.z?Lt.clone(Lt.UNIT_Y,t):Lt.clone(Lt.UNIT_Z,t)},Lt.projectVector=function(e,t,i){wt.defined("a",e),wt.defined("b",t),wt.defined("result",i);let r=Lt.dot(e,t)/Lt.dot(t,t);return Lt.multiplyByScalar(t,r,i)},Lt.equals=function(e,t){return e===t||yt(e)&&yt(t)&&e.x===t.x&&e.y===t.y&&e.z===t.z},Lt.equalsArray=function(e,t,i){return e.x===t[i]&&e.y===t[i+1]&&e.z===t[i+2]},Lt.equalsEpsilon=function(e,t,i,r){return e===t||yt(e)&&yt(t)&&At.equalsEpsilon(e.x,t.x,i,r)&&At.equalsEpsilon(e.y,t.y,i,r)&&At.equalsEpsilon(e.z,t.z,i,r)},Lt.cross=function(e,t,i){wt.typeOf.object("left",e),wt.typeOf.object("right",t),wt.typeOf.object("result",i);let r=e.x,s=e.y,o=e.z,n=t.x,a=t.y,l=t.z,d=s*l-o*a,h=o*n-r*l,c=r*a-s*n;return i.x=d,i.y=h,i.z=c,i},Lt.midpoint=function(e,t,i){return wt.typeOf.object("left",e),wt.typeOf.object("right",t),wt.typeOf.object("result",i),i.x=.5*(e.x+t.x),i.y=.5*(e.y+t.y),i.z=.5*(e.z+t.z),i},Lt.fromDegrees=function(e,t,i,r,s){return wt.typeOf.number("longitude",e),wt.typeOf.number("latitude",t),e=At.toRadians(e),t=At.toRadians(t),Lt.fromRadians(e,t,i,r,s)};var Ft=new Lt,Vt=new Lt,Nt=new Lt(40680631590769,40680631590769,40408299984661.445);Lt.fromRadians=function(e,t,i,r,s){wt.typeOf.number("longitude",e),wt.typeOf.number("latitude",t),i=Rt(i,0);let o=yt(r)?r.radiiSquared:Nt,n=Math.cos(t);Ft.x=n*Math.cos(e),Ft.y=n*Math.sin(e),Ft.z=Math.sin(t),Ft=Lt.normalize(Ft,Ft),Lt.multiplyComponents(o,Ft,Vt);let a=Math.sqrt(Lt.dot(Ft,Vt));return Vt=Lt.divideByScalar(Vt,a,Vt),Ft=Lt.multiplyByScalar(Ft,i,Ft),yt(s)||(s=new Lt),Lt.add(Vt,Ft,s)},Lt.fromDegreesArray=function(e,t,i){if(wt.defined("coordinates",e),e.length<2||e.length%2!=0)throw new bt("the number of coordinates must be a multiple of 2 and at least 2");let r=e.length;yt(i)?i.length=r/2:i=new Array(r/2);for(let s=0;s<r;s+=2){let r=e[s],o=e[s+1],n=s/2;i[n]=Lt.fromDegrees(r,o,0,t,i[n])}return i},Lt.fromRadiansArray=function(e,t,i){if(wt.defined("coordinates",e),e.length<2||e.length%2!=0)throw new bt("the number of coordinates must be a multiple of 2 and at least 2");let r=e.length;yt(i)?i.length=r/2:i=new Array(r/2);for(let s=0;s<r;s+=2){let r=e[s],o=e[s+1],n=s/2;i[n]=Lt.fromRadians(r,o,0,t,i[n])}return i},Lt.fromDegreesArrayHeights=function(e,t,i){if(wt.defined("coordinates",e),e.length<3||e.length%3!=0)throw new bt("the number of coordinates must be a multiple of 3 and at least 3");let r=e.length;yt(i)?i.length=r/3:i=new Array(r/3);for(let s=0;s<r;s+=3){let r=e[s],o=e[s+1],n=e[s+2],a=s/3;i[a]=Lt.fromDegrees(r,o,n,t,i[a])}return i},Lt.fromRadiansArrayHeights=function(e,t,i){if(wt.defined("coordinates",e),e.length<3||e.length%3!=0)throw new bt("the number of coordinates must be a multiple of 3 and at least 3");let r=e.length;yt(i)?i.length=r/3:i=new Array(r/3);for(let s=0;s<r;s+=3){let r=e[s],o=e[s+1],n=e[s+2],a=s/3;i[a]=Lt.fromRadians(r,o,n,t,i[a])}return i},Lt.ZERO=Object.freeze(new Lt(0,0,0)),Lt.ONE=Object.freeze(new Lt(1,1,1)),Lt.UNIT_X=Object.freeze(new Lt(1,0,0)),Lt.UNIT_Y=Object.freeze(new Lt(0,1,0)),Lt.UNIT_Z=Object.freeze(new Lt(0,0,1)),Lt.prototype.clone=function(e){return Lt.clone(this,e)},Lt.prototype.equals=function(e){return Lt.equals(this,e)},Lt.prototype.equalsEpsilon=function(e,t,i){return Lt.equalsEpsilon(this,e,t,i)},Lt.prototype.toString=function(){return`(${this.x}, ${this.y}, ${this.z})`};var kt=Lt,Ht=new kt,jt=new kt;var Gt=function(e,t,i,r,s){if(!yt(e))throw new bt("cartesian is required.");if(!yt(t))throw new bt("oneOverRadii is required.");if(!yt(i))throw new bt("oneOverRadiiSquared is required.");if(!yt(r))throw new bt("centerToleranceSquared is required.");let o=e.x,n=e.y,a=e.z,l=t.x,d=t.y,h=t.z,c=o*o*l*l,u=n*n*d*d,_=a*a*h*h,p=c+u+_,m=Math.sqrt(1/p),f=kt.multiplyByScalar(e,m,Ht);if(p<r)return isFinite(m)?kt.clone(f,s):void 0;let g=i.x,v=i.y,y=i.z,x=jt;x.x=f.x*g*2,x.y=f.y*v*2,x.z=f.z*y*2;let b,T,P,w,M,R,S,C,I,E,A,L=(1-m)*kt.magnitude(e)/(.5*kt.magnitude(x)),U=0;do{L-=U,P=1/(1+L*g),w=1/(1+L*v),M=1/(1+L*y),R=P*P,S=w*w,C=M*M,I=R*P,E=S*w,A=C*M,b=c*R+u*S+_*C-1,T=c*I*g+u*E*v+_*A*y,U=b/(-2*T)}while(Math.abs(b)>At.EPSILON12);return yt(s)?(s.x=o*P,s.y=n*w,s.z=a*M,s):new kt(o*P,n*w,a*M)};function Wt(e,t,i){this.longitude=Rt(e,0),this.latitude=Rt(t,0),this.height=Rt(i,0)}Wt.fromRadians=function(e,t,i,r){return wt.typeOf.number("longitude",e),wt.typeOf.number("latitude",t),i=Rt(i,0),yt(r)?(r.longitude=e,r.latitude=t,r.height=i,r):new Wt(e,t,i)},Wt.fromDegrees=function(e,t,i,r){return wt.typeOf.number("longitude",e),wt.typeOf.number("latitude",t),e=At.toRadians(e),t=At.toRadians(t),Wt.fromRadians(e,t,i,r)};var qt=new kt,Yt=new kt,Xt=new kt,Zt=new kt(1/6378137,1/6378137,1/6356752.314245179),$t=new kt(1/40680631590769,1/40680631590769,1/40408299984661.445),Qt=At.EPSILON1;Wt.fromCartesian=function(e,t,i){let r=yt(t)?t.oneOverRadii:Zt,s=yt(t)?t.oneOverRadiiSquared:$t,o=yt(t)?t._centerToleranceSquared:Qt,n=Gt(e,r,s,o,Yt);if(!yt(n))return;let a=kt.multiplyComponents(n,s,qt);a=kt.normalize(a,a);let l=kt.subtract(e,n,Xt),d=Math.atan2(a.y,a.x),h=Math.asin(a.z),c=At.sign(kt.dot(l,e))*kt.magnitude(l);return yt(i)?(i.longitude=d,i.latitude=h,i.height=c,i):new Wt(d,h,c)},Wt.toCartesian=function(e,t,i){return wt.defined("cartographic",e),kt.fromRadians(e.longitude,e.latitude,e.height,t,i)},Wt.clone=function(e,t){if(yt(e))return yt(t)?(t.longitude=e.longitude,t.latitude=e.latitude,t.height=e.height,t):new Wt(e.longitude,e.latitude,e.height)},Wt.equals=function(e,t){return e===t||yt(e)&&yt(t)&&e.longitude===t.longitude&&e.latitude===t.latitude&&e.height===t.height},Wt.equalsEpsilon=function(e,t,i){return i=Rt(i,0),e===t||yt(e)&&yt(t)&&Math.abs(e.longitude-t.longitude)<=i&&Math.abs(e.latitude-t.latitude)<=i&&Math.abs(e.height-t.height)<=i},Wt.ZERO=Object.freeze(new Wt(0,0,0)),Wt.prototype.clone=function(e){return Wt.clone(this,e)},Wt.prototype.equals=function(e){return Wt.equals(this,e)},Wt.prototype.equalsEpsilon=function(e,t){return Wt.equalsEpsilon(this,e,t)},Wt.prototype.toString=function(){return`(${this.longitude}, ${this.latitude}, ${this.height})`};var Kt=Wt,Jt=6378137,ei=Math.PI*Jt,ti=.0818191908426;function ii({lon:e,lat:t,alt:i},r=W(0,0,0)){return r.x=(ei+function(e){let t=He(Ge(e),-Math.PI,Math.PI);return Jt*t}(e))/ei-1,r.y=ke(1-(ei-function(e){let t=Ge(ke(e,-89.9999999999,89.9999999999)),i=ti*Math.sin(t),r=Math.tan(.25*Math.PI+.5*t),s=Math.pow(Math.tan(.25*Math.PI+.5*Math.asin(i)),ti),o=r/s;return Jt*Math.log(o)}(t))/ei,-1,1),r.z=function(e,t){return e/Math.cos(Ge(t))}(i,t)/ei,r}function ri(e,t={lon:0,lat:0,alt:0}){let i=Kt.fromCartesian(e,void 0,si);return t.lon=i.longitude,t.lat=i.latitude,t.alt=i.height,t}var si=new Kt,oi=vt(((e,t=ce(le))=>{let{fov:i,azimuth:r,tilt:s,aspectRatio:o,screenSize:n}=e,a=ot(e),l=st(e),d=dt(n.height,i,l),h=_t(d,r,s,li);ce(le,t),pe(t,h,Y,se(X,r),t);let c=ui(d,s,a);return function(e,t,i,r,s,o=he()){let n=1/Math.tan(.5*t),a=n/i,l=(r+s)/(r-s),d=2*r*s/(r-s);for(let t=0;t<de;t+=4){o[t]=e[t]*a,o[t+1]=e[t+1]*n;let i=e[t+2],r=e[t+3];o[t+2]=i*l+r*d,o[t+3]=-i}}(t,a,o,c.zNear,c.zFar,t),t})),ni=10/ei,ai=Ge(85),li=W(0,0,0);function di(e,t,i){return Math.min(.01*e,e/(1+ci(t,i)))}function hi(e,t,i){return e/(1-ci(Math.min(t,ai-.5*i),i))+ni}function ci(e,t){return Math.tan(Math.abs(e))*Math.tan(.5*t)}function ui(e,t,i){return{zNear:di(e,t,i),zFar:hi(e,t,i)}}var _i=vt(((e,t={origin:W(0,0,0),planes:[{normal:W(0,0,0),distance:0},{normal:W(0,0,0),distance:0},{normal:W(0,0,0),distance:0},{normal:W(0,0,0),distance:0}],farPlane:{normal:W(0,0,0),distance:0},nearPlane:{normal:W(0,0,0),distance:0},edges:[W(0,0,0),W(0,0,0),W(0,0,0),W(0,0,0)]})=>{let{origin:i,planes:r,farPlane:s,nearPlane:o,edges:n}=t,{screenSize:a,fov:l,azimuth:d,tilt:h,aspectRatio:c}=e,u=ot(e),_=st(e),p=dt(a.height,l,_),m=_t(p,d,h,vi);q(e.center.x,e.center.y,0,i),Q(i,m,i);let f=gi(u),g=W(f*c,f,1);for(let e=0;e<4;++e){let t=n[e];K(fi[e],g,t),re(t,ft(h,l,-1===fi[e].y),t),se(t,d,t)}mi(n[0],n[3],i,r[0]),mi(n[1],n[0],i,r[1]),mi(n[2],n[1],i,r[2]),mi(n[3],n[2],i,r[3]);let v=ui(p,h,u),y=ee(m,yi),x=J(y,-1,xi);return pi(x,x,v.zFar,i,s),pi(y,x,v.zNear,i,o),t}));function pi(e,t,i,r,s){$(e,s.normal);let o=J(t,i,bi);s.distance=te(s.normal,Q(o,r,bi))}function mi(e,t,i,r){ie(e,t,r.normal),ee(r.normal,r.normal),r.distance=-te(r.normal,i)}var fi=[W(-1,1,-1),W(1,1,-1),W(1,-1,-1),W(-1,-1,-1)],gi=tt((e=>Math.tan(.5*e))),vi=W(0,0,0),yi=W(0,0,0),xi=W(0,0,0),bi=W(0,0,0),Ti=vt(((e,t=[W(0,0,0),W(0,0,0),W(0,0,0),W(0,0,0)])=>{let i=_i(e),r=function(e,t){for(let i=0;i<e.edges.length;++i)t[i].origin=e.origin,t[i].direction=e.edges[i];return t}(i,Si);for(let[e,s]of Ri){let o=Pi(Mi(i,r[e],r[s],Ci));t[e]=o[0],t[s]=o[1]}return t}));function Pi(e){let t=[],i=e.length;for(let r=0;r<i;++r){let s=e[r],o=e[(r+1)%i];if(D(o.z,0,Number.EPSILON))continue;let n=oe(0,s,o);n&&t.push(n)}if(2===t.length)return t;throw new Error(`Intersection with polyline ${JSON.stringify(e)} has ${t.length} points`)}function wi(e){if(null==e)throw new Error("Called unwrap on an absent value");return e}function Mi(e,t,i,r){return wi(ne(e.farPlane,t,r[0])),wi(ne(e.nearPlane,t,r[1])),wi(ne(e.nearPlane,i,r[2])),wi(ne(e.farPlane,i,r[3])),r}var Ri=[[1,2],[0,3]],Si=[{origin:Y,direction:Y},{origin:Y,direction:Y},{origin:Y,direction:Y},{origin:Y,direction:Y}],Ci=[W(0,0,0),W(0,0,0),W(0,0,0),W(0,0,0)],Ii=z(-1,-1),Ei=e=>{let t=F(e);return function(e,t,i=z(0,0)){i.x=e.x-t.x,i.y=e.y-t.y}(t,Ii,t),N(t,.5,t),t},Ai=e=>.25*(e+2)*4294967295,Li=e=>Math.trunc(e/65536),Ui=e=>65535&e,Oi=(e,t)=>e.x-t.x||e.y-t.y,Di=z(0,0),zi=[],Bi=[];function Fi(e){let t=Ti(e);if(0===function(e,t,i){let r=Math.min(t.length,i.length);for(let s=0;s<r;s++){let r=e(t[s],i[s]);if(r)return r}return t.length-i.length}(Oi,zi,t))return Bi;let i=[];for(let r of function(e){let t=[],i=G(e),r=Math.floor(i.minX),s=Math.ceil(i.maxX)-r,o=new Je(s);for(let t=e.length-1,s=0;s<e.length;t=s++){let n=e[t],a=e[s];if(n.x>a.x){let e=n;n=a,a=e}let l=Math.floor(n.x+1),d=Math.ceil(a.x-1),h=(n.y-a.y)/(n.x-a.x);o.updateValue(et(n.x,i.maxX)-r,et(n.y,i.maxY)),o.updateValue(et(a.x,i.maxX)-r,et(a.y,i.maxY));for(let e=l;e<=d;e++){let t=(isFinite(h)?h*(e-n.x):0)+n.y,s=e-r,a=s-1,l=Math.floor(t);Number.isInteger(t)?t===i.maxY?(o.updateValue(a,l-1),o.updateValue(s,l-1)):h>0?(o.updateValue(a,l-1),o.updateValue(s,l)):h<0&&(o.updateValue(a,l),o.updateValue(s,l-1)):(o.updateValue(a,l),o.updateValue(s,l))}}for(let{min:e,max:i,index:s}of o.values()){let o=r+s;for(let r=e;r<=i;r++)t.push(z(o,r))}return t}(t.map(Ei)))if(!(2!==e.options.wrapModeX&&0!==r.x||2!==e.options.wrapModeY&&0!==r.y)){N(r,-2,Di),V(e.center,Di,Di);let t=F(Di);k(Di,Ai,Di),i.push({lookAt:t,lookAtHigh:k(Di,Li),lookAtLow:k(Di,Ui)})}Se(i,Bi),Bi.length=i.length,zi.length=t.length;for(let e=0;e<t.length;e++)zi[e]=F(t[e],zi[e]);return i}function Vi(){return devicePixelRatio>1?devicePixelRatio:1}function Ni(e=0,t=0){return{width:e,height:t}}function ki(e,t=Ni()){return t.width=e.width,t.height=e.height,t}function Hi(e,t){return e.width===t.width&&e.height===t.height}var ji=Date.now();var Gi="performance"in self&&"now"in performance?()=>performance.now():function(){return Date.now()-ji},Wi="varying lowp vec4 id;void main(void){gl_FragColor=id;}",qi=new O({depthTest:!0,clearDepth:0,depthFunc:516,dither:!1}),Yi=class extends Ve{constructor(e){let t=e.createProgram("#version 100\nattribute vec2 position;uniform sampler2D directPriorityGrid;uniform sampler2D reversePriorityGrid;uniform vec2 idHalfPxSize;varying lowp vec4 id;const vec2 NO_ID=vec2(0,0);const vec4 DISCARD_POSITION=vec4(2,2,2,1);const float ID_RENORMALIZATION=255.0/256.0;const float MIN_OVERLAPPING_PRIMITVES_ALPHA=0.01;const float JUST_VISIBLE_PRIMITIVE_Z_POSITION=0.25;const float OVERLAPPING_PRIMITIVE_Z_POSITION=0.5;void main(){vec4 primitiveIdReversePriority=texture2D(reversePriorityGrid,position);if(primitiveIdReversePriority.rg!=NO_ID){vec4 primitiveIdPriority=texture2D(directPriorityGrid,position);vec2 idTexCoordinates=primitiveIdReversePriority.rg*ID_RENORMALIZATION+idHalfPxSize;bool isOverlap=primitiveIdReversePriority!=primitiveIdPriority;gl_Position=vec4(idTexCoordinates*2.0-1.0,JUST_VISIBLE_PRIMITIVE_Z_POSITION,1);id=vec4(NO_ID,0,0);if(isOverlap&&primitiveIdPriority.a>=MIN_OVERLAPPING_PRIMITVES_ALPHA){gl_Position.z=OVERLAPPING_PRIMITIVE_Z_POSITION;id=vec4(primitiveIdPriority.rg,0,1);}gl_PointSize=1.0;}else{gl_Position=DISCARD_POSITION;}}",Wi,{attribMap:{position:0}});super(e,qi,t),e.bindProgram(t),t.setIntScalarUniform("directPriorityGrid",0),t.setIntScalarUniform("reversePriorityGrid",1)}_prepareProgram(e,t,i,r,s,o,n){super._prepareProgram(e,t,i,r,s,o,n),this._context.bindTextureUnit(0),this._context.bindTexture(r),this._context.bindTextureUnit(1),this._context.bindTexture(s),e.setVector2Uniform("idHalfPxSize",o)}_render(e,t){this._context.bindVao(e),this._context.drawMesh(0,t,0)}_prepareRenderTarget(e,t,i,r,s,o,n){super._prepareRenderTarget(e,t,i,r,s,o,n),n&&this._context.clearCurrentTarget(256)}},Xi=Te([[0,{size:4,type:5120,normalized:!1}]]),Zi=class extends ze{constructor(){super(Xi.vertexByteSize,4,4,6),this._writeBytes(-1,-1,0,0),this._writeBytes(-1,1,0,1),this._writeBytes(1,1,1,1),this._writeBytes(1,-1,1,0),this.writeIndicesForFan([0,1,2,3]),this.vertexData=this.getBuffers()[0].vertexBuffer,this.indexData=this.getBuffers()[0].indexBuffer}},$i=new O({dither:!1}),Qi=class extends Ve{constructor(e){let t=e.createProgram("#version 100\nattribute vec4 position;varying vec2 idTexCoordinates;void main(){gl_Position=vec4(position.xy,0,1);idTexCoordinates=position.zw;}","#version 100\nprecision mediump float;uniform sampler2D prevVisibility;uniform sampler2D overlaps;uniform sampler2D scene;uniform sampler2D friendIds;uniform float fadeAnimationAmount;uniform float currentZoom;uniform float currentTilt;uniform float currentAzimuth;varying vec2 idTexCoordinates;const vec2 NO_ID=vec2(0,0);const float LOWP_EPSILON=1.0/256.0;void main(){vec4 prevVisibilityValue=texture2D(prevVisibility,idTexCoordinates);vec4 overlapsValue=texture2D(overlaps,idTexCoordinates);vec4 sceneValue=texture2D(scene,idTexCoordinates);vec4 friendIdsValue=texture2D(friendIds,idTexCoordinates);bool isInScene=sceneValue.a>=LOWP_EPSILON;if(isInScene){gl_FragColor=prevVisibilityValue;bool isOverlapped=overlapsValue.a>=LOWP_EPSILON;bool isFriend=friendIdsValue.rg!=NO_ID&&friendIdsValue.rg==overlapsValue.rg;if(isOverlapped&&!isFriend){if(gl_FragColor.b<LOWP_EPSILON){gl_FragColor.b=currentZoom;gl_FragColor.r=currentTilt;gl_FragColor.g=currentAzimuth;}gl_FragColor.a=clamp(gl_FragColor.a-fadeAnimationAmount,0.0,1.0);}else{gl_FragColor.a=clamp(gl_FragColor.a+fadeAnimationAmount,0.0,1.0);gl_FragColor.rgb=vec3(0,0,0);}}else{gl_FragColor=vec4(0,0,0,0);}}",{attribMap:{position:0}});super(e,$i,t);let i=new Zi;this._idSamplerVertexBuffer=this._context.createVertexBuffer(i.vertexData.byteLength),this._idSamplerIndexBuffer=this._context.createIndexBuffer(i.indexData.byteLength),this._idSamplerVao=this._context.createVao([{attributeMapping:Xi,buffer:this._idSamplerVertexBuffer}],this._idSamplerIndexBuffer),this._context.uploadDataToBuffer(this._idSamplerVertexBuffer,i.vertexData),this._context.uploadDataToBuffer(this._idSamplerIndexBuffer,i.indexData),e.bindProgram(t),t.setIntScalarUniform("prevVisibility",0),t.setIntScalarUniform("overlaps",1),t.setIntScalarUniform("scene",2),t.setIntScalarUniform("friendIds",3)}destroy(){this._idSamplerVertexBuffer.destroy(),this._idSamplerIndexBuffer.destroy(),this._idSamplerVao.destroy(),super.destroy()}_prepareProgram(e,t,i,r,s,o,n,a,l){super._prepareProgram(e,t,i,r,s,o,n,a,l),this._context.bindTextureUnit(0),this._context.bindTexture(t),this._context.bindTextureUnit(1),this._context.bindTexture(i),this._context.bindTextureUnit(2),this._context.bindTexture(r),this._context.bindTextureUnit(3),this._context.bindTexture(s),e.setScalarUniform("fadeAnimationAmount",o),e.setScalarUniform("currentZoom",n),e.setScalarUniform("currentTilt",a),e.setScalarUniform("currentAzimuth",l)}_render(){this._context.bindVao(this._idSamplerVao),this._context.drawIndexedMesh(0,6,4,5123)}},Ki=new O({blend:!0,blendFuncSrcRgb:0,blendFuncDstRgb:1,blendFuncSrcAlpha:1,blendFuncDstAlpha:0,dither:!1}),Ji=class extends Ve{constructor(e){let t=e.createProgram("#version 100\nattribute vec4 position;void main(){gl_Position=vec4(position.xy,0,1);}","#version 100\nvoid main(){gl_FragColor=vec4(0,0,0,1);}",{attribMap:{position:0}});super(e,Ki,t);let i=new Zi;this._idSamplerVertexBuffer=this._context.createVertexBuffer(i.vertexData.byteLength),this._idSamplerIndexBuffer=this._context.createIndexBuffer(i.indexData.byteLength),this._idSamplerVao=this._context.createVao([{attributeMapping:Xi,buffer:this._idSamplerVertexBuffer}],this._idSamplerIndexBuffer),this._context.uploadDataToBuffer(this._idSamplerVertexBuffer,i.vertexData),this._context.uploadDataToBuffer(this._idSamplerIndexBuffer,i.indexData)}destroy(){this._idSamplerVertexBuffer.destroy(),this._idSamplerIndexBuffer.destroy(),this._idSamplerVao.destroy(),super.destroy()}_render(){this._context.bindVao(this._idSamplerVao),this._context.drawIndexedMesh(0,6,4,5123)}},er=256,tr=new O({clearColor:R(0,0,0,0),dither:!1}),ir=R(0,0,0,1),rr=new O({clearColor:ir,depthTest:!0,clearDepth:-1,depthFunc:518,dither:!1}),sr=new O({clearColor:ir,depthTest:!0,clearDepth:1,depthFunc:513,dither:!1}),or=class{constructor(e,t,i,r,s=150){this._onSceneUpdate=()=>{this._lastSceneUpdateTime=Gi(),this._animationTicksCount=0,this._renderLoop.update()},this._onBeforeRender=()=>{this._isDirty=!0},this.fadeEffectDuration=s,this._context=e,this._camera=t,this._renderLoop=i,this._lastRenderTimeInLoop=-1,this._lastSceneUpdateTime=Gi(),this._animationTicksCount=0,this._prevTargetSize={width:0,height:0},this._isEnabled=!0,this._camera.onUpdate.addListener(this._onSceneUpdate),this._renderLoop.onBeforeRender.addListener(this._onBeforeRender),this._directPriorityGridRenderer=new Ne(e,rr),this._reversePriorityGridRenderer=new Ne(e,sr),this._noCollidingVisibilityTexture=this._createPlainTexture(R(1,1,1,1)),this._currentVisibilityTexture=e.createEmpty2DTexture(er,er,6408,5121),this._prevVisibilityTexture=e.createEmpty2DTexture(er,er,6408,5121),this._sceneTexture=e.createEmpty2DTexture(er,er,6408,5121),this._overlapsTexture=e.createEmpty2DTexture(er,er,6408,5121),this._friendsTexture=e.createEmpty2DTexture(er,er,6408,5121),this._currentVisibilityBuffer=e.createFramebuffer({color:this._currentVisibilityTexture}),this._prevVisibilityBuffer=e.createFramebuffer({color:this._prevVisibilityTexture}),this._sceneBuffer=e.createFramebuffer({color:this._sceneTexture}),this._overlapsBuffer=e.createFramebuffer({color:this._overlapsTexture,depthStencil:e.createRenderbuffer(er,er,34041)}),this._friendsBuffer=e.createFramebuffer({color:this._friendsTexture}),this._stabilityShift=W(0,0,0),this._gridHalfPxSizeUniform=z(0,0),this._idHalfPxSizeUniform=z(.5/er,.5/er),this._resetRemoved=new class{render(e,t,i){for(let r of t)r.render(e,i)}},this._makeAllOverlapped=new Ji(e),this._findOverlaps=new Yi(e),this._makeFriends=new class{render(e,t,i){for(let r of t)r.render(e,i)}},this._computeVisibility=new Qi(e),this._clearVisibility(this._currentVisibilityBuffer),this._clearVisibility(this._overlapsBuffer),this._primitiveProviders=[],this._resetRemovedRenderers=[],this._friendIdRenderers=[],this._phases=[],this.setTargetSize(r)}get visibilityTexture(){return this._isEnabled?this._currentVisibilityTexture:this._noCollidingVisibilityTexture}get noCollidingVisibilityTexture(){return this._noCollidingVisibilityTexture}destroy(){this._destroyGridResources(),this._directPriorityGridRenderer.destroy(),this._reversePriorityGridRenderer.destroy(),this._noCollidingVisibilityTexture.destroy(),this._currentVisibilityTexture.destroy(),this._prevVisibilityTexture.destroy(),this._sceneTexture.destroy(),this._overlapsTexture.destroy(),this._friendsTexture.destroy(),this._currentVisibilityBuffer.destroy(),this._prevVisibilityBuffer.destroy(),this._sceneBuffer.destroy(),this._overlapsBuffer.destroy(),this._friendsBuffer.destroy(),this._makeAllOverlapped.destroy(),this._findOverlaps.destroy(),this._computeVisibility.destroy(),this._renderLoop.onBeforeRender.removeListener(this._onBeforeRender),this._camera.onUpdate.removeListener(this._onSceneUpdate)}setEnabled(e){this._isEnabled=e,this._renderLoop.update()}setTargetSize(e){let t=3*Vi(),i=Math.ceil(e.width/t),r=Math.ceil(e.height/t);this._directPriorityGridRenderer.setResolution(i,r),this._reversePriorityGridRenderer.setResolution(i,r),this._gridSamplerVertexBuffer&&this._destroyGridResources();let s=new Fe(i,r),o=this._context;this._gridSamplerVertexBuffer=o.createVertexBuffer(s.data.byteLength),this._gridSamplerVao=o.createVao([{attributeMapping:Be,buffer:this._gridSamplerVertexBuffer}]),this._numberOfGridSamplers=s.numberOfSamplers,this._context.uploadDataToBuffer(this._gridSamplerVertexBuffer,s.data),ki(e,this._prevTargetSize),this._gridHalfPxSizeUniform.x=.5/i,this._gridHalfPxSizeUniform.y=.5/r}updateVisibilityIfNeeded(){if(!this._isDirty)return;this._isDirty=!1;let e=this._stabilityShift;F(this._camera.center,e),e.z=0,fe(oi(this._camera),e,e),e.x%=4*this._gridHalfPxSizeUniform.x,e.y%=4*this._gridHalfPxSizeUniform.y;let t=this._currentVisibilityTexture,i=this._currentVisibilityBuffer,r=this._prevVisibilityTexture,s=this._prevVisibilityBuffer,o=this._overlapsTexture,n=this._overlapsBuffer,a=this._sceneTexture,l=this._sceneBuffer,d=this._friendsTexture,h=this._friendsBuffer;this._currentVisibilityBuffer=s,this._currentVisibilityTexture=r,this._prevVisibilityBuffer=i,this._prevVisibilityTexture=t;let c=this._idHalfPxSizeUniform,u=this._camera.zoom/this._camera.options.maxZoom,_=this._camera.tilt,p=this._camera.azimuth/(2*Math.PI),m=oi(this._camera),f=Fi(this._camera),g=this._gridSamplerVao,v=this._numberOfGridSamplers,y=Gi(),x=this._lastRenderTimeInLoop,b=-1!==x,T=y-this._lastSceneUpdateTime>this.fadeEffectDuration||b&&y-x>this.fadeEffectDuration,P=T?1:b?(y-x)/this.fadeEffectDuration:(y-this._lastSceneUpdateTime)/this.fadeEffectDuration;this._animationTicksCount++,this._clearVisibility(s),this._clearVisibility(l),this._clearVisibility(h),this._resetRemoved.render(l,this._resetRemovedRenderers,c),this._makeFriends.render(h,this._friendIdRenderers,c),this._makeAllOverlapped.render(n);for(let i=0;i<this._phases.length;i++){let r=this._phases[i],l=0===i,h=this._directPriorityGridRenderer.updateGrid(m,f,r.colorIdRenderers,e,t,o,a,u,_,p,l),y=this._reversePriorityGridRenderer.updateGrid(m,f,r.colorIdRenderers,e,t,o,a,u,_,p,l);this._findOverlaps.render(n,g,v,h,y,c,l),this._computeVisibility.render(s,t,o,a,d,P,u,_,p)}T&&this._animationTicksCount>1?this._lastRenderTimeInLoop=-1:(this._renderLoop.update(),this._lastRenderTimeInLoop=y)}registerCollidingPrimitives(e,{colorId:t,resetRemoved:i,friendId:r},s=0){var o;this._primitiveProviders.push(e),this._resetRemovedRenderers.push(i),r&&this._friendIdRenderers.push(r);let n=(o=this._phases)[s]||(o[s]={colorIdRenderers:[]});n.colorIdRenderers.push(t),n.colorIdRenderers.sort(((e,t)=>Number(e.options.clearDepth)-Number(t.options.clearDepth))),e.onUpdate.addListener(this._onSceneUpdate)}deregisterCollidingPrimitives(e,{colorId:t,resetRemoved:i,friendId:r}){let s=this._primitiveProviders.indexOf(e);s>-1&&this._primitiveProviders.splice(s,1),s=this._resetRemovedRenderers.indexOf(i),s>-1&&this._resetRemovedRenderers.splice(s,1),s=r?this._friendIdRenderers.indexOf(r):-1,s>-1&&this._friendIdRenderers.splice(s,1);for(let e of this._phases)s=e.colorIdRenderers.indexOf(t),s>-1&&e.colorIdRenderers.splice(s,1);e.onUpdate.removeListener(this._onSceneUpdate)}_clearVisibility(e){this._context.bindRenderState(tr),this._context.bindRenderTarget(e),this._context.clearCurrentTarget(16384)}_createPlainTexture(e){let t=this._context.createEmpty2DTexture(1,1,6408,5121);return this._context.setTextureData(t,new Uint8Array([255*e.r,255*e.g,255*e.b,255*e.a])),t}_destroyGridResources(){this._gridSamplerVertexBuffer.destroy(),this._gridSamplerVao.destroy()}},nr=8/Vi(),ar=128,lr=Ni(ar,ar);function dr(e){return Math.ceil(e/nr/ar)*ar}var hr=class extends Error{constructor(){super("Base render unit is not in the list")}},cr=class{constructor(){this.onUpdate=this._onUpdate=new qe,this._subRenderUnits=[]}addRenderUnit(e){this._subRenderUnits.push(e),e.onUpdate.addListener(this._onSubRenderUnitUpdate,this),this._onUpdate.fire()}removeRenderUnit(e){let t=this._subRenderUnits.indexOf(e);-1!==t&&(this._subRenderUnits.splice(t,1),e.onUpdate.removeListener(this._onSubRenderUnitUpdate),this._onUpdate.fire())}addRenderUnitAbove(e,t){let i=this._subRenderUnits.indexOf(e);if(-1===i)throw new hr;this._subRenderUnits.splice(i+1,0,t),t.onUpdate.addListener(this._onSubRenderUnitUpdate,this)}addRenderUnitBelow(e,t){let i=this._subRenderUnits.indexOf(e);if(-1===i)throw new hr;this._subRenderUnits.splice(i,0,t),t.onUpdate.addListener(this._onSubRenderUnitUpdate,this)}render(e,...t){for(let i of this._subRenderUnits)i.render(e,...t)}renderHitTestBuffer(e,...t){for(let i of this._subRenderUnits)i.renderHitTestBuffer(e,...t)}_onSubRenderUnitUpdate(){this._onUpdate.fire()}},ur=new O({clearDepth:-1,depthTest:!0,depthFunc:518}),_r=new O(g(f({},ur),{clearColor:M})),pr={r:0,g:0,b:0,a:0},mr=class extends cr{constructor(e,t){super(),this._context=e,this._camera=t,this.onRender=this._onRender=new qe,this.setBackgroundColor(pr)}render(e){let t=oi(this._camera),i=Fi(this._camera);this._context.bindRenderTarget(e),this._context.bindRenderState(this._renderState),this._context.clearCurrentTarget(17664);for(let r of this._subRenderUnits)r.render(e,t,i);this._onRender.fire()}renderHitTestBuffer(e){let t=oi(this._camera),i=Fi(this._camera);this._context.bindRenderTarget(e),this._context.bindRenderState(_r),this._context.clearCurrentTarget(17664);for(let r of this._subRenderUnits)r.renderHitTestBuffer(e,t,i)}setBackgroundColor(e){this._renderState=new O(ur,{clearColor:e})}},fr=0,gr=class{*[Symbol.iterator](){this._prepare(),yield*this._data}get length(){return this._prepare(),this._data.length}constructor(){this._key=Symbol("array_storage_metadata#"+fr++),this._data=[],this._isDirty=!1}add(e){let t=this._getMetadata(e);return!t&&(t={index:this._data.push(e)-1},e[this._key]=t,!0)}remove(e){let t=this._getMetadata(e);return!!t&&(delete this._data[t.index],delete e[this._key],this._setDirty(),!0)}_prepare(){this._isDirty&&(this._onDirtyDataAccessed(),this._isDirty=!1)}_getDirty(){return this._isDirty}_setDirty(){this._isDirty=!0}_onDirtyDataAccessed(){this._shakeDown()}_getMetadata(e){return e[this._key]}_shakeDown(){let e=0;for(let t=0;t<this._data.length;++t){let i=this._data[t];if(void 0!==i){let t=this._getMetadata(i);this._data[e]=i,t.index=e,++e}}this._data.length=e}};function vr(e,t){let i=0;return(...r)=>{i&&clearTimeout(i),i=setTimeout((()=>{i=0,e(...r)}),t)}}function yr(e,t=!1){let i=!1;return(...r)=>{(!t||!i)&&(Promise.resolve().then((()=>{e(...r),i=!1})),i=!0)}}var xr=class{constructor(e=new gr){this._primitives=e,this.onUpdate=this._onUpdate=new qe,this._updateScheduler=yr(this._fireUpdate.bind(this),!0)}get primitives(){return this._primitives}add(e){let t=!1;for(let i of e)this._primitives.add(i)&&(t=!0);t&&this._updateScheduler()}delete(e){let t=!1;for(let i of e)this._primitives.remove(i)&&(t=!0);t&&this._updateScheduler()}_fireUpdate(){this._onUpdate.fire()}},br=class extends xr{constructor(e=new gr){super(),this._visiblePrimitives=e}get primitives(){return this.visiblePrimitives}get visiblePrimitives(){return this._visiblePrimitives}add(e){super.add(e),this.show(e)}delete(e){this.hide(e),super.delete(e)}show(e){this._show(e)&&this._updateScheduler()}hide(e){this._hide(e)&&this._updateScheduler()}_show(e){let t=!1;for(let i of e)this._visiblePrimitives.add(i)&&(t=!0);return t}_hide(e){let t=!1;for(let i of e)this._visiblePrimitives.remove(i)&&(t=!0);return t}},Tr=class{constructor(e,t,i,r){this.id=i,this.vao=e,this.location=t,this.metadata=r}},Pr=class extends Tr{};function wr(e,t){return t<<16|65535&e}function Mr(e){return we(.25*(e+2))}function Rr(e,t){let i=Mr(t.x),r=Mr(t.y);e.writeVertexUint32(function(e,t){return wr(e>>>16,t>>>16)}(i,r)),e.writeVertexUint32(function(e,t){return wr(e,t)}(i,r))}var Sr=class{constructor(e){this._bufferDataProvider=e,this._currentMeshWrittenVertices=0}endMesh(){return this._currentMeshWrittenVertices=0,this._currentBufferData.endMesh()}writeIndices(e){this._ensureEnoughIndexBufferSpace(e.length),this._currentBufferData.writeIndices(e)}writeVertex(...e){return this._ensureEnoughVertexBufferSpace(),this._writeVertex(this._currentBufferData,...e),this._currentMeshWrittenVertices++}_ensureEnoughVertexBufferSpace(e=1){this._currentBufferData||this._requestNewBuffer();let t=this._currentBufferData.vertexBuffer,i=e*t.vertexByteSize;if(t.occupiedByteSize+i>t.byteSize&&(this._requestNewBuffer(),i>this._currentBufferData.vertexBuffer.byteSize))throw new Error("Mesh is too big to write its vertices")}_ensureEnoughIndexBufferSpace(e){this._currentBufferData||this._requestNewBuffer();let t=this._currentBufferData.indexBuffer;if(t.occupiedSize+e>t.size&&(this._requestNewBuffer(),e>this._currentBufferData.indexBuffer.size))throw new Error("Mesh is too big to write its indices")}_requestNewBuffer(){let e=this._currentBufferData;if(this._currentBufferData=this._bufferDataProvider(),e){if(0===e.vertexBuffer.currentMeshBaseIndex)throw new Error("Mesh is too big: tried to transfer the whole buffer");e.vertexBuffer.transferUnfinishedMesh(this._currentBufferData.vertexBuffer),e.indexBuffer.transferUnfinishedMesh(this._currentBufferData.indexBuffer,e.vertexBuffer.currentMeshBaseIndex)}}},Cr=class extends Sr{writeFakePrimitive(e,t,i){let r=this.writeVertex(e,t.minX,t.minY,i),s=this.writeVertex(e,t.minX,t.maxY,i),o=this.writeVertex(e,t.maxX,t.minY,i),n=this.writeVertex(e,t.maxX,t.maxY,i);return this.writeIndices([r,o,s,s,o,n]),this.endMesh()}_writeVertex(e,t,i,r,s){Rr(e,t),e.writeVertexUint32(wr(i,r)),e.writeVertexUint32(s)}};function Ir(e,t="something that is supposed to be defined is undefined"){if(void 0===e)throw new Error(t);return void 0!==e}function Er(e){let t=new Image,i=new Promise((i=>{t.onload=()=>i(),t.crossOrigin="anonymous",t.src=e}));return[t,i]}function Ar(e){return!!e&&"function"==typeof e.close}function Lr(e){let t=1,i=1;return Ar(e)&&(t=e.width,i=e.height),{width:t,height:i}}function Ur(e,t,i){return x(this,null,(function*(){let r;r=Ar(i)?i:yield function(e){return x(this,null,(function*(){let[t,i]=Er(e);return yield i,t}))}(function(e){return!!e&&e.data instanceof ArrayBuffer}(i)?function(e,t){let i=new Blob([e],{type:t});return URL.createObjectURL(i)}(i.data,i.mimeType):i.uri),(t.getWidth()!==r.width||t.getHeight()!==r.height)&&e.resizeTexture(t,{width:r.width,height:r.height}),e.setTextureDataFromDomElement(t,r)}))}var Or={wrapS:33071,wrapT:33071,magnificationFilter:9728,minificationFilter:9728,premultipliedAlpha:!1,unpackAlignment:4},Dr=class{constructor(e,t,i,r,s,o,n=e.createTexture()){let a=f(f({},Or),o);this._gl=e,this._format=r,this._type=s,this._params=a,this._width=t,this._height=i,this._halfPxSize=zr(t,i),this._handle=n,this._magnificationFilter=null,this._minificationFilter=null}initialize(){let e=this._gl;e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,this._params.wrapS),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,this._params.wrapT),this.setFilters(this._params.magnificationFilter,this._params.minificationFilter),e.texImage2D(e.TEXTURE_2D,0,this._format,this._width,this._height,0,this._format,this._type,null)}bind(){let e=this._gl;e.bindTexture(e.TEXTURE_2D,this._handle)}isBound(){let e=this._gl;return e.getParameter(e.TEXTURE_BINDING_2D)===this._handle}attachToFramebuffer(e){let t=this._gl;t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,this._handle,0)}getWidth(){return this._width}getHeight(){return this._height}getFormat(){return this._format}getType(){return this._type}getParams(){return this._params}getHalfPxSize(){return this._halfPxSize}setFilters(e=this._params.magnificationFilter,t=this._params.minificationFilter){let i=this._gl;this._magnificationFilter!==e&&(this._magnificationFilter=e,i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,e)),this._minificationFilter!==t&&(this._minificationFilter=t,i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,t))}resize({width:e,height:t}){this._width=e,this._height=t,this._halfPxSize=zr(e,t)}destroy(){this._gl.deleteTexture(this._handle)}};function zr(e,t){return z(.5/e,.5/t)}function Br(e){return e.getWidth()*e.getHeight()*Fr[e.getFormat()]*Vr[e.getType()]}var Fr={6406:1,6409:1,6410:2,6407:3,6408:4},Vr={5126:4,36193:2,5121:1,32819:1,32820:1,33635:1},Nr=class{},kr=class extends Nr{constructor(e,t,i,r,s){super(),this.id=e,this._buffers=[],this._onMemoryChanged=s,this._memorySize=0;let o,n=[];r&&n.push(...r.vertexBuffers);for(let{data:e,mapping:r}of i.vertices){let i=t.createVertexBuffer(e.byteLength);this._buffers.push(i),this._memorySize+=e.byteLength,t.uploadDataToBuffer(i,e),n.push({attributeMapping:r,buffer:i})}r?o=r.indexBuffer:(o=t.createIndexBuffer(i.indices.byteLength),this._buffers.push(o),this._memorySize+=i.indices.byteLength,t.uploadDataToBuffer(o,i.indices)),this.vertexBuffers=n,this.indexBuffer=o,this.vao=t.createVao(n,o),this._onMemoryChanged(this._memorySize)}get memoryUsageInBytes(){return this._memorySize}destructor(){this.vao.destroy();for(let e of this._buffers)e.destroy();this._onMemoryChanged(-this._memorySize)}},Hr=class extends Nr{constructor(e,t,i,r){super(),this.id=e,this._onMemoryChanged=r;let{width:s,height:o}=Lr(i.content);this.texture=t.createEmpty2DTexture(s,o,6408,5121,{minificationFilter:9987,magnificationFilter:9729,wrapS:10497,wrapT:10497}),this._memorySize=Br(this.texture),this._onMemoryChanged(this._memorySize),Ur(t,this.texture,i.content).then((()=>{let e=Br(this.texture);e!==this._memorySize&&(this._onMemoryChanged(e-this._memorySize),this._memorySize=e)}),(e=>{console.warn(e)}))}get memoryUsageInBytes(){return this._memorySize}destructor(){this.texture.destroy(),this._onMemoryChanged(-this._memorySize)}},jr=class{constructor(e,t){this._onMessage=e=>{switch(e.type){case 0:this._onPageAdd(e);break;case 1:this._onPageUpdate(e);break;case 2:this._onPageRemove(e);break;case 3:this._entityManager.addEntity(e.id,e.description);break;case 4:this._entityManager.removeEntity(e.id)}},this._communicator=e,this._context=t,this._pages=new Map,this._entityManager=this._createEntityManager(),this._memoryUsage={memoryForBuffers:0,memoryForVertices:0,memoryForIndices:0},this._onMemoryUsageChanged=new qe,this._communicator.onMessage.addListener(this._onMessage)}get memoryUsage(){return this._memoryUsage}get onMemoryUsageChanged(){return this._onMemoryUsageChanged}destructor(){this._communicator.onMessage.removeListener(this._onMessage),this._entityManager.destructor();for(let[e,t]of this._pages)t.destructor();this._pages.clear()}getPage(e){return this._pages.get(e)}getEntity(e){return this._entityManager.getEntity(e)}_onPageAdd(e){this._pages.set(e.id,new class{constructor(e,t,i,r,s){this._context=e,this.layout=t,this.vertexBuffer=this._context.createVertexBuffer(i),this.indexBuffer=this._context.createIndexBuffer(r);let o=[{attributeMapping:t,buffer:this.vertexBuffer}];s&&(this.dynamicVertexBuffer=this._context.createVertexBuffer(i/t.vertexByteSize*s.vertexByteSize|0,35048),o.push({attributeMapping:s,buffer:this.dynamicVertexBuffer})),this.vao=this._context.createVao(o,this.indexBuffer)}destructor(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.dynamicVertexBuffer&&this.dynamicVertexBuffer.destroy(),this.vao.destroy()}updateVertexContent(e,t){this._context.bindVao(null),this._context.uploadDataToBuffer(this.vertexBuffer,e,t)}updateIndexContent(e,t){this._context.bindVao(null),this._context.uploadDataToBuffer(this.indexBuffer,e,t)}updateDynamicContent(e,t){if(!this.dynamicVertexBuffer)throw new Error("Tried to update dynamic data of a page without dynamic vertex buffer.");this._context.bindVao(null),this._context.uploadDataToBuffer(this.dynamicVertexBuffer,e,t)}}(this._context,e.attribMapping,e.vertexDataByteSize,e.indexDataByteSize,e.dynamicAttribMapping))}_onPageUpdate(e){let t=this.getPage(e.id);if(Ir(t)){let{vertexUpdate:i,indexUpdate:r,dynamicVertexUpdate:s}=e;i&&t.updateVertexContent(i.data,i.byteOffset),r&&t.updateIndexContent(r.data,r.byteOffset),s&&t.updateDynamicContent(s.data,s.byteOffset)}}_onPageRemove(e){let t=this._pages.get(e.id);Ir(t)&&(this._pages.delete(e.id),t.destructor())}_createEntityManager(){return new class{constructor(e,t){this._context=e,this._onMemoryChanged=t,this._entities=new Map}destructor(){for(let e of Array.from(this._entities.keys()))this.removeEntity(e)}getEntity(e){return this._entities.get(e)}addEntity(e,t){let i;switch(t.type){case 0:i=this._createGeometry(e,t);break;case 1:i=this._createImage(e,t)}this._entities.set(e,i)}removeEntity(e){let t=this._entities.get(e);Ir(t)&&(this._entities.delete(e),t.destructor())}_createGeometry(e,t){let i;return void 0!==t.baseGeometryId&&(i=this._entities.get(t.baseGeometryId),Ir(i)),new kr(e,this._context,t,i,this._onMemoryChanged)}_createImage(e,t){return new Hr(e,this._context,t,this._onMemoryChanged)}}(this._context,(e=>{}))}},Gr=class{get isRetained(){return 0!==this._clients}constructor(){this.onReleased=this._onReleased=new qe,this.onRetain=this._onRetain=new qe,this._clients=0}retain(){++this._clients,this._onRetain.fire(this)}release(){this._clients>0&&(--this._clients,0===this._clients&&this._onReleased.fire(this))}},Wr=class extends Error{};function qr(e,t){if("boolean"==typeof e&&!e||"function"==typeof e&&!e())throw new Wr(`Assertion failed: ${t}`)}var Yr=class{get data(){return this._uint8View.buffer}get byteSize(){return this._uint8View.byteLength}get occupiedByteSize(){return this._nextWordOffset*this._wordByteSize}constructor(e,t){qr(e%t==0,"size in bytes must be a multiply of wordByteSize"),this._wordByteSize=t,this._nextWordOffset=0,this._currentMeshByteOffset=0,this._uint8View=new Uint8Array(e)}endMesh(){let e=this._currentMeshByteOffset,t=this.occupiedByteSize,i=t-e;return this._currentMeshByteOffset=t,{byteOffset:e,byteSize:i}}transferUnfinishedMesh(e){let t=this.occupiedByteSize,i=t-this._currentMeshByteOffset,r=this._uint8View.subarray(this._currentMeshByteOffset,t);e._uint8View.set(r,0),e._nextWordOffset=i/this._wordByteSize,this._nextWordOffset=this._currentMeshByteOffset/this._wordByteSize}reset(){this._nextWordOffset=0,this._currentMeshByteOffset=0}},Xr=class extends Yr{constructor(e,t){super(e*t,Uint32Array.BYTES_PER_ELEMENT),this.vertexByteSize=t,this._uint32View=new Uint32Array(this._uint8View.buffer),this._float32View=new Float32Array(this._uint8View.buffer),this._currentMeshBaseIndex=0}get currentMeshBaseIndex(){return this._currentMeshBaseIndex}get isFull(){return this._nextWordOffset>=this._uint32View.length}pushUint32(e){this._uint32View[this._nextWordOffset++]=e}pushFloat32(e){this._float32View[this._nextWordOffset++]=e}asUint32Array(){return this._uint32View.subarray(0,this._nextWordOffset)}endMesh(){return this._currentMeshBaseIndex=this.occupiedByteSize/this.vertexByteSize,super.endMesh()}reset(){this._currentMeshBaseIndex=0,super.reset()}},Zr=class extends Yr{constructor(e){let t=Uint16Array.BYTES_PER_ELEMENT;super(e*t,t),this._uint16View=new Uint16Array(this._uint8View.buffer)}get size(){return this._uint16View.length}get occupiedSize(){return this._nextWordOffset}push(e){this._uint16View[this._nextWordOffset++]=e}asUint16Array(){return this._uint16View.subarray(0,this._nextWordOffset)}transferUnfinishedMesh(e,t=0){if(super.transferUnfinishedMesh(e),t)for(let i=0;i<e._nextWordOffset;i++)e._uint16View[i]-=t}},$r={vertexMinByte:Number.MAX_SAFE_INTEGER,vertexMaxByte:Number.MIN_SAFE_INTEGER},Qr=g(f({},$r),{indexMinByte:Number.MAX_SAFE_INTEGER,indexMaxByte:Number.MIN_SAFE_INTEGER}),Kr=class extends Gr{constructor(e,t,i,r,s){super(),this.id=e,this.attribMapping=t,this.data=new class{constructor(e,t,i,r){this.id=e,this.vertexBuffer=new Xr(t,i),this.indexBuffer=new Zr(r),this.onMeshWritten=this._onMeshWritten=new qe}writeVertexUint32(e){this.vertexBuffer.pushUint32(e)}writeVertexFloat32(e){this.vertexBuffer.pushFloat32(e)}writeIndices(e){let t=this.vertexBuffer.currentMeshBaseIndex;for(let i of e)this.indexBuffer.push(t+i)}endMesh(){let e=this.vertexBuffer.endMesh(),t=this.indexBuffer.endMesh(),i={vertexByteOffset:e.byteOffset,vertexByteLength:e.byteSize,indexByteOffset:t.byteOffset,indexByteLength:t.byteSize,indexType:5123,bufferId:this.id};return this._onMeshWritten.fire(i),i}reset(){this.vertexBuffer.reset(),this.indexBuffer.reset()}}(e,i,t.vertexByteSize,r),this.dynamicData=s&&{attribMapping:s,vertexData:new Xr(i,s.vertexByteSize)},this.data.onMeshWritten.addListener(this._onMeshWritten,this),this.onUpdate=this._onUpdate=new qe,this._updatedRegion=void 0,this._updatedDynamicRegion=void 0}reset(){this.data.reset(),this.flushUpdatedRegion()}touch(e){this._onMeshWritten(e)}touchDynamicData(e){this._onDynamicMeshWritten(e)}flushUpdatedRegion(){let e=this._updatedRegion;return this._updatedRegion=void 0,e}flushUpdatedDynamicRegion(){let e=this._updatedDynamicRegion;return this._updatedDynamicRegion=void 0,e}_onMeshWritten(e){this._updatedRegion||(this._updatedRegion=f({},Qr)),this._extendRegion(this._updatedRegion,e),this._onUpdate.fire(this)}_onDynamicMeshWritten(e){this._updatedDynamicRegion||(this._updatedDynamicRegion=f({},$r)),this._extendVertexBufferRegion(this._updatedDynamicRegion,e),this._onUpdate.fire(this)}_extendRegion(e,t){this._extendVertexBufferRegion(e,t),t.indexByteOffset<e.indexMinByte&&(e.indexMinByte=t.indexByteOffset);let i=t.indexByteOffset+t.indexByteLength;i>e.indexMaxByte&&(e.indexMaxByte=i)}_extendVertexBufferRegion(e,t){t.vertexByteOffset<e.vertexMinByte&&(e.vertexMinByte=t.vertexByteOffset);let i=t.vertexByteOffset+t.vertexByteLength;i>e.vertexMaxByte&&(e.vertexMaxByte=i)}},Jr=class extends Gr{constructor(e,t){super(),this.id=e,this.type=t}};var es=Te([[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[6,{size:2,type:5122,normalized:!1}],[2,{size:4,type:5121,normalized:!1}]]),ts="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexDisplacement;attribute vec4 vertexId;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 shift;const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);const float MAX_PRIORITY=1.0-pow(2.0,-24.0);varying vec4 id;void main(){vec4 position=viewProjMatrix*vec4((YV_H*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*YV_N,0,1);gl_Position=vec4(position.xy/position.w,MAX_PRIORITY,1.0);gl_Position.xy+=vertexDisplacement*pixelSize;gl_Position.xy+=shift;id=vec4(vertexId.xy/255.0,0,1);}";function is(e,t){switch(t){case 5123:return e>>1;case 5125:return e>>2;default:return-1}}function rs(e,t){return t.indexByteOffset+t.indexByteLength===e.indexByteOffset&&(t.indexByteLength+=e.indexByteLength,!0)}function ss(e,t){return t.vertexByteOffset+t.vertexByteLength===e.vertexByteOffset&&t.indexByteOffset+t.indexByteLength===e.indexByteOffset&&(t.vertexByteLength+=e.vertexByteLength,t.indexByteLength+=e.indexByteLength,!0)}function os(e,t,i){return function*(e,t,i,r=(()=>!0),s=rs){let o=e[Symbol.iterator](),n=o.next().value;if(!n)return;let a=n,l=i(a);for(n=o.next().value;n;){let e=t(n);(!r(a,n,l)||!s(e,l))&&(yield l,l=i(n)),a=n,n=o.next().value}yield l}(e,(e=>e.location),(e=>f({firstPrimitive:e},e.location)),((e,i)=>!(e.vao!==i.vao||t&&!t(e,i))),i)}var ns=class{constructor(e){this._batches=[],this._isSynced=!1,this._canBatchPredicate=e}batch(e){return this._sync(e),this._batches}invalidate(){this._isSynced=!1}_sync(e){if(!this._isSynced){let t=0;for(let i of os(e,this._canBatchPredicate))this._batches[t]=i,t++;this._batches.length=t,this._isSynced=!0}}},as=class extends Ve{constructor(e,t,i,r,s,o){super(t,i,r,s,o),this._updateListener=()=>{this._batchesCache.invalidate(),this._hitTestBatchesCache.invalidate(),this._onUpdate.fire()},this.primitiveProvider=e,this.onUpdate=this._onUpdate=new qe,this.primitiveProvider.onUpdate.addListener(this._updateListener),this._canBatchPredicate=this._canBatchAdjacentPrimitives.bind(this),this._batchesCache=new ns(this._canBatchPredicate),this._hitTestBatchesCache=new ns(this._canBatchPredicate)}destroy(){this.primitiveProvider.onUpdate.removeListener(this._updateListener),super.destroy()}_render(e,t){let i=this._program,r=this._batchesCache.batch(this._getPrimitives());for(let e of t){i.setVector2Uniform("lookAtHigh",e.lookAtHigh),i.setVector2Uniform("lookAtLow",e.lookAtLow);for(let e of r)this._renderBatch(e,i)}}_renderHitTestBuffer(e,t){let i=this._hitTestProgram,r=this._hitTestBatchesCache.batch(this._getHitTestPrimitives());for(let e of t){i.setVector2Uniform("lookAtHigh",e.lookAtHigh),i.setVector2Uniform("lookAtLow",e.lookAtLow);for(let e of r)this._renderHitTestBufferBatch(e,i)}}_getPrimitives(){return this.primitiveProvider.primitives}_getHitTestPrimitives(){return this.primitiveProvider.primitives}_prepareProgram(e,t,i,...r){super._prepareProgram(e,t,i,...r),e.setMatrix4Uniform("viewProjMatrix",t)}_prepareHitTestProgram(e,t,i,...r){super._prepareProgram(e,t,i,...r),e.setMatrix4Uniform("viewProjMatrix",t)}_renderBatch(e,t){this._context.bindVao(e.firstPrimitive.vao),this._context.drawIndexedMesh(e.indexByteOffset,is(e.indexByteLength,e.indexType),4,e.indexType)}_renderHitTestBufferBatch(e,t){this._context.bindVao(e.firstPrimitive.vao),this._context.drawIndexedMesh(e.indexByteOffset,is(e.indexByteLength,e.indexType),4,e.indexType)}_canBatchAdjacentPrimitives(e,t){return!0}},ls=class extends as{constructor(e,t,i,r=hs){super(e,t,new O,i),this.options=r}_getPrimitives(){return this.primitiveProvider.primitives}_prepareProgram(e,t,i,r,s,o,n,a,l,d,h){super._prepareProgram(e,t,i,r,s,o,n,a,l,d,h),this._context.bindTextureUnit(0),this._context.bindTexture(o),this._context.bindTextureUnit(1),this._context.bindTexture(n),this._context.bindTextureUnit(2),this._context.bindTexture(a),e.setIntScalarUniform("visibility",0),e.setIntScalarUniform("overlap",1),e.setIntScalarUniform("scene",2),e.setVector2Uniform("idHalfPxSize",o.getHalfPxSize()),e.setVector2Uniform("shift",s),e.setScalarUniform("currentZoom",l),e.setScalarUniform("currentTilt",d),e.setScalarUniform("currentAzimuth",h)}_prepareRenderTarget(e,t,i,r,s,o,n){this._context.bindRenderState(r),this._context.bindRenderTarget(e),this.options.clearDepth&&this._context.clearCurrentTarget(256)}},ds=class extends ls{constructor(e,t,i,r=hs){super(e,t,i),this.options=r}_getPrimitives(){return this.primitiveProvider.visiblePrimitives}},hs={clearDepth:!1},cs={attribMap:{vertexPosHigh:0,vertexPosLow:1,vertexDisplacement:6,vertexId:2}},us=class extends ds{constructor(e,t,i,r){super(e,t,t.createProgram(ts,Wi,cs),r),this._camera=i}_prepareProgram(e,t,i,r,s,o,n,a,l,d,h){super._prepareProgram(e,t,i,r,s,o,n,a,l,d,h),e.setVector2Uniform("pixelSize",this._camera.pixelSize)}},_s=class extends Ve{constructor(e,t){let i=t.createProgram("#version 100\nattribute vec2 vertexId;uniform vec2 idHalfPxSize;void main(){vec2 idTexCoordinates=vertexId.xy/256.0+idHalfPxSize;vec4 idWindowCoordinates=vec4(idTexCoordinates*2.0-1.0,0,1);gl_Position=idWindowCoordinates;gl_PointSize=1.0;}","#version 100\nvoid main(){gl_FragColor=vec4(0,0,0,1);}",{attribMap:{vertexId:2}});super(t,new O,i),this._primitiveProvider=e}_render(){let e=this._primitiveProvider.primitives;for(let t of os(e))this._context.bindVao(t.firstPrimitive.vao),this._context.drawIndexedMesh(t.indexByteOffset,is(t.indexByteLength,t.indexType),0,t.indexType)}_prepareProgram(e,t){super._prepareProgram(e,t),e.setVector2Uniform("idHalfPxSize",t)}},ps=class{constructor(){this.onMessage=this._onMessage=new qe}sendMessage(e,t){this.peerCommunicator&&this.peerCommunicator._onMessage.fire(e)}};var ms={min:1,max:511},fs={min:512,max:4095},gs={min:65536,max:77823};function vs({min:e,max:t}){let i=0;return()=>i++%(t-e+1)+e}var ys=class{constructor(e,t,i,r){this._onUpdate=()=>{this.renderLoop.update()},this._onRender=()=>{this.visibilityManager.updateVisibilityIfNeeded(),this.renderer.render(this._renderTarget),this._hitTestManager.setDirty()},this._onContextLost=()=>{this._onInternalError.fire()},this.camera=t,this.context=e,this._renderTarget=e.getDefaultRenderTarget(),this.renderer=new mr(e,t),this.renderLoop=i,this._hitTestManager=new class{constructor(e,t,i){this._context=e,this._renderer=t,this._renderLoop=i,this._tileCache=new Map,this._isDirty=!0,this._allocateResources(),this._lastRenderTime=0}destroy(){this._deleteResources()}updateSize(){this._deleteResources(),this._allocateResources(),this.setDirty()}setDirty(){this._isDirty||(this._isDirty=!0,this._tileCache.clear())}getIdAt(e){this._isDirty&&(!this._lastRenderTime||Gi()-this._lastRenderTime>100)&&(this._lastRenderTime=Gi(),this._renderer.renderHitTestBuffer(this._framebuffer),this._renderLoop.update(),this._tileCache.clear(),this._isDirty=!1);let t=this._context,i=this._framebuffer,r=t.getDefaultRenderTarget().size,s=e.x/r.width,o=1-e.y/r.height,n=s*i.size.width|0,a=o*i.size.height|0,l=z(Math.floor(n/ar)*ar,Math.floor(a/ar)*ar),d=l.x<<16|l.y,h=this._tileCache.get(d);return h||(t.bindRenderTarget(i),h=new Uint32Array(i.readPixels(lr,l).buffer),this._renderLoop.update(),this._tileCache.set(d,h)),h[ar*(a-l.y)+(n-l.x)]}_deleteResources(){this._framebuffer.destroy(),this._colorBuffer.destroy(),this._depthBuffer.destroy()}_allocateResources(){let e=this._context,{width:t,height:i}=e.getDefaultRenderTarget().size,r=dr(t),s=dr(i);this._colorBuffer=e.createEmpty2DTexture(r,s,6408,5121),this._depthBuffer=e.createRenderbuffer(r,s,34041),this._framebuffer=e.createFramebuffer({color:this._colorBuffer,depthStencil:this._depthBuffer})}}(e,this.renderer,i),this._isOwnVisibilityManager=!r,this.visibilityManager=r||new or(e,t,i,e.getDefaultRenderTarget().size),this.visibilityTextureProvider=()=>(this.visibilityManager.updateVisibilityIfNeeded(),this.visibilityManager.visibilityTexture),this.stencilIdProvider=function(){let e=xs;return()=>{let t={id:e,shouldClear:e===xs};return e=He(e+1,xs,bs),t}}(),this.invisibleCollidingPrimitiveManager=new class{constructor(e,t,i,r){this._pageRegistryCommunicators=function(){let e=new ps,t=new ps;return e.peerCommunicator=t,t.peerCommunicator=e,{master:e,worker:t}}(),this._pageRegistry=new jr(this._pageRegistryCommunicators.master,e),this._pageRegistryBackend=new class{constructor(e,t=65536){this._onPageUpdated=e=>{this._updatedPages.add(e)},this._onPageReleased=e=>{var t,i;let r=this._getFreePages(e.attribMapping,null==(t=e.dynamicData)?void 0:t.attribMapping);r?r.pages.push(e):this._freePages.push({pages:[e],attribMapping:e.attribMapping,dynamicAttribMapping:null==(i=e.dynamicData)?void 0:i.attribMapping})},this._communicator=e,this._pageVertexNumber=t,this._updatedPages=new Set,this._pages=new Map,this._freePages=[],this._lastGeneratedPageId=0,this._entityManager=this._createEntityManager()}destructor(){this._entityManager.destructor();for(let[e,t]of this._pages)t.onUpdate.removeListener(this._onPageUpdated),t.onReleased.removeListener(this._onPageReleased);this._pages.clear(),this._freePages.length=0}getPage(e){return this._pages.get(e)}getFreeOrCreatePage(e,t){var i;let r=null==(i=this._getFreePages(e,t))?void 0:i.pages,s=r&&r.pop();if(s)return s.reset(),s;{let i=this._generateId(),r=new Kr(i,e,this._pageVertexNumber,2*this._pageVertexNumber,t);return r.onUpdate.addListener(this._onPageUpdated),r.onReleased.addListener(this._onPageReleased),this._pages.set(i,r),this._communicator.sendMessage({type:0,id:i,attribMapping:e,dynamicAttribMapping:t,vertexDataByteSize:r.data.vertexBuffer.byteSize,indexDataByteSize:r.data.indexBuffer.byteSize},!1),r}}flushBackendUpdates(){for(let e of this._updatedPages){let t=e.flushUpdatedRegion(),i=e.flushUpdatedDynamicRegion(),r=t&&{data:e.data.vertexBuffer.data.slice(t.vertexMinByte,t.vertexMaxByte),byteOffset:t.vertexMinByte},s=t&&{data:e.data.indexBuffer.data.slice(t.indexMinByte,t.indexMaxByte),byteOffset:t.indexMinByte},o=i&&e.dynamicData&&{data:e.dynamicData.vertexData.data.slice(i.vertexMinByte,i.vertexMaxByte),byteOffset:i.vertexMinByte},n=[];r&&n.push(r.data),s&&n.push(s.data),o&&n.push(o.data),this._communicator.sendMessage({type:1,id:e.id,vertexUpdate:r,indexUpdate:s,dynamicVertexUpdate:o},!1,...n)}this._updatedPages.clear()}getEntity(e){return this._entityManager.getEntity(e)}addEntity(e){return this._entityManager.addEntity(e)}_getFreePages(e,t){return this._freePages.find((i=>i.attribMapping===e&&i.dynamicAttribMapping===t))}_generateId(){return this._lastGeneratedPageId++}_createEntityManager(){return new class{constructor(e){this._onEntityReleased=e=>{this._removeEntity(e)},this._onAddEntity=e.onAddEntity,this._onRemoveEntity=e.onRemoveEntity,this._entities=new Map,this._referencesMap=new Map,this._nextId=0}destructor(){let e=Array.from(this._entities.values());for(let t of e)this._removeEntity(t)}getEntity(e){return this._entities.get(e)}addEntity(e){let t=new Jr(this._generateId(),e.type);return this._entities.set(t.id,t),t.onReleased.addListener(this._onEntityReleased),this._setupEntity(t,e),t}_setupEntity(e,t){let i=[];switch(t.type){case 0:this._setupGeometryEntity(e,t,i);break;case 1:this._setupImageEntity(e,t,i)}this._onAddEntity(e,t,i)}_setupGeometryEntity(e,t,i){void 0!==t.baseGeometryId&&this._addReference(e,t.baseGeometryId);for(let e of t.vertices)e.data.byteLength>0&&i.push(e.data);t.indices.byteLength>0&&i.push(t.indices)}_setupImageEntity(e,t,i){(function(e){return!!e&&"string"==typeof e.uri})(t.content)||i.push(Ar(t.content)?t.content:t.content.data)}_removeEntity(e){this._removeReference(e),this._entities.delete(e.id),e.onReleased.removeListener(this._onEntityReleased),this._onRemoveEntity(e)}_addReference(e,t){this._referencesMap.set(e.id,t);let i=this._entities.get(t);Ir(i,`entity ${e.id}: add reference to ${t}`)&&i.retain()}_removeReference(e){let t=this._referencesMap.get(e.id);if(void 0===t)return;this._referencesMap.delete(e.id);let i=this._entities.get(t);Ir(i,`entity ${e.id}: remove reference to ${t}`)&&i.release()}_generateId(){return this._nextId++}}({onAddEntity:(e,t,i)=>{this._communicator.sendMessage({type:3,id:e.id,description:t},!1,...i)},onRemoveEntity:e=>{this._communicator.sendMessage({type:4,id:e.id},!1)}})}}(this._pageRegistryCommunicators.worker),this._bufferWriter=new Cr(function(e,t,i){let r;return()=>{r&&setTimeout((e=>e.release()),0,r),r=e.getFreeOrCreatePage(t,i),r.retain();let s=e=>{e.release(),e.onRetain.removeListener(s)};return r.retain(),r.onRetain.addListener(s),r.data}}(this._pageRegistryBackend,es)),this._visibilityManager=i,this._fakePrimitiveStorage=new br,this._fakePrimitiveColorIdRenderer=new us(this._fakePrimitiveStorage,e,t),this._fakePrimitiveResetRemovedRenderer=new _s(this._fakePrimitiveStorage,e),this._visibilityManager.registerCollidingPrimitives(this._fakePrimitiveStorage,{colorId:this._fakePrimitiveColorIdRenderer,resetRemoved:this._fakePrimitiveResetRemovedRenderer}),this._idGenerator=r,this._primitives=new Map}destructor(){this._visibilityManager.deregisterCollidingPrimitives(this._fakePrimitiveStorage,{colorId:this._fakePrimitiveColorIdRenderer,resetRemoved:this._fakePrimitiveResetRemovedRenderer}),this._fakePrimitiveResetRemovedRenderer.destroy(),this._fakePrimitiveColorIdRenderer.destroy(),this._pageRegistry.destructor()}addPrimitives(...e){let t=e.map((({anchor:e,rect:t})=>{let i=this._idGenerator();return{id:i,location:this._bufferWriter.writeFakePrimitive(e,t,i)}}));this._pageRegistryBackend.flushBackendUpdates();let i=t.map((({location:e,id:t})=>{let i=this._pageRegistry.getPage(e.bufferId);if(!i)throw new Error("No page for created fake primitive");return new Pr(i.vao,e,t)}));return this._fakePrimitiveStorage.add(i),this._createCollidingPrimitives(i)}removePrimitives(...e){let t=[];for(let i of e){let e=this._primitives.get(i);e&&(t.push(e),this._primitives.delete(i))}this._fakePrimitiveStorage.delete(t)}clear(){this.removePrimitives(...this._primitives.keys())}_createCollidingPrimitives(e){return e.map((e=>{let t={};return this._primitives.set(t,e),t}))}}(e,t,this.visibilityManager,vs(ms)),this._onInternalError=new qe,this.renderLoop.onRender.addListener(this._onRender),this.camera.onUpdate.addListener(this._onUpdate),this.renderer.onUpdate.addListener(this._onUpdate),this.context.onLoss.addListener(this._onContextLost)}get onInternalError(){return this._onInternalError}destroy(){this.context.onLoss.removeListener(this._onContextLost),this.renderer.onUpdate.removeListener(this._onUpdate),this.camera.onUpdate.removeListener(this._onUpdate),this.renderLoop.onRender.removeListener(this._onRender),this.invisibleCollidingPrimitiveManager.destructor(),this._hitTestManager.destroy(),this._isOwnVisibilityManager&&this.visibilityManager.destroy()}setRenderTargetSize(e){Hi(this._renderTarget.size,e)||(this._renderTarget.size=e,this.visibilityManager.setTargetSize(e),this._hitTestManager.updateSize())}getObjectIdAt(e){return this._hitTestManager.getIdAt(e)}setBackgroundColor(e){this.renderer.setBackgroundColor(e),this.renderLoop.update()}},xs=1,bs=255;var Ts=class{get size(){return this._size}constructor(e,t,i){this._gl=e,this._target=t,this._handle=e.createBuffer(),this._size=i}bind(){this._gl.bindBuffer(this._target,this._handle)}isBound(){let e=this._gl,t=this._handle;switch(this._target){case e.ARRAY_BUFFER:return e.getParameter(e.ARRAY_BUFFER_BINDING)===t;case e.ELEMENT_ARRAY_BUFFER:return e.getParameter(e.ELEMENT_ARRAY_BUFFER_BINDING)===t}return!1}getTarget(){return this._target}getSize(){return this._size}destroy(){this._gl.deleteBuffer(this._handle)}};function Ps(e,t){let i=Object.keys(t).map((e=>"#define "+e+" "+t[e])).join("\n"),r=e.indexOf("#version");if(-1===r)return i+"\n"+e;let s=e.indexOf("\n",r)+1;return e.slice(0,s)+i+"\n"+e.slice(s)}function ws(e,t,i){let r=e.createShader(t);return e.shaderSource(r,i),e.compileShader(r),r}var Ms=class extends Dr{constructor(e,t){super(e,0,0,6408,5121,{},t)}get handle(){return this._handle}bind(){let e=this._gl;e.bindTexture(e.TEXTURE_2D,this._handle)}setFilters(){}initialize(){}getWidth(){throw new Error("Not supported")}getHeight(){throw new Error("Not supported")}getFormat(){throw new Error("Not supported")}getType(){throw new Error("Not supported")}getParams(){throw new Error("Not supported")}getHalfPxSize(){throw new Error("Not supported")}destroy(){}},Rs=new Float32Array([-1,-1,0,0,1,1,1,1,-1,1,0,1,-1,-1,0,0,1,-1,1,0,1,1,1,1]),Ss=Te([[0,{size:2,type:5126,normalized:!1}],[4,{size:2,type:5126,normalized:!1}]]),Cs=class e{get onLoss(){return this._onLoss}get gl(){return this._gl}constructor(e){this._gl=e,this._skipChecks=!1,this._onLoss=new qe,this._contextLostListener=e=>{e.preventDefault(),this._onLoss.fire()},e.canvas.addEventListener("webglcontextlost",this._contextLostListener),this._capabilities=new class{constructor(e){this._gl=e,this._paramValues=new Map}getAliasedLineWidthRange(){return this._getParam(33902)}getAliasedPointSizeRange(){return this._getParam(33901)}getMaxCombinedTextureImageUnits(){return this._getParam(35661)}getMaxCubeMapTextureSize(){return this._getParam(34076)}getMaxFragmentUniformVectors(){return this._getParam(36349)}getMaxRenderbufferSize(){return this._getParam(34024)}getMaxTextureImageUnits(){return this._getParam(34930)}getMaxTextureSize(){return this._getParam(3379)}getMaxVaryingVectors(){return this._getParam(36348)}getMaxVertexAttribs(){return this._getParam(34921)}getMaxVertexTextureImageUnits(){return this._getParam(35660)}getMaxVertexUniformVectors(){return this._getParam(36347)}getMaxViewportDims(){return this._getParam(3386)}getRenderer(){return this._getParam(7937)}getSubpixelBits(){return this._getParam(3408)}getVendor(){return this._getParam(7936)}getVersion(){return this._getParam(7938)}getUnmaskedVendor(){return this._getParam(37445)}getUnmaskedRenderer(){return this._getParam(37446)}_getParam(e){let t=this._paramValues,i=t.get(e);return i||(i=this._gl.getParameter(e),t.set(e,i)),i}}(e);let t=e.getExtension("OES_vertex_array_object");if(!t)throw new Error("OES_vertex_array_object is required.");if(this._vaoExt=t,!e.getExtension("OES_element_index_uint"))throw new Error("OES_element_index_uint is required.");if(!e.getExtension("OES_standard_derivatives"))throw new Error("OES_standard_derivatives is required.");let i=this._boundRenderTarget=this._defaultRenderTarget=new class{constructor(e){this.isClear=!1,this._gl=e}bind(){let e=this._gl;e.bindFramebuffer(e.FRAMEBUFFER,null)}setSize(e,t){let i=this._gl.canvas;i.width=e,i.height=t}get size(){return Ni(this._gl.drawingBufferWidth,this._gl.drawingBufferHeight)}set size(e){let t=this._gl.canvas;t.width=e.width,t.height=e.height}destroy(){}}(e),r=this._boundRenderState=new O;this._unpackPremultiplyAlpha=!1,this._unpackAlignment=4;let{width:s,height:o}=i.size;r.scissorWidth=r.viewportWidth=s,r.scissorHeight=r.viewportHeight=o;let n=this._quadVertexBuffer=new Ts(e,e.ARRAY_BUFFER,e.STATIC_DRAW);n.bind(),e.bufferData(e.ARRAY_BUFFER,Rs,e.STATIC_DRAW),this._quadVao=this.createVao([{attributeMapping:Ss,buffer:n}]),e.bindBuffer(e.ARRAY_BUFFER,null),this._boundProgram=null,this._boundVao=null,this._boundTextures=new Array(this._capabilities.getMaxCombinedTextureImageUnits()),this._boundTextures.fill(null),this._boundTextureUnit=0}getCapabilities(){return this._capabilities}enableFragDepthExtension(){return this._gl.getExtension("EXT_frag_depth")}enableInstancedArraysExtension(){if(this._iaExt)return;let e=this._gl.getExtension("ANGLE_instanced_arrays");if(!e)throw new Error("ANGLE_instanced_arrays is required");this._iaExt=e}createFramebuffer({color:e,depth:t,stencil:i,depthStencil:r}){let s=this._gl,o=0,n=0;e?(o=e.getWidth(),n=e.getHeight()):t?(o=t.getWidth(),n=t.getHeight()):i?(o=i.getWidth(),n=i.getHeight()):r&&(o=r.getWidth(),n=r.getHeight());let a=new class{constructor(e,t){this.isClear=!1,this._gl=e,this._handle=e.createFramebuffer(),this.size=ki(t)}bind(){let e=this._gl;e.bindFramebuffer(e.FRAMEBUFFER,this._handle)}isBound(){let e=this._gl;return e.getParameter(e.FRAMEBUFFER_BINDING)===this._handle}readPixels(e=this.size,t=B,i=new Uint8Array(e.width*e.height*4)){return this._gl.readPixels(t.x,t.y,e.width,e.height,6408,5121,i),i}destroy(){this._gl.deleteFramebuffer(this._handle)}}(s,Ni(o,n));return this.bindRenderTarget(a),e&&e.attachToFramebuffer(s.COLOR_ATTACHMENT0),t&&t.attachToFramebuffer(s.DEPTH_ATTACHMENT),i&&i.attachToFramebuffer(s.STENCIL_ATTACHMENT),r&&r.attachToFramebuffer(s.DEPTH_STENCIL_ATTACHMENT),a}createRenderbuffer(e,t,i){let r=this._gl,s=new class{constructor(e,t,i){this._gl=e,this._handle=e.createRenderbuffer(),this._width=t,this._height=i}bind(){let e=this._gl;e.bindRenderbuffer(e.RENDERBUFFER,this._handle)}isBound(){let e=this._gl;return e.getParameter(e.RENDERBUFFER_BINDING)===this._handle}attachToFramebuffer(e){let t=this._gl;t.framebufferRenderbuffer(t.FRAMEBUFFER,e,t.RENDERBUFFER,this._handle)}getWidth(){return this._width}getHeight(){return this._height}destroy(){this._gl.deleteRenderbuffer(this._handle)}}(r,e,t);return s.bind(),r.renderbufferStorage(r.RENDERBUFFER,i,e,t),s}createEmpty2DTexture(e,t,i,r,s){let o=new Dr(this._gl,e,t,i,r,s);return this._setTextureDataUnpackParams(o.getParams()),this.bindTexture(o),o.initialize(),o}wrapExternalTexture(e){return new Ms(this._gl,e)}createProgram(e,t,i){return new class{constructor(e,t,i,r){this._gl=e;let s=this._handle=e.createProgram();r&&r.defines&&(t=Ps(t,r.defines),i=Ps(i,r.defines));let o=ws(e,e.VERTEX_SHADER,t),n=ws(e,e.FRAGMENT_SHADER,i);e.attachShader(s,o),e.attachShader(s,n),e.deleteShader(o),e.deleteShader(n),r&&r.attribMap&&Object.keys(r.attribMap).forEach((t=>e.bindAttribLocation(s,r.attribMap[t],t))),e.linkProgram(s),this._uniformCache=new Map}bind(){this._gl.useProgram(this._handle)}isBound(){let e=this._gl;return e.getParameter(e.CURRENT_PROGRAM)===this._handle}setIntScalarUniform(e,t){let i=this._getUniformLocation(e);i&&this._gl.uniform1i(i,t)}setScalarUniform(e,t){let i=this._getUniformLocation(e);i&&this._gl.uniform1f(i,t)}setVector2Uniform(e,t){let i=this._getUniformLocation(e);i&&this._gl.uniform2f(i,t.x,t.y)}setVector3Uniform(e,t){let i=this._getUniformLocation(e);i&&this._gl.uniform3f(i,t.x,t.y,t.z)}setVector4Uniform(e,t){let i=this._getUniformLocation(e);i&&this._gl.uniform4f(i,t.x,t.y,t.z,t.w)}setColorUniform(e,t){let i=this._getUniformLocation(e);i&&this._gl.uniform4f(i,t.r,t.g,t.b,t.a)}setMatrix3Uniform(e,t){let i=this._getUniformLocation(e);i&&this._gl.uniformMatrix3fv(i,!1,t)}setMatrix4Uniform(e,t){let i=this._getUniformLocation(e);i&&this._gl.uniformMatrix4fv(i,!1,t)}destroy(){this._gl.deleteProgram(this._handle)}_getUniformLocation(e){let t=this._uniformCache,i=t.get(e);return i||(i=this._gl.getUniformLocation(this._handle,e),t.set(e,i),i)?i:null}}(this._gl,e,t,i)}createVertexBuffer(e,t=35044){return this._createBuffer(this._gl.ARRAY_BUFFER,e,t)}createIndexBuffer(e,t=35044){return this._createBuffer(this._gl.ELEMENT_ARRAY_BUFFER,e,t)}uploadDataToBuffer(e,t,i=0){e.bind(),this._gl.bufferSubData(e.getTarget(),i,t)}createVao(e,t){let i=this._gl,r=new class{constructor(e,t){this._gl=e,this._vaoExt=t,this._handle=t.createVertexArrayOES(),this.onDestroy=this._onDestroy=new qe}bind(){this._vaoExt.bindVertexArrayOES(this._handle)}isBound(){return this._gl.getParameter(this._vaoExt.VERTEX_ARRAY_BINDING_OES)===this._handle}destroy(){this._vaoExt.deleteVertexArrayOES(this._handle),this._onDestroy.fire()}}(i,this._vaoExt);r.bind(),t?t.bind():i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null);for(let{attributeMapping:t,buffer:r,stride:s}of e){r.bind();for(let[e,r]of t.attributes)i.enableVertexAttribArray(e),i.vertexAttribPointer(e,r.size,r.type,r.normalized,s||t.vertexByteSize,r.offset),void 0!==r.divisor&&this._iaExt.vertexAttribDivisorANGLE(e,r.divisor)}return this._vaoExt.bindVertexArrayOES(null),r}setTextureData(e,t,i={x:0,y:0},r={width:e.getWidth(),height:e.getHeight()}){let s=this._gl,o=e.getFormat(),n=e.getType(),a=e.getParams(),{width:l,height:d}=r;this._setTextureDataUnpackParams(a),this.bindTexture(e),s.texSubImage2D(s.TEXTURE_2D,0,i.x,i.y,l,d,o,n,t),this._onTextureDataUpdated(e)}setTextureDataFromDomElement(e,t,i={x:0,y:0}){let r=this._gl,s=e.getFormat(),o=e.getType(),n=e.getParams();this._setTextureDataUnpackParams(n),this.bindTexture(e),r.texSubImage2D(r.TEXTURE_2D,0,i.x,i.y,s,o,t),this._onTextureDataUpdated(e)}resizeTexture(e,t){let i=this._gl,r=e.getFormat(),s=e.getType(),o=e.getParams();e.resize(t),this._setTextureDataUnpackParams(o),this.bindTexture(e),i.texImage2D(i.TEXTURE_2D,0,r,t.width,t.height,0,r,s,null),this._onTextureDataUpdated(e)}getDefaultRenderTarget(){return this._defaultRenderTarget}clearCurrentTarget(e){e&&(this._gl.clear(e),this._boundRenderTarget.isClear=!0)}bindRenderTarget(e){(this._boundRenderTarget!==e||this._skipChecks)&&(e.bind(),this._boundRenderTarget=e);let{width:t,height:i}=e.size;this._setViewportState(new O({viewportWidth:t,viewportHeight:i}))}bindRenderState(e){this._setColorBufferState(e),this._setBlendState(e),this._setCullFaceState(e),this._setFrontFaceState(e),this._setDepthTestState(e),this._setDitherState(e),this._setPolygonOffsetState(e),this._setAlphaToCoverageState(e),this._setSampleCoverageState(e),this._setStencilTestState(e),this._setScissorTestState(e),this._setViewportState(e)}bindProgram(e){(this._boundProgram!==e||this._skipChecks)&&(e.bind(),this._boundProgram=e)}bindVao(e){(this._boundVao!==e||this._skipChecks)&&(e?e.bind():this._vaoExt.bindVertexArrayOES(null),this._boundVao=e)}bindQuadVao(){this.bindVao(this._quadVao)}bindTextureUnit(e){let t=this._gl;(this._boundTextureUnit!==e||this._skipChecks)&&(t.activeTexture(t.TEXTURE0+e),this._boundTextureUnit=e)}bindTexture(e,t,i){let r=this._boundTextureUnit;(this._boundTextures[r]!==e||this._skipChecks)&&(e.bind(),this._boundTextures[r]=e),e.setFilters(t,i)}drawQuad(){this.drawMesh(0,6,4)}drawMesh(e,t,i=4){this._gl.drawArrays(i,e,t),this._boundRenderTarget.isClear=!1}drawIndexedMesh(e,t,i=4,r=5123){this._gl.drawElements(i,t,r,e),this._boundRenderTarget.isClear=!1}drawIndexedMeshInstanced(e,t,i=4,r=5123,s=1){this._iaExt.drawElementsInstancedANGLE(i,t,r,e,s),this._boundRenderTarget.isClear=!1}restoreContext(){this._skipChecks=!0,this.bindRenderTarget(this._boundRenderTarget),this.bindRenderState(this._boundRenderState),this._boundProgram&&this.bindProgram(this._boundProgram),this.bindVao(this._boundVao);for(let e=0;e<this._boundTextures.length;e++){let t=this._boundTextures[e];t&&(this.bindTextureUnit(e),this.bindTexture(t))}this._setTextureDataUnpackParams(Or),this._skipChecks=!1}destroy(){var e;this._quadVao.destroy(),this._quadVertexBuffer.destroy(),this._gl.canvas.removeEventListener("webglcontextlost",this._contextLostListener),null==(e=this._gl.getExtension("WEBGL_lose_context"))||e.loseContext()}static createFromCanvas(t,i){let r=t.getContext("webgl",i);if(!r)throw new Error("Failed to create GL context from canvas.");return new e(r)}_setCapabilityEnabled(e,t){t?this._gl.enable(e):this._gl.disable(e)}_setColorBufferState(e){let t=this._gl,i=this._boundRenderState,r=e.clearColor;(!function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a}(i.clearColor,r)||this._skipChecks)&&(t.clearColor(r.r,r.g,r.b,r.a),S(r,i.clearColor)),(i.colorMaskR!==e.colorMaskR||i.colorMaskG!==e.colorMaskG||i.colorMaskB!==e.colorMaskB||i.colorMaskAlpha!==e.colorMaskAlpha||this._skipChecks)&&(this._gl.colorMask(e.colorMaskR,e.colorMaskG,e.colorMaskB,e.colorMaskAlpha),i.colorMaskR=e.colorMaskR,i.colorMaskG=e.colorMaskG,i.colorMaskB=e.colorMaskB,i.colorMaskAlpha=e.colorMaskAlpha)}_setBlendState(e){let t=this._gl,i=this._boundRenderState;(i.blend!==e.blend||this._skipChecks)&&(this._setCapabilityEnabled(t.BLEND,e.blend),i.blend=e.blend),(e.blend||this._skipChecks)&&((i.blendEquationRgb!==e.blendEquationRgb||i.blendEquationAlpha!==e.blendEquationAlpha||this._skipChecks)&&(t.blendEquationSeparate(e.blendEquationRgb,e.blendEquationAlpha),i.blendEquationRgb=e.blendEquationRgb,i.blendEquationAlpha=e.blendEquationAlpha),(i.blendFuncDstRgb!==e.blendFuncDstRgb||i.blendFuncSrcRgb!==e.blendFuncSrcRgb||i.blendFuncDstAlpha!==e.blendFuncDstAlpha||i.blendFuncSrcAlpha!==e.blendFuncSrcAlpha||this._skipChecks)&&(t.blendFuncSeparate(e.blendFuncSrcRgb,e.blendFuncDstRgb,e.blendFuncSrcAlpha,e.blendFuncDstAlpha),i.blendFuncSrcRgb=e.blendFuncSrcRgb,i.blendFuncDstRgb=e.blendFuncDstRgb,i.blendFuncSrcAlpha=e.blendFuncSrcAlpha,i.blendFuncDstAlpha=e.blendFuncDstAlpha))}_setCullFaceState(e){let t=this._gl,i=this._boundRenderState;(i.cullFace!==e.cullFace||this._skipChecks)&&(this._setCapabilityEnabled(t.CULL_FACE,e.cullFace),i.cullFace=e.cullFace),(e.cullFace&&i.cullFaceMode!==e.cullFaceMode||this._skipChecks)&&(t.cullFace(e.cullFaceMode),i.cullFaceMode=e.cullFaceMode)}_setFrontFaceState(e){let t=this._boundRenderState;(t.frontFaceMode!==e.frontFaceMode||this._skipChecks)&&(this._gl.frontFace(e.frontFaceMode),t.frontFaceMode=e.frontFaceMode)}_setDepthTestState(e){let t=this._gl,i=this._boundRenderState;(i.depthTest!==e.depthTest||this._skipChecks)&&(this._setCapabilityEnabled(t.DEPTH_TEST,e.depthTest),i.depthTest=e.depthTest),(e.depthTest||this._skipChecks)&&((i.clearDepth!==e.clearDepth||this._skipChecks)&&(t.clearDepth(e.clearDepth),i.clearDepth=e.clearDepth),(i.depthMask!==e.depthMask||this._skipChecks)&&(t.depthMask(e.depthMask),i.depthMask=e.depthMask),(i.depthFunc!==e.depthFunc||this._skipChecks)&&(t.depthFunc(e.depthFunc),i.depthFunc=e.depthFunc),(i.depthRangeNear!==e.depthRangeNear||i.depthRangeFar!==e.depthRangeFar||this._skipChecks)&&(t.depthRange(e.depthRangeNear,e.depthRangeFar),i.depthRangeNear=e.depthRangeNear,i.depthRangeFar=e.depthRangeFar))}_setDitherState(e){let t=this._boundRenderState;(t.dither!==e.dither||this._skipChecks)&&(this._setCapabilityEnabled(this._gl.DITHER,e.dither),t.dither=e.dither)}_setPolygonOffsetState(e){let t=this._gl,i=this._boundRenderState;(i.polygonOffset!==e.polygonOffset||this._skipChecks)&&(this._setCapabilityEnabled(t.POLYGON_OFFSET_FILL,e.polygonOffset),i.polygonOffset=e.polygonOffset),(e.polygonOffset&&(i.polygonOffsetFactor!==e.polygonOffsetFactor||i.polygonOffsetUnits!==e.polygonOffsetUnits)||this._skipChecks)&&(t.polygonOffset(e.polygonOffsetFactor,e.polygonOffsetUnits),i.polygonOffsetFactor=e.polygonOffsetFactor,i.polygonOffsetUnits=e.polygonOffsetUnits)}_setAlphaToCoverageState(e){let t=this._boundRenderState;(t.sampleAlphaToCoverage!==e.sampleAlphaToCoverage||this._skipChecks)&&(this._setCapabilityEnabled(this._gl.SAMPLE_ALPHA_TO_COVERAGE,e.sampleAlphaToCoverage),t.sampleAlphaToCoverage=e.sampleAlphaToCoverage)}_setSampleCoverageState(e){let t=this._gl,i=this._boundRenderState;(i.sampleCoverage!==e.sampleCoverage||this._skipChecks)&&(this._setCapabilityEnabled(t.SAMPLE_COVERAGE,e.sampleCoverage),i.sampleCoverage=e.sampleCoverage),(e.sampleCoverage&&(i.sampleCoverageValue!==e.sampleCoverageValue||i.sampleCoverageInvert!==e.sampleCoverageInvert)||this._skipChecks)&&(t.sampleCoverage(e.sampleCoverageValue,e.sampleCoverageInvert),i.sampleCoverageValue=e.sampleCoverageValue,i.sampleCoverageInvert=e.sampleCoverageInvert)}_setStencilTestState(e){let t=this._gl,i=this._boundRenderState;if((i.stencilTest!==e.stencilTest||this._skipChecks)&&(this._setCapabilityEnabled(t.STENCIL_TEST,e.stencilTest),i.stencilTest=e.stencilTest),e.stencilTest||this._skipChecks){(i.clearStencil!==e.clearStencil||this._skipChecks)&&(t.clearStencil(e.clearStencil),i.clearStencil=e.clearStencil),(i.stencilWriteMask!==e.stencilWriteMask||this._skipChecks)&&(t.stencilMask(e.stencilWriteMask),i.stencilWriteMask=e.stencilWriteMask);let r=i.stencilMask!==e.stencilMask||i.stencilReference!==e.stencilReference;(r||this._skipChecks)&&(i.stencilMask=e.stencilMask,i.stencilReference=e.stencilReference),(i.stencilFrontFunc!==e.stencilFrontFunc||r||this._skipChecks)&&(t.stencilFuncSeparate(t.FRONT,e.stencilFrontFunc,e.stencilReference,e.stencilMask),i.stencilFrontFunc=e.stencilFrontFunc),(i.stencilBackFunc!==e.stencilBackFunc||r||this._skipChecks)&&(t.stencilFuncSeparate(t.BACK,e.stencilBackFunc,e.stencilReference,e.stencilMask),i.stencilBackFunc=e.stencilBackFunc),(i.stencilFrontFailOp!==e.stencilFrontFailOp||i.stencilFrontDepthFailOp!==e.stencilFrontDepthFailOp||i.stencilFrontDepthPassOp!==e.stencilFrontDepthPassOp||this._skipChecks)&&(t.stencilOpSeparate(t.FRONT,e.stencilFrontFailOp,e.stencilFrontDepthFailOp,e.stencilFrontDepthPassOp),i.stencilFrontFailOp=e.stencilFrontFailOp,i.stencilFrontDepthFailOp=e.stencilFrontDepthFailOp,i.stencilFrontDepthPassOp=e.stencilFrontDepthPassOp),(i.stencilBackFailOp!==e.stencilBackFailOp||i.stencilBackDepthFailOp!==e.stencilBackDepthFailOp||i.stencilBackDepthPassOp!==e.stencilBackDepthPassOp||this._skipChecks)&&(t.stencilOpSeparate(t.BACK,e.stencilBackFailOp,e.stencilBackDepthFailOp,e.stencilBackDepthPassOp),i.stencilBackFailOp=e.stencilBackFailOp,i.stencilBackDepthFailOp=e.stencilBackDepthFailOp,i.stencilBackDepthPassOp=e.stencilBackDepthPassOp)}}_setScissorTestState(e){let t=this._gl,i=this._boundRenderState;(i.scissorTest!==e.scissorTest||this._skipChecks)&&(this._setCapabilityEnabled(t.SCISSOR_TEST,e.scissorTest),i.scissorTest=e.scissorTest),(e.scissorTest&&e.scissorWidth>=0&&e.scissorHeight>=0&&(i.scissorX!==e.scissorX||i.scissorY!==e.scissorY||i.scissorWidth!==e.scissorWidth||i.scissorHeight!==e.scissorHeight)||this._skipChecks)&&(t.scissor(e.scissorX,e.scissorY,e.scissorWidth,e.scissorHeight),i.scissorX=e.scissorX,i.scissorY=e.scissorY,i.scissorWidth=e.scissorWidth,i.scissorHeight=e.scissorHeight)}_setViewportState(e){let t=this._boundRenderState;(e.viewportWidth>=0&&e.viewportHeight>=0&&(t.viewportX!==e.viewportX||t.viewportY!==e.viewportY||t.viewportWidth!==e.viewportWidth||t.viewportHeight!==e.viewportHeight)||this._skipChecks)&&(this._gl.viewport(e.viewportX,e.viewportY,e.viewportWidth,e.viewportHeight),t.viewportX=e.viewportX,t.viewportY=e.viewportY,t.viewportWidth=e.viewportWidth,t.viewportHeight=e.viewportHeight)}_setTextureDataUnpackParams(e){let t=this._gl;(this._unpackPremultiplyAlpha!==e.premultipliedAlpha||this._skipChecks)&&(t.pixelStorei(37441,+e.premultipliedAlpha),this._unpackPremultiplyAlpha=e.premultipliedAlpha),(this._unpackAlignment!==e.unpackAlignment||this._skipChecks)&&(t.pixelStorei(3317,e.unpackAlignment),this._unpackAlignment=e.unpackAlignment)}_onTextureDataUpdated(e){let t=this._gl;e.getParams().minificationFilter>=9984&&t.generateMipmap(t.TEXTURE_2D)}_createBuffer(e,t,i=this._gl.STATIC_DRAW){let r=this._gl,s=new Ts(r,e,t);return this.bindVao(null),s.bind(),r.bufferData(e,t,i),s}};var Is=(e=>(e[e.X1=0]="X1",e[e.X4=1]="X4",e[e.X16=2]="X16",e))(Is||{});new Array;function Es(e){switch(e){case 1:return-1;case 2:return-2;default:return 0}}var As,Ls=class{constructor(e){this._rootCommunicator=e,this._listeners={},this._rootCommunicator.onMessage.addListener(this._onMessage,this)}destructor(){this._rootCommunicator.onMessage.removeListener(this._onMessage)}getCommunicator(e){let t=this._listeners[e];return t||(t=new qe,this._listeners[e]=t),{onMessage:t,sendMessage:(t,i,...r)=>{this._rootCommunicator.sendMessage({type:e,message:t},i,...r)}}}_onMessage(e){let t=this._listeners[e.type];t&&t.fire(e.message)}},Us=((As=Us||{})[As.OPAQUE_POLYGON=0]="OPAQUE_POLYGON",As[As.TRANSPARENT_POLYGON=1]="TRANSPARENT_POLYGON",As[As.TEXTURED_POLYGON=2]="TEXTURED_POLYGON",As[As.MESH=3]="MESH",As[As.RICH_MODEL=4]="RICH_MODEL",As[As.POLYLINE=5]="POLYLINE",As[As.POINT_LABEL=6]="POINT_LABEL",As[As.CURVED_LABEL=7]="CURVED_LABEL",As[As.ICON=8]="ICON",As);function*Os(e){for(let t in e)yield Number(t)}var Ds=class extends Tr{constructor(e,t,i,r){super(e,t,i,r)}};function zs(e,t,i){let r=[];for(let s of t){let t=e.getPage(s.location.bufferId);if(Ir(t)){let{location:e,id:o}=s,n=void 0!==o?null==i?void 0:i.get(o):void 0;r.push(new Ds(t.vao,e,o,n))}}return r}var Bs=class extends Tr{constructor(e){super(e.vao,e.location,e.id,e.metadata),this.modelId=e.modelId,this.rtc=e.rtc,this.matrix=e.transform,this.bbox=e.bbox,this.colorFactor=S(e.colorFactor),this.colorTexture=e.colorTexture,this.instanceCount=e.instanceCount,this.animateHeight=!1,this.memoryInfo=e.memoryInfo}};function Fs(e,t,i){var r;let s=[];for(let o of t){let t=o.id,n=null==i?void 0:i.get(t),a=Vs(e,o),l=Ns(e,o),d=new Bs({id:t,vao:a.vao,location:o.location,metadata:n,modelId:-1,rtc:o.rtc,transform:o.transform,bbox:o.bbox,colorFactor:o.colorFactor,colorTexture:null==l?void 0:l.texture,instanceCount:o.instanceCount,memoryInfo:{textures:null!=(r=null==l?void 0:l.memoryUsageInBytes)?r:0,geometry:a.memoryUsageInBytes}});s.push(d)}return s}function Vs(e,t){let i=e.getEntity(t.geometryId);return Ir(i,`instantiate rich model ${t.id}: geometry ${t.geometryId}`),i}function Ns(e,t){if(void 0===t.imageId)return;let i=e.getEntity(t.imageId);return Ir(i,`instantiate rich model ${t.id}: image ${t.imageId}`),i}var ks=class extends Tr{constructor(e,t,i,r,s,o){super(t,i,r,s),this.type=e,this.zOrder=o}};function Hs(e,t,i,r){let s=[];for(let o of i){let i=e.getPage(o.location.bufferId);if(Ir(i)){let{location:e,id:n,zOrder:a}=o,l=void 0!==n?null==r?void 0:r.get(n):void 0;s.push(new ks(t,i.vao,e,n,l,null==a?void 0:a.renderObjectZOrder))}}return s}var js=class extends Tr{constructor(e,t,i,r,s){super(e,t,r,s),this.texture=i}},Gs=class extends js{constructor(e,t,i,r,s,o,n){super(e,t,i,s,o),this.type=5,this.opacity=r,this.zOrder=n}};function Ws(e,t,i,r){let s=[];for(let o of i){let i=e.getPage(o.location.bufferId),n=t.getAtlas(o.atlasId);if(Ir(i)&&Ir(n)){let{location:e,id:t,opacity:a,zOrder:l}=o,d=void 0!==t?null==r?void 0:r.get(t):void 0;s.push(new Gs(i.vao,e,n.texture,a,t,d,null==l?void 0:l.renderObjectZOrder))}}return s}var qs=class extends js{constructor(e,t,i,r,s,o){super(e.vao,t,i,s,o),this.page=e,this.minZoom=r}};function Ys(e,t,i,r,s){let o=[];for(let n of i){let i=e.getPage(n.location.bufferId),a=t.getAtlas(n.atlasId);if(Ir(i)&&Ir(a)){let{location:e,id:t}=n,l=void 0!==t?null==s?void 0:s.get(t):void 0;o.push(new qs(i,e,a.texture,r,t,l))}}return o}var Xs=class extends js{constructor(e,t,i,r,s,o,n){super(e,t,i,o,n),this.zIndex=r,this.minZoom=s}};function Zs(e,t,i,r,s){let o=[];for(let n of i){let i=e.getPage(n.location.bufferId),a=t.getAtlas(n.atlasId);if(Ir(i)&&Ir(a)){let{location:e,zIndex:t,id:l}=n,d=void 0!==l?null==s?void 0:s.get(l):void 0;o.push(new Xs(i.vao,e,a.texture,t,r,l,d))}}return o}var $s=class{constructor(e,t,i,r){this._registry=e,this._glyphAtlasRegistry=t,this._iconAtlasRegistry=i,this._additionalMetadata=r}destructor(){}_instantiatePrimitives(e,t){let i={primitives:{},references:[]};e.metadata&&(i.metadata=e.metadata,this._applyAdditionalMetadata(e.metadata)),e.references&&(i.references=i.references||[],i.references.push(...e.references));for(let r of Os(e.primitives))switch(r){case 0:case 1:i.primitives[r]=Hs(this._registry,r,e.primitives[r],e.metadata);break;case 3:i.primitives[r]=zs(this._registry,e.primitives[r],e.metadata);break;case 4:i.primitives[r]=Fs(this._registry,e.primitives[r],e.metadata);break;case 5:i.primitives[r]=Ws(this._registry,this._iconAtlasRegistry,e.primitives[r],e.metadata);break;case 6:case 7:{let s=Math.max(t-2,0);i.primitives[r]=Ys(this._registry,this._glyphAtlasRegistry,e.primitives[r],s,e.metadata);break}case 8:{let s=Math.max(t-1,0);i.primitives[r]=Zs(this._registry,this._iconAtlasRegistry,e.primitives[r],s,e.metadata);break}}return i}_applyAdditionalMetadata(e){if(e&&this._additionalMetadata)for(let t of e.values())for(let[e,i]of this._additionalMetadata)t.set(e,i)}_serializeOptions(e){return g(f({},e),{polygonsBatchingRule:Qs(e.polygonsBatchingRule),polylinesBatchingRule:Qs(e.polylinesBatchingRule),modelsBatchingRule:Qs(e.modelsBatchingRule),labelsBatchingRule:Qs(e.labelsBatchingRule)})}};function Qs(e){if(e){if("function"!=typeof e)throw new Error("Predicate must be a function");return`(${e.toString()})`}}var Ks=class extends $s{constructor(e,t,i,r,s,o,n,a){super(r,s,o,a),this._communicator=e,this._options=n,this._storage=t,this._modelStorage=i,this._onTileContentAdded=this.onTileContentAdded=new qe,this._communicator.onMessage.addListener(this._onMessage,this),this._communicator.sendMessage({type:0,options:this._serializeOptions(this._options)},!1),this._options.customizationConfig&&this._options.customizationConfig.length&&this._updateCustomizationConfig()}destructor(){this._communicator.onMessage.removeListener(this._onMessage),super.destructor()}updateOption(e,t){this._options[e]=t,this._communicator.sendMessage({type:0,options:this._serializeOptions(this._options)},!1)}updateCustomizationConfig(e){this._options.customizationConfig=e,this._updateCustomizationConfig()}_onMessage(e){switch(e.type){case 3:this._onAddPrimitives(e);break;case 5:this._onAddModelPrimitives(e);break;case 4:this._onRemovePrimitives(e)}}_onAddPrimitives(e){let t=this._storage.get(e.tileId);if(Ir(t)){let i=function(e,t){return e.zoom-Es(t)}(t.tile,this._options.tileSize),r=this._instantiatePrimitives(e.content,i);t.addContent(r),this._onTileContentAdded.fire(t,r,e.metrics)}}_onRemovePrimitives(e){let t=this._storage.get(e.tileId);if(Ir(t)){let i={primitives:{},references:[]};for(let r of e.content){let e=t.content.primitives[r];Js(i.primitives,r,e&&[...e])}t.removeContent(i)}}_onAddModelPrimitives(e){let t=this._modelStorage.get(e.modelId),i=e.content.metadata;if(Ir(t)){let r=e.content.primitives[3],s=e.content.primitives[4],o=r?zs(this._registry,r,e.content.metadata):void 0,n=s?Fs(this._registry,s,e.content.metadata):void 0;(o||n)&&(this._applyAdditionalMetadata(i),t.addContent({primitives:{3:o,4:n},metadata:i}))}}_updateCustomizationConfig(){this._communicator.sendMessage({type:2,customizationConfig:this._options.customizationConfig},!1)}};function Js(e,t,i){e[t]=i}function eo(e,t){return e.x+"_"+e.y+"_"+e.zoom+"_"+t}function to(e,t){return g(f({},e),{id:eo(e,t)})}function io(e,t){let i=[];for(let[r,s]of e)t.has(r)||i.push(s);return i}function ro(e,t,i){let r=e.get(t);return r||(r=i(),e.set(t,r)),r}var so={x:0,y:0,zoom:0};var oo=vt(((e,t=f({},H))=>G(Ti(e),t))),no=class{constructor(e,t){this._communicator=e,this._camera=t}sendMessageToBackend(e,t){ho(this._communicator,this._camera,e,t)}destroy(){}},ao=class{constructor(e,t,i){this._sendDelayedMessageToBackend=()=>{this._timerId=void 0,ho(this._communicator,this._camera,[...this._visibleTilesToAdd.values()],[...this._visibleTilesToRemove.values()]),this._visibleTilesToAdd.clear(),this._visibleTilesToRemove.clear()},this._timerId=void 0,this._visibleTilesToAdd=new Map,this._visibleTilesToRemove=new Map,this._communicator=e,this._camera=t,this._delay=i}sendMessageToBackend(e,t,i){clearTimeout(this._timerId),function(e,t,i,r){for(let r of i)t.delete(r.id)||e.set(r.id,r);for(let i of r)e.delete(i.id)||t.set(i.id,i)}(this._visibleTilesToAdd,this._visibleTilesToRemove,e,t),i?this._sendDelayedMessageToBackend():this._timerId=setTimeout(this._sendDelayedMessageToBackend,this._delay)}destroy(){clearTimeout(this._timerId)}},lo=10;function ho(e,t,i,r){e.sendMessage({type:1,cameraPosition:{x:t.center.x,y:t.center.y,zoom:t.zoom},visibleTilesToAdd:i,visibleTilesToRemove:r},!0)}var co=class{get size(){return this._items.size}get items(){return this._items.values()}constructor(){this._items=new Map,this.onAdded=this._onAdded=new qe,this.onRemoved=this._onRemoved=new qe}get(e){return this._items.get(e)}has(e){return this._items.has(e)}_add(e,t){this._items.set(e,t),this._onAdded.fire(t)}_remove(e){let t=this._items.get(e);t&&(this._items.delete(e),this._onRemoved.fire(t))}},uo=class extends co{constructor(e){super(),this._communicator=e,this._communicator.onMessage.addListener(this._onMessage,this)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}_onMessage(e){switch(e.type){case 0:this._onAdd(e);break;case 1:this._onRemove(e)}}_onAdd(e){this._add(e.id,this._deserialize(e.item))}_onRemove(e){this._remove(e.id)}};function*_o(e,t){for(let i of e.references||[])i.type===t&&(yield i.value)}var po=class{constructor(e){this.content=this._content=e,this.onContentAdded=this._onContentAdded=new qe,this.onContentRemoved=this._onContentRemoved=new qe}addContent(e){for(let t of Os(e.primitives))this._content.primitives[t]||(this._content.primitives[t]=this._createStorage()),e.primitives[t]&&this._addPrimitives(this._content.primitives[t],e.primitives[t]);if(e.references&&(this._content.references=this._content.references||[],this._content.references.push(...e.references)),e.metadata){this._content.metadata=this._content.metadata||new Map;for(let[t,i]of e.metadata)this._content.metadata.set(t,i)}this._onContentAdded.fire(this,e)}removeContent(e){for(let t of Os(e.primitives)){let i=this._content.primitives[t],r=e.primitives[t];i&&r&&this._removePrimitives(i,r)}if(e.references&&this._content.references){let t=e.references||[];Ae(this._content.references,t)}if(e.metadata&&this._content.metadata)for(let t of e.metadata.keys())this._content.metadata.delete(t);this._onContentRemoved.fire(this,e)}},mo=class extends po{_createStorage(){return[]}_addPrimitives(e,t){e.push(...t)}_removePrimitives(e,t){Ae(e,t)}},fo=class extends mo{constructor(e){super({primitives:{},references:[]}),this.id=e.id,this.tile=e}},go=class extends uo{_deserialize(e){return new fo(e)}};function vo(e){let t="";for(let i=e.zoom;i>0;i--){let r="0",s=1<<i-1;e.x&s&&(r="1"),e.y&s&&(r="1"===r?"3":"2"),t+=r}return t}function yo(e,t){let i=t.zoom-e.zoom;return i>0&&t.x>>i===e.x&&t.y>>i===e.y}function xo(e){return!(!e.content.primitives[0]&&!e.content.primitives[1]||!e.content.primitives[6]&&!e.content.primitives[7])}var bo=class{constructor(e,t,i,r,s=xo){this._viewport=e,this._storage=t,this._tileContentVisibilityManager=i,this._modelVisibilityManager=r,this.isTileVisualizable=s,this._allTileNodes=new Map,this._visualizableTileNodeByQuadKey=new Map,this._visibleTileNodes=new Map,this._visualizedTileNodes=new Map,this._mode=0,this._onViewportStateChanged=new qe,this.viewportState=this._viewportState={visibleTileNumber:0,visualizableTileNumber:0},this._onTileVisualized=new qe,this._onTileHidden=new qe,this._viewport.onViewportChanged.addListener(this._onViewportUpdate,this),this._storage.onAdded.addListener(this._onTileAdd,this),this._storage.onRemoved.addListener(this._onTileRemove,this)}get onViewportStateChanged(){return this._onViewportStateChanged}get onTileVisualized(){return this._onTileVisualized}get onTileHidden(){return this._onTileHidden}destructor(){this._viewport.onViewportChanged.removeListener(this._onViewportUpdate),this._storage.onAdded.removeListener(this._onTileAdd),this._storage.onRemoved.removeListener(this._onTileRemove),clearTimeout(this._changeModeTimer)}getVisualizedTiles(){return[...ve(this._visualizedTileNodes.values(),(e=>e.tile))]}_onTileAdd(e){let t=this.isTileVisualizable(e),i=this._getTileNode(e.tile);i.tile=e,i.isVisualizable=t,t&&this._visualizableTileNodeByQuadKey.set(i.quadKey,i),i.isVisible&&i.isVisualizable&&!i.isVisualized&&this._tryToVisualizeViewport(),e.onContentAdded.addListener(this._onTileContentAdded,this)}_onTileContentAdded(e){let t=this._getTileNode(e.tile);t.isVisualizable=t.isVisualizable||this.isTileVisualizable(e),t.isVisualizable&&this._visualizableTileNodeByQuadKey.set(t.quadKey,t),t.isVisible&&t.isVisualizable&&this._tryToVisualizeViewport()}_onTileRemove(e){let t=this._getTileNode(e.tile);t.isVisible||(this._allTileNodes.delete(t.tileItem.id),this._visualizableTileNodeByQuadKey.delete(t.quadKey)),t.isVisualized&&this._makeNotVisualized(t),delete t.tile,e.onContentAdded.removeListener(this._onTileContentAdded)}_onViewportUpdate({visibleAdded:e,visibleRemoved:t}){for(let t of e){let e=this._getTileNode(t);this._makeVisible(e)}for(let e of t){let t=this._getTileNode(e);this._makeNotVisible(t)}if(e.length>0){let t=new Set,i=e[0].zoom;for(let e of this._visualizedTileNodes.values())t.add(e.tileItem.zoom);if(t.size<=2&&t.has(i+1))for(let e of this._visibleTileNodes.values())if(e.isVisualizable)this._makeVisualized(e);else for(let t=0;t<4;t++){let i=this._visualizableTileNodeByQuadKey.get(e.quadKey+t);i&&this._makeVisualized(i)}else if(t.size<=2&&t.has(i))for(let e of this._visibleTileNodes.values())if(e.isVisualizable)this._makeVisualized(e);else{let t=e.quadKey.slice(0,-1),i=this._visualizableTileNodeByQuadKey.get(t);if(i){let e=!0;for(let i=0;i<4;i++)this._visualizableTileNodeByQuadKey.get(t+i)&&(e=!1);e&&this._makeVisualized(i)}}}!this._changeModeTimer&&0===this._mode&&(this._changeModeTimer=setTimeout((()=>{this._mode=1,this._tryToVisualizeViewport()}),800)),this._tryToVisualizeViewport()}_tryToVisualizeViewport(){let e=this._visibleTileNodes.size;if(e===be(this._visibleTileNodes.values(),(e=>e.isVisualizable))){clearTimeout(this._changeModeTimer),this._changeModeTimer=0,this._mode=0;for(let e of this._visualizedTileNodes.values())e.isVisible||this._makeNotVisualized(e);for(let e of this._visibleTileNodes.values())this._makeVisualized(e)}else if(1===this._mode)for(let e of this._visibleTileNodes.values())if(!e.isVisualized&&e.isVisualizable){let t=!1;for(let i of this._visualizedTileNodes.values())if(yo(e.tileItem,i.tileItem)||e.quadKey===i.quadKey)this._makeNotVisualized(i);else if(yo(i.tileItem,e.tileItem)){let e=i,r=[];for(let t of this._visibleTileNodes.values())yo(e.tileItem,t.tileItem)&&r.push(t);xe(r,(e=>e.isVisualizable))?this._makeNotVisualized(e):t=!0}t||this._makeVisualized(e)}let t=be(this._visibleTileNodes.values(),(e=>e.isVisualized));(e!==this._viewportState.visibleTileNumber||t!==this._viewportState.visualizableTileNumber)&&(this._viewportState.visibleTileNumber=e,this._viewportState.visualizableTileNumber=t,this._onViewportStateChanged.fire(this._viewportState))}_makeVisible(e){e.isVisible||(e.isVisible=!0,this._visibleTileNodes.set(e.id,e))}_makeNotVisible(e){e.isVisible&&(e.isVisible=!1,this._visibleTileNodes.delete(e.id))}_makeVisualized(e){let t=e.tile;e.isVisualizable&&!e.isVisualized&&t&&(this._tileContentVisibilityManager.showObject(t),this._modelVisibilityManager.showTileModels(t),e.isVisualized=!0,this._visualizedTileNodes.set(e.id,e),this._onTileVisualized.fire(t))}_makeNotVisualized(e){let t=e.tile;e.isVisualized&&t&&(this._tileContentVisibilityManager.hideObject(t),this._modelVisibilityManager.hideTileModels(t),e.isVisualized=!1,this._visualizedTileNodes.delete(e.id),this._onTileHidden.fire(t))}_getTileNode(e){let t=this._allTileNodes.get(e.id);if(t)return t;{let t={id:e.id,tileItem:e,quadKey:vo(e),isVisualizable:!1,isVisible:!1,isVisualized:!1};return this._allTileNodes.set(e.id,t),t}}},To=class{constructor(e,t,i){this._onMessage=e=>{switch(e.type){case 1:this._onAtlasAdd(e);break;case 2:this._onAtlasUpdate(e);break;case 3:this._onAtlasRemove(e)}},this._communicator=e,this._context=i,this._options=t,this._atlases=[],this._memoryUsage={memoryForGlyphs:0},this._onMemoryUsageChanged=new qe,this._communicator.onMessage.addListener(this._onMessage),this._syncOptions()}get memoryUsage(){return this._memoryUsage}get onMemoryUsageChanged(){return this._onMemoryUsageChanged}destructor(){this._communicator.onMessage.removeListener(this._onMessage);for(let e of this._atlases)e.destructor();this._atlases.length=0}getAtlas(e){return this._atlases[e]}updateOption(e,t){this._options[e]=t,this._syncOptions()}_onAtlasAdd(e){this._atlases[e.atlasId]=new class{constructor(e,t,i){this._context=e,this.texture=e.createEmpty2DTexture(t,i,6406,5121,{wrapS:33071,wrapT:33071,magnificationFilter:9729,minificationFilter:9729,premultipliedAlpha:!1,unpackAlignment:1}),"string"==typeof navigator.vendor&&navigator.vendor.match(/^Apple/)&&this.updateContent(z(0,0),Ni(1,1),new Uint8Array(1))}destructor(){this.texture.destroy()}updateContent(e,t,i){this._context.setTextureData(this.texture,i,e,t)}}(this._context,e.width,e.height)}_onAtlasUpdate(e){let{atlasId:t,data:i,offset:r,size:s}=e,o=this._atlases[t];Ir(o)&&o.updateContent(r,s,i)}_onAtlasRemove(e){let t=this._atlases[e.atlasId];Ir(t)&&(t.destructor(),delete this._atlases[e.atlasId])}_syncOptions(){this._communicator.sendMessage({type:0,options:this._options},!1)}},Po=(Symbol.iterator,Symbol.iterator,function(e,t,i,r){}(Number.MAX_SAFE_INTEGER,Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,Number.MIN_SAFE_INTEGER),class{constructor(e,t,i){this._onMessage=e=>{switch(e.type){case 1:this._onAddAtlas(e);break;case 2:this._onUpdateAtlas(e);break;case 3:this._onRemoveAtlas(e)}},this._communicator=e,this._context=i,this._options=t,this._atlases=[],this._memoryUsage={memoryForIcons:0},this._onMemoryUsageChanged=new qe,this._communicator.onMessage.addListener(this._onMessage),this._syncOptions()}get memoryUsage(){return this._memoryUsage}get onMemoryUsageChanged(){return this._onMemoryUsageChanged}destructor(){this._communicator.onMessage.removeListener(this._onMessage);for(let e of this._atlases)e.destructor();this._atlases.length=0}getAtlas(e){return this._atlases[e]}updateOption(e,t){this._options[e]=t,this._syncOptions()}_onAddAtlas(e){this._atlases[e.atlasId]=new class{constructor(e,t,i){this._context=e,this.texture=e.createEmpty2DTexture(t,i,6408,5121,{wrapS:33071,wrapT:33071,magnificationFilter:9728,minificationFilter:9728,premultipliedAlpha:!0,unpackAlignment:1}),this.onContentUpdated=this._onContentUpdated=new qe}destructor(){this.texture.destroy()}updateContent(e){this._context.setTextureData(this.texture,e.data,e.offset,e.size),this._onContentUpdated.fire()}}(this._context,e.atlasWidth,e.atlasHeight)}_onUpdateAtlas(e){let t=this._atlases[e.atlasId];Ir(t)&&t.updateContent(e.atlasRegion)}_onRemoveAtlas(e){let t=this._atlases[e.atlasId];Ir(t)&&(t.destructor(),delete this._atlases[e.atlasId])}_syncOptions(){this._communicator.sendMessage({type:0,options:this._options},!1)}}),wo=class extends mo{constructor(e){super({primitives:{}}),this.id=e}},Mo=class extends uo{_deserialize(e){return new wo(e)}},Ro="_vector_",So={objectId:"objectId",position:"position",priority:Ro+"priority",zoom:Ro+"zoom",selectedIconUrl:Ro+"selectedIconUrl",richModel:Ro+"richModel",footprintModelId:Ro+"footprintModelId"};function Co(e){return null==e?void 0:e.get(So.objectId)}function*Io(e){yield*_o(e.content,"model")}var Eo=class e{constructor(){this._marks=new Map}mark(e){this._marks.set(e,Gi())}unmark(e){this._marks.delete(e)}measure(t,i=!1){let r=this._marks.get(t);return void 0!==r?(i||this.unmark(t),Gi()-r):e.UNMEASURED}};Eo.UNMEASURED=-1;var Ao,Lo=Eo,Uo={postfix:"",reduce:e=>e[0]},Oo={postfix:"Max",reduce:e=>e[e.length-1]},Do={postfix:"Avg",reduce:e=>e.reduce(((e,t)=>e+t),0)/e.length},zo=class{constructor(e,t,i=1,r=[Uo],s){this._transport=e,this._name=t,this._maxItems=i,this._reducers=r,this._additionalParams=s,this._values={},this._marker=new Lo}mark(e){this._marker.mark(e)}unmark(e){this._marker.unmark(e)}putMeasuredValue(e,t=e,i){let r=this._marker.measure(e,i);r!==Lo.UNMEASURED&&this.putValue(t,r)}putValue(e,t){let i=this._values[e];i||(i=this._values[e]=[]),i.length<this._maxItems&&i.push(t),function(e){return"function"==typeof e.putValue}(this._transport)&&this._transport.putValue(this._name,e,t,this._additionalParams)}putValues(e){for(let t of Object.keys(e)){let i=t,r=e[i];void 0!==r&&this.putValue(i,r)}}submit(){(function(e){return"function"==typeof e.submit})(this._transport)&&this._hasValues()&&this._transport.submit(this._name,this._getReducedValues()),this._clearValues()}_getReducedValues(){let e=f({},this._additionalParams);for(let t of Object.keys(this._values)){let i=t,r=this._values[i];if(r&&r.length>0){r.sort(((e,t)=>e-t));for(let t of this._reducers)e[i+t.postfix]=t.reduce(r).toFixed(2)}}return e}_hasValues(){return Object.keys(this._values).length>0}_clearValues(){this._values={}}},Bo=class{constructor(e,t,i,r){let s=[Do];this._metrics=new zo(e,t,1024,s,f({firstViewport:"0"},r)),this._firstViewportMetrics=new zo(e,t,1024,s,f({firstViewport:"1"},r)),this._firstViewportTiles=new Set,this._isFirstViewport=!0,this._camera=i}addTilesToMeasure(e){this._firstViewportState||(this._firstViewportState={x:this._camera.center.x,y:this._camera.center.y,zoom:this._camera.zoom}),this._isFirstViewport&&(this._firstViewportState.x!==this._camera.center.x||this._firstViewportState.y!==this._camera.center.y||this._firstViewportState.zoom!==this._camera.zoom)&&(this._isFirstViewport=!1),this._isFirstViewport?(this._firstViewportTiles.add(e),this._firstViewportMetrics.mark(e)):this._metrics.mark(e)}measure(e,t){this._firstViewportTiles.size>0&&this._firstViewportTiles.has(e)?this._firstViewportMetrics.putMeasuredValue(e,t,!0):this._metrics.putMeasuredValue(e,t,!0)}removeTileMeasurement(e){this._firstViewportTiles.size>0&&this._firstViewportTiles.delete(e)?this._firstViewportMetrics.unmark(e):this._metrics.unmark(e)}putValues(e,t){this._firstViewportTiles.size>0&&this._firstViewportTiles.has(e)?this._firstViewportMetrics.putValues(t):this._metrics.putValues(t)}submit(){this._firstViewportMetrics.submit(),this._metrics.submit()}},Fo=((Ao=Fo||{})[Ao.DEFAULT=0]="DEFAULT",Ao[Ao.NIGHT=1]="NIGHT",Ao);var Vo=class{constructor(e){this.onUpdate=this._onUpdate=new qe,this._camera=e,this._onZoomUpdated=this._onZoomUpdated.bind(this),e.onUpdate.addListener(this._onZoomUpdated)}destructor(){this._camera.onUpdate.removeListener(this._onZoomUpdated)}test(e){return this._camera.zoom>=e.minZoom}_onZoomUpdated(){this._prevZoom!==this._camera.zoom&&(this._onUpdate.fire(),this._prevZoom=this._camera.zoom)}},No=class{constructor(e){this._storages=e,this._index=new Map;for(let e of this._storages){for(let t of e.items)this._onObjectAdded(t);e.onAdded.addListener(this._onObjectAdded,this),e.onRemoved.addListener(this._onObjectRemoved,this)}}destructor(){for(let e of this._storages){for(let t of e.items)this._onObjectRemoved(t);e.onAdded.removeListener(this._onObjectAdded),e.onRemoved.removeListener(this._onObjectRemoved)}}getMetadata(e){var t;return null==(t=this._index.get(e))?void 0:t.metadata}_onObjectAdded(e){this._onContentAdded(e,e.content),e.onContentAdded.addListener(this._onContentAdded,this),e.onContentRemoved.addListener(this._onContentRemoved,this)}_onObjectRemoved(e){this._onContentRemoved(e,e.content),e.onContentAdded.removeListener(this._onContentAdded),e.onContentRemoved.removeListener(this._onContentRemoved)}_onContentAdded(e,t){t.metadata&&this._addPrimitivesMetadata(t.metadata)}_onContentRemoved(e,t){t.metadata&&this._removePrimitivesMetadata(t.metadata)}_addPrimitivesMetadata(e){for(let[t,i]of e.entries())this._retain(t,i)}_removePrimitivesMetadata(e){for(let t of e.keys())this._release(t)}_retain(e,t){let i=this._index.get(e);i?i.count++:this._index.set(e,{metadata:t,count:1})}_release(e){let t=this._index.get(e);t&&(t.count--,0===t.count&&this._index.delete(e))}},ko=(e=>(e[e.GROUND=100]="GROUND",e))(ko||{}),Ho=class extends br{constructor(e,t){super(t),this._appearingEffectDuration=e,this._timeoutIds=new Set,this._removeSchedulerFlagKey=Symbol("1"),this._scheduler=yr(this._scheduleRemovePrimitives.bind(this),!0),this._scheduledForRemovePrimitives=[]}get primitives(){return this._primitives}add(e){super.add(e);for(let t of e){let e=t[this._removeSchedulerFlagKey];e&&e.isScheduledForRemove&&(e.isScheduledForRemove=!1)}}delete(e){this.hide(e);for(let t of e){let e=t[this._removeSchedulerFlagKey];e||(e={isScheduledForRemove:!0},t[this._removeSchedulerFlagKey]=e),e.isScheduledForRemove=!0}this._scheduledForRemovePrimitives.push(...e),this._scheduler()}destroy(){for(let e of this._timeoutIds)clearTimeout(e)}_scheduleRemovePrimitives(){let e=setTimeout((t=>{super.delete([...ye(t,(e=>{let t=e[this._removeSchedulerFlagKey];return void 0!==t&&t.isScheduledForRemove}))]),this._timeoutIds.delete(e)}),this._appearingEffectDuration,[...this._scheduledForRemovePrimitives]);this._scheduledForRemovePrimitives.length=0,this._timeoutIds.add(e)}},jo=class{constructor(...e){this.onUpdate=this._onUpdate=new qe,this._filterUpdateListener=()=>this._onUpdate.fire();for(let t of e)t.onUpdate&&t.onUpdate.addListener(this._filterUpdateListener);this._filters=new Set(e)}addFilter(e){this._filters.has(e)||(this._filters.add(e),e.onUpdate&&e.onUpdate.addListener(this._filterUpdateListener),this._onUpdate.fire())}deleteFilter(e){this._filters.delete(e)&&(e.onUpdate&&e.onUpdate.removeListener(this._filterUpdateListener),this._onUpdate.fire())}test(e){return xe(this._filters,(t=>t.test(e)))}},Go=class{constructor(e,t,i,r,s,o,n){this._onVisibleObjectSceneUpdate=()=>{this._onVisibleObjectsChanged.fire()},this._isPaused=!1,this.name=e,this._context=t,this._camera=i,this._gpuMemoryRegistry=r,this._glyphAtlasRegistry=s,this._iconAtlasRegistry=o,this._objectMetadataIndex=n,this.scene=this._createScene(),this._contentVisibilityManager=new class{constructor(e){this._scene=e,this._filteringManagers={}}destructor(){}addFilter(e,t){let i=this._filteringManagers[e];if(!i){let t=this._scene[e],r=new class{constructor(e){this._storage=e}add(e){this._storage.add(e)}remove(e){this._storage.delete(e)}show(e){this.add(e)}hide(e){this.remove(e)}}(t);i=new class{constructor(e){this._scene=e,this._filter=new jo,this._visible=new gr,this._hidden=new gr,this._onFilterUpdate=this._onFilterUpdate.bind(this),this._filter.onUpdate.addListener(this._onFilterUpdate,this)}addPrimitives(e){let t=[],i=[];for(let r of e)this._filter.test(r)?(t.push(r),this._visible.add(r)):(i.push(r),this._hidden.add(r));this._scene.add(t),this._scene.add(i),this._scene.show(t),this._scene.hide(i)}removePrimitives(e){this._scene.remove(e);for(let t of e)this._visible.remove(t),this._hidden.remove(t)}addFilter(e){this._filter.addFilter(e)}removeFilter(e){this._filter.deleteFilter(e)}_onFilterUpdate(){let e=[];for(let t of this._visible)this._filter.test(t)||(e.push(t),this._visible.remove(t),this._hidden.add(t));this._scene.hide(e);let t=[];for(let e of this._hidden)this._filter.test(e)&&(t.push(e),this._visible.add(e),this._hidden.remove(e));this._scene.show(t)}}(r),this._filteringManagers[e]=i}return i.addFilter(t),this}removeFilter(e,t){let i=this._filteringManagers[e];return i&&i.removeFilter(t),this}showObject(e){this._showObjectContent(e,e.content),e.onContentAdded.addListener(this._onContentAdded,this),e.onContentRemoved.addListener(this._onContentRemoved,this)}hideObject(e){this._hideObjectContent(e,e.content),e.onContentAdded.removeListener(this._onContentAdded),e.onContentRemoved.removeListener(this._onContentRemoved)}_showObjectContent(e,t){for(let e of Os(t.primitives)){let i=t.primitives[e];if(i&&i.length>0){let t=this._filteringManagers[e];t?t.addPrimitives(i):this._scene[e].add(i)}}}_hideObjectContent(e,t){for(let e of Os(t.primitives)){let i=t.primitives[e];if(i){let t=this._filteringManagers[e];t?t.removePrimitives(i):this._scene[e].delete(i)}}}_onContentAdded(e,t){this._showObjectContent(e,t)}_onContentRemoved(e,t){this._hideObjectContent(e,t)}}(this.scene),this.memoryUsage=this._memoryUsage=f(f({},this._glyphAtlasRegistry.memoryUsage),this._iconAtlasRegistry.memoryUsage),this._onMemoryUsageChanged=new qe,this._onVisibleObjectsChanged=new qe,this._addUpdateToVisibleObjectScenes()}get isPaused(){return this._isPaused}get onMemoryUsageChanged(){return this._onMemoryUsageChanged}get onVisibleObjectsChanged(){return this._onVisibleObjectsChanged}destructor(){this._removeUpdateToVisibleObjectScenes(),this._contentVisibilityManager.destructor()}getObjectMetadata(e){return this._objectMetadataIndex.getMetadata(e)}getVisibleObjects(){let e={},t={},i={icon:this.scene[8].visiblePrimitives,label:this.scene[6].visiblePrimitives,model:this.scene[4].primitives};Object.entries(i).forEach((([i,r])=>{for(let{metadata:s}of r){let r=Co(s);if(r){if("model"===i&&!t[r]){t[r]=s;continue}e[r]||(e[r]={metadata:s,icon:!1,label:!1}),e[r][i]=!0}}}));let r=[];return Object.keys(e).forEach((t=>{let{metadata:i,icon:s,label:o}=e[t];r.push({objectId:t,metadata:i,type:s&&o?"icon-label":o?"label":"icon"})})),Object.keys(t).forEach((e=>{r.push({objectId:e,metadata:t[e],type:"model"})})),r}pause(){this._isPaused=!0}resume(){this._isPaused=!1}_createScene(){return{100:new xr,0:new xr,1:new xr,2:new xr,5:new xr,3:new xr,4:new xr,6:new Ho(150),7:new Ho(150),8:new Ho(150)}}_createAdditionalMetadata(){return new Map([[Ro+"layerName",this.name]])}_onMemoryUsageComponentChange(e){Object.assign(this._memoryUsage,e),this._onMemoryUsageChanged.fire(this._memoryUsage)}_addUpdateToVisibleObjectScenes(){this.scene[8].onUpdate.addListener(this._onVisibleObjectSceneUpdate),this.scene[6].onUpdate.addListener(this._onVisibleObjectSceneUpdate),this.scene[4].onUpdate.addListener(this._onVisibleObjectSceneUpdate)}_removeUpdateToVisibleObjectScenes(){this.scene[8].onUpdate.removeListener(this._onVisibleObjectSceneUpdate),this.scene[6].onUpdate.removeListener(this._onVisibleObjectSceneUpdate),this.scene[4].onUpdate.removeListener(this._onVisibleObjectSceneUpdate)}},Wo="start";function qo(e){let t=setInterval(e,5e3);return window.addEventListener("beforeunload",e),()=>{clearInterval(t)}}var Yo=class extends Go{constructor(e,t,i,r,s,o,n){let a=f({dpr:Vi()},s),l=new Ls(e),d=new go(l.getCommunicator(1)),h=new Mo(l.getCommunicator(2));super(o,i,t,r,new To(l.getCommunicator(4),a,i),new Po(l.getCommunicator(5),a,i),new No([d,h])),this._submitMetrics=()=>{this._metricsCollector.submit(),this._viewportMetricsCollector.submit()},this._options=a,this._commutator=l,this._storage=d,this._modelStorage=h,this._metricsTransport=n,this._viewport=new class{get visibleTiles(){return this._visibleTiles.values()}set tileIdPrefix(e){this._tileIdPrefix=e,this._syncOptions()}constructor(e,t,i,r=new class{constructor(e,t,i=.5,r=1/0){this._camera=e,this._zoomShift=Es(t),this._targetZoomShift=i,this._maxZoomWithTilesLoading=r}recalculateVisibleTiles(){let e=this._camera,t=Math.min(this._getTargetZoom(),this._maxZoomWithTilesLoading);return function*(e,t,i,r,s){if(0===s)return void(yield so);let o=1<<s,n=o-1,{minX:a,maxX:l,minY:d,maxY:h}=t,c=Math.floor((a+1)*o/2),u=Math.floor((l+1)*o/2),_=u-c+1,p=new Array(_),m=new Array(_);p.fill(Math.floor((1-d)*o/2)),m.fill(Math.floor((1-h)*o/2));let f=e.length,g=e[f-1].x+1,v=1-e[f-1].y,y=Math.floor(g*o/2),x=Math.floor(v*o/2);for(let t=0;t<f;++t){let i=e[t].x+1,r=1-e[t].y,s=Math.floor(i*o/2),n=Math.floor(r*o/2),a=Math.abs(s-y)+Math.abs(n-x),l=i-g,d=r-v,h=l>0?1:-1,u=d>0?1:-1,_=2*h*d,f=-2*h*l,b=h*o*(l*v-d*g)+_*(~h>>>31);for(let e=0,t=y,i=x;e<a;++e){let e=_*t+f*i+b;0<=e&&e<=-f?t+=h:i+=u;let r=t-c;m[r]<i&&(m[r]=i),p[r]>i&&(p[r]=i)}g=i,v=r,y=s,x=n}if(2===i&&_>o)for(let e=0;e<o;++e)for(let t=e+o;t<_;t+=o)m[e]<m[t]&&(m[e]=m[t]),p[e]>p[t]&&(p[e]=p[t]);if(2===r)for(let e=0;e<_&&e<o;++e){let t=m[e]-p[e];if(t>o)p[e]=0,m[e]=n;else{let i=p[e]&=n;m[e]=i+t}}else for(let e=0;e<_&&e<o;++e)p[e]=Math.max(p[e],0),m[e]=Math.min(m[e],n);if(2===i)for(let e=0;e<_&&e<o;++e){let t=e+c&n;for(let i=p[e];i<=m[e];++i)yield{x:t,y:i&n,zoom:s}}else for(let e=Math.max(c,0),t=Math.min(u,n);e<=t;++e){let t=e-c;for(let i=p[t];i<=m[t];++i)yield{x:e,y:i&n,zoom:s}}}(Ti(e),oo(e),e.options.wrapModeX,e.options.wrapModeY,Math.max(0,t+this._zoomShift))}_getTargetZoom(){return Math.floor(this._camera.zoom+this._targetZoomShift)}}(t,i.tileSize,i.targetZoomShift,i.maxZoomWithTilesLoading),s=""){this._camera=t,this._communicator=e,this._options=i,this._visibleTilesCalculator=r,this._tileIdPrefix=s,this._visibleTiles=new Map,this.onViewportChanged=this._onViewportChanged=new qe;let o=Number(i.cameraIdleThrottling)||0;this._messageSender=o<=lo?new no(e,t):new ao(e,t,o),this._onCameraUpdateWrapper=this._onCameraUpdate.bind(this),this._camera.onUpdate.addListener(this._onCameraUpdateWrapper),this._syncOptions()}destructor(){this.pause(),this._camera.onUpdate.removeListener(this._onCameraUpdateWrapper),this._messageSender.destroy()}forceCameraStateRecalculation(e=!1){this._onCameraUpdate(e)}pause(){this._camera.onUpdate.removeListener(this._onCameraUpdateWrapper),this._fireUpdates([],[...this._visibleTiles.values()],!0),this._visibleTiles.clear()}resume(){this._camera.onUpdate.addListener(this._onCameraUpdateWrapper,this),this.forceCameraStateRecalculation(!0)}_onCameraUpdate(e){let t=new Map;for(let e of this._visibleTilesCalculator.recalculateVisibleTiles()){let i=to(e,this._tileIdPrefix);t.set(i.id,i)}let i=this._visibleTiles;this._visibleTiles=t;let r=io(t,i),s=io(i,t);(r.length>0||s.length>0)&&this._fireUpdates(r,s,e)}_syncOptions(){var e;this._communicator.sendMessage({type:0,tileIdPrefix:this._tileIdPrefix,preloadedTilesBeltWidth:this._options.preloadedTilesBeltWidth,useLowPrecisionBeltTiles:null==(e=this._options.useLowPrecisionBeltTiles)||e,wrapModeX:this._camera.options.wrapModeX,wrapModeY:this._camera.options.wrapModeY},!1)}_fireUpdates(e,t,i){this._onViewportChanged.fire({visibleAdded:e,visibleRemoved:t}),this._messageSender.sendMessageToBackend(e,t,i)}}(this._commutator.getCommunicator(0),t,this._options),this._tileModelVisibilityManager=new class{constructor(e,t){this._contentVisibilityManager=e,this._modelStorage=t,this._modelsToVisualizedTiles=new Map,this._modelFootprintFilter=new class{get onUpdate(){return this._onUpdate}constructor(){this._modelIds=new Set,this._onUpdate=new qe}test(e){let{metadata:t}=e;if(t){let e=t.get(So.footprintModelId);if(void 0!==e)return!this._modelIds.has(e)}return!0}addModelId(e){this._modelIds.add(e),this._onUpdate.fire()}removeModelId(e){this._modelIds.delete(e),this._onUpdate.fire()}reset(){this._modelIds.clear(),this._onUpdate.fire()}},this._modelStorage.onAdded.addListener(this._onModelAdded,this),this._modelStorage.onRemoved.addListener(this._onModelRemoved,this),this._contentVisibilityManager.addFilter(0,this._modelFootprintFilter),this._contentVisibilityManager.addFilter(1,this._modelFootprintFilter)}destructor(){this._modelFootprintFilter.reset(),this._contentVisibilityManager.removeFilter(0,this._modelFootprintFilter),this._contentVisibilityManager.removeFilter(1,this._modelFootprintFilter),this._modelStorage.onAdded.removeListener(this._onModelAdded),this._modelStorage.onRemoved.removeListener(this._onModelRemoved)}showTileModels(e){for(let t of Io(e)){let i=ro(this._modelsToVisualizedTiles,t,(()=>new Set));0===i.size&&this._tryToGetAndShowModel(t),i.add(e)}}hideTileModels(e){for(let t of Io(e)){let i=this._modelsToVisualizedTiles.get(t);i&&(i.delete(e),0===i.size&&(this._modelsToVisualizedTiles.delete(t),this._tryToGetAndHideModel(t)))}}_onModelAdded(e){this._modelsToVisualizedTiles.has(e.id)&&this._showModel(e)}_onModelRemoved(e){this._modelsToVisualizedTiles.has(e.id)&&this._hideModel(e)}_tryToGetAndShowModel(e){let t=this._modelStorage.get(e);t&&this._showModel(t)}_tryToGetAndHideModel(e){let t=this._modelStorage.get(e);t&&this._hideModel(t)}_showModel(e){this._contentVisibilityManager.showObject(e),this._modelFootprintFilter.addModelId(e.id)}_hideModel(e){this._contentVisibilityManager.hideObject(e),this._modelFootprintFilter.removeModelId(e.id)}}(this._contentVisibilityManager,this._modelStorage),this._tileContentClipper=new class{constructor(e){this._communicator=e,this._geometryIds=new WeakMap,this._currentId=1}addGeometry(e){let t=this._geometryIds.get(e);t||(t=this._currentId++,this._geometryIds.set(e,t)),this._communicator.sendMessage({type:0,id:t,geometry:e},!1)}removeGeometry(e){let t=this._geometryIds.get(e);t&&(this._geometryIds.delete(e),this._communicator.sendMessage({type:1,id:t},!1))}}(this._commutator.getCommunicator(6)),this._tileContentManager=this._createContentManager(),this._zoomFilter=new Vo(this._camera),this._richModelVisibilityFilter=new class{constructor(e){this._onCameraUpdate=()=>{this._screenBbox=oo(this._camera),this._onUpdate.fire()},this._onUpdate=new qe,this._camera=e,this._screenBbox=oo(this._camera),this._camera.onUpdate.addListener(this._onCameraUpdate)}destructor(){this._camera.onUpdate.removeListener(this._onCameraUpdate)}get onUpdate(){return this._onUpdate}test(e){return void 0!==e.instanceCount||this._isVisibleOnScreen(e)}_isVisibleOnScreen(e){return j(this._screenBbox,e.bbox)}}(this._camera),this._addVisibilityFilters(),this.visibilityManager=this._visibilityManager=this._createViewportVisibilityManager(),this._metricsCollector=new class{constructor(e,t,i,r,s,o,n){this._storage=r,this._contentManager=s,this._viewport=o,this._tileReadyChecker=n,this._everVisibleTiles=new Set,this._measuringTiles=new Set;let a="vector."+t+".tile_processing";this._metrics=new Bo(e,a,i,{visible:"1"}),r.onRemoved.addListener(this._onTileRemoved,this),s.onTileContentAdded.addListener(this._onTileContentAdded,this),o.onViewportChanged.addListener(this._onViewportChanged,this)}submit(){this._metrics.submit()}destructor(){this._storage.onRemoved.removeListener(this._onTileRemoved),this._contentManager.onTileContentAdded.removeListener(this._onTileContentAdded),this._viewport.onViewportChanged.removeListener(this._onViewportChanged)}_onTileRemoved(e){this._everVisibleTiles.delete(e.id)}_onTileContentAdded(e,t,i){if(this._measuringTiles.has(e.id)){this._metrics.putValues(e.id,i),this._tileReadyChecker(e)&&this._metrics.measure(e.id,"tileReady");let r=t.primitives;(r[0]||r[1])&&this._metrics.measure(e.id,"polygonsReady"),(r[7]||r[6])&&this._metrics.measure(e.id,"labelsReady"),t.primitives[8]&&this._metrics.measure(e.id,"iconsReady")}}_onViewportChanged(e){for(let t of e.visibleAdded)!this._everVisibleTiles.has(t.id)&&!this._storage.get(t.id)&&(this._everVisibleTiles.add(t.id),this._measuringTiles.add(t.id),this._metrics.addTilesToMeasure(t.id));for(let t of e.visibleRemoved)this._measuringTiles.delete(t.id)&&this._metrics.removeTileMeasurement(t.id)}}(n,o,t,this._storage,this._tileContentManager,this._viewport,this.visibilityManager.isTileVisualizable),this._viewportMetricsCollector=new class{constructor(e,t,i,r){this._onViewportVisibilityChanged=e=>{this._isFirstViewport&&e.visualizableTileNumber===e.visibleTileNumber&&this._onFirstViewportReady()},this._onViewportChanged=e=>{this._isFirstViewport&&e.visibleAdded.length+e.visibleRemoved.length>0&&this._onFirstViewportLeft(),!this._isFirstViewport&&e.visibleAdded.length>0&&(this._isFirstViewport=!0)},this._viewport=i,this._viewportVisibility=r,this._isFirstViewport=!1,this._metrics=new zo(t,`vector.${e}.viewport`,32),this._metrics.mark(Wo),this._subscribeToViewports()}destructor(){this._unsubscribeFromViewports()}submit(){this._metrics.submit()}_onFirstViewportLeft(){this._metrics.putMeasuredValue(Wo,"firstViewportLeft"),this._unsubscribeFromViewports()}_onFirstViewportReady(){this._metrics.putMeasuredValue(Wo,"firstViewportReady"),this._unsubscribeFromViewports()}_subscribeToViewports(){this._viewport.onViewportChanged.addListener(this._onViewportChanged),this._viewportVisibility.onViewportStateChanged.addListener(this._onViewportVisibilityChanged)}_unsubscribeFromViewports(){this._viewport.onViewportChanged.removeListener(this._onViewportChanged),this._viewportVisibility.onViewportStateChanged.removeListener(this._onViewportVisibilityChanged)}}(o,n,this._viewport,this.visibilityManager),this._tileGeneration=0,this._recalculateViewport(),this._stopSubmittingMetrics=qo(this._submitMetrics)}destructor(){this._stopSubmittingMetrics(),this._removeVisibilityFilters(),this._zoomFilter.destructor(),this._richModelVisibilityFilter.destructor(),this._tileModelVisibilityManager.destructor(),this._viewport.destructor(),this._metricsCollector.destructor(),this._viewportMetricsCollector.destructor(),this._storage.destructor(),this._modelStorage.destructor(),this._tileContentManager.destructor(),this._visibilityManager.destructor(),this._contentVisibilityManager.destructor(),this._iconAtlasRegistry.destructor(),this._glyphAtlasRegistry.destructor(),this._objectMetadataIndex.destructor(),this._commutator.destructor()}pause(){this._viewport.pause(),super.pause()}resume(){this._viewport.resume(),super.resume()}get options(){return this._options}get tileStorage(){return this._storage}get modelStorage(){return this._modelStorage}updateUrlTemplates(e){let{iconUrlTemplate:t,glyphRangeUrlTemplate:i,tileUrlTemplate:r,meshUrlTemplate:s,richModelUrlTemplate:o}=e;t&&(this._iconAtlasRegistry.updateOption("iconUrlTemplate",t),this._options.iconUrlTemplate=t),i&&(this._glyphAtlasRegistry.updateOption("glyphRangeUrlTemplate",i),this._options.glyphRangeUrlTemplate=i),r&&(this._tileContentManager.updateOption("tileUrlTemplate",r),this._options.tileUrlTemplate=r),s&&(this._tileContentManager.updateOption("meshUrlTemplate",s),this._options.meshUrlTemplate=s),o&&(this._tileContentManager.updateOption("richModelUrlTemplate",o),this._options.richModelUrlTemplate=o),this._tileGeneration++,this._recalculateViewport()}setMapMode(e){e!==this._options.mapMode&&(this._tileContentManager.updateOption("mapMode",e),this._options.mapMode=e,this._recalculateViewport())}updateCustomizationConfig(e){let t=[],i=!1;!function(e){return!Array.isArray(e)}(e)?t=e:(e.style&&(t=e.style),i="off"===e["render-3d"]),this._tileContentManager.updateCustomizationConfig(t),this._options.customizationConfig=t,this._options.disable3d=i,this._tileContentManager.updateOption("disable3d",i),this._tileGeneration++,this._recalculateViewport()}addVisibilityFilter(e,t){return this._contentVisibilityManager.addFilter(e,t),this}removeVisibilityFilter(e,t){return this._contentVisibilityManager.removeFilter(e,t),this}addTileContentClipperGeometry(e){this._tileContentClipper.addGeometry(e),this._tileGeneration++,this._recalculateViewport()}removeTileContentClipperGeometry(e){this._tileContentClipper.removeGeometry(e),this._tileGeneration++,this._recalculateViewport()}_createViewportVisibilityManager(){return new bo(this._viewport,this._storage,this._contentVisibilityManager,this._tileModelVisibilityManager)}_createContentManager(){return new Ks(this._commutator.getCommunicator(3),this._storage,this._modelStorage,this._gpuMemoryRegistry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._options,this._createAdditionalMetadata())}_addVisibilityFilters(){this._contentVisibilityManager.addFilter(6,this._zoomFilter).addFilter(7,this._zoomFilter).addFilter(8,this._zoomFilter).addFilter(4,this._richModelVisibilityFilter)}_removeVisibilityFilters(){this._contentVisibilityManager.removeFilter(6,this._zoomFilter).removeFilter(7,this._zoomFilter).removeFilter(8,this._zoomFilter).removeFilter(4,this._richModelVisibilityFilter)}_recalculateViewport(){this._viewport.tileIdPrefix=this._getTileIdPrefix(),this._viewport.forceCameraStateRecalculation()}_getTileIdPrefix(){let e=1===this._options.mapMode?"night_":"";return this._getCustomTileIdPrefix()+e+this._tileGeneration.toString()}_getCustomTileIdPrefix(){return""}},Xo="indoor_plan",Zo=class{constructor(e,t,i,r){if(this.id=e,0===t.length)throw new Error("No levels provided for a plan");this.levels=t;let s=this._selectLevelById(t,i);if(!s)throw new Error("Cannot find default level");this.defaultLevel=this._activeLevel=s,this.bbox=r,this.onActiveLevelChange=this._onActiveLevelChange=new qe,this.onVisibilityChange=this._onVisibilityChange=new qe,this.onOpacityChange=this._onOpacityChange=new qe,this._isVisible=!1,this._opacity=1}get activeLevel(){return this._activeLevel}setActiveLevel(e){let t=this._selectLevelById(this.levels,e);if(t&&t!==this._activeLevel){let e=this._activeLevel;this._activeLevel=t,this._onActiveLevelChange.fire({previousLevel:e,currentLevel:t},this)}}get isVisible(){return this._isVisible}set isVisible(e){e!==this._isVisible&&(this._isVisible=e,this._onVisibilityChange.fire(e,this))}get opacity(){return this._opacity}set opacity(e){e!==this._opacity&&(this._opacity=e,this._onOpacityChange.fire(e,this))}_selectLevelById(e,t){return e.find((e=>e.id===t))}},$o=class{constructor(e){this._planRegistry=e,this.onUpdate=this._onUpdate=new qe,this._metaKey=Symbol(),this._currentVersion=0,this._onPlanAdded=this._onPlanAdded.bind(this),this._onPlanRemoved=this._onPlanRemoved.bind(this),this._onPlanVisibilityChange=this._onPlanVisibilityChange.bind(this),this._onPlanLevelChange=this._onPlanLevelChange.bind(this),this._planRegistry.onPlanAdded.addListener(this._onPlanAdded,this),this._planRegistry.onPlanRemoved.addListener(this._onPlanRemoved,this)}destructor(){this._planRegistry.onPlanRemoved.removeListener(this._onPlanRemoved),this._planRegistry.onPlanAdded.removeListener(this._onPlanAdded),this._planRegistry.getAllPlans().forEach((e=>{e.onActiveLevelChange.removeListener(this._onPlanLevelChange),e.onVisibilityChange.removeListener(this._onPlanVisibilityChange)}))}test(e){let t=e[this._metaKey];if(t&&t.version===this._currentVersion)return t.result;let i=this._test(e);return t?t.result=i:e[this._metaKey]={version:this._currentVersion,result:i},i}_test(e){let{metadata:t}=e;if(!t)return!1;let i=t.get("indoor_plan_id");if(!i)return!1;let r=i&&this._planRegistry.getPlan(i);if(!r)return!1;let s=t.get("indoor_level_id");return!!s&&(r.isVisible&&r.activeLevel.id===s)}_onPlanAdded(e){e.onVisibilityChange.addListener(this._onPlanVisibilityChange),e.onActiveLevelChange.addListener(this._onPlanLevelChange),e.isVisible&&this._fireUpdate()}_onPlanRemoved(e){e.isVisible&&this._fireUpdate(),e.onActiveLevelChange.removeListener(this._onPlanLevelChange),e.onVisibilityChange.removeListener(this._onPlanVisibilityChange)}_onPlanVisibilityChange(){this._fireUpdate()}_onPlanLevelChange(e,t){t.isVisible&&this._fireUpdate()}_fireUpdate(){this._currentVersion++,this._onUpdate.fire()}},Qo=class extends Yo{constructor(e,t,i,r,s,o,n,a){super(t,i,r,s,o,e,n),this._coveredByIndoorFilter=a,this._planRegistry=new class{constructor(e,t){this._communicator=e,this._plans=new Map,this.onPlanAdded=this._onPlanAdded=new qe,this.onPlanRemoved=this._onPlanRemoved=new qe,this._communicator.onMessage.addListener(this._onMessage,this),this._communicator.sendMessage({type:0,options:t},!0)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}getPlan(e){return this._plans.get(e)}getAllPlans(){return[...this._plans.values()]}_onMessage(e){switch(e.type){case 1:this._onAdd(e);break;case 2:this._onDestroy(e)}}_onAdd(e){let{planId:t,levels:i,defaultLevelId:r,boundary:s}=e,o=new Zo(t,i,r,s);this._plans.set(t,o),this._onPlanAdded.fire(o)}_onDestroy(e){let t=this._plans.get(e.planId);Ir(t)&&(this._plans.delete(e.planId),this._onPlanRemoved.fire(t))}}(this._commutator.getCommunicator(8),this._options),this._planRegistry.onPlanAdded.addListener(this._onPlanAdded,this),this._planRegistry.onPlanRemoved.addListener(this._onPlanRemoved,this),this.onPlansChanged=this._onPlansChanged=new qe,this._visibleIndoorPlans=new class{constructor(e,t){this._viewport=e,this._planRegistry=t,this._planRefCounts=new Map,this._visiblePlans=new Map,this._allPlans=new Set,this._onVisiblePlansChanged=new qe,this._planRegistry.onPlanAdded.addListener(this._onPlanAdded,this),this._planRegistry.onPlanRemoved.addListener(this._onPlanRemoved,this);for(let e of t.getAllPlans())this._onPlanAdded(e);this._viewport.onTileVisualized.addListener(this._onTileVisualized,this),this._viewport.onTileHidden.addListener(this._onTileHidden,this);for(let e of this._viewport.getVisualizedTiles())this._onTileVisualized(e)}destructor(){this._planRegistry.onPlanAdded.removeListener(this._onPlanAdded),this._planRegistry.onPlanRemoved.removeListener(this._onPlanRemoved),this._viewport.onTileVisualized.removeListener(this._onTileVisualized),this._viewport.onTileHidden.removeListener(this._onTileHidden);for(let e of this._allPlans)e.onVisibilityChange.removeListener(this._onPlanVisibilityChange)}get visiblePlans(){return this._visiblePlans}get onVisiblePlansChanged(){return this._onVisiblePlansChanged}_onTileVisualized(e){for(let t of _o(e.content,Xo))this._retainPlan(t)}_onTileHidden(e){for(let t of _o(e.content,Xo))this._releasePlan(t)}_onPlanAdded(e){this._allPlans.add(e),e.onVisibilityChange.addListener(this._onPlanVisibilityChange,this),this._onPlanVisibilityChange(e.isVisible,e)}_onPlanRemoved(e){this._allPlans.delete(e),e.onVisibilityChange.removeListener(this._onPlanVisibilityChange)}_onPlanVisibilityChange(e,t){this._updatePlanVisibility(t.id)}_retainPlan(e){let t=this._planRefCounts.get(e)||0;this._planRefCounts.set(e,t+1),this._updatePlanVisibility(e)}_releasePlan(e){let t=this._planRefCounts.get(e)||0;t>1?this._planRefCounts.set(e,t-1):this._planRefCounts.delete(e),this._updatePlanVisibility(e)}_updatePlanVisibility(e){let t=this._planRegistry.getPlan(e),i=this._planRefCounts.get(e)||0,r=this._visiblePlans.size;i>0&&t&&t.isVisible?this._visiblePlans.set(e,t):this._visiblePlans.delete(e),this._visiblePlans.size!==r&&this._onVisiblePlansChanged.fire(this._visiblePlans.size)}}(this.visibilityManager,this._planRegistry),this._visibleIndoorPlans.onVisiblePlansChanged.addListener(this._updateCoveredByIndoorFilter,this),this._applyContentVisibilityFilters(),this._updateCoveredByIndoorFilter()}destructor(){this._planRegistry&&(this._planRegistry.onPlanRemoved.removeListener(this._onPlanRemoved),this._planRegistry.onPlanAdded.removeListener(this._onPlanAdded),this._planRegistry.destructor()),this._coveredByIndoorFilter.deactivate(),super.destructor()}pause(){this._coveredByIndoorFilter.deactivate(),super.pause()}resume(){super.resume(),this._updateCoveredByIndoorFilter()}get plans(){return this._planRegistry.getAllPlans()}_createIndoorFilter(){return new $o(this._planRegistry)}_applyContentVisibilityFilters(){let e=this._createIndoorFilter();this._contentVisibilityManager.addFilter(5,e).addFilter(0,e).addFilter(1,e).addFilter(6,e).addFilter(7,e).addFilter(8,e)}_updateCoveredByIndoorFilter(e=this._visibleIndoorPlans.visiblePlans.size){e>0?this._coveredByIndoorFilter.activate():this._coveredByIndoorFilter.deactivate()}_onPlanAdded(e){this._onPlansChanged.fire(this._planRegistry.getAllPlans())}_onPlanRemoved(e){this._onPlansChanged.fire(this._planRegistry.getAllPlans())}},Ko=class{constructor(){this._isActive=!1,this.onUpdate=this._onUpdate=new qe}activate(){this._isActive||(this._isActive=!0,this._onUpdate.fire())}deactivate(){this._isActive&&(this._isActive=!1,this._onUpdate.fire())}test(e){let{metadata:t}=e;return!(this._isActive&&t&&"true"===t.get("indoor_covered"))}},Jo=class extends $s{constructor(e,t,i,r,s,o,n){super(i,r,s,n),this._communicator=e,this._options=o,this._detalizationStorage=t,this._onContentAdded=this.onContentAdded=new qe,this._communicator.onMessage.addListener(this._onMessage,this),this._communicator.sendMessage({type:0,options:this._serializeOptions(this._options)},!1)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}updateOption(e,t){this._options[e]=t,this._communicator.sendMessage({type:0,options:this._serializeOptions(this._options)},!1)}_onMessage(e){switch(e.type){case 2:this._onAddPrimitives(e);break;case 3:this._onRemovePrimitives(e)}}_onAddPrimitives(e){let t=this._detalizationStorage.get(e.levelId);if(Ir(t)){let i=this._instantiatePrimitives(e.content,t.zoom);t.addContent(i),this._onContentAdded.fire(t,i,e.metrics)}}_onRemovePrimitives(e){let t=this._detalizationStorage.get(e.levelId);if(Ir(t)){let i={primitives:{},references:[]};for(let r of e.content)i.primitives[r]=t.content.primitives[r];t.removeContent(i)}}},en=class extends uo{constructor(e,t){super(e),this._groupStorage=t}_deserialize({id:e,parentId:t}){let i=this._groupStorage.get(t);if(!i)throw new Error(`Parent ${t} for object ${e} is not found`);return new class{constructor(e,t){this.type=0,this.id=e,this.parent=t,this._onActiveDetalizationChanged=new qe,this._latestActiveDetalizationVersion=-1,this._detalizationLevels=new Set}get activeDetalizationLevel(){return this._activeDetalizationLevel}set activeDetalizationLevel(e){if(e!==this._activeDetalizationLevel){let t=this._activeDetalizationLevel;this._activeDetalizationLevel=e,e&&e.version>this._latestActiveDetalizationVersion&&(this._latestActiveDetalizationVersion=e.version),this._onActiveDetalizationChanged.fire(this,t,this._activeDetalizationLevel)}}get onActiveDetalizationChanged(){return this._onActiveDetalizationChanged}get latestActiveDetalizationVersion(){return this._latestActiveDetalizationVersion}get detalizationLevels(){return this._detalizationLevels}addDetalizationLevel(e){this._detalizationLevels.add(e)}removeDetalizationLevel(e){this._detalizationLevels.delete(e)}}(e,i)}_add(e,t){t.parent.addChild(t),super._add(e,t)}_remove(e){let t=this.get(e);t&&t.parent.removeChild(t),super._remove(e)}},tn=class extends po{constructor(e){super({primitives:{}}),this.type=0,this.zIndex=e,this.levelIds=new Set}_createStorage(){return new gr}_addPrimitives(e,t){for(let i of t)e.add(i)}_removePrimitives(e,t){for(let i of t)e.remove(i)}},rn=class{get children(){return this._children}get batchedChildren(){return this._batchedChildren}constructor(e,t,i){this.type=1,this.id=e,this.zIndex=t.zIndex,this.opacity=t.opacity,this.parent=i,this._children=new Set,this._batchedChildren=[],this._batchesByLevelIds=new Map,this.onUpdate=this._onUpdate=new qe}addChild(e){this._children.add(e),0===e.type?(e.onActiveDetalizationChanged.addListener(this._onChildActiveLevelChanged,this),e.activeDetalizationLevel&&this._onChildActiveLevelChanged(e,void 0,e.activeDetalizationLevel)):(e.onUpdate.addListener(this._onChildUpdate,this),this._addGroupBatch(e),this._onChildUpdate())}removeChild(e){this._children.delete(e)&&(0===e.type?(e.onActiveDetalizationChanged.removeListener(this._onChildActiveLevelChanged),e.activeDetalizationLevel&&this._onChildActiveLevelChanged(e,e.activeDetalizationLevel,void 0)):(e.onUpdate.removeListener(this._onChildUpdate),this._removeBatchedChild(e),this._onChildUpdate()))}_onChildUpdate(){this._onUpdate.fire()}_onChildActiveLevelChanged(e,t,i){t&&(t.onContentAdded.removeListener(this._onChildContentAdded),t.onContentRemoved.removeListener(this._onChildContentRemoved),t.hasContent&&this._onChildContentRemoved(t,t.content),this._removeLevelBatch(t.id)),i&&(i.onContentAdded.addListener(this._onChildContentAdded,this),i.onContentRemoved.addListener(this._onChildContentRemoved,this),i.hasContent&&this._onChildContentAdded(i,i.content))}_onChildContentAdded(e,t){this._addContentToBatch(e.id,t,e.zIndex),this._onChildUpdate()}_onChildContentRemoved(e,t){this._removeContentFromBatch(e.id,t),this._onChildUpdate()}_addContentToBatch(e,t,i){let r=this._getBatchIndex(i),s=this._batchedChildren[r-1],o=s&&0===s.type&&s.zIndex===i,n=o?s:new tn(i);o||this._batchedChildren.splice(r,0,n),this._batchesByLevelIds.set(e,n),n.addContent(t),n.levelIds.add(e)}_removeContentFromBatch(e,t){let i=this._batchesByLevelIds.get(e);i&&i.removeContent(t)}_removeLevelBatch(e){let t=this._batchesByLevelIds.get(e);t&&(t.levelIds.delete(e),0===t.levelIds.size&&this._removeBatchedChild(t),this._batchesByLevelIds.delete(e))}_addGroupBatch(e){let t=this._getBatchIndex(e.zIndex);this._batchedChildren.splice(t,0,e)}_removeBatchedChild(e){let t=this._batchedChildren.indexOf(e);t>-1&&this._batchedChildren.splice(t,1)}_getBatchIndex(e){let t=this._batchedChildren.findIndex((t=>t.zIndex>e));return-1===t?this._batchedChildren.length:t}},sn=class extends uo{_deserialize({id:e,style:t,parentId:i}){let r=null===i?null:this.get(i);if(void 0===r)throw new Error(`Parent ${i} for group ${e} is not found`);return new rn(e,t,r)}_add(e,t){t.parent&&t.parent.addChild(t),super._add(e,t)}_remove(e){let t=this.get(e);t&&t.parent&&t.parent.removeChild(t),super._remove(e)}};function on(e){return!!(e.content.primitives[5]||e.content.primitives[0]||e.content.primitives[1]||e.content.primitives[8])}var nn={zIndex:0,simplificationRate:0},an={zIndex:0,opacity:1},ln=new rn("__root_id__",an,null),dn=class extends mo{constructor(e,t,i,r,s){super({primitives:{}}),this.object=t,this.zoom=r,this.zIndex=i,this.version=s,this.id=e,this._hasContent=!1}get hasContent(){return this._hasContent}addContent(e){this._hasContent=!0,super.addContent(e)}},hn=class extends uo{constructor(e,t){super(e),this._objectStorage=t}_deserialize({id:e,objectId:t,zoom:i,zIndex:r,version:s}){let o=this._objectStorage.get(t);if(!o)throw new Error(`Object ${t} for level ${e} is not found`);return new dn(e,o,r,i,s)}_add(e,t){t.object.addDetalizationLevel(t),super._add(e,t)}_remove(e){let t=this.get(e);t&&t.object.removeDetalizationLevel(t),super._remove(e)}},cn=class{constructor(e,t,i,r,s,o,n){this.name=e,this._camera=t,this._context=i,this._metricsTransport=n,this._gpuMemoryRegistry=s;let a=this._commutator=new Ls(r),l=f({dpr:Vi(),iconUrlTemplate:"no icon url",glyphRangeUrlTemplate:"no glyph range url template"},o),d=new sn(a.getCommunicator(3));this._groupStorage=d;let h=new en(a.getCommunicator(2),d);this._objectStorage=h,this._detalizationStorage=new hn(a.getCommunicator(4),h),this._glyphAtlasRegistry=new To(a.getCommunicator(8),l,i),this._iconAtlasRegistry=new Po(a.getCommunicator(7),l,i),this._objectMetadataIndex=new No([this._detalizationStorage]),this._options=l;let c=new class{constructor(){this.onUpdate=this._onUpdate=new qe}get root(){return this._root}set root(e){let t=this._root;t&&t.onUpdate.removeListener(this._onRootUpdate),e&&e.onUpdate.addListener(this._onRootUpdate,this),this._root=e,e!==t&&this._onRootUpdate()}_onRootUpdate(){this._onUpdate.fire()}};this.scene=c,this._viewport=new class{constructor(e,t){this._communicator=e,this._camera=t,this._zoom=0,this.onUpdate=this._onUpdate=new qe,this._onCameraUpdate=this._onCameraUpdate.bind(this),this._camera.onUpdate.addListener(this._onCameraUpdate),this._onCameraUpdate()}destructor(){this._camera.onUpdate.removeListener(this._onCameraUpdate)}get zoom(){return this._zoom}_tryToUpdateZoom(e){let t=Math.round(e);t!==this._zoom&&(this._zoom=t,this._communicator.sendMessage({type:0,zoom:t},!0),this._onUpdate.fire())}_onCameraUpdate(){this._tryToUpdateZoom(this._camera.zoom)}}(a.getCommunicator(5),t);let u=new class{constructor(e,t){this._communicator=e,this._currentObjectId=1,this._communicator.sendMessage({type:0,options:t},!1),this._addRootGroup()}addObject(e,t,i=ln.id,r=String(this._currentObjectId++)){return this._communicator.sendMessage({type:1,feature:e,style:f(f({},nn),t),id:r,parentId:i},!0),r}updateObject(e,t,i){this._communicator.sendMessage({type:2,id:e,feature:t,style:f(f({},nn),i)},!0)}removeObject(e){this._communicator.sendMessage({type:3,id:e},!0)}addGroup(e,t=ln.id,i=String(this._currentObjectId++)){return this._addGroup(i,f(f({},an),e),t)}removeGroupAndChildren(e){this._communicator.sendMessage({type:5,id:e},!0)}_addGroup(e,t,i){return this._communicator.sendMessage({type:4,id:e,style:t,parentId:i},!0),e}_addRootGroup(){let{id:e,zIndex:t,opacity:i}=ln;this._addGroup(e,{zIndex:t,opacity:i},null)}}(a.getCommunicator(1),this._options);this._graphicsManager=u,this.visibilityManager=new class{get state(){return this._state}constructor(e,t,i,r,s){this._scene=e,this._viewport=t,this._groupStorage=i,this._objectStorage=r,this._detalizationStorage=s,this.onStateChanged=this._onStateChanged=new qe,this._state={objectsVisible:0,objectsTotal:0},this._visibleObjectIds=new Set,this._viewport.onUpdate.addListener(this._onViewportUpdate,this),this._onViewportUpdate(),this._groupStorage.onAdded.addListener(this._onGroupAdded,this),this._groupStorage.onRemoved.addListener(this._onGroupRemoved,this),this._objectStorage.onAdded.addListener(this._onObjectAdded,this),this._objectStorage.onRemoved.addListener(this._onObjectRemoved,this),this._detalizationStorage.onAdded.addListener(this._onLevelAdded,this),this._detalizationStorage.onRemoved.addListener(this._onLevelRemoved,this);for(let e of this._groupStorage.items)this._onGroupAdded(e);for(let e of this._objectStorage.items)this._onObjectAdded(e);for(let e of this._detalizationStorage.items)this._onLevelAdded(e)}destructor(){this._groupStorage.onAdded.removeListener(this._onGroupAdded),this._groupStorage.onRemoved.removeListener(this._onGroupRemoved),this._objectStorage.onAdded.removeListener(this._onObjectAdded),this._objectStorage.onRemoved.removeListener(this._onObjectRemoved),this._detalizationStorage.onAdded.removeListener(this._onLevelAdded),this._detalizationStorage.onRemoved.removeListener(this._onLevelRemoved);for(let e of this._groupStorage.items)this._onGroupRemoved(e);for(let e of this._objectStorage.items)this._onObjectRemoved(e);for(let e of this._detalizationStorage.items)this._onLevelRemoved(e)}pause(){this._scene.root=void 0}resume(){this._scene.root=this._currentRoot}_onGroupAdded(e){null===e.parent&&(this._scene.root&&console.warn(`Adding another root to the scene, new: ${e.id}, old: ${this._scene.root}`),this._scene.root=e,this._currentRoot=e)}_onGroupRemoved(e){this._scene.root===e&&(this._scene.root=void 0,this._currentRoot=void 0)}_onObjectAdded(e){this._recalculateState()}_onObjectRemoved(e){this._setObjectActiveLevel(e,void 0),this._recalculateState()}_onLevelAdded(e){e.onContentAdded.addListener(this._onLevelContentAdded,this),e.onContentRemoved.addListener(this._onLevelContentRemoved,this),this._onLevelContentAdded(e,e.content)}_onLevelRemoved(e){e.onContentAdded.removeListener(this._onLevelContentAdded),e.onContentRemoved.removeListener(this._onLevelContentRemoved),e.object.activeDetalizationLevel===e&&this._findBestLevelForObject(e.object)}_onLevelContentAdded(e,t){let i=e.object.activeDetalizationLevel;on(e)&&this._shouldReplaceLevel(i,e)&&this._setObjectActiveLevel(e.object,e)}_onLevelContentRemoved(e,t){e===e.object.activeDetalizationLevel&&!on(e)&&this._setObjectActiveLevel(e.object,void 0)}_recalculateState(){let e=this._visibleObjectIds.size,t=this._objectStorage.size;(this._state.objectsVisible!==e||this._state.objectsTotal!==t)&&(this._state.objectsVisible=e,this._state.objectsTotal=t,this._onStateChanged.fire(this._state))}_onViewportUpdate(){for(let e of this._objectStorage.items)this._findBestLevelForObject(e)}_setObjectActiveLevel(e,t){e.activeDetalizationLevel=t,t?this._visibleObjectIds.add(e.id):this._visibleObjectIds.delete(e.id),this._recalculateState()}_findBestLevelForObject(e){let t;for(let i of e.detalizationLevels)on(i)&&this._shouldReplaceLevel(t,i)&&(t=i);t!==e.activeDetalizationLevel&&this._setObjectActiveLevel(e,t)}_shouldReplaceLevel(e,t){return!(!t||t.version<t.object.latestActiveDetalizationVersion||e&&!(t.version!==e.version?t.version>e.version:Math.abs(t.zoom-this._viewport.zoom)<Math.abs(e.zoom-this._viewport.zoom)))}}(c,this._viewport,this._groupStorage,this._objectStorage,this._detalizationStorage),this._contentManager=new Jo(this._commutator.getCommunicator(0),this._detalizationStorage,this._gpuMemoryRegistry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._options,this._createAdditionalMetadata()),this._metrics=new class{constructor(e,t,i){this._objectStorage=t,this._contentManager=i,this._metrics=new zo(e,"vector.graphics.processing",1024,[Do,Oo]),this._objectStorage.onAdded.addListener(this._onObjectAdded,this),this._objectStorage.onRemoved.addListener(this._onObjectRemoved,this),this._contentManager.onContentAdded.addListener(this._onContentAdded,this)}destructor(){this._contentManager.onContentAdded.removeListener(this._onContentAdded),this._objectStorage.onRemoved.removeListener(this._onObjectRemoved),this._objectStorage.onAdded.removeListener(this._onObjectAdded)}submit(){this._metrics.submit()}_onObjectAdded(e){this._metrics.mark(e.id)}_onObjectRemoved(e){this._metrics.unmark(e.id)}_onContentAdded(e,t,i){this._metrics.putValues(i),on(e)&&this._metrics.putMeasuredValue(e.object.id,"graphicsReady",!1)}}(this._metricsTransport,this._objectStorage,this._contentManager),this.memoryUsage=this._memoryUsage=f(f({},this._glyphAtlasRegistry.memoryUsage),this._iconAtlasRegistry.memoryUsage),this.onMemoryUsageChanged=this._onMemoryUsageChanged=new qe,this._stopSubmittingMetrics=qo((()=>this._metrics.submit()))}destructor(){this._stopSubmittingMetrics(),this._objectStorage.destructor(),this._groupStorage.destructor(),this._contentManager.destructor(),this._commutator.destructor(),this._viewport.destructor(),this.visibilityManager.destructor(),this._metrics.destructor()}get options(){return this._options}get isPaused(){return this._isPaused}getObjectMetadata(e){return this._objectMetadataIndex.getMetadata(e)}pause(){this._isPaused||(this.visibilityManager.pause(),this._isPaused=!0)}resume(){this._isPaused&&(this.visibilityManager.resume(),this._isPaused=!1)}addObject(e,t,i,r){return this._graphicsManager.addObject(e,t,i,r)}updateObject(e,t,i){return this._graphicsManager.updateObject(e,t,i)}removeObject(e){return this._graphicsManager.removeObject(e)}addGroup(e,t,i){return this._graphicsManager.addGroup(e,t,i)}removeGroupAndChildren(e){return this._graphicsManager.removeGroupAndChildren(e)}_createAdditionalMetadata(){return new Map([[Ro+"layerName",this.name]])}_onMemoryUsageComponentChange(e){Object.assign(this._memoryUsage,e),this._onMemoryUsageChanged.fire(this._memoryUsage)}},un=class extends mo{constructor(e,t){super({primitives:{},references:[]}),this.id=e,this.bbox=t}},_n=class extends uo{_deserialize(e){return new un(e.id,e.bbox)}},pn=class extends $s{constructor(e,t,i,r,s,o,n){super(i,r,s,n),this._communicator=e,this._options=o,this._storage=t,this._onContentAdded=this.onContentAdded=new qe,this._communicator.onMessage.addListener(this._onMessage,this),this._communicator.sendMessage({type:0,options:this._options},!1)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}updateOption(e,t){this._options[e]=t,this._communicator.sendMessage({type:0,options:this._options},!1)}_onMessage(e){if(2===e.type)this._onAddPrimitives(e)}_onAddPrimitives(e){let t=this._storage.get(e.objectId);if(Ir(t)){let i=this._instantiatePrimitives(e.content,0);t.addContent(i),this._onContentAdded.fire(t,i)}}},mn=class extends Go{constructor(e,t,i,r,s,o){let n=new Ls(r),a=f({dpr:Vi()},o),l=new _n(n.getCommunicator(2));super(e,t,i,s,new To(n.getCommunicator(4),a,t),new Po(n.getCommunicator(3),a,t),new No([l])),this._options=a,this._commutator=n,this._communicator=this._commutator.getCommunicator(0),this._storage=l,this._geoContentManager=new pn(this._commutator.getCommunicator(1),this._storage,this._gpuMemoryRegistry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._options),this._visibilityManager=new class{constructor(e,t,i){this._camera=e,this._storage=t,this._contentVisibilityManager=i,this._visibleObjects=new Map,this._cameraArea=oo(this._camera),this._camera.onUpdate.addListener(this._onCameraChanged,this),this._storage.onAdded.addListener(this._onObjectAdded,this),this._storage.onRemoved.addListener(this._onObjectRemoved,this)}destructor(){this._camera.onUpdate.removeListener(this._onCameraChanged),this._storage.onAdded.removeListener(this._onObjectAdded),this._storage.onRemoved.removeListener(this._onObjectRemoved)}_onCameraChanged(){for(let e of this._storage.items)this._updateObjectVisibility(e)}_onObjectAdded(e){this._updateObjectVisibility(e)}_onObjectRemoved(e){this._visibleObjects.has(e.id)&&(this._visibleObjects.delete(e.id),this._contentVisibilityManager.hideObject(e))}_updateObjectVisibility(e){j(this._cameraArea,e.bbox)?this._visibleObjects.has(e.id)||(this._visibleObjects.set(e.id,e),this._contentVisibilityManager.showObject(e)):this._visibleObjects.has(e.id)&&(this._visibleObjects.delete(e.id),this._contentVisibilityManager.hideObject(e))}}(this._camera,this._storage,this._contentVisibilityManager),this._gc=new class{constructor(e,t,i){this._camera=t,this._communicator=e,this._storage=i,this._isActive=!1,this._onCameraUpdateDebounced=vr(this._onCameraUpdate.bind(this),5e3),this._onUpdateInStorage()}destructor(){this._pause()}_pause(){this._isActive&&(this._camera.onUpdate.removeListener(this._onCameraUpdateDebounced),this._isActive=!1)}_resume(){this._isActive||(this._camera.onUpdate.addListener(this._onCameraUpdateDebounced,this),this._isActive=!0)}_onCameraUpdate(){this._communicator.sendMessage({type:0,viewportBBox:oo(this._camera)},!0)}_onUpdateInStorage(){0===this._storage.size?this._pause():this._resume()}}(this._commutator.getCommunicator(5),this._camera,this._storage),this._onCameraChanged(),this._onCameraChanged=vr(this._onCameraChanged.bind(this),500),this._camera.onUpdate.addListener(this._onCameraChanged)}destructor(){this._camera.onUpdate.removeListener(this._onCameraChanged),this._storage.destructor(),this._geoContentManager.destructor(),this._visibilityManager.destructor(),this._gc.destructor(),this._commutator.destructor()}_onCameraChanged(){let e=this._camera.center;this._communicator.sendMessage({type:0,center:z(e.x,e.y),zoom:this._camera.zoom},!0)}};function*fn(e,t=(()=>!1)){let i=0,r=[e];for(;i<r.length;){let e=r[i];if(yield e,!t(e))for(let t of e.children)r.push(t);++i}}function gn(e,t,i){if(function(e,t){for(let i of t){let t=!0;for(let r of e)if(te(i.normal,r)+i.distance<0){t=!1;break}if(t)return!1}return!0}(e.bboxPoints,i.planes)){let r=[];if(!e.isDetailzationAcceptable(t))for(let s of e.children){let e=gn(s,t,i);e&&r.push(e)}return{tile:e,children:r}}}function vn(e){let t=!0;for(let i of e.children)if(!vn(i)){t=!1;break}return e.children.length>0&&t?(e.isSelfRenderable=!1,!0):e.tile.content?(e.isSelfRenderable=!0,!0):(e.isSelfRenderable=!1,!1)}var yn=class{constructor(e){this._onCameraChanged=()=>{this._needRecalculation=!0,this._recalculateVisibleTiles()},this._camera=e,this._entries=[],this._onUpdate=new qe,this._needRecalculation=!0,this._camera.onUpdate.addListener(this._onCameraChanged)}get onUpdate(){return this._onUpdate}destructor(){this._camera.onUpdate.removeListener(this._onCameraChanged)}*visibleTiles(){for(let e of this._entries){if("simple"===e.type){yield e.tile;continue}let t=e.node;if(t)for(let e of fn(t))yield e.tile}}*visibleRenderableTiles(){for(let e of this._entries){if("simple"===e.type){yield e.tile;continue}let t=e.node;if(t){vn(t);for(let e of fn(t,xn))e.isSelfRenderable&&(yield e.tile)}}}_onAddRootTile(e){if(-1!==this._entries.findIndex((t=>t.tile===e)))return;let t=void 0!==e.getObjectMetadata?{tile:e,type:"simple"}:{tile:e,type:"tree",node:gn(e,this._camera,_i(this._camera))};this._entries.push(t),this._onUpdate.fire()}_onRemoveRootTile(e){let t=this._entries.findIndex((t=>t.tile===e));-1!==t&&(this._entries.splice(t,1),this._onUpdate.fire())}_recalculateVisibleTiles(){if(!this._needRecalculation||(this._needRecalculation=!1,0===this._entries.length))return;let e=_i(this._camera),t=0;for(let i of this._entries)"tree"===i.type&&(i.node=gn(i.tile,this._camera,e),++t);t>0&&this._onUpdate.fire()}};function xn(e){return!e.isSelfRenderable}var bn=class extends yn{constructor(){super(...arguments),this._onTileUpdate=()=>{this._onUpdate.fire()}}addRootTile(e){e.onUpdate.addListener(this._onTileUpdate),this._onAddRootTile(e)}removeRootTile(e){e.onUpdate.removeListener(this._onTileUpdate),this._onRemoveRootTile(e)}forceVisibilityRecalculation(){this._recalculateVisibleTiles()}},Tn=["Y","M","A","P","S","_","R","T","C"].join(""),Pn=["Y","M","A","P","S","_","B","O","X"].join(""),wn=["Y","M","A","P","S","_","T","I","E","R","S"].join("");function Mn(e){return void 0!==e.content}var Rn=1;Number.MAX_SAFE_INTEGER;function Sn(e,t){return e.type===t}var Cn=class{constructor(e){this._addressee=e,this._events=new qe,this._listeners=new Map,this._transferableExtractors=new Map,this._messages=[],this._transferables=[],this._timeoutHandle=0,this._flushMessagesBinded=this.flushMessages.bind(this)}setTransferableExtractor(e,t){this._transferableExtractors.set(e,t)}sendMessage(e,t=0){e.messagePostMetrics={postDelay:Gi(),postTime:0};let i=this._transferableExtractors.get(e.type),r=i?i(e):void 0,s=0===this._messages.length;s&&(this._firstMessageTime=Gi()),this._messages.push(e),r&&(this._transferables=this._transferables.concat(r)),clearTimeout(this._timeoutHandle),this._messages.length>50||1===t||!s&&Gi()-this._firstMessageTime>250?this.flushMessages():this._timeoutHandle=setTimeout(this._flushMessagesBinded,50)}request(e,t){return new Promise(((i,r)=>{-1===e.requestId&&(e.requestId=Rn++);let s=t=>{Sn(t,e.responseType)&&t.requestId===e.requestId&&(i(t),this._events.removeListener(s)),Sn(t,e.errorType)&&t.requestId===e.requestId&&(r(),this.off(s))};this._events.addListener(s),this.sendMessage(e,t)}))}respond(e,t,i){t.requestId=e.requestId,this.sendMessage(t,i)}on(e,t){let i=i=>{Sn(i,e)&&t(i)};this._listeners.set(t,i),this._events.addListener(i)}off(e){let t=this._listeners.get(e);t&&this._events.removeListener(t)}flushMessages(){for(let e of this._messages)e.messagePostMetrics&&(e.messagePostMetrics.postDelay=Gi()-e.messagePostMetrics.postDelay,e.messagePostMetrics.postTime=Date.now());this._addressee.postMessage(this._messages,this._transferables),this._messages.length=0,this._transferables.length=0}listen(){this._addressee.onmessage=({data:e})=>{for(let t of e)this.onMessage(t)}}onMessage(e){this._events.fire(e)}},In=class extends Cn{constructor(e){let t="function"==typeof e?e():new Worker(e);super(t),this._worker=t,this.listen()}destroy(){this._worker.terminate()}},En=class extends In{};function An({buffer:e}){return[e]}var Ln=class{constructor(e){this._worker=new class{constructor(e){this._onFromBackendDecodeResponseMessage=e=>{let t=this._queue.get(e.messageId);t&&(this._queue.delete(e.messageId),e.asset?t.resolve(e.asset):t.reject(e.error))},this._nextMessageId=0,this._worker=new En(e),this._worker.setTransferableExtractor(0,An),this._queue=new Map,this._worker.on(1,this._onFromBackendDecodeResponseMessage)}destructor(){this._worker.off(this._onFromBackendDecodeResponseMessage),this._worker.destroy(),this._queue.clear()}decode(e,t){let i,r,s=this._getMessageId(),o={type:0,messageId:s,buffer:e,metadata:t},n=new Promise(((e,t)=>{i=e,r=t}));return this._queue.set(s,{resolve:i,reject:r,decoding:n}),this._worker.sendMessage(o),n}cancel(e){let t;for(let[i,r]of this._queue)if(e===r.decoding){t=i;break}return void 0!==t&&(this._queue.delete(t),!0)}_getMessageId(){return++this._nextMessageId}}(e),this._taskToWorkerTaskMap=new Map}destructor(){this._worker.destructor(),this._taskToWorkerTaskMap.clear()}decode(e,t){let i,r,{buffer:s,byteOffset:o,byteLength:n}=e,a=s.slice(o,o+n),l=new Promise(((e,t)=>{i=e,r=t})),d=this._worker.decode(a,t);return d.then((e=>{this._taskToWorkerTaskMap.has(l)&&(this._taskToWorkerTaskMap.delete(l),i(e))}),(e=>{this._taskToWorkerTaskMap.has(l)&&(this._taskToWorkerTaskMap.delete(l),r(e))})),this._taskToWorkerTaskMap.set(l,d),l}cancel(e){let t=this._taskToWorkerTaskMap.get(e);return!!t&&(this._taskToWorkerTaskMap.delete(e),this._worker.cancel(t),!0)}};function Un(e){return(e+1>>1)-1}function On(e){return(e+1<<1)-1}var Dn=class{constructor(e=Me){this._items=[],this._comparator=e}insert(e){let t=this._items,i=this._comparator,r=t.push(e)-1,s=Un(r);for(;s>-1&&i(t[r],t[s])>0;)Re(t,r,s),r=s,s=Un(r)}pop(){let e=this._items;if(0===e.length)return;let t=e[0];return this._removeByIndex(0),t}peek(){return this._items[0]}*[Symbol.iterator](){for(let e of this._items)yield e}get size(){return this._items.length}remove(e){let t=this._items.findIndex(e);-1!==t&&this._removeByIndex(t)}_restoreOrderDownward(e){let t=e,i=On(t),r=this._items.length,s=this._comparator,o=this._items;for(;i<r&&(i+1<r&&s(o[i],o[i+1])<0&&(i+=1),!(s(o[t],o[i])>0));)Re(o,t,i),t=i,i=On(i)}_removeByIndex(e){Re(this._items,e,this._items.length-1),this._items.pop(),this._restoreOrderDownward(e)}};function zn(e,t){return e.priority-t.priority}var Bn=class{constructor(){this._heap=new Dn(zn)}enqueue(e){this._heap.insert(e)}dequeue(){return this._heap.pop()}peek(){return this._heap.peek()}isEmpty(){return 0===this._heap.size}get size(){return this._heap.size}remove(e){this._heap.remove(e)}};var Fn="to_nested:init",Vn="to_nested:terminate",Nn="to_nested:request",kn="from_nested:response",Hn="_NESTED_WORKER_TAG_";function jn(e){return[f({[Hn]:!0},e)]}function Gn(e){let t=e;return 1===t.length&&t[0][Hn]?t[0]:null}var Wn=1;var qn=null,Yn=[];function Xn(e){qn&&qn(e);for(let t of Yn)t(e)}var Zn=class{constructor(e){this._onMathThreadMessage=({data:e})=>{let t=Gn(e);t&&t.id===this._id&&t.type===kn&&this._processMessage(t.content)},this._id=function(){let e=Wn;return++Wn,e}();let t=jn({type:Fn,id:this._id,content:e});postMessage(t),function(e){0===Yn.length&&(qn=onmessage,onmessage=Xn),Yn.push(e)}(this._onMathThreadMessage)}get onmessage(){return this._onmessage}set onmessage(e){this._onmessage=e}get onmessageerrot(){throw new Error("Not implemented")}set onmessageerror(e){throw new Error("Not implemented")}get onerror(){throw new Error("Not implemented")}set onerror(e){throw new Error("Not implemented")}terminate(){!function(e){let t=Yn.indexOf(e);t>=0&&Yn.splice(t,1),0===Yn.length&&(onmessage=qn,qn=null)}(this._onMathThreadMessage);let e=jn({type:Vn,id:this._id,content:null});postMessage(e)}postMessage(e,t){let i=t||[],r=jn({type:Nn,id:this._id,content:e});postMessage(r,i)}addEventListener(e,t,i){throw new Error("Not implemented")}removeEventListener(e,t,i){throw new Error("Not implemented")}dispatchEvent(e){throw new Error("Not implemented")}_processMessage(e){this._onmessage&&this._onmessage({data:e})}};function $n(){"function"==typeof importScripts&&"undefined"==typeof Worker&&(Worker=Zn)}var Qn=class{constructor(e){this._decoder=e}run({content:e,metadata:t}){return this._decoder.decode(e,t)}cancel(e){this._decoder.cancel(e)}},Kn=class{get primitives(){return function*(e){for(let t of e)t.content&&(yield*t.content.primitives)}(this._viewport.visibleRenderableTiles())}constructor(e){this._viewport=e,this.onUpdate=this._onUpdate=new qe,this._viewport.onUpdate.addListener(this._onViewportUpdate,this)}destructor(){this._viewport.onUpdate.removeListener(this._onViewportUpdate)}_onViewportUpdate(){this._onUpdate.fire()}};var Jn=Te([[0,{size:3,type:5126,normalized:!1}]]),ea=Te([[4,{size:2,type:5126,normalized:!1}]]),ta=Te([[2,{size:4,type:5123,normalized:!0}]]),ia=(Te([[12,{size:4,type:5126,normalized:!1,divisor:1}],[13,{size:4,type:5126,normalized:!1,divisor:1}],[14,{size:4,type:5126,normalized:!1,divisor:1}],[15,{size:4,type:5126,normalized:!1,divisor:1}]]),M),ra={colorFactor:ia,colorTextureIndex:void 0};function sa(e,t){var i;let r=e.materials[t.material],s=null==r?void 0:r.pbrMetallicRoughness;return s?{colorFactor:s.baseColorFactor?R(...s.baseColorFactor):ia,colorTextureIndex:null==(i=s.baseColorTexture)?void 0:i.index}:ra}function oa(e,t,i,r){return[e,t,i,r]}function na(e,t=function(){return{rotation:oa(0,0,0,1),scale:W(1,1,1),translation:W(0,0,0)}}()){return e.rotation&&function(e,t,i,r,s){s[0]=e,s[1]=t,s[2]=i,s[3]=r}(...e.rotation,t.rotation),e.translation&&q(...e.translation,t.translation),e.scale&&q(...e.scale,t.scale),t}function aa(e,t=ce(le)){if(void 0!==e.scale){let i=function(e,t,i=he()){for(let r=0;r<de;r+=4)i[r]=e[r]*t.x,i[r+1]=e[r+1]*t.y,i[r+2]=e[r+2]*t.z,i[r+3]=e[r+3];return i}(le,e.scale,ha);t=me(t,i,t)}if(void 0!==e.rotation){let i=function([e,t,i,r],s=ce(le)){let o=e*e,n=e*t,a=e*i,l=e*r,d=t*r,h=t*t,c=t*i,u=i*i,_=i*r;return s[0]=1-2*(h+u),s[1]=2*(n+_),s[2]=2*(a-d),s[4]=2*(c-_),s[5]=1-2*(o+u),s[6]=2*(c+l),s[8]=2*(a+d),s[9]=2*(c-l),s[10]=1-2*(o+h),s}(e.rotation,ce(le,ha));t=me(t,i,t)}if(void 0!==e.translation){t=me(t,ue(le,e.translation,ha),t)}return t}function la(e){let{scene:t,scenes:i,nodes:r}=e;return void 0!==t&&i[t].nodes||function(e){if(void 0===e)return[];let t=new Array(e.length);for(let i of e)for(let e of i.children||[])t[e]=!0;let i=[];for(let e=0;e<t.length;++e)void 0===t[e]&&i.push(e);return i}(r)}function da(e,t,i=ce(le),r={}){for(let s of t){let t=e[s],o=aa(na(t));me(o,i,o),void 0!==t.mesh&&(r[t.mesh]=o),da(e,t.children||[],o,r)}return r}var ha=he();var ca=Array.from({length:8}).map((()=>W(0,0,0))),ua=Array.from({length:ca.length}).map((()=>0)),_a=Array.from({length:ca.length}).map((()=>0)),pa=Array.from({length:ca.length}).map((()=>0));function ma(e,t,i){let r=e.accessors[i],s=e.bufferViews[r.bufferView];return new Uint8Array(t[s.buffer],s.byteOffset||0,s.byteLength)}function fa(e,t){let i=e.accessors[t];if(!i||"VEC3"!==i.type||5126!==i.componentType)throw new Error("no or bad POSITION attribute")}function ga(e,t){let i=e.accessors[t];if(!i||"VEC2"!==i.type||5126!==i.componentType)throw new Error("no or bad TEXCOORD_0 attribute")}function va(e,t){let i=e.accessors[t];if(!i||"VEC4"!==i.type||5123!==i.componentType)throw new Error("no or bad COLOR_0 attribute")}function ya(e){let t=0;for(let i of e)t+=i.size;return t}var xa,ba=new Map,Ta=class{constructor(e,t,i,r,s,o,n){this._onViewportUpdate=()=>{let e=new Set(this._viewport.visibleTiles());for(let t of this._visibleTiles)if(!e.has(t)){this._getDetails(t).isVisible=!1,this._stopTileProcessing(t)}this._visibleTiles=e;for(let t of e){let e=this._getDetails(t);e?e.isVisible=!0:(e={isVisible:!0,stage:0},t[this._contentManagementKey]=e),this._continueTileProcessing(t)}},this._context=e,this._viewport=t,this._taskQueue=r,this._taskBasePriority=s,this._tileIdGenerator=o,this._tilesMetadata=n,this._richModelDecoder=i,this._visibleTiles=new Set,this._preloadingTiles=new Set,this._contentManagementKey=Symbol("content_manager_details"),this._onTileProcessingError=new qe,this._onTileProcessingStageChanged=new qe,this._viewport.onUpdate.addListener(this._onViewportUpdate),this._onViewportUpdate()}get onTileProcessingError(){return this._onTileProcessingError}get onTileProcessingStageChanged(){return this._onTileProcessingStageChanged}destructor(){for(let e of this._visibleTiles)this._stopTileProcessing(e);for(let e of this._preloadingTiles)this._stopTileProcessing(e);this._viewport.onUpdate.removeListener(this._onViewportUpdate)}preload(e){e[this._contentManagementKey]={isVisible:!0,stage:0},this._preloadingTiles.add(e),this._continueTileProcessing(e)}cancelPreload(e){let t=this._getDetails(e);t&&(t.isVisible=!1,this._preloadingTiles.delete(e),this._stopTileProcessing(e))}changeTextures(e,t){let i=this._getDetails(e);if(!i||!e.content)throw new Error("tile is unknown or content is not ready");if(8!==i.stage&&(this._stopTileProcessing(e),i.texturesData=void 0,i.texturesContent=void 0),null===t)return this._setStage(e,i,8),void e.content.updateTextures(null).catch((()=>{}));i.texturesTier=t,this._setStage(e,i,9),this._continueTileProcessing(e)}updateMetadataForTile(e){this._setTileMetadata(e)}_continueTileProcessing(e){let t=this._getDetails(e);if(t.isVisible)switch(t.stage){case 0:case 2:clearTimeout(t.failedContentDataLoadRetryId),e.load().then(this._onTileLoaded.bind(this,e),this._onTileLoadingFailed.bind(this,e)),this._setStage(e,t,1);break;case 3:t.contentDecodingCancel=this._callDecoder(e,t.contentData.data,t.contentData.metadata,(t=>this._onTileDecoded(e,t)),(t=>this._onTileDecodingFailed(e,t))),this._setStage(e,t,4);break;case 6:if(!t.initializingAsset){let i=void 0!==e.getObjectMetadata;this._setTileMetadata(e);let r=i?e.modelId:this._tileIdGenerator.getTileId(e.modelId),s=i?-1:e.modelId;t.initializingAsset=new class{get primitives(){if(!this.isInitilized)throw new Error("asset is not fully initialized, call stepInitialization() more times");return this._primitives}get isInitilized(){return 0===this._initSteps.length}get onUpdate(){return this._onUpdate}constructor(e,t,i,r,s,o,n){this.gltf=e.description,this._context=t,this._buffers=[],this._textures=[],this._vaos=[],this._primitives=[],this._initSteps=[],this._onUpdate=new qe;let a=e.images;for(let e of a)this._initSteps.push((()=>this._initTexture(e)));this._defaultImages=n?a:null,this._initSteps.push((()=>this._initPrimitives(e,i,r,s,o))),this._initSteps.reverse()}destructor(){for(let e of this._buffers)e.destroy();for(let e of this._textures)e.destroy();for(let e of this._vaos)e.destroy()}stepInitialization(){return 0!==this._initSteps.length&&this._initSteps.pop()(),!this.isInitilized}updateTextures(e){if(!this.isInitilized)throw new Error("asset is not fully initialized, call stepInitialization() more times");if(!this._defaultImages)throw new Error("asset does not support textures change");let t=e||this._defaultImages,i=[];for(let e=0;e<this._textures.length;++e){let r=this._textures[e],s=t[e];i.push(Ur(this._context,r,s).catch((e=>{console.warn(e)})))}return Promise.all(i).then((()=>{for(let e of this.primitives)e.memoryInfo.textures=void 0!==e.colorTexture?Br(e.colorTexture):0;this._onUpdate.fire()}))}_initTexture(e){let{width:t,height:i}=Lr(e),r=this._context.createEmpty2DTexture(t,i,6408,5121,{minificationFilter:9987,magnificationFilter:9729,wrapS:10497,wrapT:10497});Ur(this._context,r,e).catch((e=>{console.warn(e)})),this._textures.push(r)}_initPrimitives(e,t,i,r,s){let{description:o,buffers:n}=e,a=this._context,l=da(o.nodes||[],la(o)),d={minX:0,maxX:0,minY:0,maxY:0,minZ:0,maxZ:0};for(let e=0;e<(o.meshes||[]).length;e++){let h=o.meshes[e];for(let c of h.primitives){let h=[],u=c.attributes.POSITION;fa(o,u);let _=ma(o,n,u),p=a.createVertexBuffer(_.byteLength);a.uploadDataToBuffer(p,_),this._buffers.push(p),h.push({attributeMapping:Jn,buffer:p});let m=c.attributes.TEXCOORD_0;ga(o,m);let f=ma(o,n,m),g=a.createVertexBuffer(f.byteLength);a.uploadDataToBuffer(g,f),this._buffers.push(g),h.push({attributeMapping:ea,buffer:g});let v=c.attributes.COLOR_0;if(v>=0&&s){va(o,v);let e=ma(o,n,v),t=a.createVertexBuffer(e.byteLength);a.uploadDataToBuffer(t,e),this._buffers.push(t),h.push({attributeMapping:ta,buffer:t})}let y=ma(o,n,c.indices),x=a.createIndexBuffer(y.byteLength);a.uploadDataToBuffer(x,y),this._buffers.push(x);let b=a.createVao(h,x);this._vaos.push(b);let T={indexByteOffset:0,indexByteLength:y.byteLength,indexType:o.accessors[c.indices].componentType},{colorFactor:P,colorTextureIndex:w}=sa(o,c),M=void 0!==w?this._textures[w]:void 0,R=l[e]||le,S=ya([x,...h.map((({buffer:e})=>e))]),C=M?Br(M):0,I=new Bs({id:i,vao:b,location:T,modelId:r,rtc:t,transform:R,bbox:d,colorFactor:P,colorTexture:M,metadata:ba,memoryInfo:{textures:C,geometry:S}});this._primitives.push(I)}}!function(e,t,i,r={minX:0,maxX:0,minY:0,maxY:0,minZ:0,maxZ:0}){let s=e.meshes,o=e.accessors,n=+Number.MAX_VALUE,a=+Number.MAX_VALUE,l=+Number.MAX_VALUE,d=-Number.MAX_VALUE,h=-Number.MAX_VALUE,c=-Number.MAX_VALUE,u=0;for(let e=0;e<s.length;++e)for(let t of s[e].primitives){let e=i[u++],r=o[t.attributes.POSITION],[s,_,p]=r.min,[m,f,g]=r.max,v=ca;ae({minX:s,maxX:m,minY:_,maxY:f,minZ:p,maxZ:g},v);let y=ua,x=_a,b=pa;for(let t=0;t<v.length;++t){let i=v[t];fe(e,i,i),y[t]=i.x,x[t]=i.y,b[t]=i.z}n=Math.min(...y,n),a=Math.min(...x,a),l=Math.min(...b,l),d=Math.max(...y,d),h=Math.max(...x,h),c=Math.max(...b,c)}r.minX=t.x+n,r.maxX=t.x+d,r.minY=t.y+a,r.maxY=t.y+h,r.minZ=t.z+l,r.maxZ=t.z+c}(o,t,this._primitives.map((({matrix:e})=>e)),d)}}(t.content,this._context,t.contentData.metadata[Tn],r,s,!i,!i),this._setStage(e,t,7)}t.task={priority:this._taskBasePriority,execute:()=>{t.initializingAsset.stepInitialization()?this._taskQueue.enqueue(t.task):(this._setStage(e,t,8),e.content=t.initializingAsset,t.contentData=void 0,t.content=void 0,this._preloadingTiles.delete(e))}},this._taskQueue.enqueue(t.task);break;case 9:case 11:clearTimeout(t.failedTextureDataLoadRetryId),e.loadTextures(t.texturesTier).then((t=>this._onTileTexturesDataLoaded(e,t)),(t=>this._onTileTexturesDataLoadingFailed(e,t))),this._setStage(e,t,10);break;case 12:t.texturesDecodingCancel=this._callDecoder(e,t.texturesData,{},(t=>this._onTileTextureDataDecoded(e,t)),(t=>this._onTileTextureDataDecodingFailed(e,t))),this._setStage(e,t,13);break;case 15:let{images:i}=t.texturesContent;this._setStage(e,t,8),t.texturesContent=void 0,e.content.updateTextures(i).catch((()=>{}))}}_stopTileProcessing(e){let t=this._getDetails(e);switch(t.stage){case 1:e.cancelLoading(),this._setStage(e,t,0);break;case 2:clearTimeout(t.failedContentDataLoadRetryId);break;case 4:t.contentDecodingCancel(),t.contentDecodingCancel=void 0,this._setStage(e,t,3);break;case 7:this._taskQueue.remove(t.task),this._destroyInitializingAsset(e),this._setStage(e,t,6);break;case 10:e.cancelLoadingTextures(),this._setStage(e,t,9);break;case 11:clearTimeout(t.failedTextureDataLoadRetryId),t.failedTextureDataLoadAttempts=0,this._setStage(e,t,9);break;case 13:t.texturesDecodingCancel(),t.texturesDecodingCancel=void 0,this._setStage(e,t,12)}}_onTileLoaded(e,t){let i=this._getDetails(e);i.contentData=t,i.contentDataReadyTime=Gi(),this._setStage(e,i,3),this._continueTileProcessing(e)}_onTileLoadingFailed(e,t){let i=this._getDetails(e);this._setStage(e,i,2),i.failedContentDataLoadAttempts=(i.failedContentDataLoadAttempts||0)+1,i.failedContentDataLoadAttempts<=2?i.failedContentDataLoadRetryId=setTimeout(this._continueTileProcessing.bind(this,e),500):this._onTileProcessingError.fire(e,t)}_onTileDecoded(e,t){let i=this._getDetails(e);i.contentDecodingCancel=void 0,i.content=t,this._setStage(e,i,6),this._continueTileProcessing(e)}_onTileDecodingFailed(e,t){let i=this._getDetails(e);i.contentDecodingCancel=void 0,this._setStage(e,i,5),this._onTileProcessingError.fire(e,t)}_callDecoder(e,t,i,r,s){let o=-this._getDetails(e).contentDataReadyTime,n=this._richModelDecoder.decode(t,i,o);return n.then(r,s),()=>{this._richModelDecoder.cancel(n)}}_onTileTexturesDataLoaded(e,t){let i=this._getDetails(e);i.texturesTier=void 0,i.failedTextureDataLoadAttempts=0,i.texturesData=t,this._setStage(e,i,12),this._continueTileProcessing(e)}_onTileTexturesDataLoadingFailed(e,t){let i=this._getDetails(e);this._setStage(e,i,11),i.failedTextureDataLoadAttempts=(i.failedTextureDataLoadAttempts||0)+1,i.failedTextureDataLoadAttempts<=2?i.failedTextureDataLoadRetryId=setTimeout((()=>this._continueTileProcessing(e)),500):(i.texturesTier=void 0,i.failedTextureDataLoadAttempts=0,this._onTileProcessingError.fire(e,t))}_onTileTextureDataDecoded(e,t){let i=this._getDetails(e);i.texturesData=void 0,i.texturesDecodingCancel=void 0,i.texturesContent=t,this._setStage(e,i,15),this._continueTileProcessing(e)}_onTileTextureDataDecodingFailed(e,t){let i=this._getDetails(e);i.texturesDecodingCancel=void 0,this._setStage(e,i,14),this._onTileProcessingError.fire(e,t)}_destroyInitializingAsset(e){let t=this._getDetails(e);t.initializingAsset&&t.initializingAsset.destructor()}_getDetails(e){return e[this._contentManagementKey]}_setStage(e,t,i){let r=t.stage;t.stage=i,this._onTileProcessingStageChanged.fire(e,i,r)}_setTileMetadata(e){let t=void 0!==e.getObjectMetadata;this._tilesMetadata.setTileMetadata(e.modelId,t?void 0:e.getCustomObjectIds(),t?e.getObjectMetadata():void 0)}},Pa=((xa=Pa||{})[xa.NOT_LOADED=0]="NOT_LOADED",xa[xa.REQUESTED=1]="REQUESTED",xa[xa.REQUEST_FAILED=2]="REQUEST_FAILED",xa[xa.RESPONSE_RECEIVED=3]="RESPONSE_RECEIVED",xa[xa.DECODING=4]="DECODING",xa[xa.DECODING_FAILED=5]="DECODING_FAILED",xa[xa.DECODED=6]="DECODED",xa[xa.INSTIATING_ENQUEUED=7]="INSTIATING_ENQUEUED",xa[xa.INSTIANCIATED=8]="INSTIANCIATED",xa[xa.TEXTURES_CHANGE_REQUESTED=9]="TEXTURES_CHANGE_REQUESTED",xa[xa.TEXTURES_DATA_LOAD_PENDING=10]="TEXTURES_DATA_LOAD_PENDING",xa[xa.TEXTURES_DATA_LOAD_FAILED=11]="TEXTURES_DATA_LOAD_FAILED",xa[xa.TEXTURES_DATA_LOAD_DONE=12]="TEXTURES_DATA_LOAD_DONE",xa[xa.TEXTURES_DATA_DECODE_PENDING=13]="TEXTURES_DATA_DECODE_PENDING",xa[xa.TEXTURES_DATA_DECODE_FAILED=14]="TEXTURES_DATA_DECODE_FAILED",xa[xa.TEXTURES_DATA_DECODE_DONE=15]="TEXTURES_DATA_DECODE_DONE",xa),wa=(e=>(e[e.HIGH=300]="HIGH",e[e.MEDIUM=200]="MEDIUM",e[e.LOW=100]="LOW",e))(wa||{}),Ma=class{constructor(e,t="GET",i={}){this._url=e,this._method=t,this._options=i,this._abortController=new AbortController}send(){let e=this._options.retryCount||0;return this._send(e>0?0|e:0)}cancel(){this._abortController.abort(new Error("request is canceled"))}_send(e){let t=fetch(this._url,{method:this._method,credentials:this._options.withCredentials?"include":"omit",headers:this._options.requestHeaders,signal:this._abortController.signal}).then((e=>this._prepareResponse(e))).catch((e=>{throw e instanceof Error&&(e.message=`Failed to fetch ${this._url}: ${e.message}`),e}));return 0===e?t:t.catch((()=>function(e,t){return 0===e?Promise.resolve():new Promise(((i,r)=>{let s=setTimeout(i,e);t.addEventListener("abort",(()=>{clearTimeout(s),r(t.reason)}))}))}(this._options.retryDelay||0,this._abortController.signal).then((()=>this._send(e-1)))))}},Ra=class extends Ma{_prepareResponse(e){return e.arrayBuffer()}},Sa=class extends Ma{_prepareResponse(e){return e.json()}};vt((e=>dt(e.screenSize.height,e.fov,e.zoom)));var Ca=tt((e=>2*Math.tan(.5*e)));var Ia={minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0,minZ:1/0,maxZ:-1/0},Ea=W(0,0,0),Aa={lon:0,lat:0,alt:0},La=[W(0,0,0),W(0,0,0),W(0,0,0),W(0,0,0),W(0,0,0),W(0,0,0),W(0,0,0),W(0,0,0)];function Ua(e,t=W(0,0,0)){return e?ii(ri(W(e[0],e[1],e[2]),Oa),t):q(0,0,0,t)}var Oa={lon:0,lat:0,alt:0};function Da(e){let t=new class{constructor({buffer:e,byteOffset:t,byteLength:i}){this._buffer=e,this._currentOffset=t,this._availableBytes=i,this._u32view=new Uint32Array(e)}readUint32(){this._checkAvailableBytes(4);let e=this._u32view[this._currentOffset>>2];return this._advance(4),e}readBinary(e){this._checkAvailableBytes(e);let t=new Uint8Array(this._buffer,this._currentOffset,e);return this._advance(e+(4-e%4)%4),t}readJSON(e){return function(e){let t=(new TextDecoder).decode(e);return JSON.parse(t)}(this.readBinary(e))}availableBytes(){return this._availableBytes}_checkAvailableBytes(e){if(e>this._availableBytes)throw new Error("not enough data")}_advance(e){this._currentOffset+=e,this._availableBytes-=e}}(new Uint8Array(e)),i=function(e){if(1835283298!==e.readUint32())throw new Error("b3dm header magic mismatch");if(1!==e.readUint32())throw new Error("b3dm format version mismatch");return{tileByteLength:e.readUint32(),featureTableJSONByteLength:e.readUint32(),featureTableBinaryByteLength:e.readUint32(),batchTableJSONByteLength:e.readUint32(),batchTableBinaryByteLength:e.readUint32()}}(t),r=function(e,t){if(0===t.featureTableJSONByteLength)return{RTC_CENTER:[0,0,0],BATCH_LENGTH:0};let i=e.readJSON(t.featureTableJSONByteLength);return e.readBinary(t.featureTableBinaryByteLength),i}(t,i),s=function(e,t){if(0===t.batchTableJSONByteLength)return;let i=e.readJSON(t.batchTableJSONByteLength);return e.readBinary(t.batchTableBinaryByteLength),i}(t,i);return{featureTable:r,batchTable:s,binaryGlTF:t.readBinary(t.availableBytes())}}var za=["Y","M","A","P","S","_","O","B","J","E","C","T","_","I","D","S"].join("");var Ba=class e{constructor(e,t,i,r=1){this._onTileUpdated=()=>{this._onUpdate.fire(this)},this._updateTile(e),this.baseUri=t,this.modelId=i,this.detalizationFactor=r,this._onUpdate=new qe}get bboxPoints(){return this._bboxPoints}get children(){return this._children?this._children:(this._children=this._initChildren(),this._children||[])}get content(){return this._content}set content(e){this._content&&this._content.onUpdate.removeListener(this._onTileUpdated),this._content=e,this._content&&this._content.onUpdate.addListener(this._onTileUpdated),this._onTileUpdated()}get onUpdate(){return this._onUpdate}load(){return x(this,null,(function*(){if(!this._content&&this._tile.content){let e=this.baseUri+this._tile.content.uri,t=yield(this._contentRequest=new Ra(e)).send();this._contentRequest=void 0;let{featureTable:i,binaryGlTF:r}=Da(t);return{data:r,metadata:f({[Tn]:Ua(i.RTC_CENTER)},i)}}throw new Error("no contentUri or already loaded")}))}cancelLoading(){this._contentRequest&&(this._contentRequest.cancel(),this._contentRequest=void 0)}getTexturesTiers(){let e=Fa(this._tile);return e?Object.keys(e):[]}loadTextures(e){return x(this,null,(function*(){if(this._texturesRequest)throw new Error("textures are already being loaded");let t=Fa(this._tile),i=t&&t[e];if(!i)throw new Error(`tier "${e}" is unknown`);this._texturesRequest=new Ra(this.baseUri+i);let r=yield this._texturesRequest.send();return this._texturesRequest=void 0,new Uint8Array(r)}))}cancelLoadingTextures(){this._texturesRequest&&(this._texturesRequest.cancel(),this._texturesRequest=void 0)}isDetailzationAcceptable(e){let t=ot(e),i=_i(e).origin.z,{height:r}=e.screenSize,s=this.detalizationFactor;return this._tile.geometricError*r/(i*Ca(t))*s<55e6}getCustomObjectIds(){return this._tile.content?function(e){let t=e[za];if(!t)return;let i=new Map;for(let[e,r]of Object.entries(t))i.set(Number(e),r);return i}(this._tile.content):void 0}_updateTile(e){this._tile=e,e.boundingVolume[Pn]?this._bbox=Object.assign(this._bbox||{},e.boundingVolume[Pn]):this._bbox=function(e,t=f({},Ia)){if(e.box){let i=e.box;Object.assign(t,Ia);let r=La;ii(ri(q(i[0]+i[3]+i[6]+i[9],i[1]+i[4]+i[7]+i[10],i[2]+i[5]+i[8]+i[11],Ea),Aa),r[0]),ii(ri(q(i[0]+i[3]+i[6]-i[9],i[1]+i[4]+i[7]-i[10],i[2]+i[5]+i[8]-i[11],Ea),Aa),La[1]),ii(ri(q(i[0]+i[3]-i[6]+i[9],i[1]+i[4]-i[7]+i[10],i[2]+i[5]-i[8]+i[11],Ea),Aa),La[2]),ii(ri(q(i[0]+i[3]-i[6]-i[9],i[1]+i[4]-i[7]-i[10],i[2]+i[5]-i[8]-i[11],Ea),Aa),La[3]),ii(ri(q(i[0]-i[3]+i[6]+i[9],i[1]-i[4]+i[7]+i[10],i[2]-i[5]+i[8]+i[11],Ea),Aa),La[4]),ii(ri(q(i[0]-i[3]+i[6]-i[9],i[1]-i[4]+i[7]-i[10],i[2]-i[5]+i[8]-i[11],Ea),Aa),La[5]),ii(ri(q(i[0]-i[3]-i[6]+i[9],i[1]-i[4]-i[7]+i[10],i[2]-i[5]-i[8]+i[11],Ea),Aa),La[6]),ii(ri(q(i[0]-i[3]-i[6]-i[9],i[1]-i[4]-i[7]-i[10],i[2]-i[5]-i[8]-i[11],Ea),Aa),La[7]);for(let e of r)t.maxX=Math.max(t.maxX,e.x),t.minX=Math.min(t.minX,e.x),t.maxY=Math.max(t.maxY,e.y),t.minY=Math.min(t.minY,e.y),t.maxZ=Math.max(t.maxZ,e.z),t.minZ=Math.min(t.minZ,e.z);return t}throw new Error("unsupported bounding volume type")}(e.boundingVolume,this._bbox),this._bboxCenter=function(e,t=W(0,0,0)){return t.x=(e.minX+e.maxX)/2,t.y=(e.minY+e.maxY)/2,t.z=(e.minZ+e.maxZ)/2,t}(this._bbox,this._bboxCenter),this._bboxPoints=ae(this._bbox,this._bboxPoints),this._bboxRadius=function(e){return Math.max(Math.abs(e.maxX-e.minX)/2,Math.abs(e.maxY-e.minY)/2,Math.abs(e.maxZ-e.minZ)/2)}(this._bbox)}_initChildren(){if(!this._tile.children)return;let t=[];for(let i of this._tile.children)if(i.content){let r=this.baseUri+i.content.uri,s=r.match(/\.json$/)?new Va(r,i,this.modelId,this.detalizationFactor):new e(i,this.baseUri,this.modelId,this.detalizationFactor);s.onUpdate.addListener(this._onTileUpdated),t.push(s)}return t}};function Fa(e){return e.content[wn]}var Va=class e extends Ba{constructor(e,t,i=Na++,r){super(t,e.substring(0,e.lastIndexOf("/")+1),i,r),this.tilesetUri=e}load(){return x(this,null,(function*(){if(!this._tileset){let e=this._tilesetRequest=new Sa(this.tilesetUri);this._tileset=yield e.send(),this._tilesetRequest=void 0,this._updateTile(this._tileset.root)}return((e,t,i)=>_(h(e),i,t))(e.prototype,this,"load").call(this)}))}cancelLoading(){this._tilesetRequest&&(this._tilesetRequest.cancel(),this._tilesetRequest=void 0),super.cancelLoading()}},Na=0;function ka(e){return Pa[e]}function Ha(e){return e instanceof Va?e.tilesetUri:e instanceof Ba?e.baseUri:"nouri"}var ja={getTileId:()=>4294967295},Ga={setTileMetadata(){}},Wa=class{get contentManager(){return this._contentManager}get onMemoryUsageChanged(){return this._onMemoryUsageChanged}get modelColor(){return this._modelColor}constructor(e,t,i,r,s,o,n){this.name=r,this._buildingsFilters=o,this._renderLoop=i,this._metricsTransport=n,this._options=f(f({},Xa),s),this._modelColor=S(qa),this.memoryUsage={},this._onMemoryUsageChanged=new qe,this.viewport=new bn(t),this.collidingViewport=new bn(t),this._richModelDecoder=new class{constructor(e){$n(),this._poolSize=e,this._decoders=[],this._workerUrl=""}destructor(){this._destroyDecoders()}setWorkerUrl(e){e!==this._workerUrl&&(this._destroyDecoders(),this._workerUrl=e,this._workerUrl&&this._createDecoders())}decode(e,t,i){if(!this._pool)throw new Error("decoder worker url is not defined");return this._pool.run({content:e,metadata:t},i)}cancel(e){this._pool&&this._pool.cancel(e)}_createDecoders(){for(let e=0;e<this._poolSize;++e){let e=new Ln(this._workerUrl);this._decoders.push(e)}let e=this._decoders.map((e=>new Qn(e))),t=[];for(let i=0;i<4;++i)t.push(...e);this._pool=new class{constructor(e){this._executors=[...e],this._active=[],this._queue=new Bn}destroy(){for(let e of this._active)e.executor.cancel(e.pending)}run(e,t=0){let i,r,s=new Promise(((e,t)=>{i=e,r=t})),o={promise:s,resolve:i,reject:r,priority:t,input:e};return this._queue.enqueue(o),this._checkTasks(),s}cancel(e){let t=this._active.findIndex((t=>t.promise===e));if(t>=0){let[e]=this._active.splice(t,1);return e.executor.cancel(e.pending),this._executors.push(e.executor),void this._checkTasks()}this._queue.remove((t=>t.promise===e))}_checkTasks(){if(0===this._queue.size||0===this._executors.length)return;let e=this._queue.dequeue();this._active.push(e),e.executor=this._executors.shift(),e.pending=e.executor.run(e.input),e.input=void 0,function(e,t){e.finally?e.finally(t):e.then((e=>Promise.resolve(t()).then((()=>e))),(e=>Promise.resolve(t()).then((()=>Promise.reject(e)))))}(e.pending.then(e.resolve,e.reject),(()=>{let t=this._active.indexOf(e);t>=0&&(this._active.splice(t,1),this._executors.push(e.executor),this._checkTasks())}))}}(t)}_destroyDecoders(){this._pool&&(this._pool.destroy(),this._pool=void 0);for(let e of this._decoders)e.destructor();this._decoders.length=0}}(1),this._richModelDecoder.setWorkerUrl(this._options.gltfDecoderWorkerUrl),this._taskQueue=new class{constructor(e=50){this._queue=new Bn,this._frozen=!1,this._dequeueTimeoutHandle=0,this.onEmpty=this._onEmpty=new qe,this.onAdd=this._onAdd=new qe,this._maxDequeueDuration=e}destroy(){clearTimeout(this._dequeueTimeoutHandle)}enqueue(e){return this._onAdd.fire(),this._frozen||this._setDequeueTimeout(),new Promise(((t,i)=>{let r={execute(){try{e.execute(),t()}catch(e){i(e)}},priority:e.priority,task:e};this._queue.enqueue(r)}))}enqueueSync(e){let t={execute(){try{e.execute()}catch(e){console.error(e)}},priority:e.priority,task:e};this._queue.enqueue(t),this._frozen||this._setDequeueTimeout()}remove(e){this._queue.remove((t=>t.task===e))}isEmpty(){return this._queue.isEmpty()}freeze(){this._dequeueTimeoutHandle&&(clearTimeout(this._dequeueTimeoutHandle),this._dequeueTimeoutHandle=0),this._frozen=!0}unfreeze(){this._frozen=!1,this._queue.isEmpty()||this._setDequeueTimeout()}_dequeue(){if(this._dequeueTimeoutHandle=0,null===this._maxDequeueDuration)for(;this._queue.size;)this._queue.dequeue().execute();else{let e=Gi();for(;this._queue.size&&(this._queue.dequeue().execute(),!(Gi()-e>this._maxDequeueDuration)););}this._queue.isEmpty()?this._onEmpty.fire():this._setDequeueTimeout()}_setDequeueTimeout(){this._dequeueTimeoutHandle||(this._dequeueTimeoutHandle=setTimeout((()=>this._dequeue()),0))}}(10),this._tileIdGenerator=new class{constructor(){let{min:e,max:t}=gs;this._generateId=vs({min:e>>8,max:t>>8}),this._idToModelMap=new Map,this._modelToIdMap=new Map}getTileId(e){let t=this._modelToIdMap.get(e);return void 0===t?(t=this._generateId()<<8,this._idToModelMap.set(t,e),this._modelToIdMap.set(e,t),this._modelToIdMap.get(e)):t}resetTile(e){let t=this._modelToIdMap.get(e);this._idToModelMap.delete(t),this._modelToIdMap.delete(e)}parseObjectId(e){let t=4294967040&e,i=function(e){let t=255&e;return t<255?t:0}(e),r=this._idToModelMap.get(t);return void 0!==r?{modelId:r,itemId:i}:void 0}},this._tilesMetadata=new class{constructor(e){this._modelToMetadataMap=new Map,this._modelToObjectIdsMap=new Map,this._commonMetadata=[...e]}resetTile(e){this._modelToMetadataMap.delete(e),this._modelToObjectIdsMap.delete(e)}setTileMetadata(e,t,i){let r=new Map;this._modelToMetadataMap.set(e,r),r.set(0,this._createMetadata(e,i)),t&&this._modelToObjectIdsMap.set(e,t)}get(e,t){let i=this._modelToMetadataMap.get(e);if(!i)return;let r=i.get(t);return 0!==t&&!r&&(r=this._makeItemMetadata(i.get(0),t,this._modelToObjectIdsMap.get(e)),i.set(t,r)),r}_createMetadata(e,t){let i=new Map;for(let[e,t]of this._commonMetadata)i.set(e,t);if(i.set("modelId",String(e)),t)for(let[e,r]of t.entries())i.set(e,r);return i}_makeItemMetadata(e,t,i){let r=new Map(e);if(r.set("itemId",String(t)),i){let e=i.get(t);void 0!==e&&r.set("objectId",e)}return r}}([[Ro+"layerName",this.name]]),this._contentManager=new Ta(e,this.viewport,this._richModelDecoder,this._taskQueue,0,this._tileIdGenerator,this._tilesMetadata),this._collidingContentManager=new Ta(e,this.collidingViewport,this._richModelDecoder,this._taskQueue,0,ja,Ga),this.scene=new Kn(this.viewport),this.collidingScene=new Kn(this.collidingViewport),this._tiles=new Map,this._metrics=new class{constructor(e,t){this._transport=e,this._contentManager=t,this._tiles=new Map,this._contentManager.onTileProcessingStageChanged.addListener(this._onTileProcessingStageChanged,this)}destructor(){this._contentManager.onTileProcessingStageChanged.removeListener(this._onTileProcessingStageChanged)}submit(){for(let e of this._tiles.values())e.submit()}_onTileProcessingStageChanged(e,t,i){let r=this._getTileMetrics(e);r.putMeasuredValue(ka(i),function(e,t){return`${ka(e)}->${ka(t)}`}(i,t),!1),r.unmark(ka(i)),r.mark(ka(t))}_getTileMetrics(e){let t=function(e){return`${Ha(e)}~${e.modelId}`}(e),i=Ha(e);return ro(this._tiles,t,(()=>new zo(this._transport,"vector.map.tile3d",1024,void 0,{tileUri:i})))}}(this._metricsTransport,this._contentManager),this._stopSubmittingMetrics=qo((()=>this._metrics.submit()))}destructor(){this._stopSubmittingMetrics(),this._collidingContentManager.destructor(),this._contentManager.destructor(),this._taskQueue.destroy(),this._metrics.destructor(),this._richModelDecoder.destructor(),this.viewport.destructor(),this.collidingViewport.destructor();for(let[e,t]of this._tiles)this._buildingsFilters.idFilter.removeModelFilter(e),this._removeTileEntry(t)}addRootTile(e,t=[],i,r=Za){if(void 0===e.modelId)throw new Error("tile modelId is not defined");if(i&&i.modelId!==e.modelId)throw new Error("modelId of tile and collidingTile must be equal");let s=this._getTileEntry(e);if(s)return 5===s.state&&(s.state=0),void this.showRootTile(e);let o={tile:e,collidingTile:i,updateListener:()=>this._onTileUpdateEntryUpdate(o),preRenderListener:()=>this._onPrerenderEntryUpdate(o),objectIds:t,state:0,progress:0,progressUpdateTime:Gi(),hideTimeoutId:0,fadeInDuration:Qa(r),fadeOutDuration:$a};e.onUpdate.addListener(o.updateListener),this._onTileUpdateEntryUpdate(o),this._tiles.set(e.modelId,o),this._addToViewport(o)}removeRootTile(e,t=$a){let i=this._getTileEntry(e);if(i)switch(i.state){case 4:case 0:this._removeTileEntry(i);break;case 2:case 1:case 3:i.state=5,i.fadeOutDuration=Qa(t),this._runFadeOutAnimation(i,(()=>this._removeTileEntry(i)))}}showRootTile(e,t=Za){let i=this._getTileEntry(e);if(i){switch(i.state){case 3:i.state=0,this._cancelHiding(i);break;case 4:i.state=0,this._addToViewport(i)}i.fadeInDuration=Qa(t),this._onTileUpdateEntryUpdate(i)}}hideRootTile(e,t=$a){let i=this._getTileEntry(e);if(i)switch(i.state){case 1:case 2:i.state=3,i.fadeOutDuration=Qa(t),this._runFadeOutAnimation(i,(()=>this._hideTileEntry(i)));break;case 0:this._removeFromViewport(i),i.state=4}}changeRootTileTextures(e,t){this._getTileEntry(e)&&this._contentManager.changeTextures(e,t)}pause(){}resume(){}getObjectMetadata(e){let t=this._tileIdGenerator.parseObjectId(e);if(void 0!==t)return this._tilesMetadata.get(t.modelId,t.itemId)}getModelAppearingProgress(e){var t;return null==(t=this._tiles.get(e))?void 0:t.progress}setModelColor(e){this._modelColor=S(e),this._renderLoop.update()}_getTileEntry(e){return this._tiles.get(e.modelId)}_addToViewport(e){this.viewport.addRootTile(e.tile),e.collidingTile&&this.collidingViewport.addRootTile(e.collidingTile)}_removeFromViewport(e){this.viewport.removeRootTile(e.tile),e.collidingTile&&this.collidingViewport.removeRootTile(e.collidingTile)}_onTileUpdateEntryUpdate(e){Mn(e.tile)&&(0===e.state?(this._toggleEntryBuildingsFilters(e,!0),e.state=1,e.progress=0,e.progressUpdateTime=Gi(),this._beginRenderLoopUpdates(e)):2===e.state&&this._renderLoop.update()),this.viewport.forceVisibilityRecalculation()}_onPrerenderEntryUpdate(e){let t=Gi(),i=t-e.progressUpdateTime,r=1===e.state?1:-1,s=r>0?e.fadeInDuration:e.fadeOutDuration;e.progress=ke(e.progress+r*i/s,0,1),e.progressUpdateTime=t,r<0&&e.progress<=0?this._endRenderLoopUpdates(e):r>0&&e.progress>=1?(e.state=2,this._endRenderLoopUpdates(e)):this._renderLoop.update()}_cancelHiding(e){0!==e.hideTimeoutId&&(clearTimeout(e.hideTimeoutId),e.hideTimeoutId=0)}_runFadeOutAnimation(e,t){this._cancelHiding(e),e.progressUpdateTime=Gi(),e.hideTimeoutId=setTimeout(t,e.progress*e.fadeOutDuration),this._beginRenderLoopUpdates(e)}_hideTileEntry(e){this._cancelHiding(e),this._removeFromViewport(e),this._endRenderLoopUpdates(e),(3===e.state||5===e.state)&&this._toggleEntryBuildingsFilters(e,!1),e.state=4}_beginRenderLoopUpdates(e){this._endRenderLoopUpdates(e),this._renderLoop.onBeforeRender.addListener(e.preRenderListener),this._renderLoop.update()}_endRenderLoopUpdates(e){this._renderLoop.onBeforeRender.removeListener(e.preRenderListener)}_removeTileEntry(e){var t;let{modelId:i}=e.tile;this._hideTileEntry(e),e.tile.onUpdate.removeListener(e.updateListener),this._tiles.delete(i),this._tileIdGenerator.resetTile(i),this._tilesMetadata.resetTile(i),e.tile.content&&e.tile.content.destructor(),null!=(t=e.collidingTile)&&t.content&&e.collidingTile.content.destructor()}_toggleEntryBuildingsFilters(e,t){let{modelId:i}=e.tile;t?this._buildingsFilters.idFilter.addModelFilter(i,e.objectIds):this._buildingsFilters.idFilter.removeModelFilter(i)}},qa=E("#E8E4DE"),Ya=E("#2B3343"),Xa={basePriority:200,gltfDecoderWorkerUrl:"gltf_decoder.worker.js"},Za=500,$a=500;function Qa(e){return Math.max(0,e)}var Ka=class{get onUpdate(){return this._filter.onUpdate}constructor(){this._filter=new jo,this._modelFilters=new Map}addModelFilter(e,t){if(!this._modelFilters.has(e)){let i=new class{constructor(e){this._objectIds=new Set(e),this.onUpdate=this._onUpdate=new qe}test(e){let{metadata:t}=e;if(t){let e=t.get("objectId");if(void 0!==e)return!this._objectIds.has(e)}return!0}addObjectId(e){this._objectIds.add(e),this._onUpdate.fire()}removeObjectId(e){this._objectIds.delete(e),this._onUpdate.fire()}removeAllObjectIds(){this._objectIds.clear(),this._onUpdate.fire()}}(t);this._modelFilters.set(e,i),this._filter.addFilter(i)}}removeModelFilter(e){let t=this._modelFilters.get(e);t&&(this._modelFilters.delete(e),this._filter.deleteFilter(t))}test(e){return this._filter.test(e)}},Ja=class extends js{constructor(e,t,i,r,s){super(e,t,i,r,s)}},el=class extends Ks{constructor(e,t,i,r,s,o,n,a,l,d){super(e,r,s,o,n,a,l,d),this._extCommunicator=t,this._context=i,this._extCommunicator.onMessage.addListener(this._onExtMessage,this),this._extCommunicator.sendMessage({type:0,options:l},!1)}destructor(){this._extCommunicator.onMessage.removeListener(this._onExtMessage),super.destructor()}_onExtMessage(e){if(1===e.type)this._onExtAddPrimitives(e)}_onExtAddPrimitives(e){return x(this,null,(function*(){let t=this._storage.get(e.tileId);if(Ir(t)){let i=e.content[2];for(let[r,s]of function*(e,t,i=((e,t)=>[e,t])){let r=e[Symbol.iterator](),s=t[Symbol.iterator]();for(let e=r.next(),t=s.next();!e.done&&!t.done;e=r.next(),t=s.next())yield i(e.value,t.value)}(i||[],e.images||[])){let e=this._registry.getPage(r.location.bufferId);if(!Ir(e))continue;let[i,o]="createImageBitmap"in self?[s,void 0]:Er(URL.createObjectURL(s));o&&(yield o);let n=this._context.createEmpty2DTexture(i.width+2,i.height+2,6408,5121,{magnificationFilter:9729,minificationFilter:9729,premultipliedAlpha:!0});this._context.setTextureDataFromDomElement(n,i,{x:1,y:1});let a={primitives:{2:[new Ja(e.vao,r.location,n)]}};t.addContent(a),this._onTileContentAdded.fire(t,a,{})}}}))}},tl=class extends Yo{_createViewportVisibilityManager(){return new bo(this._viewport,this._storage,this._contentVisibilityManager,this._tileModelVisibilityManager,(e=>this._isTileVisualizable(e)))}_createContentManager(){return new el(this._commutator.getCommunicator(3),this._commutator.getCommunicator(8),this._context,this._storage,this._modelStorage,this._gpuMemoryRegistry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._options,this._createAdditionalMetadata())}_isTileVisualizable(e){let t=!!e.content.primitives[2],i=!this._options.tileUrlTemplate||!(!e.content.primitives[6]&&!e.content.primitives[7]);return t&&i}},il=class extends Yo{_createViewportVisibilityManager(){return new bo(this._viewport,this._storage,this._contentVisibilityManager,this._tileModelVisibilityManager,rl)}_addVisibilityFilters(){let e=new Vo(this._camera);this._contentVisibilityManager.addFilter(6,e).addFilter(7,e)}};function rl(e){return xo(e)&&!!e.content.primitives[8]}p(2,5),p(2,10),p(2,1),p(2,10),p(2,7);var sl,ol=(e,t)=>{var i,r;return(null!=(i=e.zOrder)?i:0)-(null!=(r=t.zOrder)?r:0)},nl=class{constructor(e){this._target=e,this.primitives=[],this.onUpdate=new qe}add(e){this._target.add(e)}delete(e){this._target.delete(e)}},al=class extends gr{constructor(e){super(),this._comparator=e}add(e){let t=super.add(e);return t&&this._setDirty(),t}_onDirtyDataAccessed(){super._onDirtyDataAccessed(),function(e,t=Me,i=0,r=e.length){if(r-i<=32)return void Ce(e,t,i,r);{let s=i,o=s+32;for(;o<r;)Ce(e,t,s,o),s=o,o+=32;Ce(e,t,s,r)}let s=new Array(r-i);for(let o=32;o<r-i;o+=o){Se(e,s,i,r);let n=i,a=0,l=o,d=l+o;for(;d<r-i;)Ie(s,e,t,a,l,d,n),a=d,l=a+o,d=l+o,n+=2*o;Ie(s,e,t,a,Math.min(l,r-i),r-i,n)}}(this._data,this._comparator);for(let e=0;e<this._data.length;e++){this._getMetadata(this._data[e]).index=e}}},ll=class extends Ks{updateOption(e,t){this._options[e]=t,this._communicator.sendMessage({type:0,options:this._serializeOptions(this._options)},!1)}},dl=class extends $o{_test(e){var t;return null==(t=e.metadata)||!t.has("indoor_plan_id")||super._test(e)}},hl=((sl=hl||{})[sl.MAP=0]="MAP",sl[sl.DRIVING=1]="DRIVING",sl[sl.TRANSIT=2]="TRANSIT",sl[sl.ADMIN=3]="ADMIN",sl[sl.FUTURE_MAP=4]="FUTURE_MAP",sl),cl={mapType:0,hdMode:!1};var ul=2,_l=class extends Qo{constructor(e,t,i,r,s,o,n,a){super(e,t,i,r,s,o,n,a),this.backgroundController=new class{constructor(e){this._onMessage=e=>{0===e.type&&this._onSetBackground(e)},this._communicator=e,this._onBackgroundSet=new qe,this._communicator.onMessage.addListener(this._onMessage)}get onBackgroundSet(){return this._onBackgroundSet}get background(){return this._background}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}_onSetBackground(e){this._background=e.background,this._onBackgroundSet.fire(this._background)}}(this._commutator.getCommunicator(7))}destructor(){this.backgroundController.destructor(),super.destructor()}updateUrlTemplates(e){super.updateUrlTemplates(e),e.styleUrlTemplate&&this._tileContentManager.updateOption("styleUrlTemplate",e.styleUrlTemplate),e.fontListUrlTemplate&&this._tileContentManager.updateOption("fontListUrlTemplate",e.fontListUrlTemplate),e.fontObjectUrlTemplate&&this._tileContentManager.updateOption("fontObjectUrlTemplate",e.fontObjectUrlTemplate)}setMapType(e){e!==this._options.mapType&&(this._tileContentManager.updateOption("mapType",e),this._options.mapType=e,this._recalculateViewport())}setHDMode(e){e!==this._options.hdModeEnabled&&(this._tileContentManager.updateOption("hdModeEnabled",e),this._options.hdModeEnabled=e,this._recalculateViewport())}_createScene(){let e=new xr(new al(ol));return g(f({},super._createScene()),{100:e,0:new nl(e),1:new nl(e),2:new nl(e),5:new nl(e)})}_createContentManager(){return new ll(this._commutator.getCommunicator(3),this._storage,this._modelStorage,this._gpuMemoryRegistry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._options,this._createAdditionalMetadata())}_createViewportVisibilityManager(){return new bo(this._viewport,this._storage,this._contentVisibilityManager,this._tileModelVisibilityManager,pl)}_createIndoorFilter(){return new dl(this._planRegistry)}_getCustomTileIdPrefix(){var e,t;return`${function(e){return e.mapType*ul+Number(e.hdMode)}({hdMode:null!=(e=this._options.hdModeEnabled)?e:cl.hdMode,mapType:null!=(t=this._options.mapType)?t:cl.mapType})}_`}};function pl(e){return!(!e.content.primitives[0]&&!e.content.primitives[1]||!e.content.primitives[6]&&!e.content.primitives[7])}var ml=class{constructor(e){this._addressee=e,this._messageQueue=[],this._transferableQueue=[],this._listeners=[]}addMessage(e,t=[]){this._messageQueue.push(e),this._transferableQueue.push(...t)}onMessage(e){this._listeners.push(e)}flushMessages(){0!==this._messageQueue.length&&this._addressee.postMessage(this._messageQueue,this._transferableQueue),this._messageQueue.length=0,this._transferableQueue.length=0}listen(){this._addressee.onmessage=({data:e})=>{for(let t of e)for(let e of this._listeners)e(t)}}},fl=class extends ml{constructor(e,t){let i="function"==typeof e?e():new Worker(e);super(i),this._worker=i,this._onWorkerError=()=>{t(new Error(`Error in worker: ${e}`))},this._worker.addEventListener("error",this._onWorkerError),this.listen()}destroy(){this._worker.removeEventListener("error",this._onWorkerError),this._worker.terminate()}};function gl(e){if("undefined"!=typeof window){let t=new class{constructor(e){this._onMessage=({data:e})=>{let t=Gn(e);t&&this._processMessage(t.type,t.id,t.content)},this._masterWorker=e,this._nestedWorkers=new Map,this._masterWorker.addEventListener("message",this._onMessage)}terminate(){this._masterWorker.removeEventListener("message",this._onMessage);for(let e of this._nestedWorkers.values())e.terminate()}_processMessage(e,t,i){switch(e){case Fn:this._initNestedWorker(t,i);break;case Vn:this._terminateNestedWorker(t);break;case Nn:this._passRequestToNestedWorker(t,i)}}_initNestedWorker(e,t){if(this._nestedWorkers.has(e))throw new Error(`nested worker ${e} already exists`);let i=new Worker(t);i.onmessage=({data:t})=>{this._passResponseFromNestedWorker(e,t)},this._nestedWorkers.set(e,i)}_terminateNestedWorker(e){let t=this._nestedWorkers.get(e);if(!t)throw new Error(`nested worker ${e} does not exist`);this._nestedWorkers.delete(e),t.terminate()}_passRequestToNestedWorker(e,t){let i=this._nestedWorkers.get(e);if(!i)throw new Error(`nested worker ${e} does not exist`);i.postMessage(t)}_passResponseFromNestedWorker(e,t){let i=jn({type:kn,id:e,content:t});this._masterWorker.postMessage(i)}}(e);!function(e,t){let{terminate:i}=e;e.terminate=function(){i.apply(this,arguments),t()}}(e,(()=>t.terminate()))}}var vl,yl,xl="workerInitialized",bl=((vl=bl||{})[vl.TILE=0]="TILE",vl[vl.ICONS_TILE=1]="ICONS_TILE",vl[vl.HYBRID=2]="HYBRID",vl[vl.INDOOR=3]="INDOOR",vl[vl.GRAPHICS=4]="GRAPHICS",vl[vl.GEO=5]="GEO",vl[vl.TILE_3D=6]="TILE_3D",vl[vl.VMAP3_TILE=7]="VMAP3_TILE",vl),Tl=class{constructor(e,t,i,r,s){this._onMessage=e=>{if(2===e.type)this._workerHolder.workerInitializedWith(e.version)},this._workerHolder=new class{constructor(e,t){this._metrics=new zo(e,"vector.map.content_provider"),this._metrics.mark(xl),this._onInternalError=new qe,this._worker=new fl(t,(e=>this._onInternalError.fire(e))),this._backendInitializationTimeout=setTimeout((()=>this.workerInitializedWith("_TIMEOUT_")),3e4),this._stopSubmittingMetrics=qo((()=>this._metrics.submit())),gl(this.worker._worker)}destructor(){clearTimeout(this._backendInitializationTimeout),this._stopSubmittingMetrics(),this._worker.destroy()}get onInternalError(){return this._onInternalError}get worker(){return this._worker}workerInitializedWith(e){clearTimeout(this._backendInitializationTimeout),"6.13.1"===e?this._metrics.putMeasuredValue(xl):this._onInternalError.fire(new Error(`Content provider backend is not initialized: ${e} != 6.13.1`))}}(s,e),this._context=i,this._camera=t,this._renderLoop=r,this._metricsTransport=s,this._commutator=new Ls(new class{constructor(e){this._worker=e,this._scheduledFlush=yr((()=>e.flushMessages())),this.onMessage=this._onMessage=new qe,e.onMessage((e=>{this._onMessage.fire(e)}))}sendMessage(e,t,...i){this._worker.addMessage(e,i),t&&this._scheduledFlush()}}(this._workerHolder.worker)),this._communicator=this._commutator.getCommunicator(0),this._gpuMemoryRegistry=new jr(this._commutator.getCommunicator(1),i),this._onMemoryUsageChanged=new qe,this._contentProviders=[],this.coveredByIndoorFilter=new Ko,this.buildingsFilters={idFilter:new Ka},this._currentProviderId=2,this.idGenerator=vs(fs),this._communicator.onMessage.addListener(this._onMessage)}get onMemoryUsageChanged(){return this._onMemoryUsageChanged}get onInternalError(){return this._workerHolder.onInternalError}get contentProviders(){return this._contentProviders}destructor(){this._communicator.onMessage.removeListener(this._onMessage);for(let e of this._contentProviders)e.provider.destructor();this._contentProviders.length=0,this._gpuMemoryRegistry.destructor(),this._commutator.destructor(),this._workerHolder.destructor()}getContentProvider(e,t){let i=this._contentProviders.find((e=>e.provider.name===t));if(i){if(i.type!==e)throw new Error(`Provider ${t} already exists with another type: ${i.type}`);return i.provider}}initContentProvider(e,t,i){let r=this.getContentProvider(e,t);if(r)return r.isPaused?r.resume():console.warn("initializing already initialized and running content provider"),r;let s,o=this._currentProviderId++;switch(e){case 0:this._initContentProviderBackend(o,t,e,i),s=new Yo(this._commutator.getCommunicator(o),this._camera,this._context,this._gpuMemoryRegistry,i,t,this._metricsTransport);break;case 1:this._initContentProviderBackend(o,t,0,i),s=new il(this._commutator.getCommunicator(o),this._camera,this._context,this._gpuMemoryRegistry,i,t,this._metricsTransport);break;case 2:this._initContentProviderBackend(o,t,e,i),s=new tl(this._commutator.getCommunicator(o),this._camera,this._context,this._gpuMemoryRegistry,i,t,this._metricsTransport);break;case 3:this._initContentProviderBackend(o,t,e,i),s=new Qo(t,this._commutator.getCommunicator(o),this._camera,this._context,this._gpuMemoryRegistry,i,this._metricsTransport,this.coveredByIndoorFilter);break;case 4:this._initContentProviderBackend(o,t,e,i),s=new cn(t,this._camera,this._context,this._commutator.getCommunicator(o),this._gpuMemoryRegistry,i,this._metricsTransport);break;case 5:this._initContentProviderBackend(o,t,e,i),s=new mn(t,this._context,this._camera,this._commutator.getCommunicator(o),this._gpuMemoryRegistry,i);break;case 6:s=new Wa(this._context,this._camera,this._renderLoop,t,i,this.buildingsFilters,this._metricsTransport);break;case 7:this._initContentProviderBackend(o,t,e,i),s=new _l(t,this._commutator.getCommunicator(o),this._camera,this._context,this._gpuMemoryRegistry,i,this._metricsTransport,this.coveredByIndoorFilter);break;default:throw new Error(`Unknown content provider type: ${e}`)}return this._contentProviders.push({id:o,type:e,provider:s}),s}getObjectMetadata(e){for(let t of this._contentProviders){if(!t)continue;let i=t.provider.getObjectMetadata(e);if(i)return i}}destroyContentProvider(e){let t=this._contentProviders.findIndex((t=>t.provider===e));if(-1!==t){let i=this._contentProviders[t];e.destructor(),this._communicator.sendMessage({type:1,id:i.id},!1),this._contentProviders.splice(t,1)}}_initContentProviderBackend(e,t,i,r){this._communicator.sendMessage({type:0,id:e,name:t,providerType:i,options:r},!1)}_onMemoryUsageInContentProviderChanged(){let e={providers:this._contentProviders.reduce(((e,{provider:t})=>(e[t.name]=t.memoryUsage,e)),{}),providersTotal:this._computeProvidersTotalMemoryUsage(),gpuMemory:this._gpuMemoryRegistry.memoryUsage};this._onMemoryUsageChanged.fire(e)}_computeProvidersTotalMemoryUsage(){let e=this._contentProviders;return{memoryForGlyphs:e.reduce(((e,{provider:t})=>e+t.memoryUsage.memoryForGlyphs),0),memoryForIcons:e.reduce(((e,{provider:t})=>e+t.memoryUsage.memoryForIcons),0)}}},Pl=((yl=Pl||{})[yl.LOW=0]="LOW",yl[yl.MEDIUM=1]="MEDIUM",yl[yl.HIGH=2]="HIGH",yl[yl.ULTRA=3]="ULTRA",yl),wl=class extends Va{constructor(){super(...arguments),this._isLoading=!1,this._isLoaded=!1,this._onLoadingStarted=new qe,this._onLoadingFinished=new qe,this._texturesTierLoading=void 0,this._texturesTierLoaded=void 0,this._onTexturesTierLoadingStarted=new qe,this._onTexturesTierLoadingFinished=new qe}get isLoading(){return this._isLoading}get isLoaded(){return this._isLoaded}get onLoadingStarted(){return this._onLoadingStarted}get onLoadingFinished(){return this._onLoadingFinished}get texturesTierLoading(){return this._texturesTierLoading}get texturesTierLoaded(){return this._texturesTierLoaded}get onTexturesTierLoadingStarted(){return this._onTexturesTierLoadingStarted}get onTexturesTierLoadingFinished(){return this._onTexturesTierLoadingFinished}load(){return this._isLoading=!0,this._onLoadingStarted.fire(this),super.load().finally((()=>{this._isLoading=!1})).then((e=>(this._isLoaded=!0,this._onLoadingFinished.fire(this),e)))}cancelLoading(){this._isLoading=!1,super.cancelLoading()}loadTextures(e){return this._texturesTierLoading=e,this._texturesTierLoaded=void 0,this._onTexturesTierLoadingStarted.fire(this,e),super.loadTextures(e).finally((()=>{this._texturesTierLoading=void 0})).then((t=>(this._texturesTierLoaded=e,this._onTexturesTierLoadingFinished.fire(this,e),t)))}cancelLoadingTextures(){this._texturesTierLoading=void 0,super.cancelLoadingTextures()}};(function(e,t,i=he()){let r=Math.cos(t),s=Math.sin(t);for(let t=0;t<de;t+=4){i[t]=e[t];let o=e[t+1],n=e[t+2];i[t+1]=o*r-n*s,i[t+2]=o*s+n*r,i[t+3]=e[t+3]}})(le,Math.PI/2),z(0,0),Number.MAX_VALUE,z(0,0),z(-1,0),z(1,0),z(0,1),z(0,-1),z(-1,1),z(1,1),z(-1,-1),z(1,-1);var Ml=function(e){let t=new Map;for(let[i,r]of e.entries())t.set(r,i);return t}(new Map([["map",0],["transit",2],["driving",1],["admin",3],["future_map",4]]));function Rl(e){let t=Ml.get(e);if(void 0===t)throw"mapTypeToString: unknown map type";return t}var Sl="#version 100\nattribute vec2 vertexPosition;attribute vec2 vertexUv;uniform float zIndex;\n#ifndef YV_LEAST_16b_P\n# ifdef GL_FRAGMENT_PRECISION_HIGH\n# define YV_LEAST_16b_P highp\n# else\n# define YV_LEAST_16b_P mediump\n# endif\n#endif\nvarying YV_LEAST_16b_P vec2 uv;void main(void){gl_Position=vec4(vertexPosition,zIndex,1);uv=vertexUv;}",Cl=new O({depthTest:!0,depthFunc:518}),Il={LIGHT:{r:.98,g:.97,b:.94,a:1},DARK:{r:.12,g:.14,b:.18,a:1}},El=class extends Ve{constructor(e){let t=e.createProgram(Sl,"#version 100\nuniform lowp vec4 color;void main(){gl_FragColor=color;}",{attribMap:{vertexPosition:0,vertexUv:4}});super(e,Cl,t),this._color=Il.LIGHT,e.bindProgram(t),t.setScalarUniform("zIndex",-1),this.onUpdate=new qe}setColor(e){this._color=e,this.onUpdate.fire()}_render(){this._context.bindQuadVao(),this._context.drawQuad()}_prepareProgram(e){super._prepareProgram(e),e.setScalarUniform("dpr",Vi());let{r:t,g:i,b:r,a:s}=this._color;e.setVector4Uniform("color",{x:t,y:i,z:r,w:s})}},Al=new O({depthTest:!0,clearDepth:-1}),Ll=(e=>(e[e.NO_CLEAR=0]="NO_CLEAR",e[e.BEFORE_RENDER=1]="BEFORE_RENDER",e))(Ll||{}),Ul=class extends cr{constructor(e,t=0){super(),this._depthClearStrategy=t,this._context=e}render(e,...t){this._clearDepthIfNeeded(e),super.render(e,...t)}renderHitTestBuffer(e,...t){this._clearDepthIfNeeded(e),super.renderHitTestBuffer(e,...t)}_clearDepthIfNeeded(e){1===this._depthClearStrategy&&(this._context.bindRenderState(Al),this._context.bindRenderTarget(e),this._context.clearCurrentTarget(256))}},Ol=new O(A),Dl=class extends Ve{constructor(e,t){super(e,Ol,e.createProgram(Sl,"#version 100\nprecision mediump float;uniform vec2 pixelSize;uniform sampler2D texture;uniform float dpr;const float FXAA_QUALITY_SUBPIX=0.75;const float FXAA_QUALITY_EDGE_THRESHOLD=0.063;const float FXAA_QUALITY_EDGE_THRESHOLD_MIN=0.0625;const float EPSILON=0.0001;float luma(vec4 rgba){return dot(rgba.xyz,vec3(0.299,0.587,0.114));}vec4 fxaa(vec2 pos,sampler2D tex,vec2 fxaaQualityRcpFrame,float fxaaQualitySubpix,float fxaaQualityEdgeThreshold,float fxaaQualityEdgeThresholdMin){vec2 posM;posM.x=pos.x;posM.y=pos.y;vec4 rgbyM=texture2D(tex,posM);float lumaM=luma(rgbyM);float lumaS=luma(texture2D(tex,posM+vec2(0,1)*fxaaQualityRcpFrame.xy));float lumaE=luma(texture2D(tex,posM+vec2(1,0)*fxaaQualityRcpFrame.xy));float lumaN=luma(texture2D(tex,posM+vec2(0,-1)*fxaaQualityRcpFrame.xy));float lumaW=luma(texture2D(tex,posM+vec2(-1,0)*fxaaQualityRcpFrame.xy));float maxSM=max(lumaS,lumaM);float minSM=min(lumaS,lumaM);float maxESM=max(lumaE,maxSM);float minESM=min(lumaE,minSM);float maxWN=max(lumaN,lumaW);float minWN=min(lumaN,lumaW);float rangeMax=max(maxWN,maxESM);float rangeMin=min(minWN,minESM);float rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;float range=rangeMax-rangeMin;float rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);bool earlyExit=range<rangeMaxClamped;if(earlyExit)return rgbyM;float lumaNW=luma(texture2D(tex,posM+vec2(-1,-1)*fxaaQualityRcpFrame.xy));float lumaSE=luma(texture2D(tex,posM+vec2(1,1)*fxaaQualityRcpFrame.xy));float lumaNE=luma(texture2D(tex,posM+vec2(1,-1)*fxaaQualityRcpFrame.xy));float lumaSW=luma(texture2D(tex,posM+vec2(-1,1)*fxaaQualityRcpFrame.xy));float lumaNS=lumaN+lumaS;float lumaWE=lumaW+lumaE;float subpixRcpRange=1.0/range;float subpixNSWE=lumaNS+lumaWE;float edgeHorz1=(-2.0*lumaM)+lumaNS;float edgeVert1=(-2.0*lumaM)+lumaWE;float lumaNESE=lumaNE+lumaSE;float lumaNWNE=lumaNW+lumaNE;float edgeHorz2=(-2.0*lumaE)+lumaNESE;float edgeVert2=(-2.0*lumaN)+lumaNWNE;float lumaNWSW=lumaNW+lumaSW;float lumaSWSE=lumaSW+lumaSE;float edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);float edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);float edgeHorz3=(-2.0*lumaW)+lumaNWSW;float edgeVert3=(-2.0*lumaS)+lumaSWSE;float edgeHorz=abs(edgeHorz3)+edgeHorz4;float edgeVert=abs(edgeVert3)+edgeVert4;float subpixNWSWNESE=lumaNWSW+lumaNESE;float lengthSign=fxaaQualityRcpFrame.x;bool horzSpan=edgeHorz>=edgeVert;float subpixA=subpixNSWE*2.0+subpixNWSWNESE;if(horzSpan){lengthSign=fxaaQualityRcpFrame.y;}else{lumaN=lumaW;lumaS=lumaE;}float subpixB=(subpixA*(1.0/12.0))-lumaM;float gradientN=lumaN-lumaM;float gradientS=lumaS-lumaM;float lumaNN=lumaN+lumaM;float lumaSS=lumaS+lumaM;bool pairN=abs(gradientN)>=abs(gradientS);float gradient=max(abs(gradientN),abs(gradientS));if(pairN){lengthSign=-lengthSign;}else{lumaNN=lumaSS;}float subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);vec2 posB=posM;vec2 offNP;vec2 offHM;if(horzSpan){offNP=vec2(fxaaQualityRcpFrame.x,0.0);offHM=vec2(0.0,lengthSign);}else{offNP=vec2(0.0,fxaaQualityRcpFrame.y);offHM=vec2(lengthSign,0.0);}vec2 posN=posB-offNP*2.;vec2 posP=posB+offNP*2.;float subpixD=((-2.0)*subpixC)+3.0;float lumaEndN=luma(mix(texture2D(tex,posN),texture2D(tex,posN+offHM),0.5));float subpixE=subpixC*subpixC;float lumaEndP=luma(mix(texture2D(tex,posP),texture2D(tex,posP+offHM),0.5));float gradientScaled=gradient*0.25;float lumaMM=lumaM-lumaNN*0.5;float subpixF=subpixD*subpixE;bool lumaMLTZero=lumaMM<0.0;lumaEndN-=lumaNN*0.5;lumaEndP-=lumaNN*0.5;bool doneN=abs(lumaEndN)>=gradientScaled;bool doneP=abs(lumaEndP)>=gradientScaled;if(!doneN){posN-=offNP*3.0;}bool doneNP=(!doneN)||(!doneP);if(!doneP){posP+=offNP*3.0;}if(doneNP){if(!doneN){lumaEndN=luma(mix(texture2D(tex,posN),texture2D(tex,posN+offHM),0.5));lumaEndN=lumaEndN-lumaNN*0.5;}if(!doneP){lumaEndP=luma(mix(texture2D(tex,posP.xy),texture2D(tex,posP.xy+offHM),0.5));lumaEndP=lumaEndP-lumaNN*0.5;}doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN){posN-=offNP*12.0;}if(!doneP){posP+=offNP*12.0;}}float dstN=posM.x-posN.x;float dstP=posP.x-posM.x;if(!horzSpan){dstN=posM.y-posN.y;dstP=posP.y-posM.y;}float goodSpanN=float((lumaEndN<0.0)!=lumaMLTZero);float spanLength=(dstP+dstN);float goodSpanP=float((lumaEndP<0.0)!=lumaMLTZero);float spanLengthRcp=1.0/spanLength;float directionN=float(dstN<dstP);float dst=min(dstN,dstP);float goodSpan=mix(goodSpanP,goodSpanN,directionN);float subpixG=subpixF*subpixF;float pixelOffset=(dst*(-spanLengthRcp))+0.5;float subpixH=subpixG*fxaaQualitySubpix;float pixelOffsetGood=mix(0.0,pixelOffset,goodSpan);float pixelOffsetSubpix=max(pixelOffsetGood,subpixH);vec4 color;float factor=pixelOffsetSubpix;if(horzSpan){color=mix(texture2D(tex,posM),texture2D(tex,posM+vec2(0.0,lengthSign)),factor);}else{color=mix(texture2D(tex,posM),texture2D(tex,posM+vec2(lengthSign,0.0)),factor);}return color;}void main(){vec2 pos=gl_FragCoord.xy*pixelSize;vec4 color=fxaa(pos,texture,pixelSize,FXAA_QUALITY_SUBPIX,FXAA_QUALITY_EDGE_THRESHOLD,FXAA_QUALITY_EDGE_THRESHOLD_MIN);if(color.a>EPSILON){color.xyz/=color.a;}gl_FragColor=color;}",{attribMap:{vertexPosition:0}})),this._renderers=new cr,this._renderLoop=t,this.onUpdate=this._renderers.onUpdate,this._pixelSize=z(0,0)}addRenderUnit(e){this._renderers.addRenderUnit(e)}removeRenderUnit(e){this._renderers.removeRenderUnit(e)}render(e,...t){if(this._renderLoop.isActive)return this._renderers.render(e,...t),void this._renderLoop.update();this._intermediateRenderbuffer?Hi(this._intermediateRenderbuffer.size,e.size)||(this._destroyInternalRenderTargets(),this._initIntermediateRenderTargets(e.size)):this._initIntermediateRenderTargets(e.size),this._context.bindRenderTarget(this._intermediateRenderbuffer),this._context.clearCurrentTarget(17664),this._renderers.render(this._intermediateRenderbuffer,...t),this._intermediateRenderbuffer.isClear||(this._updateFrameUniformState(e),super.render(e,...t))}renderHitTestBuffer(e,...t){this._renderers.renderHitTestBuffer(e,...t)}destroy(){this._intermediateRenderbuffer&&this._destroyInternalRenderTargets()}_render(){this._context.bindQuadVao(),this._context.drawQuad()}_prepareProgram(e,...t){super._prepareProgram(e,...t),this._context.bindTextureUnit(0),this._context.bindTexture(this._intermediateColorBuffer),e.setIntScalarUniform("texture",0),e.setVector2Uniform("pixelSize",this._pixelSize),e.setScalarUniform("dpr",Vi())}_updateFrameUniformState(e){this._pixelSize.x=1/e.size.width,this._pixelSize.y=1/e.size.height}_initIntermediateRenderTargets({width:e,height:t}){let i=this._context,r=this._intermediateColorBuffer=i.createEmpty2DTexture(e,t,6408,5121),s=this._intermediateDepthStencilBuffer=i.createRenderbuffer(e,t,34041);this._intermediateRenderbuffer=i.createFramebuffer({color:r,depthStencil:s})}_destroyInternalRenderTargets(){this._intermediateRenderbuffer.destroy(),this._intermediateColorBuffer.destroy(),this._intermediateDepthStencilBuffer.destroy()}},zl=new O(A),Bl={attribMap:{vertexPosition:0,vertexUV:4}},Fl=class extends Ve{constructor(e){super(e,zl,e.createProgram("#version 100\nprecision mediump float;attribute vec2 vertexPosition;attribute vec2 vertexUV;varying vec2 uv;void main(){gl_Position=vec4(vertexPosition,0,1);uv=vertexUV;}","#version 100\nprecision mediump float;uniform sampler2D texture;varying vec2 uv;void main(){gl_FragColor=texture2D(texture,uv);}",Bl))}_render(e){this._context.bindTextureUnit(0),this._context.bindTexture(e),this._context.bindQuadVao(),this._context.drawQuad()}},Vl=new O({depthTest:!0,clearDepth:1}),Nl=class extends Ul{constructor(e){super(e),this._midRenderer=new class{constructor(e,t=!0){this._context=e,this._depthBufferEnabled=t,this._outputSize=Ni(-1,-1),this._overlayRenderer=new Fl(e)}render(e,t,...i){this._syncOutputBufferWith(e),this._prepareOutputBuffer(),t(this._outputBuffer,...i),this._outputBuffer.isClear||this._overlayRenderer.render(e,this._outputTexture)}destroy(){var e,t,i;this._overlayRenderer.destroy(),null==(e=this._outputTexture)||e.destroy(),null==(t=this._outputDepthBuffer)||t.destroy(),null==(i=this._outputBuffer)||i.destroy()}_syncOutputBufferWith(e){var t;if(!Hi(this._outputSize,e.size)){(this._outputTexture||this._outputDepthBuffer||this._outputBuffer)&&(this._outputTexture.destroy(),null==(t=this._outputDepthBuffer)||t.destroy(),this._outputBuffer.destroy());let{width:i,height:r}=ki(e.size,this._outputSize);this._outputTexture=this._context.createEmpty2DTexture(i,r,6408,5121),this._outputDepthBuffer=this._depthBufferEnabled?this._context.createRenderbuffer(i,r,34041):void 0,this._outputBuffer=this._context.createFramebuffer({color:this._outputTexture,depthStencil:this._outputDepthBuffer})}}_prepareOutputBuffer(){this._context.bindRenderTarget(this._outputBuffer),this._context.bindRenderState(Vl),this._context.clearCurrentTarget(16640)}}(e)}render(e,...t){this._midRenderer.render(e,super.render.bind(this),...t)}renderHitTestBuffer(e,...t){this._prepareHitTestRenderTarget(e),super.renderHitTestBuffer(e,...t)}destroy(){this._midRenderer.destroy()}_prepareHitTestRenderTarget(e){this._context.bindRenderTarget(e),this._context.bindRenderState(kl),this._context.clearCurrentTarget(256)}},kl=new O({depthTest:!0,clearDepth:1}),Hl=jl(0,0,0,0);function jl(e,t,i,r){return{x:e,y:t,z:i,w:r}}var Gl=class extends as{constructor(e,t,i,r,s,o,n={}){super(e,t,i,r,s,o),this._colorTransformProvider=n.colorTransform,this._opacityProvider=n.opacity||(()=>1)}_prepareProgram(e,t,i,...r){var s;super._prepareProgram(e,t,i,...r);let o=null==(s=this._colorTransformProvider)?void 0:s.call(this);o?(e.setVector4Uniform("highlightId",function(e,t){return function(e,t,i,r,s){return s.x=e,s.y=t,s.z=i,s.w=r,s}(255&e,e>>8&255,e>>16&255,e>>24&255,t)}(o.objectId,Wl)),e.setMatrix4Uniform("highlightColorTransform",o.transform)):e.setVector4Uniform("highlightId",Hl),e.setScalarUniform("opacity",this._opacityProvider())}},Wl=jl(0,0,0,0);var ql={hitTest:!1};function Yl(e,...t){let i=f({},e);for(let e of t)if(e)for(let t of Object.keys(e)){let r=e[t];void 0!==r&&(i[t]=r)}return i}var Xl="#version 100\nattribute vec3 vertexPos;attribute vec2 vertexUV;attribute vec4 vertexColorId;attribute mat4 vertexTransform;uniform mat4 viewProjMatrix;uniform mat4 modelMatrix;uniform float zFactor;uniform vec4 primitiveId;uniform float hasVertexTransform;\n#ifndef YV_COLOR_ID\nuniform vec4 highlightId;uniform mat4 highlightColorTransform;\n#endif\n#ifndef YV_COLOR_ID\nvarying vec2 uv;varying vec3 globalPosition;varying mat4 colorTranform;\n#else\nvarying vec4 id;\n#endif\nconst float ADJUSTING_FACTOR=pow(2.0,10.0);vec4 applyImprecisePerspectiveDivisionFix(vec4 position){return position*ADJUSTING_FACTOR;}float areFuzzyEqual(vec4 a,vec4 b,float threshold){return float(all(lessThan(abs(a-b),vec4(threshold))));}mat4 pickMatrix(float flag,mat4 matrix){return(1.0-flag)*mat4(1.0)+flag*matrix;}void main(void){mat4 transformMatrix=pickMatrix(hasVertexTransform,vertexTransform);vec4 position=transformMatrix*modelMatrix*vec4(vertexPos,1);position.z*=zFactor*position.w;vec4 objectId=vec4(vertexColorId.x*255.0+primitiveId.x,primitiveId.yzw);\n#ifndef YV_COLOR_ID\nuv=vertexUV;globalPosition=position.xyz/position.w;float isHighlighted=areFuzzyEqual(objectId,highlightId,0.5);colorTranform=pickMatrix(isHighlighted,highlightColorTransform);\n#else\nid=objectId/255.0;\n#endif\ngl_Position=viewProjMatrix*position;gl_Position=applyImprecisePerspectiveDivisionFix(gl_Position);}";function Zl(e,t,i,r=he()){let s=$(e.rtc,$l);return s.x-=i.x,s.y-=i.y,me(ue(le,s,Ql),t,r)}var $l=W(0,0,0),Ql=he(),Kl=class extends Gl{constructor(e,t,i={},r){let s=Yl(ql,r),o=t.createProgram(Xl,"#version 100\n#extension GL_OES_standard_derivatives : require\nprecision highp float;uniform sampler2D colorTexture;uniform vec4 colorFactor;uniform vec4 diffuseColor;uniform float materialFactor;uniform float opacity;varying vec2 uv;varying vec3 globalPosition;varying mat4 colorTranform;const vec3 LIGHT_DIRECTION=vec3(0.2,0.2,1.0);const float LIGHT_LENGTH=length(LIGHT_DIRECTION);const float LIGHT_INTENSITY=0.4;const float AMBIENT_LIGHT_INTENSITY=1.0-LIGHT_INTENSITY;const float HORIZONTAL_PLANE_DIFFUSE_INTENSITY=AMBIENT_LIGHT_INTENSITY+0.5*LIGHT_INTENSITY*(LIGHT_DIRECTION.z+1.0);vec4 getPlaneColor(vec4 diffuseColor,vec3 unnormalizedNormal,float dXnormalizator,float dYnormalizator){float dotProduct=dot(unnormalizedNormal,LIGHT_DIRECTION)/dYnormalizator/LIGHT_LENGTH/dXnormalizator;vec3 rgb=diffuseColor.rgb*(AMBIENT_LIGHT_INTENSITY+0.5*LIGHT_INTENSITY*(dotProduct+1.0))/HORIZONTAL_PLANE_DIFFUSE_INTENSITY;return vec4(rgb,diffuseColor.a);}vec4 transformColor(vec4 color,mat4 transform){return transform*vec4(color.rgb,1)*vec4(1,1,1,color.a);}vec4 maybeTransformColor(vec4 color,mat4 transform,bool condition){return mix(color,transformColor(color,transform),float(condition));}void main(void){vec3 dxpos=dFdx(globalPosition);vec3 dypos=dFdy(globalPosition);vec3 crossProduct=cross(dxpos,dypos);vec4 color=mix(getPlaneColor(diffuseColor,crossProduct,length(dxpos),length(dypos)),texture2D(colorTexture,uv)*colorFactor,materialFactor);gl_FragColor=transformColor(color,colorTranform);gl_FragColor.a*=opacity;}",td),n=s.hitTest?t.createProgram(Xl,Wi,id):void 0;super(e,t,rd,o,rd,n,i),t.enableInstancedArraysExtension(),this._stubTexture=function(e){let t=e.createEmpty2DTexture(1,1,6408,5121);return e.setTextureData(t,new Uint8Array([255,255,255,255])),t}(t),this._materialFactorProvider=function(e){let{materialFactor:t}=e;return t?e=>{var i;return ke(null!=(i=t(e))?i:1,0,1)}:()=>1}(i),this._heightFactorProvider=function(e){let{heightFactor:t}=e;return null!=t?t:()=>1}(i),this._diffuseColorProvider=function(e){let{diffuseColor:t}=e;return null!=t?t:()=>sd}(i)}destroy(){this._stubTexture.destroy(),super.destroy()}_canBatchAdjacentPrimitives(e,t){let i=e.id===t.id,r=void 0!==e.instanceCount==(void 0!==t.instanceCount);return i&&r&&super._canBatchAdjacentPrimitives(e,t)}_getHitTestPrimitives(){return ye(super._getHitTestPrimitives(),ed)}_render(e,t){let i=this._program;for(let r of t)for(let t of os(this._getPrimitives(),this._canBatchPredicate))this._setUniforms(t.firstPrimitive,e,r.lookAt,i),this._setColorUniforms(t.firstPrimitive,i),this._renderBatch(t,i)}_renderBatch(e,t){Jl(this._context,e)}_renderHitTestBuffer(e,t){let i=this._hitTestProgram;for(let r of t)for(let t of os(this._getHitTestPrimitives(),this._canBatchPredicate))this._setUniforms(t.firstPrimitive,e,r.lookAt,i),this._renderHitTestBufferBatch(t,i)}_renderHitTestBufferBatch(e,t){Jl(this._context,e)}_setUniforms(e,t,i,r){let s=Zl(e,t,i,nd);r.setMatrix4Uniform("viewProjMatrix",s),r.setMatrix4Uniform("modelMatrix",e.matrix),function(e,t){t.x=e>>0&255,t.y=e>>8&255,t.z=e>>16&255,t.w=e>>24&255}(e.id,od),r.setVector4Uniform("primitiveId",od),r.setScalarUniform("zFactor",e.animateHeight?this._heightFactorProvider():1),r.setScalarUniform("hasVertexTransform",void 0!==e.instanceCount?1:0)}_setColorUniforms(e,t){t.setColorUniform("diffuseColor",this._diffuseColorProvider()),t.setScalarUniform("materialFactor",this._materialFactorProvider(e.modelId)),this._context.bindTextureUnit(0),this._context.bindTexture(e.colorTexture||this._stubTexture),t.setIntScalarUniform("colorTexture",0),t.setColorUniform("colorFactor",e.colorFactor)}};function Jl(e,t){e.bindVao(t.firstPrimitive.vao),void 0===t.firstPrimitive.instanceCount?e.drawIndexedMesh(t.indexByteOffset,is(t.indexByteLength,t.indexType),4,t.indexType):e.drawIndexedMeshInstanced(t.indexByteOffset,is(t.indexByteLength,t.indexType),4,t.indexType,t.firstPrimitive.instanceCount)}function ed(e){return void 0!==e.metadata}var td={attribMap:{vertexPos:0,vertexUV:4,vertexColorId:2,vertexTransform:12}},id={attribMap:td.attribMap,defines:{YV_COLOR_ID:1}},rd=new O({depthTest:!0,cullFace:!0,cullFaceMode:1029}),sd=w,od=jl(0,0,0,0),nd=he();function ad(e,t){return t?me(e,t):e}var ld=.2125,dd=.7154,hd=.0721;function cd(e){let t,{color:i,lightness:r,opacity:s,saturation:o}=e;if(void 0!==i){let e=function({r:e,g:t,b:i,a:r}){return[0,0,0,e,0,0,0,t,0,0,0,i,0,0,0,r]}(i);return ge(e,e)}return void 0!==r&&(t=ad(function(e){let t=1-Math.abs(e),i=Math.max(0,e);return[t,0,0,i,0,t,0,i,0,0,t,i,0,0,0,1]}(r),t)),void 0!==o&&(t=ad(function(e){let t=(1-e)*ld,i=(1-e)*dd,r=(1-e)*hd;return[t+e,i,r,0,t,i+e,r,0,t,i,r+e,0,0,0,0,1]}(o+1),t)),void 0!==s&&(t=ad(function(e){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,e]}(s),t)),t?ge(t,t):ce(le)}var ud=class{constructor(e,t,i){this._onViewportUpdate=()=>{let e=function(e){return!e[Symbol.iterator]().next().done}(this._viewport.getModels());e!==this._isAppearing&&(this._isAppearing=e,this._lastAnimationTick=Gi(),this._renderLoop.update())},this._onBeforeRender=()=>{if(void 0!==this._lastAnimationTick){let e=Gi(),t=(e-this._lastAnimationTick)/this._duration;this._heightFactor=this._isAppearing?ke(this._heightFactor+t,0,1):0,this._lastAnimationTick=this._isAppearing&&this._heightFactor<1?e:void 0,this._renderLoop.update()}},this._viewport=e,this._renderLoop=t,this._duration=i,this._isAppearing=!1,this._lastAnimationTick=void 0,this._heightFactor=0,this.heightProvider=()=>this._heightFactor,this._viewport.onUpdate.addListener(this._onViewportUpdate),this._renderLoop.onBeforeRender.addListener(this._onBeforeRender),this._onViewportUpdate()}destroy(){this._renderLoop.onBeforeRender.removeListener(this._onBeforeRender),this._viewport.onUpdate.removeListener(this._onViewportUpdate)}},_d=new O(L),pd=class extends cr{constructor(e,t,i){super(),this._context=e,this._scene=t,this._portionPrimitiveProvider=i,this._pool=new class{constructor(e,t){this.capacity=e,this._factory=t,this._usedObjs=new Set,this._freeObjs=[]}destroy(){qr(0===this._usedObjs.size,"Tried to destroy a pool while objects are in use");for(let e of this._freeObjs)e.destroy()}acquire(){let e=this._freeObjs.pop()||this._factory();return this._usedObjs.add(e),e}release(e){this._usedObjs.delete(e)?this._freeObjs.length<this.capacity?(this._freeObjs.push(e),e.reset&&e.reset()):e.destroy():qr(!1,"Tried to release an unused object")}}(4,(()=>this._createFramebuffer())),this._program=e.createProgram(Sl,"#version 100\nuniform sampler2D texture;uniform lowp float opacity;varying mediump vec2 uv;void main(){gl_FragColor=texture2D(texture,uv)*opacity;}",{attribMap:{vertexPosition:0,vertexUv:4}}),this._scene.onUpdate.addListener(this._onSceneUpdate,this)}destroy(){this._scene.onUpdate.removeListener(this._onSceneUpdate),this._program.destroy(),this._pool.destroy()}render(e,...t){let{root:i}=this._scene;i&&this._renderGroup(i,e,...t)}renderHitTestBuffer(e,...t){let{root:i}=this._scene;i&&this._renderGroupHitTest(i,e,...t)}_onSubRenderUnitUpdate(){}_renderGroupChildren(e,t,...i){for(let r of e.batchedChildren)1===r.type?this._renderGroup(r,t,...i):(this._portionPrimitiveProvider.setPortion(r.content),super.render(t,...i))}_renderGroup(e,t,...i){if(e.opacity<1){let r=this._pool.acquire();this._resizeIfNeeded(r),this._context.bindRenderTarget(r.framebuffer),this._context.clearCurrentTarget(16384),this._renderGroupChildren(e,r.framebuffer,...i),this._renderTexture(r.color,e.opacity,t),this._pool.release(r)}else this._renderGroupChildren(e,t,...i)}_renderGroupHitTest(e,t,...i){for(let r of e.batchedChildren)1===r.type?this._renderGroupHitTest(r,t,...i):(this._portionPrimitiveProvider.setPortion(r.content),super.renderHitTestBuffer(t,...i))}_renderTexture(e,t,i){this._context.bindProgram(this._program),this._context.bindTextureUnit(0),this._context.bindTexture(e),this._program.setIntScalarUniform("texture",0),this._program.setScalarUniform("opacity",t),this._context.bindRenderState(_d),this._context.bindRenderTarget(i),this._context.bindQuadVao(),this._context.drawQuad()}_createFramebuffer(){let{width:e,height:t}=this._context.getDefaultRenderTarget().size,i=this._context.createEmpty2DTexture(e,t,6408,5121),r=this._context.createFramebuffer({color:i});return{framebuffer:r,color:i,destroy:()=>{r.destroy(),i.destroy()}}}_resizeIfNeeded(e){let{color:t}=e,{size:i}=this._context.getDefaultRenderTarget();(i.width!==t.getWidth()||i.height!==t.getHeight())&&(e.framebuffer.destroy(),this._context.resizeTexture(t,i),e.framebuffer=this._context.createFramebuffer({color:t}))}_onSceneUpdate(){this._onUpdate.fire()}},md=class{constructor(){this._currentPortion={primitives:{}},this._onUpdate=new qe}setPortion(e){this._currentPortion=e,this._onUpdate.fire()}getProvider(e){let t=this,i={get primitives(){return t._currentPortion.primitives[e]||fd},get visiblePrimitives(){return i.primitives},onUpdate:this._onUpdate};return i}},fd=[],gd=class{constructor(e,t){this._type=e,this._scene=t,this.onUpdate=new qe}get primitives(){let e=this._scene,t=this._type;return{*[Symbol.iterator](){let i=e.root?[e.root]:[];for(;i.length>0;){let e=i.pop();for(let r of e.batchedChildren)0===r.type?yield*r.content.primitives[t]:i.push(r)}}}}get visiblePrimitives(){return this.primitives}},vd={attribMap:{vertexPosition:0,vertexUv:4}},yd=class{constructor(e,t,i){this._makeRenderState=it(Pd),this._context=e,this._camera=t,this._onUpdate=new qe,e.enableFragDepthExtension(),this._renderer=new i(e.gl,{requestRender:()=>this._onUpdate.fire()}),this._program=e.createProgram(Sl,"#version 100\n#extension GL_EXT_frag_depth : enable\nprecision mediump float;uniform sampler2D texture;uniform sampler2D depth;varying mediump vec2 uv;void main(){gl_FragColor=texture2D(texture,uv);gl_FragDepthEXT=texture2D(depth,uv).x;}",vd)}get onUpdate(){return this._onUpdate}renderHitTestBuffer(){}render(e,t,i){let r=this._renderer.render({size:e.size,worlds:i.map((({lookAt:e})=>({camera:this._camera,lookAt:e,viewProjMatrix:t})))});this._context.restoreContext();let s=Td(this._context,r.color,xd),o=Td(this._context,r.depth||null,bd);this._context.bindRenderTarget(e),this._context.bindQuadVao(),this._context.bindProgram(this._program),this._setRenderState(r),this._context.bindTextureUnit(0),this._context.bindTexture(s),this._context.bindTextureUnit(1),this._context.bindTexture(o),this._program.setIntScalarUniform("texture",0),this._program.setIntScalarUniform("depth",1),this._context.drawQuad()}destroy(){this._renderer.destroy()}_setRenderState(e){let t=this._makeRenderState(!!e.depth,e.premultipliedAlphaBlend,e.clearDepthValue);this._context.bindRenderState(t),void 0!==e.clearDepthValue&&this._context.clearCurrentTarget(256)}},xd={},bd={};function Td(e,t,i){return(!i.texture||i.texture.handle!==t)&&(i.texture=e.wrapExternalTexture(t)),i.texture}function Pd(e,t,i){return new O(t?L:A,{depthTest:e,clearDepth:i})}var wd=tt((e=>2/(256*Math.pow(2,e)))),Md="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexNormal;attribute vec2 vertexDisplacement;attribute vec2 vertexUv;attribute vec4 vertexIconLocation;attribute float vertexScale;attribute vec4 vertexId;attribute vec2 vertexZoomRelatedData;attribute float vertexZIndex;attribute vec2 vertexCurrentAndSegmentLength;varying highp vec2 textureCoordinates;varying highp vec4 iconLocation;varying vec4 id;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform highp float worldToPxFactor;uniform float zoom;uniform float zoomScaleFactor;uniform float snapGeometryToNearestZoom;const float MAX_DISPLACEMENT_STROKE_WIDTH=8192.0;const float MAX_TEXTURE_COORDINATE_PX=2048.0;const float MAX_ZOOM=64.0;const float MAX_TEXTURE_DISPLACEMENT=8192.0;const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);const float ADJUSTING_FACTOR=pow(2.0,10.0);vec4 applyImprecisePerspectiveDivisionFix(vec4 position){return position*ADJUSTING_FACTOR;}void main(void){float vertexZoom=mix(vertexZoomRelatedData[0]*MAX_ZOOM,floor(zoom+0.5),snapGeometryToNearestZoom);float vertexZoomTextureUScale=vertexZoomRelatedData[1]*MAX_TEXTURE_DISPLACEMENT;float zoomGeometryScale=pow(2.0,(zoom-vertexZoom)*zoomScaleFactor);float zoomScaledWorldToPxFactor=worldToPxFactor*zoomGeometryScale;float zoomScaledPxSegmentLength=vertexCurrentAndSegmentLength.y/zoomScaledWorldToPxFactor;vec2 direction=vec2(vertexNormal.y,-vertexNormal.x);vec2 displacement=vertexDisplacement*MAX_DISPLACEMENT_STROKE_WIDTH;displacement.x=min(abs(displacement.x),zoomScaledPxSegmentLength)*sign(displacement.x);gl_Position=viewProjMatrix*vec4((YV_H*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*YV_N+(displacement.x*direction+displacement.y*vertexNormal)*zoomScaledWorldToPxFactor,0,1);gl_Position.z=gl_Position.w*vertexZIndex;gl_Position=applyImprecisePerspectiveDivisionFix(gl_Position);\n#ifndef YV_COLOR_ID\ntextureCoordinates=vertexUv*MAX_TEXTURE_COORDINATE_PX*vertexScale;iconLocation=vertexIconLocation;float zoomUDisplacementScale=pow(2.0,vertexZoom-zoom)*zoomGeometryScale;float vertexWorldToPxFactor=worldToPxFactor*pow(2.0,zoom-vertexZoom);float pxCurrentLength=vertexCurrentAndSegmentLength.x/vertexWorldToPxFactor;float uDisplacement=min(abs(vertexZoomTextureUScale),zoomScaledPxSegmentLength)*sign(vertexZoomTextureUScale);textureCoordinates.x+=(pxCurrentLength+uDisplacement*zoomUDisplacementScale)*vertexScale;\n#else\nid=vertexId;\n#endif\n}",Rd={depthTest:!0,depthMask:!1,depthFunc:518},Sd=new O(L),Cd={attribMap:{vertexId:2,vertexPosHigh:0,vertexPosLow:1,vertexNormal:5,vertexDisplacement:6,vertexZIndex:10,vertexUv:4,vertexIconLocation:12,vertexScale:13,vertexZoomRelatedData:14,vertexCurrentAndSegmentLength:15,vertexColor:11}},Id={attribMap:Cd.attribMap,defines:{YV_COLOR_ID:1}},Ed=g(f({},ql),{maxZoomWithTilesLoading:1/0,snapGeometryToNearestZoom:!1,renderState:Sd,depthTest:!0}),Ad=class extends Gl{constructor(e,t,i,r,s){let o=Yl(Ed,s),n=new O(o.renderState,o.depthTest?Rd:{}),a=t.createProgram(Md,"#version 100\nprecision mediump float;varying highp vec2 textureCoordinates;varying highp vec4 iconLocation;uniform sampler2D atlas;uniform vec2 atlasSize;uniform float alphaThreshold;uniform float opacity;void main(void){vec2 iconSize=iconLocation.yw-iconLocation.xz;highp vec2 texCoordinates=textureCoordinates;texCoordinates.x=mod(texCoordinates.x,iconSize.x);vec2 uv=iconLocation.xz+texCoordinates;vec4 color=texture2D(atlas,uv/atlasSize);if(color.a<alphaThreshold){discard;}gl_FragColor=color*opacity;}",Cd),l=o.hitTest?t.createProgram(Md,Wi,Id):void 0;super(e,t,n,a,new O(U),l,r),this._camera=i,this._atlasSizeUniform=z(0,0),this._maxZoomWithTilesLoading=o.maxZoomWithTilesLoading,this._snapGeometryToNearestZoom=o.snapGeometryToNearestZoom}_prepareProgram(e,t,i,...r){super._prepareProgram(e,t,i,...r),this._prepareProgramState(e)}_prepareHitTestProgram(e,t,i,...r){super._prepareHitTestProgram(e,t,i,...r),this._prepareProgramState(e)}_renderBatch(e,t){let i=e.firstPrimitive.texture;this._atlasSizeUniform.x=i.getWidth(),this._atlasSizeUniform.y=i.getHeight(),t.setVector2Uniform("atlasSize",this._atlasSizeUniform),this._context.bindTextureUnit(0),this._context.bindTexture(i,9729,9729),super._renderBatch(e,t)}_canBatchAdjacentPrimitives(e,t){return super._canBatchAdjacentPrimitives(e,t)&&e.texture===t.texture}_prepareProgramState(e){let t=this._camera.zoom,i=ke((t-this._maxZoomWithTilesLoading)/2*.5+.5,.5,1);e.setScalarUniform("worldToPxFactor",wd(t)),e.setScalarUniform("zoom",t),e.setScalarUniform("zoomScaleFactor",i),e.setScalarUniform("snapGeometryToNearestZoom",Number(this._snapGeometryToNearestZoom))}},Ld=class extends Ad{constructor(e,t,i,r=Ud,s){super(e,t,i,r,g(f({},s),{renderState:Od})),this._stencilIdProvider=r.stencilId}_renderBatch(e,t){if(e.firstPrimitive.opacity>=1)return this._renderState.stencilTest=!1,this._context.bindRenderState(this._renderState),super._renderBatch(e,t);let i=this._stencilIdProvider();i.shouldClear&&this._context.clearCurrentTarget(1024),this._renderState.stencilTest=!0,this._renderState.stencilReference=i.id,this._context.bindRenderState(this._renderState),t.setScalarUniform("alphaThreshold",.9*e.firstPrimitive.opacity),super._renderBatch(e,t),t.setScalarUniform("alphaThreshold",0),super._renderBatch(e,t)}_canBatchAdjacentPrimitives(e,t){return(e.id===t.id||e.opacity>=1&&t.opacity>=1)&&super._canBatchAdjacentPrimitives(e,t)}},Ud={stencilId:()=>{throw new Error("stencilIdProvider is not provided")}},Od=new O(Sd,{stencilTest:!0,stencilFrontFunc:517,stencilBackFunc:517,stencilFrontDepthPassOp:7681,stencilBackDepthPassOp:7681}),Dd="#version 100\nattribute vec4 vertexId;attribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexDisplacement;attribute vec2 vertexUV;attribute float vertexPriority;attribute lowp vec4 vertexColor;attribute lowp vec4 vertexOutlineColor;attribute float vertexHeight;attribute float vertexZPos;uniform float isOutlinePhase;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 atlasSize;uniform sampler2D visibility;uniform vec2 idHalfPxSize;uniform vec2 shift;uniform lowp float currentZoom;uniform float dpr;uniform vec4 highlightId;uniform mat4 highlightColorTransform;varying highp vec2 uv;varying float weight;varying float smoothness;varying lowp vec4 color;varying lowp vec4 id;const vec4 DISCARD_POSITION=vec4(2,2,2,1);vec4 transformColor(vec4 color,mat4 transform){return transform*vec4(color.rgb,1)*vec4(1,1,1,color.a);}vec4 maybeTransformColor(vec4 color,mat4 transform,bool condition){return mix(color,transformColor(color,transform),float(condition));}const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);vec4 projectPointLabelVertex(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 posHigh,vec2 posLow,vec2 displacement,vec2 pxSize,float zPos){vec4 position=viewProjMatrix*vec4((YV_H*(posHigh-lookAtHigh)+(posLow-lookAtLow))*YV_N,zPos,1);return position+vec4(position.w*displacement*pxSize,0.0,0.0);}const float GLYPH_BASE_WEIGHT=0.755;const float OUTLINE_WEIGHT_DELTA_BASE=-0.25;float getGlyphWeight(float isOutline){return GLYPH_BASE_WEIGHT+mix(0.0,OUTLINE_WEIGHT_DELTA_BASE,isOutline);}const float GLYPH_BASE_SMOOTHNESS=0.25;const float GLYPH_SMOOTHNESS_HEIGHT_IMPACT=-0.125;const float EXTRA_SMOOTHNESS_HEIGHT_EDGE=9.0;const float EPS=1e-5;float getSmoothnessDelta(float height){return GLYPH_SMOOTHNESS_HEIGHT_IMPACT*step(EXTRA_SMOOTHNESS_HEIGHT_EDGE,height)*(1.0-(1.0/max(height-EXTRA_SMOOTHNESS_HEIGHT_EDGE+1.0,EPS)));}float getGlyphSmoothness(float height,float dpr){return(GLYPH_BASE_SMOOTHNESS+getSmoothnessDelta(height))/dpr;}void main(void){float visibilityAlpha=texture2D(visibility,vertexId.xy/256.0+idHalfPxSize).a;if(visibilityAlpha!=0.0){gl_Position=projectPointLabelVertex(viewProjMatrix,lookAtHigh,lookAtLow,vertexPosHigh,vertexPosLow,vertexDisplacement,pixelSize,vertexZPos);\n#ifndef YV_COLOR_ID\nuv=vertexUV/atlasSize;weight=getGlyphWeight(isOutlinePhase);smoothness=getGlyphSmoothness(vertexHeight,dpr);vec4 inlineColor=maybeTransformColor(vertexColor,highlightColorTransform,vertexId==highlightId);vec4 outlineColor=vertexOutlineColor;outlineColor.a=maybeTransformColor(outlineColor,highlightColorTransform,vertexId==highlightId).a;color=mix(inlineColor,outlineColor,isOutlinePhase);color.a*=visibilityAlpha;\n#else\nid=vec4(vertexId.xy/255.0,0,0);\n#endif\n}else{gl_Position=DISCARD_POSITION;}}",zd="#version 100\nprecision mediump float;uniform sampler2D atlas;uniform float opacity;varying highp vec2 uv;varying float weight;varying float smoothness;varying lowp vec4 color;void main(void){vec4 resultColor=color;float dist=texture2D(atlas,uv).a;float alpha=smoothstep(weight-smoothness,weight+smoothness,dist);gl_FragColor=vec4(resultColor.rgb,resultColor.a*alpha*opacity);}",Bd=new O(A,{cullFace:!0,cullFaceMode:1028}),Fd=new O,Vd=class extends Gl{constructor(e,t,i,r,s,o){super(e,t,Bd,r,Fd,s,o),this._camera=i,this._visibilityProvider=o.visibility,this._atlasSizeUniform=z(0,0)}_render(e,t){this._program.setScalarUniform("isOutlinePhase",1),super._render(e,t),this._program.setScalarUniform("isOutlinePhase",0),super._render(e,t)}_prepareProgram(e,t,i){let r=this._visibilityProvider();super._prepareProgram(e,t,i),this._prepareProgramState(e,r)}_prepareHitTestProgram(e,t,i){let r=this._visibilityProvider();super._prepareHitTestProgram(e,t,i),this._prepareProgramState(e,r)}_renderBatch(e,t){let i=e.firstPrimitive.texture;this._atlasSizeUniform.x=i.getWidth(),this._atlasSizeUniform.y=i.getHeight(),t.setIntScalarUniform("atlas",1),t.setVector2Uniform("atlasSize",this._atlasSizeUniform),this._context.bindTextureUnit(1),this._context.bindTexture(i),super._renderBatch(e,t)}_canBatchAdjacentPrimitives(e,t){return super._canBatchAdjacentPrimitives(e,t)&&e.texture===t.texture}_prepareProgramState(e,t){this._context.bindTextureUnit(0),this._context.bindTexture(t),e.setVector2Uniform("idHalfPxSize",t.getHalfPxSize()),e.setVector2Uniform("pixelSize",this._camera.pixelSize),e.setScalarUniform("dpr",window.devicePixelRatio)}},Nd={attribMap:{vertexId:2,vertexPosHigh:0,vertexPosLow:1,vertexDisplacement:6,vertexUV:4,vertexPriority:9,vertexColor:7,vertexOutlineColor:8,vertexHeight:3,vertexZPos:11}},kd={defines:{YV_COLOR_ID:1},attribMap:Nd.attribMap},Hd=class extends Vd{constructor(e,t,i,r,s){let o=Yl(ql,s),n=t.createProgram(Dd,zd,Nd),a=o.hitTest?t.createProgram(Dd,Wi,kd):void 0;super(e,t,i,n,a,r)}_getHitTestPrimitives(){return ye(super._getHitTestPrimitives(),(({metadata:e})=>!(null==e||!e.has("objectId"))))}},jd="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexDisplacement;attribute vec2 vertexOffset;attribute vec2 vertexUV;attribute vec4 vertexId;attribute float vertexPriority;attribute vec2 vertexBrightness;attribute float vertexZPos;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 atlasSize;uniform sampler2D visibility;uniform vec2 idHalfPxSize;uniform vec2 extensionAndMinSize;uniform vec4 highlightId;varying vec2 uv;varying float alpha;varying vec4 id;varying float minBrightness;varying float maxBrightness;varying float isHighlighted;const float DISPLACEMENT_FIXED_POINT_FRACTION_FACTOR=32.0;const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);const vec4 DISCARD_POSITION=vec4(2,2,2,1);void main(){float visibilityAlpha=texture2D(visibility,vertexId.xy/256.0+idHalfPxSize).a;if(visibilityAlpha!=0.0){vec4 position=viewProjMatrix*vec4((YV_H*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*YV_N,vertexZPos,1);vec2 displacement=vertexDisplacement/DISPLACEMENT_FIXED_POINT_FRACTION_FACTOR;vec2 offset=vertexOffset/DISPLACEMENT_FIXED_POINT_FRACTION_FACTOR;float extension=extensionAndMinSize.x;float minSize=extensionAndMinSize.y;vec2 totalDisplacement=max(vec2(minSize*0.5),extension+abs(displacement))*sign(displacement)+offset;gl_Position=position+vec4(position.w*totalDisplacement*pixelSize,0,0);\n#ifndef YV_COLOR_ID\nuv=vertexUV/atlasSize;alpha=visibilityAlpha;minBrightness=vertexBrightness[0];maxBrightness=vertexBrightness[1];isHighlighted=float(vertexId==highlightId);\n#else\nid=vec4(vertexId.xy/255.0,0,0);\n#endif\n}else{gl_Position=DISCARD_POSITION;}}",Gd=new O(L),Wd=new O;var qd=class extends Gl{constructor(e,t,i=function(e){return e.createProgram("#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexUV;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;varying vec2 uv;const float YV_H=1.999969482421875;const float YV_L=0.000030517112463712692;void main(){vec4 position=viewProjMatrix*vec4(YV_H*(vertexPosHigh-lookAtHigh)+YV_L*(vertexPosLow-lookAtLow),0,1);gl_Position=position;uv=vertexUV;}","#version 100\nprecision mediump float;uniform sampler2D atlas;uniform vec2 atlasSize;varying vec2 uv;void main(){gl_FragColor=texture2D(atlas,uv/atlasSize);if(gl_FragColor.a==0.0){discard;}}",{attribMap:{vertexPosHigh:0,vertexPosLow:1,vertexUV:4}})}(t),r,s={}){super(e,t,Gd,i,Wd,r,s),this._atlasSizeUniform=z(0,0)}_renderBatch(e,t){let i=e.firstPrimitive.texture;this._atlasSizeUniform.x=i.getWidth(),this._atlasSizeUniform.y=i.getHeight(),t.setVector2Uniform("atlasSize",this._atlasSizeUniform),this._prepareTexture(i),super._renderBatch(e,t)}_prepareTexture(e){this._context.bindTextureUnit(0),this._context.bindTexture(e)}_canBatchAdjacentPrimitives(e,t){return super._canBatchAdjacentPrimitives(e,t)&&e.texture===t.texture}},Yd=g(f({},ql),{iconHitTestField:0,iconHitTestMinSize:0}),Xd={attribMap:{vertexPosHigh:0,vertexPosLow:1,vertexDisplacement:6,vertexOffset:11,vertexUV:4,vertexId:2,vertexPriority:9,vertexBrightness:12,vertexZPos:13}},Zd={attribMap:Xd.attribMap,defines:{YV_COLOR_ID:1}},$d=class extends qd{constructor(e,t,i,r,s){let o=Yl(Yd,s),n=t.createProgram(jd,"#version 100\nprecision mediump float;uniform sampler2D atlas;uniform mat4 highlightColorTransform;uniform float opacity;varying vec2 uv;varying float alpha;varying float minBrightness;varying float maxBrightness;varying float isHighlighted;vec4 transformColor(vec4 color,mat4 transform){return transform*vec4(color.rgb,1)*vec4(1,1,1,color.a);}vec4 maybeTransformColor(vec4 color,mat4 transform,bool condition){return mix(color,transformColor(color,transform),float(condition));}const vec3 BACKGROUND=vec3(1.);vec4 colorize(vec4 color,vec4 updatedColor){float originalBrightness=(0.2126*color.r+0.7152*color.g+0.0722*color.b)/(color.a+1e-5);float brightnessNormalized=clamp((originalBrightness-minBrightness)/(maxBrightness-minBrightness),0.,1.);vec3 correctedRgb=mix(updatedColor.rgb,BACKGROUND,brightnessNormalized);return vec4(correctedRgb*updatedColor.a,updatedColor.a);}void main(){vec4 color=texture2D(atlas,uv);gl_FragColor=mix(color,colorize(color,transformColor(color,highlightColorTransform)),isHighlighted)*alpha*opacity;}",Xd),a=o.hitTest?t.createProgram(jd,Wi,Zd):void 0;super(e,t,n,a,r),this._camera=i,this._linearFilterFrames=0,this._cameraUpdateListener=()=>{this._linearFilterFrames=3},this._camera.onUpdate.addListener(this._cameraUpdateListener),this._visibilityProvider=r.visibility,this._extensionAndMinSize={x:o.iconHitTestField,y:o.iconHitTestMinSize}}destroy(){this._camera.onUpdate.removeListener(this._cameraUpdateListener),super.destroy()}_render(e,t){super._render(e,t),this._linearFilterFrames>0&&(this._linearFilterFrames--,this._requestRerender())}_prepareProgram(e,t,i){let r=this._visibilityProvider();super._prepareProgram(e,t,i),this._prepareProgramState(e,r),e.setVector2Uniform("extensionAndMinSize",B)}_prepareHitTestProgram(e,t,i){let r=this._visibilityProvider();super._prepareHitTestProgram(e,t,i),this._prepareProgramState(e,r),e.setVector2Uniform("extensionAndMinSize",this._extensionAndMinSize)}_prepareTexture(e){this._context.bindTextureUnit(0);let t=this._linearFilterFrames>0?9729:void 0;this._context.bindTexture(e,t,t)}_requestRerender(){this._onUpdate.fire()}_prepareProgramState(e,t){this._context.bindTextureUnit(1),this._context.bindTexture(t),e.setIntScalarUniform("visibility",1),e.setVector2Uniform("idHalfPxSize",t.getHalfPxSize()),e.setVector2Uniform("pixelSize",this._camera.pixelSize)}},Qd="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec4 vertexColor;attribute float vertexZIndex;attribute vec4 vertexId;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec4 highlightId;uniform mat4 highlightColorTransform;uniform float opacity;varying vec4 id;varying vec4 color;vec4 transformColor(vec4 color,mat4 transform){return transform*vec4(color.rgb,1)*vec4(1,1,1,color.a);}vec4 maybeTransformColor(vec4 color,mat4 transform,bool condition){return mix(color,transformColor(color,transform),float(condition));}const float ADJUSTING_FACTOR=pow(2.0,10.0);vec4 applyImprecisePerspectiveDivisionFix(vec4 position){return position*ADJUSTING_FACTOR;}const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);void main(void){gl_Position=viewProjMatrix*vec4((YV_H*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*YV_N,0,1);gl_Position.z=gl_Position.w*vertexZIndex;gl_Position=applyImprecisePerspectiveDivisionFix(gl_Position);\n#ifndef YV_COLOR_ID\ncolor=maybeTransformColor(vertexColor,highlightColorTransform,vertexId==highlightId);color.a*=opacity;\n#else\nid=vertexId/255.0;\n#endif\n}",Kd={},Jd={depthTest:!0,depthFunc:518},eh={vertexPosHigh:0,vertexPosLow:1,vertexColor:7,vertexZIndex:10,vertexId:2},th={attribMap:eh},ih={attribMap:eh,defines:{YV_COLOR_ID:1}},rh=g(f({},ql),{renderState:new O(Kd),depthTest:!0}),sh=class extends Gl{constructor(e,t,i,r){let s=Yl(rh,r),o=new O(s.renderState,s.depthTest?Jd:{}),n=t.createProgram(Qd,"#version 100\nvarying lowp vec4 color;void main(void){gl_FragColor=color;}",th),a=s.hitTest?t.createProgram(Qd,Wi,ih):void 0;super(e,t,o,n,new O(U),a,i)}},oh=new O(Kd,{depthMask:!1},A),nh=class extends sh{constructor(e,t,i,r){super(e,t,i,g(f({},r),{renderState:oh}))}},ah={attribMap:{vertexPosHigh:0,vertexPosLow:1,vertexUv:4,vertexZIndex:10}},lh=class extends as{constructor(e,t,i=new O(f({},L))){super(e,t,i,t.createProgram("#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexUv;attribute vec2 vertexDisplacement;attribute float vertexZIndex;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;varying vec2 uv;const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);void main(void){gl_Position=viewProjMatrix*vec4((YV_H*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*YV_N,0,1);gl_Position.z=gl_Position.w*vertexZIndex;uv=vertexUv;}","#version 100\nprecision mediump float;uniform sampler2D atlas;varying vec2 uv;void main(void){gl_FragColor=texture2D(atlas,uv);}",ah))}_renderBatch(e,t){this._context.bindTextureUnit(0),this._context.bindTexture(e.firstPrimitive.texture),super._renderBatch(e,t)}_canBatchAdjacentPrimitives(e,t){return e.texture===t.texture}},dh="#version 100\nattribute vec3 vertexPosHigh;attribute vec3 vertexPosLow;attribute float vertexHeight;attribute vec4 vertexColor;attribute vec4 vertexId;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform float zFactor;uniform vec4 highlightId;uniform mat4 highlightColorTransform;uniform float opacity;varying vec4 globalPosition;varying vec4 diffuseColor;varying vec4 id;const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);vec4 transformColor(vec4 color,mat4 transform){return transform*vec4(color.rgb,1)*vec4(1,1,1,color.a);}vec4 maybeTransformColor(vec4 color,mat4 transform,bool condition){return mix(color,transformColor(color,transform),float(condition));}const float ADJUSTING_FACTOR=pow(2.0,10.0);vec4 applyImprecisePerspectiveDivisionFix(vec4 position){return position*ADJUSTING_FACTOR;}void main(void){vec4 globalPos=vec4((YV_H*(vertexPosHigh.xy-lookAtHigh)+(vertexPosLow.xy-lookAtLow))*YV_N,vertexHeight*zFactor,1);gl_Position=viewProjMatrix*globalPos;gl_Position=applyImprecisePerspectiveDivisionFix(gl_Position);\n#ifndef YV_COLOR_ID\ndiffuseColor=maybeTransformColor(vertexColor,highlightColorTransform,vertexId==highlightId);diffuseColor.a*=opacity;globalPosition=globalPos;\n#else\nid=vertexId/255.0;\n#endif\n}",hh=new O({depthTest:!0}),ch={attribMap:{vertexPosHigh:0,vertexPosLow:1,vertexHeight:3,vertexColor:7,vertexId:2}},uh={attribMap:ch.attribMap,defines:{YV_COLOR_ID:1}},_h=()=>1,ph=class extends Gl{constructor(e,t,i,r){let s=Yl(ql,r),o=t.createProgram(dh,"#version 100\n#extension GL_OES_standard_derivatives : require\nprecision highp float;varying vec4 diffuseColor;varying vec4 globalPosition;const vec3 LIGHT_DIRECTION=vec3(0.2,0.2,1.0);const float LIGHT_LENGTH=length(LIGHT_DIRECTION);const float LIGHT_INTENSITY=0.4;const float AMBIENT_LIGHT_INTENSITY=1.0-LIGHT_INTENSITY;const float HORIZONTAL_PLANE_DIFFUSE_INTENSITY=AMBIENT_LIGHT_INTENSITY+0.5*LIGHT_INTENSITY*(LIGHT_DIRECTION.z+1.0);vec4 getPlaneColor(vec4 diffuseColor,vec3 unnormalizedNormal,float dXnormalizator,float dYnormalizator){float dotProduct=dot(unnormalizedNormal,LIGHT_DIRECTION)/dYnormalizator/LIGHT_LENGTH/dXnormalizator;vec3 rgb=diffuseColor.rgb*(AMBIENT_LIGHT_INTENSITY+0.5*LIGHT_INTENSITY*(dotProduct+1.0))/HORIZONTAL_PLANE_DIFFUSE_INTENSITY;return vec4(rgb,diffuseColor.a);}void main(void){vec3 pos=globalPosition.xyz;vec3 dxpos=dFdx(pos);vec3 dypos=dFdy(pos);vec3 crossProduct=cross(dxpos,dypos);gl_FragColor=getPlaneColor(diffuseColor,crossProduct,length(dxpos),length(dypos));}",ch),n=s.hitTest?t.createProgram(dh,Wi,uh):void 0;super(e,t,hh,o,hh,n,i),this._heightFactorProvider=(null==i?void 0:i.heightFactor)||_h}_prepareProgram(e,t,i,...r){super._prepareProgram(e,t,i,...r),e.setScalarUniform("zFactor",this._heightFactorProvider())}_prepareHitTestProgram(e,t,i,...r){super._prepareHitTestProgram(e,t,i,...r),e.setScalarUniform("zFactor",this._heightFactorProvider())}},mh="#version 100\nattribute vec4 vertexId;attribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexDisplacement;attribute vec2 vertexUV;attribute float vertexPriority;attribute lowp vec4 vertexColor;attribute lowp vec4 vertexOutlineColor;attribute vec2 vertexPolylineLengthDisplacement;attribute float vertexHeight;attribute vec4 vertexLeftPolylineRatios;attribute vec4 vertexLeftPolylineAngles;attribute vec4 vertexRightPolylineRatios;attribute vec4 vertexRightPolylineAngles;uniform float isOutlinePhase;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 atlasSize;uniform sampler2D visibility;uniform vec2 idHalfPxSize;uniform vec2 shift;uniform lowp float currentZoom;uniform float dpr;varying highp vec2 uv;varying float weight;varying float smoothness;varying lowp vec4 color;varying lowp vec4 id;const vec4 DISCARD_POSITION=vec4(2,2,2,1);const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);const float PI=3.1415927410125732;const int MAX_POLYLINE_POINTS=4;const float INFINITY=1000000.0;const float UBYTE_RATIO_EPSILON=1.0/256.0;vec2 project(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 pixelSize,vec2 pointHigh,vec2 pointLow,vec2 delta){vec4 position=viewProjMatrix*vec4((YV_H*(pointHigh-lookAtHigh)+(pointLow-lookAtLow))*YV_N+delta,0,1);vec2 projected=position.xy/position.w;return projected/pixelSize;}vec2 decodePolylineDeltas(float ratio,float angle,float polylineLength){float a=angle*2.0*PI-PI;float len=ratio*polylineLength;return vec2(cos(a),sin(a))*len;}float value(vec4 a,int i){if(i==0)return a[0];if(i==1)return a[1];if(i==2)return a[2];return a[3];}vec4 projectCurvedLabelVertex(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 pxSize,vec2 posHigh,vec2 posLow,vec2 displacement,float lineDisplacement,float polylineLength,vec4 leftPolylineRatios,vec4 leftPolylineAngles,vec4 rightPolylineRatios,vec4 rightPolylineAngles){vec2 position=project(viewProjMatrix,lookAtHigh,lookAtLow,pxSize,posHigh,posLow,vec2(0,0));vec2 deltas=decodePolylineDeltas(rightPolylineRatios[0],rightPolylineAngles[0],polylineLength);vec2 projectedPoint=project(viewProjMatrix,lookAtHigh,lookAtLow,pxSize,posHigh,posLow,deltas);bool isRightPart=lineDisplacement>0.0;bool isInverted=projectedPoint.x<position.x;float isLeftToRight=float(isRightPart ^^ isInverted);if(isRightPart==isInverted){deltas=mix(decodePolylineDeltas(leftPolylineRatios[0],leftPolylineAngles[0],polylineLength),decodePolylineDeltas(rightPolylineRatios[0],rightPolylineAngles[0],polylineLength),isLeftToRight);projectedPoint=project(viewProjMatrix,lookAtHigh,lookAtLow,pxSize,posHigh,posLow,deltas);}float remainingLength=abs(lineDisplacement);for(int i=1;i<=MAX_POLYLINE_POINTS;i++){vec2 segment=projectedPoint-position;float isLast=float(i==MAX_POLYLINE_POINTS||value(mix(leftPolylineRatios,rightPolylineRatios,isLeftToRight),i)<UBYTE_RATIO_EPSILON);float segmentLength=mix(length(segment),INFINITY,isLast);if(segmentLength>remainingLength){float signFactor=mix(-1.0,1.0,float(lineDisplacement>0.0));vec2 direction=normalize(segment);vec2 normal=vec2(-direction.y,direction.x);position+=direction*remainingLength;position+=signFactor*direction*displacement.x;position+=signFactor*normal*displacement.y;break;}else{remainingLength-=segmentLength;position+=segment;vec2 nextDeltas=mix(decodePolylineDeltas(value(leftPolylineRatios,i),value(leftPolylineAngles,i),polylineLength),decodePolylineDeltas(value(rightPolylineRatios,i),value(rightPolylineAngles,i),polylineLength),isLeftToRight);projectedPoint=project(viewProjMatrix,lookAtHigh,lookAtLow,pxSize,posHigh,posLow,nextDeltas);}}return vec4(position*pxSize,0.0,1.0);}const float GLYPH_BASE_WEIGHT=0.755;const float OUTLINE_WEIGHT_DELTA_BASE=-0.25;float getGlyphWeight(float isOutline){return GLYPH_BASE_WEIGHT+mix(0.0,OUTLINE_WEIGHT_DELTA_BASE,isOutline);}const float GLYPH_BASE_SMOOTHNESS=0.25;const float GLYPH_SMOOTHNESS_HEIGHT_IMPACT=-0.125;const float EXTRA_SMOOTHNESS_HEIGHT_EDGE=9.0;const float EPS=1e-5;float getSmoothnessDelta(float height){return GLYPH_SMOOTHNESS_HEIGHT_IMPACT*step(EXTRA_SMOOTHNESS_HEIGHT_EDGE,height)*(1.0-(1.0/max(height-EXTRA_SMOOTHNESS_HEIGHT_EDGE+1.0,EPS)));}float getGlyphSmoothness(float height,float dpr){return(GLYPH_BASE_SMOOTHNESS+getSmoothnessDelta(height))/dpr;}void main(void){float visibilityAlpha=texture2D(visibility,vertexId.xy/256.0+idHalfPxSize).a;if(visibilityAlpha!=0.0){float vertexLineLength=vertexPolylineLengthDisplacement.x;float vertexLineDisplacement=vertexPolylineLengthDisplacement.y;gl_Position=projectCurvedLabelVertex(viewProjMatrix,lookAtHigh,lookAtLow,pixelSize,vertexPosHigh,vertexPosLow,vertexDisplacement,vertexLineDisplacement,vertexLineLength,vertexLeftPolylineRatios,vertexLeftPolylineAngles,vertexRightPolylineRatios,vertexRightPolylineAngles);\n#ifndef YV_COLOR_ID\nuv=vertexUV/atlasSize;weight=getGlyphWeight(isOutlinePhase);smoothness=getGlyphSmoothness(vertexHeight,dpr);color=mix(vertexColor,vertexOutlineColor,isOutlinePhase);color.a*=visibilityAlpha;\n#else\nid=vec4(vertexId.xy/255.0,0,0);\n#endif\n}else{gl_Position=DISCARD_POSITION;}}",fh={attribMap:{vertexId:2,vertexPosHigh:0,vertexPosLow:1,vertexDisplacement:6,vertexUV:4,vertexColor:7,vertexOutlineColor:8,vertexPriority:9,vertexLeftPolylineRatios:12,vertexLeftPolylineAngles:13,vertexRightPolylineRatios:14,vertexRightPolylineAngles:15,vertexPolylineLengthDisplacement:11,vertexHeight:3}},gh={defines:{YV_COLOR_ID:1},attribMap:fh.attribMap},vh=class extends Vd{constructor(e,t,i,r,s){let o=Yl(ql,s),n=t.createProgram(mh,zd,fh),a=o.hitTest?t.createProgram(mh,Wi,gh):void 0;super(e,t,i,n,a,r)}},yh={vertexPosHigh:0,vertexPosLow:1,vertexDisplacement:6},xh=class extends as{constructor(e,t,i,r=new O){super(e,t,r,t.createProgram(ts,Wi,{attribMap:yh})),this._camera=i}_prepareProgram(e,t,i){super._prepareProgram(e,t,i),e.setVector2Uniform("pixelSize",this._camera.pixelSize)}},bh=class{get onUpdate(){return this._onUpdate}constructor(e,t,i){this._primitiveProvider=e,this._portionPrimitiveProvider=t,this._renderUnits=i,this._onUpdate=new qe,this._typeToRenderUnit={0:this._renderUnits.opaquePolygon,1:this._renderUnits.transparentPolygon,2:this._renderUnits.texPolygonRenderUnit,5:this._renderUnits.polyline},this._primitiveProvider.onUpdate.addListener(this._onPrimitivesUpdate,this)}destroy(){this._primitiveProvider.onUpdate.removeListener(this._onPrimitivesUpdate)}render(e,...t){var i;for(let{type:r,portion:s}of Th(this._primitiveProvider.primitives))this._portionPrimitiveProvider.setPortion(s),null==(i=this._typeToRenderUnit[r])||i.render(e,...t)}renderHitTestBuffer(e,...t){var i;for(let{type:r,portion:s}of Th(this._primitiveProvider.primitives))this._portionPrimitiveProvider.setPortion(s),null==(i=this._typeToRenderUnit[r])||i.renderHitTestBuffer(e,...t)}_onPrimitivesUpdate(){this._onUpdate.fire()}};function*Th(e){let t=[];for(let i of e)0===t.length||t[0].type===i.type?t.push(i):(yield Ph(t),t=[i]);t.length>0&&(yield Ph(t))}function Ph(e){let t=e[0].type;return{type:t,portion:{primitives:{[t]:e}}}}var wh=class extends ds{constructor(e,t,i,r,s){super(e,t,i,s),this._camera=r}_prepareProgram(e,t,i,r,s,o,n,a,l,d,h){super._prepareProgram(e,t,i,r,s,o,n,a,l,d,h),e.setVector2Uniform("pixelSize",this._camera.pixelSize)}},Mh=class extends wh{constructor(e,t,i){super(e,t,t.createProgram("#version 100\nattribute vec4 vertexId;attribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec4 vertexDisplacement;attribute vec2 vertexUV;attribute float vertexPriority;attribute float vertexZPos;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform sampler2D visibility;uniform sampler2D overlap;uniform sampler2D scene;uniform vec2 idHalfPxSize;uniform vec2 shift;uniform lowp float currentZoom;uniform lowp float currentTilt;uniform lowp float currentAzimuth;varying lowp vec4 id;const vec4 DISCARD_POSITION=vec4(2,2,2,1);const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);vec4 projectPointLabelVertex(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 posHigh,vec2 posLow,vec2 displacement,vec2 pxSize,float zPos){vec4 position=viewProjMatrix*vec4((YV_H*(posHigh-lookAtHigh)+(posLow-lookAtLow))*YV_N,zPos,1);return position+vec4(position.w*displacement*pxSize,0.0,0.0);}const vec4 EMPTY_PRIMITIVE=vec4(0,0,0,0);const vec2 NO_ID=vec2(0,0);const float ID_RENORMALIZATION=255.0/256.0;const float ZOOM_THRESHOLD=0.05;const float TILT_THRESHOLD=0.15;const float AZIMUTH_THRESHOLD=0.02;bool isOverlapperStillVisible(vec2 idTexCoordinate,vec2 idHalfPxSize,sampler2D overlap,sampler2D scene){vec2 overlapId=texture2D(overlap,idTexCoordinate).rg;return overlapId!=NO_ID&&texture2D(scene,overlapId*ID_RENORMALIZATION+idHalfPxSize)!=EMPTY_PRIMITIVE;}float getVisibility(vec2 id,vec2 idHalfPxSize,sampler2D visibility,sampler2D overlap,sampler2D scene,float currentZoom,float currentTilt,float currentAzimuth){vec2 idTexCoordinate=id/256.0+idHalfPxSize;vec4 visibilityValue=texture2D(visibility,idTexCoordinate);float overlapZoom=visibilityValue.b;float overlapTilt=visibilityValue.r;float overlapAzimuth=visibilityValue.g;float zoomDiff=overlapZoom-currentZoom;float tiltDiff=abs(overlapTilt-currentTilt);float azimuthDiff=abs(overlapAzimuth-currentAzimuth);if((zoomDiff>ZOOM_THRESHOLD||(abs(zoomDiff)<=ZOOM_THRESHOLD&&tiltDiff<TILT_THRESHOLD&&azimuthDiff<AZIMUTH_THRESHOLD))&&isOverlapperStillVisible(idTexCoordinate,idHalfPxSize,overlap,scene)){return-1.0;}return visibilityValue.a;}void main(void){float alpha=getVisibility(vertexId.xy,idHalfPxSize,visibility,overlap,scene,currentZoom,currentTilt,currentAzimuth);if(alpha<0.0){gl_Position=DISCARD_POSITION;}else{vec4 pos=projectPointLabelVertex(viewProjMatrix,lookAtHigh,lookAtLow,vertexPosHigh,vertexPosLow,vertexDisplacement.xy+vertexDisplacement.zw,pixelSize,vertexZPos);pos.xy+=shift*pos.w;pos.z=vertexPriority*pos.w;gl_Position=pos;id=vec4(vertexId.xy/255.0,0,alpha);}}",Wi,Nd),i)}},Rh=new Map;function Sh(e,t){let i=t.firstPrimitive,r=i.page.layout.vertexByteSize,s=function(e){return 4*e<=255?4:2*e<=255?2:1}(r)*r,o=i.vao,n=Rh.get(o);return n||(n=e.createVao([{attributeMapping:i.page.layout,buffer:i.page.vertexBuffer,stride:s}]),Rh.set(o,n),o.onDestroy.addListener((()=>{Rh.get(o).destroy(),Rh.delete(o)}))),{vao:n,stride:s}}var Ch=class extends _s{_render(){let e=this._primitiveProvider.primitives;for(let t of os(e,void 0,ss)){let{vao:e,stride:i}=Sh(this._context,t);this._context.bindVao(e),this._context.drawMesh(t.vertexByteOffset/i,t.vertexByteLength/i,0)}}},Ih=class extends wh{constructor(e,t,i){super(e,t,t.createProgram("#version 100\nattribute vec2 vertexId;attribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec4 vertexDisplacement;attribute vec2 vertexUV;attribute float vertexPriority;attribute lowp vec4 vertexColor;attribute lowp vec4 vertexOutlineColor;attribute vec2 vertexPolylineLengthDisplacement;attribute vec4 vertexLeftPolylineRatios;attribute vec4 vertexLeftPolylineAngles;attribute vec4 vertexRightPolylineRatios;attribute vec4 vertexRightPolylineAngles;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform sampler2D visibility;uniform sampler2D overlap;uniform sampler2D scene;uniform vec2 idHalfPxSize;uniform vec2 shift;uniform lowp float currentZoom;uniform lowp float currentTilt;uniform lowp float currentAzimuth;varying lowp vec4 id;const vec4 DISCARD_POSITION=vec4(2,2,2,1);const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);const float PI=3.1415927410125732;const int MAX_POLYLINE_POINTS=4;const float INFINITY=1000000.0;const float UBYTE_RATIO_EPSILON=1.0/256.0;vec2 project(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 pixelSize,vec2 pointHigh,vec2 pointLow,vec2 delta){vec4 position=viewProjMatrix*vec4((YV_H*(pointHigh-lookAtHigh)+(pointLow-lookAtLow))*YV_N+delta,0,1);vec2 projected=position.xy/position.w;return projected/pixelSize;}vec2 decodePolylineDeltas(float ratio,float angle,float polylineLength){float a=angle*2.0*PI-PI;float len=ratio*polylineLength;return vec2(cos(a),sin(a))*len;}float value(vec4 a,int i){if(i==0)return a[0];if(i==1)return a[1];if(i==2)return a[2];return a[3];}vec4 projectCurvedLabelVertex(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 pxSize,vec2 posHigh,vec2 posLow,vec2 displacement,float lineDisplacement,float polylineLength,vec4 leftPolylineRatios,vec4 leftPolylineAngles,vec4 rightPolylineRatios,vec4 rightPolylineAngles){vec2 position=project(viewProjMatrix,lookAtHigh,lookAtLow,pxSize,posHigh,posLow,vec2(0,0));vec2 deltas=decodePolylineDeltas(rightPolylineRatios[0],rightPolylineAngles[0],polylineLength);vec2 projectedPoint=project(viewProjMatrix,lookAtHigh,lookAtLow,pxSize,posHigh,posLow,deltas);bool isRightPart=lineDisplacement>0.0;bool isInverted=projectedPoint.x<position.x;float isLeftToRight=float(isRightPart ^^ isInverted);if(isRightPart==isInverted){deltas=mix(decodePolylineDeltas(leftPolylineRatios[0],leftPolylineAngles[0],polylineLength),decodePolylineDeltas(rightPolylineRatios[0],rightPolylineAngles[0],polylineLength),isLeftToRight);projectedPoint=project(viewProjMatrix,lookAtHigh,lookAtLow,pxSize,posHigh,posLow,deltas);}float remainingLength=abs(lineDisplacement);for(int i=1;i<=MAX_POLYLINE_POINTS;i++){vec2 segment=projectedPoint-position;float isLast=float(i==MAX_POLYLINE_POINTS||value(mix(leftPolylineRatios,rightPolylineRatios,isLeftToRight),i)<UBYTE_RATIO_EPSILON);float segmentLength=mix(length(segment),INFINITY,isLast);if(segmentLength>remainingLength){float signFactor=mix(-1.0,1.0,float(lineDisplacement>0.0));vec2 direction=normalize(segment);vec2 normal=vec2(-direction.y,direction.x);position+=direction*remainingLength;position+=signFactor*direction*displacement.x;position+=signFactor*normal*displacement.y;break;}else{remainingLength-=segmentLength;position+=segment;vec2 nextDeltas=mix(decodePolylineDeltas(value(leftPolylineRatios,i),value(leftPolylineAngles,i),polylineLength),decodePolylineDeltas(value(rightPolylineRatios,i),value(rightPolylineAngles,i),polylineLength),isLeftToRight);projectedPoint=project(viewProjMatrix,lookAtHigh,lookAtLow,pxSize,posHigh,posLow,nextDeltas);}}return vec4(position*pxSize,0.0,1.0);}const vec4 EMPTY_PRIMITIVE=vec4(0,0,0,0);const vec2 NO_ID=vec2(0,0);const float ID_RENORMALIZATION=255.0/256.0;const float ZOOM_THRESHOLD=0.05;const float TILT_THRESHOLD=0.15;const float AZIMUTH_THRESHOLD=0.02;bool isOverlapperStillVisible(vec2 idTexCoordinate,vec2 idHalfPxSize,sampler2D overlap,sampler2D scene){vec2 overlapId=texture2D(overlap,idTexCoordinate).rg;return overlapId!=NO_ID&&texture2D(scene,overlapId*ID_RENORMALIZATION+idHalfPxSize)!=EMPTY_PRIMITIVE;}float getVisibility(vec2 id,vec2 idHalfPxSize,sampler2D visibility,sampler2D overlap,sampler2D scene,float currentZoom,float currentTilt,float currentAzimuth){vec2 idTexCoordinate=id/256.0+idHalfPxSize;vec4 visibilityValue=texture2D(visibility,idTexCoordinate);float overlapZoom=visibilityValue.b;float overlapTilt=visibilityValue.r;float overlapAzimuth=visibilityValue.g;float zoomDiff=overlapZoom-currentZoom;float tiltDiff=abs(overlapTilt-currentTilt);float azimuthDiff=abs(overlapAzimuth-currentAzimuth);if((zoomDiff>ZOOM_THRESHOLD||(abs(zoomDiff)<=ZOOM_THRESHOLD&&tiltDiff<TILT_THRESHOLD&&azimuthDiff<AZIMUTH_THRESHOLD))&&isOverlapperStillVisible(idTexCoordinate,idHalfPxSize,overlap,scene)){return-1.0;}return visibilityValue.a;}void main(void){float alpha=getVisibility(vertexId.xy,idHalfPxSize,visibility,overlap,scene,currentZoom,currentTilt,currentAzimuth);if(alpha<0.0){gl_Position=DISCARD_POSITION;}else{float vertexLineLength=vertexPolylineLengthDisplacement.x;float vertexLineDisplacement=vertexPolylineLengthDisplacement.y;gl_Position=projectCurvedLabelVertex(viewProjMatrix,lookAtHigh,lookAtLow,pixelSize,vertexPosHigh,vertexPosLow,vertexDisplacement.xy+vertexDisplacement.zw,vertexLineDisplacement,vertexLineLength,vertexLeftPolylineRatios,vertexLeftPolylineAngles,vertexRightPolylineRatios,vertexRightPolylineAngles);gl_Position.xy+=shift;gl_Position.z=vertexPriority;id=vec4(vertexId.xy/255.0,0,alpha);}}",Wi,fh),i)}},Eh=class extends ds{constructor(e,t,i,r){super(e,t,t.createProgram("#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec4 vertexDisplacement;attribute vec2 vertexOffset;attribute vec4 vertexId;attribute float vertexPriority;attribute float vertexZPos;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 shift;uniform sampler2D visibility;uniform sampler2D overlap;uniform sampler2D scene;uniform vec2 idHalfPxSize;uniform lowp float currentZoom;uniform lowp float currentTilt;uniform lowp float currentAzimuth;varying vec4 id;const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);const float DISPLACEMENT_FIXED_POINT_FRACTION_FACTOR=32.0;const vec4 DISCARD_POSITION=vec4(2,2,2,1);const vec4 EMPTY_PRIMITIVE=vec4(0,0,0,0);const vec2 NO_ID=vec2(0,0);const float ID_RENORMALIZATION=255.0/256.0;const float ZOOM_THRESHOLD=0.05;const float TILT_THRESHOLD=0.15;const float AZIMUTH_THRESHOLD=0.02;bool isOverlapperStillVisible(vec2 idTexCoordinate,vec2 idHalfPxSize,sampler2D overlap,sampler2D scene){vec2 overlapId=texture2D(overlap,idTexCoordinate).rg;return overlapId!=NO_ID&&texture2D(scene,overlapId*ID_RENORMALIZATION+idHalfPxSize)!=EMPTY_PRIMITIVE;}float getVisibility(vec2 id,vec2 idHalfPxSize,sampler2D visibility,sampler2D overlap,sampler2D scene,float currentZoom,float currentTilt,float currentAzimuth){vec2 idTexCoordinate=id/256.0+idHalfPxSize;vec4 visibilityValue=texture2D(visibility,idTexCoordinate);float overlapZoom=visibilityValue.b;float overlapTilt=visibilityValue.r;float overlapAzimuth=visibilityValue.g;float zoomDiff=overlapZoom-currentZoom;float tiltDiff=abs(overlapTilt-currentTilt);float azimuthDiff=abs(overlapAzimuth-currentAzimuth);if((zoomDiff>ZOOM_THRESHOLD||(abs(zoomDiff)<=ZOOM_THRESHOLD&&tiltDiff<TILT_THRESHOLD&&azimuthDiff<AZIMUTH_THRESHOLD))&&isOverlapperStillVisible(idTexCoordinate,idHalfPxSize,overlap,scene)){return-1.0;}return visibilityValue.a;}void main(){float alpha=getVisibility(vertexId.xy,idHalfPxSize,visibility,overlap,scene,currentZoom,currentTilt,currentAzimuth);if(alpha<0.0){gl_Position=DISCARD_POSITION;}else{vec4 position=viewProjMatrix*vec4((YV_H*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*YV_N,vertexZPos,1);vec2 displacement=vertexDisplacement.xy+vertexDisplacement.zw;vec2 totalDisplacement=(displacement+vertexOffset)/DISPLACEMENT_FIXED_POINT_FRACTION_FACTOR;position.xy+=position.w*(shift+totalDisplacement*pixelSize);position.z=position.w*vertexPriority;gl_Position=position;id=vec4(vertexId.xy/255.0,0,alpha);}}",Wi,Xd),r),this._camera=i}_prepareProgram(e,t,i,r,s,o,n,a,l,d,h){super._prepareProgram(e,t,i,r,s,o,n,a,l,d,h),e.setVector2Uniform("pixelSize",this._camera.pixelSize)}},Ah=class extends ls{constructor(e,t,i=(()=>1),r=1){let s=t.createProgram("#version 100\nattribute vec3 vertexPos;attribute vec2 vertexUV;uniform mat4 viewProjMatrix;uniform mat4 modelMatrix;uniform vec2 primitiveId;uniform float zFactor;varying lowp vec4 id;const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);const float MAX_PRIORITY=1.0-pow(2.0,-24.0);const float ADJUSTING_FACTOR=pow(2.0,10.0);vec4 applyImprecisePerspectiveDivisionFix(vec4 position){return position*ADJUSTING_FACTOR;}void main(void){vec4 position=modelMatrix*vec4(vertexPos,1);position.z*=zFactor*position.w;gl_Position=viewProjMatrix*position;gl_Position.z=MAX_PRIORITY*gl_Position.w;gl_Position=applyImprecisePerspectiveDivisionFix(gl_Position);id=vec4(primitiveId.xy/255.0,0.0,1.0);}",Wi,td);s.setScalarUniform("priority",r),super(e,t,s),this._heightFactorProvider=i}_getPrimitives(){return ye(super._getPrimitives(),Lh)}_render(e,t){let i=this._program;for(let r of t)for(let t of os(this._getPrimitives(),this._canBatchPredicate)){let s=Zl(t.firstPrimitive,e,r.lookAt,Oh);i.setMatrix4Uniform("viewProjMatrix",s),i.setMatrix4Uniform("modelMatrix",t.firstPrimitive.matrix),this._renderBatch(t,i)}}_renderBatch(e,t){let{id:i}=e.firstPrimitive;Uh.x=255&i,Uh.y=i>>8&255,t.setVector2Uniform("primitiveId",Uh),super._renderBatch(e,t)}_prepareProgram(e,t,i,r,s,o,n,a,l,d,h){super._prepareProgram(e,t,i,r,s,o,n,a,l,d,h),e.setScalarUniform("zFactor",this._heightFactorProvider())}};function Lh(e){return void 0===e.instanceCount}var Uh=z(0,0),Oh=he(),Dh=class extends _s{_render(){}},zh=class extends Ve{constructor(e,t){let i=t.createProgram("#version 100\nattribute vec2 vertexId;attribute vec2 vertexCollidingFriendId;uniform vec2 idHalfPxSize;varying vec4 id;void main(){vec2 idTexCoordinates=vertexId.xy/256.0+idHalfPxSize;vec4 idWindowCoordinates=vec4(idTexCoordinates*2.0-1.0,0,1);id=vec4(vertexCollidingFriendId/255.0,0,0);gl_Position=idWindowCoordinates;gl_PointSize=1.0;}",Wi,{attribMap:{vertexId:2,vertexCollidingFriendId:15}});super(t,new O,i),this._primitiveProvider=e}_render(){let e=this._primitiveProvider.primitives;for(let t of os(e))this._context.bindVao(t.firstPrimitive.vao),this._context.drawIndexedMesh(t.indexByteOffset,is(t.indexByteLength,t.indexType),0,t.indexType)}_prepareProgram(e,t){super._prepareProgram(e,t),e.setVector2Uniform("idHalfPxSize",t)}},Bh=class extends zh{_render(){let e=this._primitiveProvider.primitives;for(let t of os(e,void 0,ss)){let{vao:e,stride:i}=Sh(this._context,t);this._context.bindVao(e),this._context.drawMesh(t.vertexByteOffset/i,t.vertexByteLength/i,0)}}},Fh=P},16387:(e,t,i)=>{"use strict";i.r(t),i.d(t,{getContentProviderWorker:()=>Z,getRichModelDecoderWorkerUrl:()=>Q,vector:()=>s(),vectorMapEngineFactory:()=>W});var r=i(26259),s=i.n(r),o=i(29509),n=i(9461),a=i(62367),l=i(51717),d=i(25950),h=i(25387),c=i(91249);class u{constructor(e,t){this.source=e,this.FD9_plan=t}getId(){return this.FD9_plan.id}getBounds(){const e=this.FD9_plan.bbox;return[[e.lowerCorner.lon,e.lowerCorner.lat],[e.upperCorner.lon,e.upperCorner.lat]]}isVisible(){return this.FD9_plan.isVisible}setVisible(e){this.FD9_plan.isVisible=e}getLevels(){return this.FD9_plan.levels}getDefaultLevel(){return this.FD9_plan.defaultLevel}getActiveLevel(){return this.FD9_plan.activeLevel}setActiveLevel(e){this.FD9_plan.setActiveLevel(e)}getOpacity(){return this.FD9_plan.opacity}setOpacity(e){this.FD9_plan.opacity=e}}var _=i(68222),p=i(47226);let m;class f{constructor(e={}){this.EBB_additionalData=e}submit(e,t){var i;const r=`/dtype=stred/pid=443/cid=73323/path=${e}/${i=Object.assign(Object.assign({},t),this.EBB_additionalData),Object.keys(i).map((e=>`${e}=${i[e]}`)).join("/")}/*`,s=function(){if(m)return m;switch(location.hostname.split(".").pop()){case"tr":return m="https://yandex.com.tr/clck/counter",m;case"com":case"fr":return m="https://yandex.com/clck/counter",m;case"eu":return m="https://yandex.eu/clck/counter",m;default:return m="https://yandex.ru/clck/counter",m}}();window.navigator.sendBeacon?navigator.sendBeacon(s,r):document.createElement("img").src=`${s}${r}`}}var g=i(19649),v=i(79655),y=i(60632),x=i(16574),b=i(98648);function T(e){return{feature:P(e),style:w(e)}}function P(e){const{id:t,feature:i,style:r}=e;switch(i.geometry.type){case"Point":return function(e,t,i){return{type:"Feature",geometry:t.geometry,properties:{style:M(i),metadata:I(e,i)}}}(t,i,r);case"LineString":case"MultiLineString":return function(e,t,i){const{geometry:r}=t,s=[];for(let t=i.stroke.length-1;t>=0;t--){const o=i.stroke[t];if("MultiLineString"===r.type)s.push({type:"Feature",geometry:{type:"MultiLineString",coordinates:r.coordinates},properties:{style:S(o,0),metadata:I(e,i)}});else{const t=C(r.coordinates,i.paletteColorStops);for(let r=t.length-1;r>=0;r--)s.push({type:"Feature",geometry:{type:"LineString",coordinates:t[r]},properties:{style:S(o,r),metadata:I(e,i)}})}}return{type:"FeatureCollection",features:s}}(t,i,r);case"Polygon":case"MultiPolygon":return function(e,t,i){return{type:"Feature",geometry:t.geometry,properties:{style:R(i),metadata:I(e,i)}}}(t,i,r);default:(0,x._y)(new Error(`Unexpected geometry type: ${i.geometry.type}`))}}function w(e){return{zIndex:e.style.zIndex,simplificationRate:"Point"===e.feature.geometry.type?0:e.style.simplificationRate}}function M(e){return{"icon-image":e.icon.url,"icon-offset":e.icon.offset,"icon-scale":e.icon.scale}}function R(e){const t=e.stroke[0];return{"fill-color":e.fill,"fill-opacity":e.fillOpacity,"fill-rule":e.fillRule,"fill-contour-width":null==t?void 0:t.width,"fill-contour-color":null==t?void 0:t.color,"fill-contour-opacity":null==t?void 0:t.opacity,"fill-contour-dasharray":E(t.dash),"fill-contour-join":"round"}}function S(e,t){return{"line-color":e.paletteColors.length>0?e.paletteColors[t]:e.color,"line-width":e.width,"line-opacity":e.opacity,"line-dasharray":E(e.dash),"line-join":"round","line-cap":"round"}}function C(e,t){if(0===t.length)return[e];const i=[];let r=0;for(const s of t)i.push(e.slice(r,s+1)),r=s;return i}function I(e,t){return t.interactive?{objectId:e}:void 0}function E(e){return e&&1===e.length?[e[0],e[0]]:e}class A{constructor(e,t){this.EBE_destroyed=!1,this.onBeforeRender=new e.EventTrigger,this.onRender=new e.EventTrigger,this.onAfterRender=new e.EventTrigger,this.A15_renderLoop=t,this.A23_renderLoopSubscription=this.A15_renderLoop.on("beforeRender",(()=>this.onBeforeRender.fire())).on("render",(()=>this.onRender.fire())).on("afterRender",(()=>this.onAfterRender.fire()))}get isActive(){return this.A15_renderLoop.isActive}update(){this.EBE_destroyed||this.A15_renderLoop.update()}destroy(){this.EBE_destroyed=!0,this.A23_renderLoopSubscription.offAll()}}var L=i(6049);function U(e){const t=null==e?void 0:e.opacity;return"number"==typeof t?(0,L.q)(t,0,1):1}const O=e=>(t,i,r,{parentLayer:s}={},o)=>{const n=[];ymaps3.strictMode&&(0,v.h)(null!=e,"You should defined ExternalRendererConstructor");class a extends t.ExternalRendererRenderUnit{constructor(){super(...arguments),this.EC8_originalBindRenderState=void 0,this.D9E_patchedBindRenderState=e=>{var t;null===(t=this.EC8_originalBindRenderState)||void 0===t||t.call(this._context,Object.assign(Object.assign({},e),{blendFuncSrcRgb:1}))}}render(...e){var t;this.EC8_originalBindRenderState=null===(t=this._context)||void 0===t?void 0:t.bindRenderState,this._context.bindRenderState=this.D9E_patchedBindRenderState;try{super.render(...e)}finally{this._context.bindRenderState=this.EC8_originalBindRenderState}}}const l=new((null==s?void 0:s.rootRenderUnit)instanceof t.BuildingsRenderUnit?a:t.ExternalRendererRenderUnit)(i.context,i.camera,(d=e,class extends d{constructor(e,t){super(e,{requestRender:t.requestRender}),this.FEE__implGl=e,this.C52__vaoExt=e.getExtension("OES_vertex_array_object")}render({size:e,worlds:t}){const{camera:i}=t[0];var r,s,o;return r=this.FEE__implGl,s=this.C52__vaoExt,(o=null)||(o=function(e){return{cullFace:!1,cullFaceSide:e.BACK,frontFace:e.CCW,pixelStoreUnpack:4,pixelStoreUnpackPremultiplyAlpha:!1,pixelStoreUnpackFlipY:!1,stencilTest:!1,stencilFunc:e.ALWAYS,stencilRef:0,stencilMask:255,stencilFail:e.KEEP,stencilPassDepthFail:e.KEEP,stencilPassDepthPass:e.KEEP,depthTest:!0,depthFunc:e.LESS,depthMask:!0,depthRange:[0,1],dither:!0,polygonOffsetFill:!1,blend:!1,blendSrc:e.ONE,blendDst:e.ZERO,blendEquation:e.FUNC_ADD,arrayBuffer:null,elementArrayBuffer:null,frameBuffer:null,renderBuffer:null,texture:null,vertexArray:null,program:null,activeTexture:e.TEXTURE0,clearColor:[0,0,0,0],clearDepth:1,clearStencil:0,viewport:[0,0,e.drawingBufferWidth,e.drawingBufferHeight],scissorBox:[0,0,1,1]}}(r)),o.cullFace?r.enable(r.CULL_FACE):r.disable(r.CULL_FACE),r.cullFace(o.cullFaceSide),r.frontFace(o.frontFace),r.pixelStorei(r.UNPACK_ALIGNMENT,o.pixelStoreUnpack),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,o.pixelStoreUnpackPremultiplyAlpha),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,o.pixelStoreUnpackFlipY),o.stencilTest?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),r.stencilFunc(o.stencilFunc,o.stencilRef,o.stencilMask),r.stencilMask(o.stencilMask),r.stencilOp(o.stencilFail,o.stencilPassDepthFail,o.stencilPassDepthPass),o.depthTest?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),r.depthFunc(o.depthFunc),r.depthMask(o.depthMask),r.depthRange(o.depthRange[0],o.depthRange[1]),o.dither?r.enable(r.DITHER):r.disable(r.DITHER),o.polygonOffsetFill?r.enable(r.POLYGON_OFFSET_FILL):r.disable(r.POLYGON_OFFSET_FILL),o.blend?r.enable(r.BLEND):r.disable(r.BLEND),r.blendFunc(o.blendSrc,o.blendDst),r.blendEquation(o.blendEquation),r.bindBuffer(r.ARRAY_BUFFER,o.arrayBuffer),r.bindFramebuffer(r.FRAMEBUFFER,o.frameBuffer),r.bindRenderbuffer(r.RENDERBUFFER,o.renderBuffer),r.bindTexture(r.TEXTURE_2D,o.texture),s&&s.bindVertexArrayOES(s.isVertexArrayOES(o.vertexArray)?o.vertexArray:null),r.useProgram(o.program),r.activeTexture(o.activeTexture),r.clearColor(o.clearColor[0],o.clearColor[1],o.clearColor[2],o.clearColor[3]),r.clearDepth(o.clearDepth),r.clearStencil(o.clearStencil),r.viewport(o.viewport[0],o.viewport[1],o.viewport[2],o.viewport[3]),r.scissor(o.scissorBox[0],o.scissorBox[1],o.scissorBox[2],o.scissorBox[3]),super.render({size:{x:e.width,y:e.height},camera:{azimuth:i.azimuth,zoom:i.zoom,tilt:i.tilt,worldCenter:{x:i.center.x,y:i.center.y},fov:i.fov},get worlds(){return t.map((({lookAt:e,viewProjMatrix:t})=>({lookAt:e,viewProjMatrix:t})))}})}}));var d;let h=null==s?void 0:s.rootRenderUnit;return h?h.addRenderUnit(l):n.push(l),{collidingPrimitives:[],renderUnits:n,destroyables:[{destroy:()=>{h&&h.removeRenderUnit(l),l.destroy()}}]}};const D={ground:function(e,t,i,{highlightProvider:r,opacityProvider:s}={},o){if(i instanceof e.Vmap3ContentProvider)return function(e,t,i,{highlightProvider:r,opacityProvider:s}={},o){const{context:n,camera:a}=t,{scene:l}=i,d=new e.ContentPortionPrimitiveProvider,h=U(o),c=h<1?e.TransparentPolygonRenderUnit:e.PolygonRenderUnit,u=new c(d.getProvider(0),n,{colorTransform:r,opacity:s},{hitTest:!0,depthTest:!1}),_=new e.TransparentPolygonRenderUnit(d.getProvider(1),n,{colorTransform:r,opacity:s},{hitTest:!0,depthTest:!1}),p=new e.PolylineRenderUnit(d.getProvider(5),n,a,{opacity:s},{hitTest:!0,depthTest:!1}),m=new e.GroundCompositeRenderUnit(l[100],d,{opaquePolygon:u,transparentPolygon:_,polyline:p});return{renderUnits:[m],collidingPrimitives:[],destroyables:[u,_,p]}}(e,t,i);const{context:n,camera:a}=t,{scene:l}=i;return{renderUnits:[new e.LayerRenderUnit(n,1),new(U(o)<1?e.TransparentPolygonRenderUnit:e.PolygonRenderUnit)(l[0],n,{colorTransform:r,opacity:s},{hitTest:!0}),new e.TransparentPolygonRenderUnit(l[1],n,{colorTransform:r,opacity:s},{hitTest:!0}),new e.PolylineRenderUnit(l[5],n,a,{opacity:s},{hitTest:!0})],collidingPrimitives:[],destroyables:[]}},buildings:function(e,t,i,r={},s){if(i instanceof e.Tile3DContentProvider)return function(e,t,i,{highlightProvider:r,opacityProvider:s,parentLayer:o}={},n){const{context:a,renderLoop:l}=t,{scene:d,collidingScene:h}=i,c=(null==n?void 0:n.modelsAppearingAnimation)?new e.ModelsAnimationManager({onUpdate:i.viewport.onUpdate,getModels:()=>i.viewport.visibleRenderableTiles()},t.renderLoop,n.modelsAppearingAnimation.duration):void 0,u=new e.GlTFPrimitiveRenderUnit(d,a,{diffuseColor:()=>i.modelColor,materialFactor:e=>i.getModelAppearingProgress(e),colorTransform:r,opacity:s},{hitTest:!0}),_=[],p=[];let m=null==o?void 0:o.rootRenderUnit;if(!m){const t=new e.FxaaRenderUnit(a,l),i=new e.BuildingsRenderUnit(a);t.addRenderUnit(i),_.push(t),p.push(i),m=i}m.addRenderUnit(u);const f=new e.ColorIdGltfRenderer(h,a),g=new e.GltfResetRemovedRenderer(h,a);p.push({destroy:()=>{m&&m.removeRenderUnit(u),u.destroy()}}),c&&p.push(c);return{renderUnits:_,destroyables:p,collidingPrimitives:[{provider:h,renderers:{colorId:f,resetRemoved:g}}]}}(e,t,i,r,s);const o=i.scene[3],n=(null==s?void 0:s.modelsAppearingAnimation)?new e.ModelsAnimationManager({getModels:()=>o.primitives,onUpdate:o.onUpdate},t.renderLoop,s.modelsAppearingAnimation.duration):void 0,a=new e.ModelRenderUnit(o,t.context,{heightFactor:null==n?void 0:n.heightProvider,colorTransform:r.highlightProvider,opacity:r.opacityProvider},{hitTest:!0}),l=new e.FxaaRenderUnit(t.context,t.renderLoop),d=new e.BuildingsRenderUnit(t.context);d.addRenderUnit(a),l.addRenderUnit(d);const h=[l],c=[],u=[a,d];if(n&&u.push(n),i.options.richModelEnabled||i.options.richPointEnabled){const o=function(e,t,i,r,s={},o){const n=i.scene[4],a=(null==s?void 0:s.modelsAppearingAnimation)?new e.ModelsAnimationManager({onUpdate:n.onUpdate,getModels:()=>n.primitives},t.renderLoop,s.modelsAppearingAnimation.duration):void 0,l=new e.GlTFPrimitiveRenderUnit(n,t.context,{colorTransform:r.highlightProvider,heightFactor:null==a?void 0:a.heightProvider,opacity:r.opacityProvider},{hitTest:!0}),d=new e.ColorIdGltfRenderer(n,t.context),h=new e.GltfResetRemovedRenderer(n,t.context);o.addRenderUnit(l);const c=[{destroy:()=>{o.removeRenderUnit(l)}},l];a&&c.push(a);return{renderUnits:[],collidingPrimitives:[{phaseIndex:1,provider:n,renderers:{colorId:d,resetRemoved:h}}],destroyables:c}}(e,t,i,r,s,d);h.push(...o.renderUnits),c.push(...o.collidingPrimitives),u.push(...o.destroyables)}return{destroyables:u,renderUnits:h,collidingPrimitives:c,rootRenderUnit:d}},icons:function(e,t,i,{highlightProvider:r,opacityProvider:s},o){var n,a;const l=new e.IconRenderUnit(i.scene[8],t.context,t.camera,{visibility:t.visibilityTextureProvider,colorTransform:r,opacity:s},{hitTest:!0,iconHitTestField:null===(n=null==o?void 0:o.iconsInteractiveArea)||void 0===n?void 0:n.field,iconHitTestMinSize:null===(a=null==o?void 0:o.iconsInteractiveArea)||void 0===a?void 0:a.minSize}),d=new e.ColorIdIconRenderer(i.scene[8],t.context,t.camera,{clearDepth:null==o?void 0:o.isolateObjectsColliding}),h=new e.CollidingPrimitivesResetRemovedRenderer(i.scene[8],t.context),c=new e.CollidingFriendIdRenderer(i.scene[8],t.context);return{renderUnits:[l],collidingPrimitives:[{provider:i.scene[8],renderers:{colorId:d,resetRemoved:h,friendId:c}}],destroyables:[d,h,c]}},labels:function(e,t,i,{highlightProvider:r,opacityProvider:s}={},o){const{context:n,camera:a}=t,{scene:l}=i,d=new e.PointLabelRenderUnit(l[6],n,a,{visibility:t.visibilityTextureProvider,colorTransform:r,opacity:s},{hitTest:!0}),h=new e.CurvedLabelRenderUnit(l[7],n,a,{visibility:t.visibilityTextureProvider,opacity:s}),c=new e.ColorIdCurvedLabelRenderer(l[7],t.context,t.camera),u=new e.LabelResetRemovedRenderer(l[7],t.context),_=new e.ColorIdPointLabelRenderer(l[6],t.context,t.camera),p=new e.LabelResetRemovedRenderer(l[6],t.context),m=new e.LabelCollidingFriendIdRenderer(l[6],t.context);return{renderUnits:[h,d],collidingPrimitives:[{provider:l[7],renderers:{colorId:c,resetRemoved:u}},{provider:l[6],renderers:{colorId:_,resetRemoved:p,friendId:m}}],destroyables:[c,_,u,p,m]}},graphics:function(e,t,i,{opacityProvider:r}={},s){const{context:o,camera:n,visibilityManager:a,visibilityTextureProvider:l}=t,{scene:d}=i,h=[],c=()=>a.noCollidingVisibilityTexture,u=new e.ContentPortionPrimitiveProvider,_=U(s),p=new e.GraphicsRenderUnit(o,d,u),m=new(_<1?e.TransparentPolygonRenderUnit:e.PolygonRenderUnit)(u.getProvider(0),o,{opacity:r},{hitTest:!0}),f=new e.TransparentPolygonRenderUnit(u.getProvider(1),o,{opacity:r},{hitTest:!0}),g=i.options.accurateGeometryLines?new e.GraphicsPolylineRenderUnit(u.getProvider(5),o,n,{stencilId:t.stencilIdProvider,opacity:r},{hitTest:!0,snapGeometryToNearestZoom:!0}):new e.PolylineRenderUnit(u.getProvider(5),o,n,{opacity:r},{hitTest:!0,snapGeometryToNearestZoom:!0}),v=new e.IconRenderUnit(u.getProvider(8),o,n,{visibility:c,opacity:r},{hitTest:!0}),y=new e.LayerRenderUnit(o,1);return p.addRenderUnit(m),p.addRenderUnit(f),p.addRenderUnit(g),p.addRenderUnit(v),{renderUnits:[y,p],collidingPrimitives:h,destroyables:[m,f,g,v]}}};var z=i(96883);class B extends((0,n.GA)().with()){constructor(e,t,i){super(),this.EA4_tiles=new Map,this.EAB_cesiumTilesByUris=new Map,this.C77_tileUrisByModelId=new Map,this.D88_visibleTileUris=new Set,this.FD2_vector=e,this.A22_contentProvider=t,this.EBC_dataSource=i,this.EC6_sourceSubscription=this.EBC_dataSource.on("rootTileAdded",(e=>this.EA5_onRootTileAdded(e))).on("rootTileReplaced",(e=>this.D89_onRootTileReplaced(e))).on("rootTileRemoved",(e=>this.C73_onRootTileRemoved(e))).on("rootTileShown",(e=>this.C6C_onRootTileShown(e))).on("rootTileHidden",(e=>this.EAC_onRootTileHidden(e))).on("rootTileTexturesChanged",(({id:e,tier:t})=>this.A17_onRootTileTexturesChanged(e,t))),this.A22_contentProvider.contentManager.onTileProcessingError.addListener(this.B30_onTileProcessingError,this),this.A22_contentProvider.viewport.onUpdate.addListener(this.C6D_onViewportUpdate,this),this.EBC_dataSource.rootTiles.forEach((e=>this.EA5_onRootTileAdded(e)))}destroy(){this.EA4_tiles.forEach((e=>this.D7C_stopLoading(e.currentTile))),this.A22_contentProvider.viewport.onUpdate.removeListener(this.C6D_onViewportUpdate),this.A22_contentProvider.contentManager.onTileProcessingError.removeListener(this.B30_onTileProcessingError),this.EC6_sourceSubscription.offAll()}getTile3dState(e){const t=this.EAB_cesiumTilesByUris.get(e);return t?this.FD2_vector.isTile3DRenderable(t)?"ready":t.isLoaded?"loaded":t.isLoading?"loading":null:null}EA5_onRootTileAdded(e){ymaps3.strictMode&&(0,v.h)(!this.EA4_tiles.has(e.id),`Root tile with id ${e.id} already exists`);const t={rootTile:e,cachedCesiumTilesByUri:new Map,currentTile:this.B36_createVectorTile(e)};this.EA4_tiles.set(e.id,t),this.C58_startLoading(t.currentTile)}D89_onRootTileReplaced(e){const t=this.EBA_getExistingEntry(e.id);this.D7C_stopLoading(t.currentTile),t.cachedCesiumTilesByUri.set(t.currentTile.uri,t.currentTile);const i=t.cachedCesiumTilesByUri.get(e.uri);t.currentTile=i||this.B36_createVectorTile(e),this.C58_startLoading(t.currentTile)}C73_onRootTileRemoved(e){const t=this.EBA_getExistingEntry(e);this.D7C_stopLoading(t.currentTile),this.B32_removeTile(t.currentTile),t.cachedCesiumTilesByUri.forEach((e=>this.B32_removeTile(e))),this.EA4_tiles.delete(e)}C6C_onRootTileShown(e){const t=this.EBA_getExistingEntry(e);t.currentTile.isHidden=!1,this.A22_contentProvider.showRootTile(t.currentTile.cesiumTile)}EAC_onRootTileHidden(e){const t=this.EBA_getExistingEntry(e);t.currentTile.isHidden=!0,this.A22_contentProvider.hideRootTile(t.currentTile.cesiumTile)}A17_onRootTileTexturesChanged(e,t){const i=this.EBA_getExistingEntry(e);this.A22_contentProvider.changeRootTileTextures(i.currentTile.cesiumTile,t)}B30_onTileProcessingError(e,t){t.message=`Tile3d: ${t.message}`,this._emit("tile3dProcessingError",t)}C6D_onViewportUpdate(){F.clear();const e=this.A22_contentProvider.viewport.visibleRenderableTiles()[Symbol.iterator]();for(let t=e.next();!t.done;t=e.next()){const e=void 0!==t.value.modelId&&this.C77_tileUrisByModelId.get(t.value.modelId);e&&F.add(e)}this.D88_visibleTileUris.forEach((e=>{F.has(e)||(this.D88_visibleTileUris.delete(e),this.EA6_onModelVisibilityChanged(e,!1))})),F.forEach((e=>{this.D88_visibleTileUris.has(e)||(this.D88_visibleTileUris.add(e),this.EA6_onModelVisibilityChanged(e,!0))}))}EA6_onModelVisibilityChanged(e,t){this._emit("tile3dVisibilityChange",{uri:e,isVisible:t})}EBA_getExistingEntry(e){const t=this.EA4_tiles.get(e);return ymaps3.strictMode&&(0,v.h)(void 0!==t,`Tile with id ${e} does not exist`),t}B36_createVectorTile(e){const{id:t,uri:i,tile:r,detalizationFactor:s,collidingTileUri:o,modelId:n}=e,a=new this.FD2_vector.VerboseCesium3DTileSet(i,r,n,s),l=o?new this.FD2_vector.Cesium3DTileSet(o,r,a.modelId,s):void 0,d=Boolean(e.isHidden);return this.EAB_cesiumTilesByUris.set(i,a),this.C77_tileUrisByModelId.set(a.modelId,i),{id:t,cesiumTile:a,collidingCesiumTile:l,uri:i,isHidden:d,onLoadingStarted:()=>this.EBA_onTileStateChanged(t),onLoadingFinished:()=>{this.EBC_dataSource.setRootTileTexturesTiers(t,[...a.getTexturesTiers()]),this.EBA_onTileStateChanged(t)},onUpdate:()=>this.A15_onTileUpdate(t)}}B32_removeTile(e){this.EAB_cesiumTilesByUris.delete(e.uri),this.C77_tileUrisByModelId.delete(e.cesiumTile.modelId),this.EBC_dataSource.setRootTileTexturesTiers(e.id,null),this.A22_contentProvider.removeRootTile(e.cesiumTile)}C58_startLoading(e){const{cesiumTile:t,onLoadingStarted:i,onLoadingFinished:r,onUpdate:s}=e;t.onLoadingStarted.addListener(i),t.onLoadingFinished.addListener(r),t.onUpdate.addListener(s),this.A22_contentProvider.contentManager.preload(t),s()}D7C_stopLoading(e){const{cesiumTile:t,onLoadingStarted:i,onLoadingFinished:r,onUpdate:s}=e;t.onLoadingStarted.removeListener(i),t.onLoadingFinished.removeListener(r),t.onUpdate.removeListener(s),this.A22_contentProvider.contentManager.cancelPreload(t)}EBA_onTileStateChanged(e){this._emit("tile3dChanged",e)}A15_onTileUpdate(e){const t=this.EBA_getExistingEntry(e);if(this.FD2_vector.isTile3DRenderable(t.currentTile.cesiumTile)){this.EBA_onTileStateChanged(e);const{buildingObjectIds:i}=t.rootTile,{cesiumTile:r,collidingCesiumTile:s,isHidden:o}=t.currentTile;this.A22_contentProvider.addRootTile(r,i,s),o&&this.A22_contentProvider.hideRootTile(r),t.cachedCesiumTilesByUri.forEach((e=>{e!==t.currentTile&&this.A22_contentProvider.hideRootTile(e.cesiumTile,0)}))}}}const F=new Set;var V=i(45852),N=i(38575);const k=[],H=e=>{const t=Math.floor(e);return e-t<.5?t:t+1};class j extends((0,n.GA)().with()){constructor(e,t,i,r,s,o,n,a,l,h){super(),this.C6C_processingQueue=new _.$7(_.fv),this.B2D_contentProvidersBySource=new Map,this.ECB_layersById=new Map,this.FDD_layerDescriptions=[],this.B2F_dataSources={},this.D84_filters=new Map,this.FEB_tileContentClippingGeometries=new Map,this.B2F_onVisibleObjectsChanged=()=>{this._emit("visibleObjectsChanged")},this.B49_finalizeSetLayers=(e,t,i)=>{this.ECB_layersById.forEach((e=>{for(const t of e.renderUnits)this.FEA_engine.renderer.removeRenderUnit(t)})),this.B2D_contentProvidersBySource=i,this.FDD_layerDescriptions=e,this.ECB_layersById=t,this.ECB_layersById.forEach((e=>{for(const t of e.renderUnits)this.FEA_engine.renderer.addRenderUnit(t)})),this.B2D_contentProvidersBySource.forEach((e=>{this.C78_updateDataSourceZoomRange(e,this.EA2_camera)})),this.B3F_applyBackgroundColor(),this.C55_asyncSetLayersAbortController=void 0,this._emit("indoorPlansChanged")},this.EC6_createContentProvider=({source:e,sourceName:t})=>{var i,r;if(e instanceof b.m5)return this.B37_createGraphicsContentProvider(e,t);if(e instanceof c.N)return this.A71_createTile3dContentProvider(e,t);if(e instanceof V.m)return this.B4D_createNoneContentProvider(e,t);const s=e.vectorSourceDescription,o="vmap3"===s.tileFormat?7:s.indoorPlanUrl?3:s.iconsOnlyTiles?1:0,n=7===o,a=n&&s.hdModeEnabled?"&protocol=2":"";function l(e){return e?e+a:e}const d={iconUrlTemplate:s.imageUrl,glyphRangeUrlTemplate:s.glyphRangeUrl,tileUrlTemplate:s.tileUrl,meshUrlTemplate:s.meshUrl,styleUrlTemplate:n?l(s.styleUrl):void 0,fontListUrlTemplate:n?s.fontListUrl:void 0,fontObjectUrlTemplate:n?s.fontObjectUrl:void 0,indoorPlanUrlTemplate:s.indoorPlanUrl,richModelUrlTemplate:s.richModelUrl,richModelEnabled:s.richModelEnabled,richPointEnabled:s.richPointEnabled,tileSize:this.B4F_getVectorTileSize(s.requestTileSize||"X1"),preloadedTilesBeltWidth:s.tileBeltSize||0,useLowPrecisionBeltTiles:s.lowPrecisionBeltTiles,tileCacheSize:s.tileCacheSize||100,richModelCacheSize:s.richModelCacheSize,basePriority:this.FF1_getVectorContentProviderPriority(s.priority),objectsCollisionPriority:this.D9B_getVectorCollisionPriority(null!==(i=s.collisionPriority)&&void 0!==i?i:"medium"),customizationConfig:null!==(r=s.customization)&&void 0!==r?r:k,tileRequestWithCredentials:s.tileRequestWithCredentials,iconRequestWithCredentials:s.imageRequestWithCredentials,glyphRequestWithCredentials:s.glyphRequestWithCredentials,meshRequestWithCredentials:s.meshRequestWithCredentials,richModelRequestWithCredentials:s.richModelRequestWithCredentials,indoorPlanRequestWithCredentials:s.indoorPlanRequestWithCredentials,styleRequestWithCredentials:s.styleRequestWithCredentials,fontListRequestWithCredentials:s.fontListRequestWithCredentials,fontObjectRequestWithCredentials:s.fontObjectRequestWithCredentials,tileRequestHeaders:s.tileRequestHeaders,iconRequestHeaders:s.iconRequestHeaders,glyphRequestHeaders:s.glyphRequestHeaders,meshRequestHeaders:s.meshRequestHeaders,richModelRequestHeaders:s.richModelRequestHeaders,indoorPlanRequestHeaders:s.indoorPlanRequestHeaders,styleRequestHeaders:s.styleRequestHeaders,fontListRequestHeaders:s.fontListRequestHeaders,fontObjectRequestHeaders:s.fontObjectRequestHeaders,mapMode:"dark"===s.theme?1:0,hdModeEnabled:n&&s.hdModeEnabled,mapType:n?this.FEF_getVectorMapType(s.mapType):void 0,allObjectsInteractive:s.allObjectsInteractive,computeIconBrightnessRange:!0,enableTileContentColliding:n,richModelDecoderWorkerUrl:s.richModelDecoderWorkerUrl,cameraIdleThrottling:s.cameraIdleThrottling},h=this.EA6_contentProdiver.initContentProvider(o,t,d);if(h instanceof this.vector.IndoorContentProvider&&h.onPlansChanged.addListener(this.EBD_onPlansChanged),3!==o){const{coveredByIndoorFilter:e,buildingsFilters:t}=this.EA6_contentProdiver;this.EBF_toggleVisibilityFilter(h,e,!0,[8,6,3,4]),this.EBF_toggleVisibilityFilter(h,t.idFilter,!0,[3])}h instanceof this.vector.Vmap3ContentProvider&&h.backgroundController.onBackgroundSet.addListener(this.B34_onProviderBackgroundSet);const u=e.group().on("changed",(()=>{var t;const{options:i}=h,r=null!==(t=e.vectorSourceDescription.customization)&&void 0!==t?t:k;r!==i.customizationConfig&&h.updateCustomizationConfig(r);const{tileUrl:s,imageUrl:o,glyphRangeUrl:n,meshUrl:a,richModelUrl:d,indoorPlanUrl:c,styleUrl:u,fontListUrl:_,fontObjectUrl:p}=e.vectorSourceDescription,m={};s!==i.tileUrlTemplate&&(m.tileUrlTemplate=s),o!==i.iconUrlTemplate&&(m.iconUrlTemplate=o),n!==i.glyphRangeUrlTemplate&&(m.glyphRangeUrlTemplate=n),a!==i.meshUrlTemplate&&(m.meshUrlTemplate=a),d!==i.richModelUrlTemplate&&(m.richModelUrlTemplate=d),c!==i.indoorPlanUrlTemplate&&(m.indoorPlanUrlTemplate=c),l(u)!==i.styleUrlTemplate&&(m.styleUrlTemplate=l(u)),_!==i.fontListUrlTemplate&&(m.fontListUrlTemplate=_),p!==i.fontObjectUrlTemplate&&(m.fontObjectUrlTemplate=p),s!==i.tileUrlTemplate&&(m.tileUrlTemplate=s),0!==Object.keys(m).length&&h.updateUrlTemplates(m),this.B39_applyMapTheme(h,e.vectorSourceDescription.theme)}));h.visibilityManager.onViewportStateChanged.addListener(this.A28_onViewportStateChanged),h.scene[8].onUpdate.addListener(this.B2F_onVisibleObjectsChanged),h.scene[6].onUpdate.addListener(this.B2F_onVisibleObjectsChanged),this.D84_filters.forEach((e=>{this.EBF_toggleVisibilityFilter(h,e,!0)}));const _=this.FEB_tileContentClippingGeometries.get(t);return _&&h.addTileContentClipperGeometry(_.geometry),{contentProvider:h,source:e,sourceSubscription:u,type:"tile"}},this.FE9_destroyContentProvider=e=>{"tile"===e.type?(e.contentProvider.visibilityManager.onViewportStateChanged.removeListener(this.A28_onViewportStateChanged),e.contentProvider.scene[8].onUpdate.removeListener(this.B2F_onVisibleObjectsChanged),e.contentProvider.scene[6].onUpdate.removeListener(this.B2F_onVisibleObjectsChanged),e.contentProvider instanceof this.vector.IndoorContentProvider&&e.contentProvider.onPlansChanged.removeListener(this.EBD_onPlansChanged),e.contentProvider instanceof this.vector.Vmap3ContentProvider&&e.contentProvider.backgroundController.onBackgroundSet.removeListener(this.B34_onProviderBackgroundSet)):"graphics"===e.type?e.contentProvider.visibilityManager.onStateChanged.removeListener(this.A14_onGraphicsStateChanged):"tile3d"===e.type&&(e.controller.destroy(),e.controllerSubscription.offAll()),e.sourceSubscription.offAll(),this.EA6_contentProdiver.destroyContentProvider(e.contentProvider)},this.B34_onProviderBackgroundSet=()=>{this.B3F_applyBackgroundColor()},this.EBD_onPlansChanged=()=>this._emit("indoorPlansChanged"),this.A28_onViewportStateChanged=()=>{this.A14_onGraphicsStateChanged(),this.B2D_areTilesReady()&&(this._emit("tilesLoaded"),this._emit("tilesReady"))},this.A14_onGraphicsStateChanged=()=>{this._emit("stateChanged")},this.FF1_createLayerImplementation=(e,t,i)=>{const r="graphics"===t.type?"graphics":e.type;let s=D[r];if(!s){const t=e.implementation({source:e.source,type:e.type,effectiveMode:"vector"});s=O(t)}const o=e.options.vector,n=Object.assign(s(this.vector,this.FEA_engine,t.contentProvider,{parentLayer:i,highlightProvider:this.D8E_objectHighlight.provider,opacityProvider:()=>n.opacity},o),{sourceImplementation:t,sourceSubscription:this.B2F_dataSources[e.source].group(),parentLayerId:e.grouppedWith,opacity:U(o),isolateObjectsColliding:o.isolateObjectsColliding,iconsInteractiveArea:o.iconsInteractiveArea&&Object.assign({},o.iconsInteractiveArea),modelsAppearingAnimation:o.modelsAppearingAnimation&&Object.assign({},o.modelsAppearingAnimation)});this.EAD_setupHotspotLayer(n,e),n.sourceSubscription.on("changed",(()=>{this.B38_teardownHotspotLayer(n),this.EAD_setupHotspotLayer(n,e)}));for(const{provider:e,renderers:t,phaseIndex:i}of n.collidingPrimitives)this.FEA_engine.visibilityManager.registerCollidingPrimitives(e,t,i);return n},this.C57_destroyLayerImplementation=e=>{e.sourceSubscription.offAll(),this.B38_teardownHotspotLayer(e);for(let t=e.collidingPrimitives.length-1;t>=0;t--){const{provider:i,renderers:r}=e.collidingPrimitives[t];this.FEA_engine.visibilityManager.deregisterCollidingPrimitives(i,r)}for(let t=e.renderUnits.length-1;t>=0;t--){const i=e.renderUnits[t];this.FEA_engine.renderer.removeRenderUnit(i),i.destroy&&i.destroy()}for(const t of e.destroyables)t.destroy()},this.renderLoop=a,this.vector=e,this.worldOptions=l,this.EAE_tiltRange=h,this.A25_metricsTransport=r||new f,this.B2F_applyDataSources(n),this.element=i.canvas,this.element.style.width="100%",this.element.style.height="100%",this.ABC_context=new this.vector.Context(i),this.FF1_vectorRenderLoop=new A(this.vector,a),this.C5B_size=s,this.A23_renderLoopSubscription=a.on("render",(e=>{this.ECB_layersById.forEach((({hotspotLayer:t})=>t&&t.render(e)))})).on("beforeRender",(()=>{(!this.FF3_renderedSize&&Boolean(this.C5B_size)||!d.wy(this.C5B_size,this.FF3_renderedSize))&&this.D8F_doResize()})),this.FEA_engine=new this.vector.Engine(this.ABC_context,new this.vector.Camera({wrapModeX:this.ABB_getWorldWrapOption(l.cycledX),wrapModeY:this.ABB_getWorldWrapOption(l.cycledY),minTilt:this.EAE_tiltRange.min-this.EAE_tiltRange.expansion,maxTilt:this.EAE_tiltRange.max+this.EAE_tiltRange.expansion}),this.FF1_vectorRenderLoop),this.EBD_backgroundRenderUnit=new this.vector.BackgroundRenderUnit(this.ABC_context),this.FEA_engine.renderer.addRenderUnit(this.EBD_backgroundRenderUnit),this.FEA_engine.onInternalError.addListener((()=>this._emit("internalError"))),this.D85_updateRenderLoop=this.renderLoop.update.bind(this.renderLoop),this.EA6_contentProdiver=new this.vector.MainContentProvider(t,this.FEA_engine.camera,this.FEA_engine.context,this.FEA_engine.renderLoop,this.A25_metricsTransport),this.EA6_contentProdiver.onInternalError.addListener((()=>this._emit("internalError"))),this.D8E_objectHighlight={provider:()=>this.D8E_objectHighlight.transform,transform:void 0},this.update(o)}getLayerReadyState(e,t){var i;const r=null===(i=this.ECB_layersById.get(e))||void 0===i?void 0:i.sourceImplementation;if(!r||t&&r.type!==t)return;const s={tilesReady:0,tilesLoaded:0,tilesTotal:0,graphicsReady:0,graphicsTotal:0};if("graphics"===r.type&&(s.graphicsReady=r.contentProvider.visibilityManager.state.objectsVisible,s.graphicsTotal=r.contentProvider.visibilityManager.state.objectsTotal),"tile"===r.type){const e=r.contentProvider.visibilityManager.viewportState.visibleTileNumber,t=r.contentProvider.visibilityManager.viewportState.visualizableTileNumber;s.tilesReady=t,s.tilesLoaded=t,s.tilesTotal=e}return s}getTile3dState(e,t){var i;const r=null===(i=this.ECB_layersById.get(e))||void 0===i?void 0:i.sourceImplementation;return r&&"tile3d"===r.type?r.controller.getTile3dState(t):null}destroy(){this.setLayers([]),this.EBD_backgroundRenderUnit.destroy(),this.A23_renderLoopSubscription.offAll(),this.FEA_engine.destroy(),this.ABC_context.destroy(),this.FF1_vectorRenderLoop.destroy(),this.EA6_contentProdiver.destructor(),this.C55_asyncSetLayersAbortController&&(this.C55_asyncSetLayersAbortController.abort(),this.C55_asyncSetLayersAbortController=void 0)}setDataSources(e){this.B2F_applyDataSources(e),this.setLayers(this.FDD_layerDescriptions)}update(e){this.EA2_camera=e,this.FEA_engine.camera.zoom=e.zoom,this.FEA_engine.camera.center.x=e.worldCenter.x,this.FEA_engine.camera.center.y=e.worldCenter.y,this.FEA_engine.camera.azimuth=e.azimuth,this.FEA_engine.camera.tilt=e.tilt,this.FEA_engine.camera.flushUpdates(),this.ECB_layersById.forEach((({hotspotLayer:t})=>t&&t.update(e,this.fov))),this.B2D_contentProvidersBySource.forEach((t=>this.C78_updateDataSourceZoomRange(t,e)))}resize(e){this.C5B_size=e}setLayers(e){this.B32_abortAndCleanupAsyncLayersInitIfInProgress();const t=new Map,i=new Map;for(const r of e){const e=this.B2F_dataSources[r.source];e instanceof h.Nt&&!e.vectorSourceDescription&&(0,x._y)(new Error(`${r.id} does not have vector source`)),t.set(r.id,r),i.set(r.source,{source:e,sourceName:r.source})}const r=(0,l.B)(this.B2D_contentProvidersBySource,i,this.EC6_createContentProvider,this.FE9_destroyContentProvider,(()=>{}),(()=>!0)).result,s=new Map,o=(0,l.B)(this.ECB_layersById,t,(e=>{const t=r.get(e.source),{grouppedWith:i}=e,o=i?s.get(i):void 0,n=this.FF1_createLayerImplementation(e,t,o);return s.set(e.id,n),n}),this.C57_destroyLayerImplementation,((e,t)=>{s.set(t.id,e),e.opacity=U(t.options.vector)}),((e,t)=>{var i,r,s,o,n,a;const l=t.options.vector;return e.sourceImplementation.source===this.B2F_dataSources[t.source]&&e.parentLayerId===t.grouppedWith&&(null===(i=e.iconsInteractiveArea)||void 0===i?void 0:i.field)===(null===(r=l.iconsInteractiveArea)||void 0===r?void 0:r.field)&&(null===(s=e.iconsInteractiveArea)||void 0===s?void 0:s.minSize)===(null===(o=l.iconsInteractiveArea)||void 0===o?void 0:o.minSize)&&e.isolateObjectsColliding===l.isolateObjectsColliding&&(null===(n=e.modelsAppearingAnimation)||void 0===n?void 0:n.duration)===(null===(a=l.modelsAppearingAnimation)||void 0===a?void 0:a.duration)&&e.opacity<1==U(t.options.vector)<1}));this.B49_finalizeSetLayers(e,o.result,r)}initLayersAsync(e,t){var i;if(ymaps3.strictMode&&(0,v.h)(0===this.ECB_layersById.size,"There are already some layers in map engine. Can't run async init."),ymaps3.strictMode&&(0,v.h)(void 0===this.C55_asyncSetLayersAbortController,"Async init was already started."),t.aborted)return Promise.reject((0,g.o)());this.C55_asyncSetLayersAbortController=new AbortController;const r=this.C55_asyncSetLayersAbortController.signal,s=()=>{t.removeEventListener("abort",s),this.B32_abortAndCleanupAsyncLayersInitIfInProgress()};t.addEventListener("abort",s);const o=new Map,n=new Map,a=[];for(const t of e){const e=this.B2F_dataSources[t.source];e instanceof h.Nt&&!e.vectorSourceDescription&&(0,x._y)(new Error(`${t.id} does not have vector source.`));const s=null!==(i=o.get(t.source))&&void 0!==i?i:this.EC6_createContentProvider({source:e,sourceName:t.source});o.set(t.source,s);const l=()=>{if(!r.aborted){const{grouppedWith:e}=t,i=e?n.get(e):void 0,r=this.FF1_createLayerImplementation(t,s,i);n.set(t.id,r)}};a.push(new Promise((e=>setTimeout(e))).then(l))}return new Promise(((e,t)=>{r.addEventListener("abort",(()=>{o.forEach(this.FE9_destroyContentProvider),t((0,g.o)())})),Promise.all(a).then((()=>e())).catch((e=>{(0,x.H)(e),t(e)}))})).then((()=>{r.aborted||this.B49_finalizeSetLayers(e,n,o)})).finally((()=>{t.removeEventListener("abort",s),this.C55_asyncSetLayersAbortController&&(this.C55_asyncSetLayersAbortController=void 0)}))}preloadHotspotsInPoint(e){this.ECB_layersById.forEach((t=>{t.hotspotLayer&&t.hotspotLayer.preloadHotspotsInPoint(e)}))}preloadHotspotsForViewport(){this.ECB_layersById.forEach((e=>{e.hotspotLayer&&e.hotspotLayer.preloadHotspotsForViewport()}))}setObjectFilters(e){const t=(0,l.B)(this.D84_filters,e,(e=>{const t=new this.vector.EventTrigger,i=e.on("update",(()=>t.fire()));return{filter:e,onUpdate:t,subscription:i,test:t=>e.test(t)}}),(e=>{e.subscription.offAll()}));for(const e of t.removed)this.B2D_contentProvidersBySource.forEach((t=>{"tile"===t.type&&this.EBF_toggleVisibilityFilter(t.contentProvider,e,!1)}));for(const e of t.created)this.B2D_contentProvidersBySource.forEach((t=>{"tile"===t.type&&this.EBF_toggleVisibilityFilter(t.contentProvider,e,!0)}));this.D84_filters=t.result}setInvisibleCollidingPrimitives(e){const t=this.FEA_engine.invisibleCollidingPrimitiveManager,i=[];e.forEach((e=>i.push(e))),t.clear(),t.addPrimitives(...i)}getIndoorPlans(){const e=[];if(this.B2D_contentProvidersBySource.forEach((({contentProvider:t},i)=>{t instanceof this.vector.IndoorContentProvider&&e.push([t,i])})),0===e.length)return null;const t=[];for(const[i,r]of e)if(!i.isPaused)for(const e of i.plans)t.push(new u(r,e));return t}getVisibleObjects(e){const t=this.B2D_contentProvidersBySource.get(e);if(!t)return null;if("graphics"===t.type||"tile3d"===t.type||"none"===t.type)return null;const i={},{scene:r}=t.contentProvider,s=[{type:"icon",iterable:r[8].visiblePrimitives},{type:"label",iterable:r[6].visiblePrimitives}];for(const{type:e,iterable:t}of s){const r=t[Symbol.iterator]();for(let t=r.next();!t.done;t=r.next()){const{metadata:r}=t.value,s=r&&r.get("objectId");s&&(i[s]||(i[s]={metadata:r,icon:!1,label:!1}),i[s][e]=!0)}}return Object.keys(i).map((e=>{const{metadata:t,icon:r,label:s}=i[e];return{objectId:e,metadata:t,type:r&&s?"icon-label":s?"label":"icon"}}))}setTileContentClippingGeometry(e){const t=new Map;e.forEach(((e,i)=>t.set(i,{dataSourceId:i,geometry:e})));const{removed:i,created:r,result:s}=(0,l.B)(this.FEB_tileContentClippingGeometries,t,(e=>e),void 0,void 0,(()=>!1));for(const{dataSourceId:e,geometry:t}of i){const i=this.B2D_contentProvidersBySource.get(e);i&&"tile"===i.type&&i.contentProvider.removeTileContentClipperGeometry(t)}for(const{dataSourceId:e,geometry:t}of r){const i=this.B2D_contentProvidersBySource.get(e);i&&"tile"===i.type&&i.contentProvider.addTileContentClipperGeometry(t)}this.FEB_tileContentClippingGeometries=s}ABB_getWorldWrapOption(e){return e?2:0}B32_abortAndCleanupAsyncLayersInitIfInProgress(){this.C55_asyncSetLayersAbortController&&(this.C55_asyncSetLayersAbortController.abort(),this.C55_asyncSetLayersAbortController=void 0)}B2F_applyDataSources(e){this.B2F_dataSources={};for(const t of Object.keys(e)){const i=e[t];(i instanceof h.Nt&&i.vectorSourceDescription||i instanceof b.m5||i instanceof c.N||i instanceof V.m)&&(this.B2F_dataSources[t]=i)}}C78_updateDataSourceZoomRange(e,t){const{source:i,contentProvider:r}=e;if(i instanceof h.Nt&&i.zoomRange){const e=t.zoom>=i.zoomRange.min&&t.zoom<=i.zoomRange.max;this.A20_setContentProviderActive(r,e)}}A20_setContentProviderActive(e,t){let i=!1;t&&e.isPaused?(e.resume(),i=!0):t||e.isPaused||(e.pause(),i=!0),i&&e instanceof this.vector.IndoorContentProvider&&this.EBD_onPlansChanged()}B39_applyMapTheme(e,t){if(this.B3F_applyBackgroundColor(),e instanceof this.vector.Tile3DContentProvider){const i="dark"===t?this.vector.TILE3D_MODEL_COLOR_NIGHT:this.vector.TILE3D_MODEL_COLOR_DAY;e.setModelColor(i)}else{const i="dark"===t?1:0;e.setMapMode(i)}}B3F_applyBackgroundColor(){const{LIGHT:e,DARK:t}=this.vector.BackgroundColor;let i,r=!1;this.B2D_contentProvidersBySource.forEach((({source:e,contentProvider:t})=>{var s;i||(t instanceof this.vector.Vmap3ContentProvider&&t.backgroundController.background&&(i=t.backgroundController.background),e instanceof h.Nt&&"dark"===(null===(s=e.vectorSourceDescription)||void 0===s?void 0:s.theme)&&(r=!0))}));const s=r?t:e;this.EBD_backgroundRenderUnit.setColor(i?i.color:s)}D8F_doResize(){const e=Math.max(this.C5B_size.x,1),t=Math.max(this.C5B_size.y,1),i=(0,a.x)();this.FEA_engine.camera.screenSize.width=e,this.FEA_engine.camera.screenSize.height=t,this.FEA_engine.camera.flushUpdates(),this.FEA_engine.setRenderTargetSize({width:e*i,height:t*i}),this.ECB_layersById.forEach((({hotspotLayer:e})=>e&&e.resize(this.C5B_size))),this.FF3_renderedSize=this.C5B_size}B4D_createNoneContentProvider(e,t){return{contentProvider:{name:t,memoryUsage:0,onMemoryUsageChanged:{addListener(){},removeListener(){}},isPaused:!1,destructor(){},pause(){},resume(){},getObjectMetadata(){}},source:e,sourceSubscription:e.group(),type:"none"}}B37_createGraphicsContentProvider(e,t){const i=this.EA6_contentProdiver.initContentProvider(4,t,{basePriority:100,objectsCollisionPriority:2,accurateGeometryLines:!0});i.visibilityManager.onStateChanged.addListener(this.A14_onGraphicsStateChanged);const r=t=>{const r=e.features.get(t);if((0,b.uT)(r))return;const{feature:s,style:o}=T(r);i.addObject(s,o,G(r.parentGroupId),t)},s=e=>{i.removeObject(e)},o=t=>{const r=e.groups.get(t);i.addGroup({opacity:r.style.opacity,zIndex:r.style.zIndex},G(r.parentGroupId),t)},n=e.on("featureAdded",r).on("featureRemoved",s).on("featureUpdated",(t=>{const r=e.features.get(t);if((0,b.uT)(r))return;const{feature:s,style:o}=T(r);i.updateObject(t,s,o)})).on("groupAdded",o).on("groupRemoved",(({id:e})=>{i.removeGroupAndChildren(e)})).on("featureMovedToGroup",(e=>{s(e),r(e)})),a=e=>{o(e.id);for(const t of e.children)"feature"===t.type?r(t.id):a(t)};return a(e.groups.get(b.oR)),{contentProvider:i,source:e,sourceSubscription:n,type:"graphics"}}A71_createTile3dContentProvider(e,t){const i=this.EA6_contentProdiver.initContentProvider(6,t,{basePriority:this.FF1_getVectorContentProviderPriority(e.priority),gltfDecoderWorkerUrl:e.workerUrl}),r=new B(this.vector,i,e),s=r.on("tile3dChanged",(e=>this._emit("tile3dChanged",e))).on("tile3dVisibilityChange",(e=>this._emit("tile3dVisibilityChange",e))).on("tile3dProcessingError",(e=>(0,x.H)(e))),o=e.on("changed",(()=>{this.B39_applyMapTheme(i,e.theme)}));return this.B39_applyMapTheme(i,e.theme),{type:"tile3d",source:e,sourceSubscription:o,contentProvider:i,controller:r,controllerSubscription:s}}FF1_getVectorContentProviderPriority(e){return{low:100,medium:200,high:300}[e]}B4F_getVectorTileSize(e){return{X1:0,X4:1,X16:2}[e]}D9B_getVectorCollisionPriority(e){return{low:0,medium:1,high:2,ultra:3}[e]}FEF_getVectorMapType(e){if(void 0===e)return;return{admin:this.vector.MapType.ADMIN,driving:this.vector.MapType.DRIVING,map:this.vector.MapType.MAP,transit:this.vector.MapType.TRANSIT}[e]}EAD_setupHotspotLayer(e,t){const i=this.B2F_dataSources[t.source];if(!(i instanceof h.Nt))return;const r=(i.vectorSourceDescription.hotspots||{})[t.type];if("function"!=typeof r)return;const s=(0,N.E)("ymaps3x0--layer ymaps3x0--graphics-layer"),n=new p.K({element:s,size:this.C5B_size,camera:this.EA2_camera,dataSource:{fetchHotspots:r,hotspotAbortRadius:i.hotspotAbortRadius,tileSize:i.tileSize,zoomRange:i.zoomRange,inset:o.zw,padding:0},processingQueue:this.C6C_processingQueue,worldOptions:this.worldOptions,zoomRoundingRule:H,tiltRange:this.EAE_tiltRange});n.on("requestRender",this.D85_updateRenderLoop),e.hotspotLayer=n}B38_teardownHotspotLayer(e){e.hotspotLayer&&(e.hotspotLayer.offSingle("requestRender",this.D85_updateRenderLoop),e.hotspotLayer.destroy())}B2D_areTilesReady(){let e=!0;return this.B2D_contentProvidersBySource.forEach((t=>{if("tile"===t.type){const{viewportState:i}=t.contentProvider.visibilityManager;e=e&&i.visibleTileNumber===i.visualizableTileNumber}})),e}findObjectInPosition(e){const t=(0,y.k6)(e,Object.assign(Object.assign({},this.EA2_camera),{fov:this.fov,size:{x:this.FEA_engine.camera.screenSize.width,y:this.FEA_engine.camera.screenSize.height}})),i=this.FEA_engine.getObjectIdAt(d.Sm(t,(0,a.x)())),r=this.EA6_contentProdiver.getObjectMetadata(i);if(!r)return this.D8F_findRasterHotspotObjectAbove(e,void 0);const s=r.get("uri"),o=r.get("position"),n=r.get("objectId"),l=o?o.split(",").map(Number):void 0,c=(r.get("tags")||r.get("eventTags")||r.get("group")||"").split(",").filter(Boolean),u=r.get(this.vector.VECTOR_METADATA_PREFIX+"layerName"),_=this.A1F_findLayerForMetadata(c,u),p=this.D8F_findRasterHotspotObjectAbove(e,_);if(p)return p;if(!_)return null;const m=this.B2F_dataSources[u],f=m instanceof h.Nt&&m.vectorSourceDescription.hotspots;return f&&!this.C74_areHotspotsEnabled(f[_.type])||"footprint"===r.get(this.vector.VECTOR_METADATA_PREFIX+"richModel")?null:m instanceof b.m5?n&&m.hasFeatureWithId(n)?{type:"feature",feature:m.getFeatureById(n),layer:_.id,source:u}:null:{type:"hotspot",layer:_.id,source:u,feature:{type:"Feature",id:n||s||o||"",geometry:l&&{type:"Point",coordinates:{x:l[0],y:l[1]}},properties:{[z.u]:{name:r.get("name")},uri:s,tags:c,name:r.get("name"),selectedIconUrl:r.get(this.vector.VECTOR_METADATA_PREFIX+"selectedIconUrl"),vectorMetadata:r,vectorId:i}}}}findObjectInPositionEx(e){const t=this.findObjectInPosition(e);let i=this.FDD_layerDescriptions.slice().reverse();const r=i.findIndex((e=>e.id===(null==t?void 0:t.layer)));r>=0&&(i=i.slice(0,r));const s={layers:[]};return s.layers.push(...i.map((e=>({layer:e.id,object:null})))),t&&s.layers.push({layer:t.layer,object:t}),s}setObjectHighlight(e){const t=null==e?void 0:e.object.properties.vectorId;this.D8E_objectHighlight.transform=e&&void 0!==t?{transform:this.vector.createColorTransform(e.color),objectId:t}:void 0,this.FF1_vectorRenderLoop.update()}D8F_findRasterHotspotObjectAbove(e,t){for(const i of this.FDD_layerDescriptions.slice().reverse()){const r=this.ECB_layersById.get(i.id);if(r.hotspotLayer){const t=r.hotspotLayer.findObjectInPosition(e);if(t)return Object.assign(Object.assign({},t),{layer:i.id,source:i.source})}if(i===t)return null}return null}A1F_findLayerForMetadata(e,t){const i=-1!==e.indexOf("building");for(const e of this.FDD_layerDescriptions)if(e.source===t&&(i&&"buildings"===e.type||"icons"===e.type))return e;return this.FDD_layerDescriptions.find((e=>e.source===t))}C74_areHotspotsEnabled(e){return"object"==typeof e?void 0===e.minZoom||this.FEA_engine.camera.zoom>=e.minZoom:void 0===e||!0===e}EBF_toggleVisibilityFilter(e,t,i,r=[8,6]){const s=i?"addVisibilityFilter":"removeVisibilityFilter";for(const i of r)e[s](i,t)}get fov(){return this.vector.getPhonyFov(this.FEA_engine.camera)}}function G(e){return e===b.oR||null===e?void 0:e}function W(e,t,i){return(...r)=>new j(t,i,e,void 0,...r)}function q(e,t){let i=`\ntry {\n    importScripts('${e}');\n    postMessage({loaded: true});\n} catch(e) {\n    postMessage({loaded: false, error: e});\n}`;const r="blob"===t?URL.createObjectURL(new Blob([i])):`data:application/javascript,${encodeURIComponent(i)}`;return new Promise(((e,t)=>{const i=new Worker(r),s=e=>{URL.revokeObjectURL(r),i.removeEventListener("error",s),t(e.error)},o=s=>{if(URL.revokeObjectURL(r),i.removeEventListener("message",o),s.data.loaded)return e(i);t(s.data.error)};i.addEventListener("error",s),i.addEventListener("message",o)}))}function Y(e,t){var i;return`${e}/${(null===(i=t.match(/[^/]*$/))||void 0===i?void 0:i[0])||""}`}const X=new URL(i(32448),i.b).pathname;function Z(e){if(!e)throw new Error("Config not specified");const t=Y(e.src.base,X);return q(t,"data").catch((()=>q(t,"blob"))).catch((()=>fetch(t).then((e=>e.blob())).then(URL.createObjectURL).then((e=>{const t=new Worker(e);return URL.revokeObjectURL(e),t}))))}const $=new URL(i(1367),i.b).pathname;function Q(e){if(!e)throw new Error("Config not specified");const t=Y(e.src.base,$);return`data:application/javascript,${encodeURIComponent(`importScripts('${t}');`)}`}},32448:(e,t,i)=>{"use strict";e.exports=i.p+"content_provider.worker.js"},1367:(e,t,i)=>{"use strict";e.exports=i.p+"gltf_decoder.worker.js"}},e=>{e.O(0,[175],(()=>{return t=16387,e(e.s=t);var t}));var t=e.O();self["@yandex/ymaps3-vector"]=t}]);